<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <? 
    // Logo.html íŒŒì¼ ë‚´ìš©ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    var logoRaw = HtmlService.createHtmlOutputFromFile('Logo').getContent();
    
    // "data:image/..." í˜•íƒœì˜ ë¬¸ìì—´ì„ ì •ê·œì‹ìœ¼ë¡œ ì¶”ì¶œí•©ë‹ˆë‹¤.
    // ì£¼ì˜: Logo.html ë‚´ë¶€ì— ì´ë¯¸ì§€ê°€ í°ë”°ì˜´í‘œ(")ë¡œ ê°ì‹¸ì ¸ ìˆì–´ì•¼ ì •ìƒ ë™ì‘í•©ë‹ˆë‹¤.
    var logoDataMatch = logoRaw.match(/"(data:image\/[^"]+)"/);
    var logoData = logoDataMatch ? logoDataMatch[1] : "";
  ?>

  <link rel="icon" href="<?!= logoData ?>">
  <link rel="apple-touch-icon" href="<?!= logoData ?>">
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="ì „ì êµ¬ì—­ ì¹´ë“œ">
  <meta name="mobile-web-app-capable" content="yes">

  <script> var SHARED_LOGO_DATA = "<?!= logoData ?>"; </script>

  <link rel="dns-prefetch" href="https://cdn.tailwindcss.com">
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="preconnect" href="https://script.google.com">
  <link rel="preconnect" href="https://googleusercontent.com">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>

  <style>

/* [í†µí•©] ë¡œë”© ì• ë‹ˆë©”ì´ì…˜, ë ˆì´ë” íš¨ê³¼ ë° ì „í™˜ ìµœì í™” */

/* 1. ì• ë‹ˆë©”ì´ì…˜ í‚¤í”„ë ˆì„ ì •ì˜ */
@keyframes logoPulse {
  0% { transform: scale(0.98); opacity: 0.8; filter: drop-shadow(0 0 5px rgba(239, 68, 68, 0.1)); }
  50% { transform: scale(1.05); opacity: 1; filter: drop-shadow(0 0 20px rgba(239, 68, 68, 0.4)); }
  100% { transform: scale(0.98); opacity: 0.8; filter: drop-shadow(0 0 5px rgba(239, 68, 68, 0.1)); }
}

@keyframes loadingBarMove {
  0% { transform: translateX(-100%); }
  50% { transform: translateX(0%); }
  100% { transform: translateX(100%); }
}

@keyframes radarSweep {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

@keyframes radarWipeAnim {
  from { --reveal-angle: 0deg; }
  to { --reveal-angle: 360deg; }
}

/* 2. ë°°ê²½ ì„¤ì • */
#app-loading-mask, #loginView {
  background: radial-gradient(circle at center, #ffffff 0%, #f1f5f9 100%) !important;
}

#app-loading-mask {
  position: fixed;
  inset: 0;
  z-index: 99999;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* 3. ë ˆì´ë” ë° ë¡œê³  UI */
.radar-wrapper {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 40px;
}

/* 2. ë ˆì´ë” ìŠ¤ìœ• (ìƒ‰ìƒ ë³€ê²½) */
.radar-sweep {
  position: absolute;
  width: 170px;
  height: 170px;
  border-radius: 50%;
  
  /* ğŸ”´ Indigo -> Redë¡œ ë³€ê²½ */
  background: conic-gradient(
    from 0deg,
    transparent 0%,
    rgba(239, 68, 68, 0.05) 50%, 
    rgba(239, 68, 68, 0.4) 95%, 
    rgba(239, 68, 68, 0.8) 100%
  );
  
  animation: radarSweep 2s linear infinite;
  z-index: 1;
}

/* 3. ë¡œê³  ë°•ìŠ¤ (ì›í˜• ë³€ê²½ + ê·¸ë¦¼ì ìƒ‰ìƒ ë³€ê²½) */
.radar-logo-box {
  position: relative;
  z-index: 10;
  width: 112px;
  height: 112px;
  background: white;
  
  /* ğŸ”´ ë‘¥ê·¼ ì‚¬ê°í˜•(2rem) -> ì™„ì „ ì›í˜•(50%) ë³€ê²½ */
  border-radius: 50%;
  
  padding: 8px;
  
  /* ğŸ”´ ê·¸ë¦¼ì ìƒ‰ìƒ ë³€ê²½ */
  box-shadow: 0 15px 35px rgba(239, 68, 68, 0.15);
  
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.8);
  animation: logoPulse 2s infinite ease-in-out;
}

/* ê¸€ì ìˆœì°¨ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ */
@keyframes letterReveal {
  0% { opacity: 0; transform: translateY(5px); }
  100% { opacity: 1; transform: translateY(0); }
}

.letter-span {
  display: inline-block;
  opacity: 0; /* ê¸°ë³¸ ìƒíƒœ: ìˆ¨ê¹€ */
  animation: letterReveal 0.5s cubic-bezier(0.5, 0, 0, 1) forwards;
}

/* âš¡ [í•µì‹¬ ìˆ˜ì •] ì´ˆê¸° í…ìŠ¤íŠ¸ ê¹œë¹¡ì„ ë°©ì§€ í´ë˜ìŠ¤ */
/* ì´ í´ë˜ìŠ¤ê°€ ë¶™ì–´ìˆìœ¼ë©´ íˆ¬ëª…ë„ 0ìœ¼ë¡œ ê°•ì œ ìˆ¨ê¹€ ì²˜ë¦¬ */
.init-hidden {
  opacity: 0 !important;
}


#loadingLogoImg {
  width: 100%;
  height: 100%;
  object-fit: contain !important;
}

/* 4. ë ˆì´ë” ì™€ì´í”„(ì „í™˜) íš¨ê³¼ - [ìˆ˜ì •ë¨] */
@property --reveal-angle {
  syntax: '<angle>';
  inherits: false;
  initial-value: 0deg;
}

#app-loading-mask.wipe-out {
  /* ê²½ê³„ë©´ì— ì‚´ì§ ë¸”ëŸ¬ë¥¼ ì£¼ì–´ ë¶€ë“œëŸ½ê²Œ ê¹ì´ê²Œ í•¨ */
  -webkit-mask-image: conic-gradient(
    transparent var(--reveal-angle), 
    rgba(0,0,0,0.8) calc(var(--reveal-angle) + 5deg), 
    black calc(var(--reveal-angle) + 10deg)
  );
  mask-image: conic-gradient(
    transparent var(--reveal-angle), 
    rgba(0,0,0,0.8) calc(var(--reveal-angle) + 5deg), 
    black calc(var(--reveal-angle) + 10deg)
  );
  animation: radarWipeAnim 1.2s forwards cubic-bezier(0.4, 0, 0.2, 1);
  
  /* ğŸš€ [í•µì‹¬ ìˆ˜ì •] ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ ì¦‰ì‹œ í´ë¦­ì´ í†µê³¼ë˜ë„ë¡ ì„¤ì • */
  pointer-events: none !important; 
}

/* 5. ë¡œê·¸ì¸ í¼ ìš”ì†Œ ìˆœì°¨ ë“±ì¥ - [ìˆ˜ì •ë¨] */
#loginView.reveal-effect > div > * {
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.6s cubic-bezier(0.22, 1, 0.36, 1);
}

/* ğŸš€ [ì¶”ê°€] reveal-now í´ë˜ìŠ¤ê°€ ë¶™ì—ˆì„ ë•Œ ë‚˜íƒ€ë‚˜ëŠ” ìµœì¢… ìƒíƒœ ì •ì˜ */
#loginView.reveal-effect > div > *.reveal-now {
  opacity: 1 !important;
  transform: translateY(0) !important;
  pointer-events: auto !important; /* ìš”ì†Œë“¤ í´ë¦­ ê°€ëŠ¥ ë³´ì¥ */
}

/* ìˆœì°¨ì  ì§€ì—° ì‹œê°„ */
#loginView.reveal-effect > div > *:nth-child(1) { transition-delay: 0.2s; }
#loginView.reveal-effect > div > *:nth-child(2) { transition-delay: 0.3s; }
#loginView.reveal-effect > div > *:nth-child(3) { transition-delay: 0.4s; }
#loginView.reveal-effect > div > *:nth-child(4) { transition-delay: 0.5s; }




    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap');
    body { font-family: 'Noto Sans KR', sans-serif; background-color: #f0f4f8; }

    /* =========================================
       [ìµœì í™”] ë¡œê·¸ì¸ í™”ë©´ ì´ˆê¸° ìŠ¤íƒ€ì¼
       ========================================= */
    #loginView {
  display: flex !important;
  flex-direction: column;       /* ì„¸ë¡œ ë°©í–¥ ì •ë ¬ */
  align-items: center;
  justify-content: flex-start;  /* ì½˜í…ì¸ ê°€ ê¸¸ ë•Œ ìƒë‹¨ë¶€í„° ë°°ì¹˜ (ì¤‘ìš”) */
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: #e2e8f0;
  z-index: 50;
  
  /* ğŸ“± ìŠ¤í¬ë¡¤ í•µì‹¬ ì„¤ì • */
  overflow-y: auto;             /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© */
  -webkit-overflow-scrolling: touch; /* iOS ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
  padding: 40px 16px;           /* ìƒí•˜ ì—¬ë°±ì„ ì£¼ì–´ ë¡œê³ /ë²„íŠ¼ì´ í™”ë©´ ëì— ë¶™ì§€ ì•Šê²Œ í•¨ */
}
    #loginView > div {
      background-color: #ffffff;
      border-radius: 1.5rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 24rem;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      
      /* ë¡œê·¸ì¸ í¼ ì „ì²´: ì‹œë„¤ë§ˆí‹± ë¸”ëŸ¬ ë“±ì¥ */
      animation: cinematicBlur 0.8s ease-out forwards;
    }

/* [ì‹ ê·œ ì• ë‹ˆë©”ì´ì…˜] ì‹œì‘ ë²„íŠ¼ ë°œê´‘ íš¨ê³¼ */
@keyframes pulseGlow {
  0% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); /* ë³´ë¼ìƒ‰ ë¹› ì‹œì‘ */
  }
  70% {
    transform: scale(1.02);
    box-shadow: 0 0 0 15px rgba(99, 102, 241, 0); /* ë¹›ì´ í¼ì§€ë©° ì‚¬ë¼ì§ */
  }
  100% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
  }
}

    /* =========================================
       ğŸ“¡ [í•µì‹¬] ì •ë°€ ë ˆì´ë” (ì¤‘ì•™ í´ë¦° ë²„ì „)
       ========================================= */
    #loginView .w-24 {
      width: 6rem;
      height: 6rem;
      background-color: #ffffff;
      border-radius: 50%;
      margin-bottom: 1.5rem;
      position: relative;
      z-index: 1;
      
      /* ë¡œê³  ë°•ë™ + ë¶‰ì€ íŒŒë™ í†µí•© */
      animation: emergencyBeatAndPulse 1.5s infinite ease-out;
    }

    /* ì´ë¯¸ì§€(ë¡œê³ ) ì„¤ì • */
    #loginView .w-24 img {
      border-radius: 50%;
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: relative;
      z-index: 0; 
    }

    /* ğŸ“¡ 1. ë¦¬ì–¼ ë ˆì´ë” íƒìƒ‰ì„  (ì¤‘ì•™ êµ¬ë© ëš«ìŒ) */
    #loginView .w-24::before {
      content: '';
      position: absolute;
      top: -5px; left: -5px; right: -5px; bottom: -5px;
      border-radius: 50%;
      z-index: 10;
      pointer-events: none;

      /* íƒìƒ‰ì„  ê·¸ë¼ë°ì´ì…˜ */
      background: conic-gradient(
        from 0deg,
        transparent 0%,
        rgba(239, 68, 68, 0.05) 60%, 
        rgba(239, 68, 68, 0.8) 99%,
        transparent 100%
      );
      
      /* â˜… í•µì‹¬: ì¤‘ì•™ ë§ˆìŠ¤í‚¹ (ê°€ìš´ë° 32px ëš«ì–´ì„œ ë¡œê³  ì„ ëª…í•˜ê²Œ) â˜… */
      -webkit-mask-image: radial-gradient(transparent 16px, black 17px);
      mask-image: radial-gradient(transparent 16px, black 17px);
      
      /* ì†ë„: 3ì´ˆ */
      animation: radarSpin 3s linear infinite;
    }

    /* =========================================
       ì• ë‹ˆë©”ì´ì…˜ í‚¤í”„ë ˆì„ ì •ì˜
       ========================================= */
    
    /* 1. ë¡œê³  ë°•ë™ + ê·¸ë¦¼ì íŒŒë™ */
    @keyframes emergencyBeatAndPulse {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      50% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    /* 2. ë ˆì´ë” íšŒì „ */
    @keyframes radarSpin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    /* 4. ì‹œë„¤ë§ˆí‹± ë¸”ëŸ¬ */
    @keyframes cinematicBlur {
      0% { opacity: 0; transform: scale(1.6); filter: blur(15px); }
      100% { opacity: 1; transform: scale(1); filter: blur(0); }
    }


    /* =========================================
       ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€
       ========================================= */
    @keyframes rubberBand {
      0% { transform: scale3d(1, 1, 1); }
      30% { transform: scale3d(1.25, 0.75, 1); }
      40% { transform: scale3d(0.75, 1.25, 1); }
      50% { transform: scale3d(1.15, 0.85, 1); }
      65% { transform: scale3d(0.95, 1.05, 1); }
      75% { transform: scale3d(1.05, 0.95, 1); }
      100% { transform: scale3d(1, 1, 1); }
    }

    .alive-badge { transition: all 0.3s ease; }
    .alive-badge:hover {
      animation: rubberBand 0.8s both;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
      z-index: 50 !important;
    }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .tap-highlight-transparent { -webkit-tap-highlight-color: transparent; }
    
    @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .modal-animate { animation: modalFadeIn 0.2s ease-out forwards; }
    
    .btn-active-ban { background-color: #fee2e2 !important; color: #b91c1c !important; border-color: #ef4444 !important; font-weight: 800 !important; }
    .btn-active-pub { background-color: #f0fdf4 !important; color: #15803d !important; border-color: #16a34a !important; font-weight: 800 !important; }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
    
    @keyframes ripple-effect { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(2.5); opacity: 0; } }
    .sos-heartbeat::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: inherit; border-radius: inherit; z-index: -1; animation: ripple-effect 1.5s infinite ease-out; }
    .sos-heartbeat::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: inherit; border-radius: inherit; z-index: -1; animation: ripple-effect 1.5s infinite ease-out 0.4s; }

/* [ìµœì í™”] í™”ë©´ ë°–ì˜ ìš”ì†ŒëŠ” ë Œë”ë§ ê³„ì‚°ì„ ê±´ë„ˆëœ€ */
    #listClean, #listHouse, #listBusy, #listComplete {
        content-visibility: auto; /* í•µì‹¬: í™”ë©´ì— ì•ˆ ë³´ì´ë©´ ê·¸ë¦¬ì§€ ì•ŠìŒ */
        contain-intrinsic-size: 100px; /* ì¹´ë“œì˜ ëŒ€ëµì ì¸ ë†’ì´ (ìŠ¤í¬ë¡¤ë°” ë–¨ë¦¼ ë°©ì§€) */
    }

  .address-popup {
      padding: 8px 16px;
      width: auto;
      min-width: 200px;
      border-radius: 25px;
      background-color: rgba(255, 255, 255, 0.95);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(0,0,0,0.05);
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 2px;
    }

    .address-popup strong {
      font-size: 14px;
      color: #333;
      margin-bottom: 0;
    }

    .address-popup span {
      font-size: 11px;
      color: #666;
    }

  /* =========================================
   [ìµœì¢… ìµœì í™”] GPU ê°€ì† ê°•ì œ ì ìš©
   ========================================= */
    /* ë¦¬ìŠ¤íŠ¸ ìŠ¤í¬ë¡¤ ì˜ì—­ì— will-change ì ìš© */
    #listClean, #listHouse, #listBusy, #listComplete {
        will-change: transform, contents;
        transform: translateZ(0); /* GPU ë ˆì´ì–´ ê°•ì œ ìƒì„± */
    }

  <link rel="preconnect" href="https://maps.google.com">
  <link rel="preconnect" href="https://maps.gstatic.com">
   
/* iOS ìŠ¤íƒ€ì¼ - íˆ¬ëª… ìœ ë¦¬ í—¤ë” */
.ios-header {
  background: rgba(255, 255, 255, 0.85);
  backdrop-filter: saturate(180%) blur(20px);
  -webkit-backdrop-filter: saturate(180%) blur(20px);
  border-bottom: 0.5px solid rgba(0, 0, 0, 0.1);
  padding-top: env(safe-area-inset-top, 12px);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* ì¶•ì†Œ ì• ë‹ˆë©”ì´ì…˜ */
  overflow: hidden;
}

/* [ì¶•ì†Œ ê¸°ëŠ¥] í—¤ë”ê°€ ì¶•ì†Œë  ë•Œ í•˜ë‹¨ ì—¬ë°± ì¤„ì„ */
.header-shrunk .ios-header {
  padding-bottom: 8px;
}

/* [ì¶•ì†Œ ê¸°ëŠ¥] ì ‘ì†ì ëª…ë‹¨ ìˆ¨ê¸°ê¸° */
#activeUsersArea {
  transition: all 0.3s ease;
  max-height: 40px; 
  opacity: 1;
}
.header-shrunk #activeUsersArea {
  max-height: 0;
  opacity: 0;
  margin-top: 0;
  pointer-events: none;
}

/* ì™¼ìª½ ì•„ì´ì½˜ ë° ë°°ì§€ ìŠ¤íƒ€ì¼ */
.ios-round-btn {
  background: rgba(0, 0, 0, 0.05);
  color: #007AFF; 
  border-radius: 10px;
  transition: all 0.2s;
}
.ios-round-btn:active { background: rgba(0, 0, 0, 0.15); transform: scale(0.95); }

/* SOS ë²„íŠ¼ (iOS ì‹œìŠ¤í…œ ë ˆë“œ) */
.ios-sos-solid {
  background: #FF3B30;
  color: white;
  box-shadow: 0 4px 10px rgba(255, 59, 48, 0.2);
}

/* ìƒíƒœ ë°°ì§€ */
#statusBadge {
  background: rgba(0, 0, 0, 0.08);
  color: #1C1C1E;
  font-size: 11px;
  font-weight: 800;
  padding: 2px 8px;
  border-radius: 6px;
  letter-spacing: -0.3px;
}

/* ì˜¤ë¥¸ìª½ ë’¤ë¡œ ë²„íŠ¼ */
.ios-back-btn {
  color: #007AFF;
  font-size: 17px;
  font-weight: 500;
  transition: opacity 0.3s;
}
.ios-back-btn:active { opacity: 0.3; }

/* ì ‘ì†ì ëª…ë‹¨ (ê²€ì •ìƒ‰) */
.active-user-text {
  color: #000000;
  font-weight: 600;
  font-size: 11px;
}

/* [ìˆ˜ì •] ì´ë¯¸ì§€ ë° ì§€ë„ ì»¨í…Œì´ë„ˆ: ì—¬ë°±ê³¼ ì„ ì„ ì™„ì „íˆ ì œê±° */
#imageWrapper, #mapContainer {
  width: 100%;
  height: 400px; /* ì‹œì›í•œ ê°œë°©ê°ì„ ìœ„í•´ ë†’ì´ë¥¼ 400pxë¡œ ìƒí–¥ */
  background-color: #ffffff; 
  margin: 0 !important;      /* ëª¨ë“  ë°©í–¥ ì—¬ë°± ì œê±° */
  padding: 0 !important;     /* ë‚´ë¶€ ì—¬ë°± ì œê±° */
  border: none !important;    /* í•˜ë‹¨ ê²½ê³„ì„  ì œê±° */
  position: relative;
  overflow: hidden;
}

/* [ìˆ˜ì •] ë¦¬ìŠ¤íŠ¸ ì˜ì—­: ìƒë‹¨ íŒ¨ë”©ì„ 0ìœ¼ë¡œ ë§Œë“¤ì–´ ì´ë¯¸ì§€ì— ë°€ì°© */
#listContainer {
  padding: 0 16px 120px 16px !important; /* ìƒë‹¨(ì²«ë²ˆì§¸ ê°’)ì„ 0ìœ¼ë¡œ ê°•ì œ */
}

/* [ìˆ˜ì •] êµ¬ì—­ ì•ˆë‚´(*) íŒŒë€ ë°•ìŠ¤: ì´ë¯¸ì§€ í•˜ë‹¨ì— ë°”ì§ ë¶™ì´ê¸° */
.mt-6.mb-4.px-4.py-3.rounded-2xl {
  margin-top: 0 !important;    /* ì´ë¯¸ì§€ ë°”ë¡œ ë’¤ì— ì˜¬ ë•Œ ì—¬ë°± ì œê±° */
  margin-bottom: 12px !important;
  border-radius: 0 0 1.5rem 1.5rem; /* ìœ„ìª½ ëª¨ì„œë¦¬ëŠ” ê¹ì•„ì„œ ì´ë¯¸ì§€ì™€ ì¼ì²´í™” */
}

/* [ìˆ˜ì •] ì£¼ì†Œ í—¤ë”: ì´ë¯¸ì§€ ë°”ë¡œ ë’¤ì— ì˜¬ ê²½ìš° ìƒë‹¨ ì—¬ë°± ì¡°ì ˆ */
.section-header.block.mt-6 {
  margin-top: 12px !important; /* ì´ë¯¸ì§€ ë°”ë¡œ ë’¤ì— ì˜¬ ë•Œ ì—¬ë°± ìµœì í™” */
}

/* ğŸ’Š ì˜…ì€ ë³´ë¼ìƒ‰ ë°°ê²½ + íŒŒë€ìƒ‰ ì†ì±„ì›€ ì•Œì•½ ìŠ¤íƒ€ì¼ */
#stickyAddressPill {
  /* ë°°ê²½: ì•„ì´í° íŠ¹ìœ ì˜ ì˜…ì€ ë¼ë²¤ë”/ë³´ë¼ìƒ‰ ë°˜íˆ¬ëª… */
  background: rgba(245, 243, 255, 0.9); 
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  
  /* í…Œë‘ë¦¬: ë³´ë¼ìƒ‰ í†¤ì— ë§ì¶˜ ì•„ì£¼ ì—°í•œ ì„  */
  border: 0.5px solid rgba(139, 92, 246, 0.2);
  
  /* ê·¸ë¦¼ì: ë³´ë¼ìƒ‰ ë¹›ì´ ì€ì€í•˜ê²Œ ê°ë„ëŠ” ê·¸ë¦¼ì */
  box-shadow: 0 4px 15px rgba(109, 40, 217, 0.08);
  border-radius: 9999px;
  
  position: fixed;
  /* í—¤ë” ìœ„ì¹˜ ìë™ ì—°ë™ */
  top: 84px; 
  left: 50%;
  transform: translateX(-50%);
  z-index: 40;
  overflow: hidden;
  
  padding: 5px 22px; 
  min-width: 160px;
  
  /* ë¶€ë“œëŸ¬ìš´ ìœ„ì¹˜ ì´ë™ ì• ë‹ˆë©”ì´ì…˜ */
  transition: top 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, transform 0.3s ease;
}

/* í—¤ë” ì¶•ì†Œ ì‹œ ì•Œì•½ ìœ„ì¹˜ ìë™ ì¡°ì • */
.header-shrunk #stickyAddressPill {
  top: 62px; 
}

/* ì•Œì•½ ë‚´ë¶€ ê²Œì´ì§€ (íŒŒë€ìƒ‰ ì†ì±„ì›€) */
#pillProgressBar {
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  /* ì±„ì›Œì§€ëŠ” ìƒ‰ìƒ: ë³´ë¼ìƒ‰ ë°°ê²½ê³¼ ì˜ ì–´ìš¸ë¦¬ëŠ” Indigo-Blue */
  background: rgba(59, 130, 246, 0.2); 
  transition: width 0.15s ease-out;
  z-index: 1;
}

/* í…ìŠ¤íŠ¸ ê°€ë…ì„± (ë³´ë¼ìƒ‰ í…Œë§ˆì— ë§ì¶¤) */
#pillMainText, #pillSubWrapper {
  position: relative;
  z-index: 10;
  color: #1c1c1e;
}

#pillMainText {
  font-size: 12px;
  line-height: 1.2;
}

#pillSubWrapper {
  margin-top: 1px;
  /* ì•„ì´ì½˜ ìƒ‰ìƒ: ë³´ë¼ìƒ‰ ê°•ì¡°ìƒ‰ ì ìš© */
  color: #8B5CF6; 
}

/* [ì¶•ì†Œ ê¸°ëŠ¥] ìŠ¤í¬ë¡¤ ì‹œ ì•Œì•½ ìœ„ì¹˜ ì´ë™ */
.header-shrunk #stickyAddressPill {
  top: 56px; 
}

/* ìë¬¼ì‡  ìƒ‰ìƒ */
.lock-blue { color: #007AFF !important; }
.lock-green { color: #34C759 !important; }

#publisherManagerModal .overflow-y-auto {
  scrollbar-gutter: stable; /* ìŠ¤í¬ë¡¤ë°”ê°€ ì—†ì–´ë„ ê³µê°„ì„ ë¯¸ë¦¬ í™•ë³´í•˜ì—¬ í”ë“¤ë¦¼ ë°©ì§€ */
  overflow-y: scroll;       /* í•­ìƒ ìŠ¤í¬ë¡¤ë°” ë°”ìš´ë”ë¦¬ ìœ ì§€ */
}

/* ìŠ¤í¬ë¡¤ë°” ë””ìì¸ ìµœì í™” */
#publisherManagerModal .overflow-y-auto::-webkit-scrollbar {
  width: 4px;
}
#publisherManagerModal .overflow-y-auto::-webkit-scrollbar-thumb {
  background: rgba(0, 0, 0, 0.1);
  border-radius: 10px;
}
/* ========================================= */

/* style íƒœê·¸ ì•ˆì˜ ë‚´ìš©ì„ ìˆ˜ì •í•˜ê±°ë‚˜ ì¶”ê°€í•˜ì„¸ìš” */
#publisherListArea {
  display: flex;
  flex-direction: column;
  flex-grow: 1;
  min-height: 320px; /* ì°½ ë†’ì´ì— ë§ì¶° 400ì—ì„œ 250ìœ¼ë¡œ í•˜í–¥ ì¡°ì • */
}

/* ìŠ¤í¬ë¡¤ë°” ì˜ì—­ ê³ ì • (ê¸°ì¡´ê³¼ ë™ì¼) */
#publisherManagerModal .overflow-y-auto {
  scrollbar-gutter: stable;
  overflow-y: scroll;
}

@keyframes modalFadeInCenter {
    from { 
      opacity: 0; 
      transform: translate(-50%, -48%) scale(0.95); 
    }
    to { 
      opacity: 1; 
      transform: translate(-50%, -50%) scale(1); 
    }
  }

  .modal-center-fix {
    position: fixed;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%); /* ìˆ˜ì§/ìˆ˜í‰ 50% ì´ë™ */
    animation: modalFadeInCenter 0.25s ease-out forwards !important;
    margin: 0 !important;
  }

  /* ê´€ë¦¬ì í¼ ì „ì²´ê°€ ì•„ë˜ì—ì„œ ìœ„ë¡œ ì“± ì˜¬ë¼ì˜¤ëŠ” íš¨ê³¼ */
@keyframes slideUp {
  from { transform: translateY(100%); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* ë‚´ë¶€ ì¹´ë“œë“¤ì´ ìˆœì°¨ì ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ëŠ” íš¨ê³¼ */
@keyframes fadeInSlide {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.admin-slide-up {
  animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

.admin-item-fade {
  opacity: 0; /* ì²˜ìŒì—” ìˆ¨ê¹€ */
  animation: fadeInSlide 0.5s ease-out forwards;
}


/* [í•„ìˆ˜] í™”ë©´ ê°€ë¦¼ë§‰ ìŠ¤íƒ€ì¼ */
#app-loading-mask {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: #ffffff; /* í°ìƒ‰ ë°°ê²½ */
  z-index: 99999; /* ì œì¼ ìœ„ì— í‘œì‹œ */
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.3s ease-out; /* ì‚¬ë¼ì§ˆ ë•Œ ë¶€ë“œëŸ½ê²Œ */
}

/* ë¡œë”© ì¤‘ í‘œì‹œí•  í…ìŠ¤íŠ¸ë‚˜ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
.loading-spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #e2e8f0;
  border-top: 4px solid #4f46e5; /* ì¸ë””ê³  ìƒ‰ìƒ */
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


/* ë²¨ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
.bell-active { color: #F59E0B !important; transform: scale(1.1); } /* í™œì„±í™” ì‹œ í™©ê¸ˆìƒ‰ + ì•½ê°„ í™•ëŒ€ */
.bell-btn { transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.bell-btn:active { transform: scale(0.8); }



/* ë™ê¸°í™” ìƒíƒœ ë°°ì§€ ìŠ¤íƒ€ì¼ */
.sync-badge {
  position: absolute;
  bottom: -4px;
  right: -4px;
  width: 18px;
  height: 18px;
  background: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.15);
  z-index: 30;
  border: 1px solid #f0f0f0;
}
.sync-pending { color: #94a3b8; } /* ì „ì†¡ ì¤‘ (íšŒìƒ‰) */
.sync-success { color: #10b981; } /* ì™„ë£Œ (ì´ˆë¡ìƒ‰) */

/* ë°°ì§€ê°€ ë‚˜íƒ€ë‚  ë•Œ í†¡! íŠ€ì–´ë‚˜ì˜¤ëŠ” íš¨ê³¼ */
@keyframes popIn {
  0% { transform: scale(0); opacity: 0; }
  80% { transform: scale(1.2); opacity: 1; }
  100% { transform: scale(1); opacity: 1; }
}
.animate-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

/* style íƒœê·¸ ì•ˆì— ëª…ì‹œì ìœ¼ë¡œ ì¶”ê°€ */
#toastContainer {
  z-index: 9999999 !important; /* ê°•ì œë¡œ ìµœìƒë‹¨ ê³ ì • */
}

  </style>
</head>

<body class="h-screen w-screen overflow-hidden flex flex-col relative text-slate-800" onclick="closeAllMenus(event)">

  <div id="app-loading-mask">
  <div class="flex flex-col items-center gap-10">
    
    <div class="radar-wrapper">
      <div class="radar-sweep"></div>
      
      <div class="radar-logo-box animate-logo">
        <img id="loadingLogoImg" src="" alt="Logo">
      </div>
    </div>
    
    <div class="flex flex-col items-center gap-3">
      <p id="loadingText" class="init-hidden text-black text-[18px] font-black tracking-[0.4em] uppercase min-h-[24px]">
        <?= loadingTitle ?>
      </p>
      
      <div class="h-0.5 w-24 bg-slate-100 rounded-full overflow-hidden relative">
        <div class="absolute inset-0 bg-red-500 rounded-full" 
            style="animation: loadingBarMove 2s infinite ease-in-out;"></div>
      </div>
    </div>

  </div>
</div>


<div id="adminActionPanel" class="fixed inset-0 z-[1000] bg-slate-100/90 backdrop-blur-md hidden flex flex-col admin-slide-up">
  
  <div class="px-6 py-4 bg-white/80 backdrop-blur-md border-b border-slate-200 flex justify-between items-center shadow-sm shrink-0">
    <div class="flex items-center gap-2">
      <div class="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center text-white shadow-md shadow-indigo-200">
        <i class="fa-solid fa-gear text-sm"></i>
      </div>
      <div>
        <h2 class="text-lg font-black text-slate-800 leading-none" data-lang="ì„¤ì • ê´€ë¦¬">ì„¤ì • ê´€ë¦¬</h2>
        <span class="text-[10px] font-bold text-slate-400">ADMINISTRATOR</span>
      </div>
    </div>
    <button onclick="closeAdminPanel()" class="w-9 h-9 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-500 transition-colors flex items-center justify-center">
      <i class="fa-solid fa-xmark text-lg"></i>
    </button>
  </div>

  <div class="flex-1 overflow-y-auto p-4 sm:p-6 space-y-6 no-scrollbar">
    
  <div id="adminLangSettingArea" class="bg-white p-5 rounded-[1.5rem] shadow-sm border border-slate-200/60 admin-item-fade">
  <div class="flex items-center justify-between mb-4 px-1">
    <div class="flex items-center gap-2 text-indigo-600">
      <i class="fa-solid fa-language text-lg"></i>
      <span class="text-sm font-black" data-lang="ì‹œìŠ¤í…œ ì–¸ì–´ ì„¤ì •">ì‹œìŠ¤í…œ ì–¸ì–´ ì„¤ì •</span>
    </div>
    <span class="text-[10px] font-bold text-slate-400" data-lang="ì–¸ì–´">ì–¸ì–´</span>
  </div>

  <div class="grid grid-cols-5 gap-2">
    <button onclick="changeSystemLanguage('ko')" id="lang-ko" class="flex flex-col items-center gap-1 p-2 rounded-xl border-2 transition-all active:scale-95">
      <span class="text-xs font-black">KO</span>
      <span class="text-[9px] font-bold" data-lang="í•œêµ­ì–´">í•œêµ­ì–´</span>
    </button>
    <button onclick="changeSystemLanguage('en')" id="lang-en" class="flex flex-col items-center gap-1 p-2 rounded-xl border-2 transition-all active:scale-95">
      <span class="text-xs font-black">EN</span>
      <span class="text-[9px] font-bold" data-lang="ì˜ì–´">ì˜ì–´</span>
    </button>
    <button onclick="changeSystemLanguage('zh')" id="lang-zh" class="flex flex-col items-center gap-1 p-2 rounded-xl border-2 transition-all active:scale-95">
      <span class="text-xs font-black">ZH</span>
      <span class="text-[9px] font-bold" data-lang="ì¤‘êµ­ì–´">ì¤‘êµ­ì–´</span>
    </button>
    <button onclick="changeSystemLanguage('ru')" id="lang-ru" class="flex flex-col items-center gap-1 p-2 rounded-xl border-2 transition-all active:scale-95">
      <span class="text-xs font-black">RU</span>
      <span class="text-[9px] font-bold" data-lang="ëŸ¬ì‹œì•„ì–´">ëŸ¬ì‹œì•„ì–´</span>
    </button>
    <button onclick="changeSystemLanguage('ja')" id="lang-ja" class="flex flex-col items-center gap-1 p-2 rounded-xl border-2 transition-all active:scale-95">
      <span class="text-xs font-black">JA</span>
      <span class="text-[9px] font-bold" data-lang="ì¼ë³¸ì–´">ì¼ë³¸ì–´</span>
    </button>
  </div>

  <p class="mt-3 text-[10px] text-slate-400 text-center leading-tight" 
   data-lang="ì–¸ì–´ ë³€ê²½ ì‹œ ì‹¤ì‹œê°„ ë°˜ì˜ë©ë‹ˆë‹¤.">
   ì–¸ì–´ ë³€ê²½ ì‹œ ì‹¤ì‹œê°„ ë°˜ì˜ë©ë‹ˆë‹¤.
</p>
</div>

<div id="adminGeneralSettingArea" class="bg-white p-5 rounded-[1.5rem] shadow-sm border border-slate-200/60 admin-item-fade mt-4">
  <div class="flex items-center gap-2 text-indigo-600 mb-4 px-1">
    <i class="fa-solid fa-sliders text-lg"></i>
    <span class="text-sm font-black" data-lang="ê¸°ë³¸ ì •ë³´ ì„¤ì •">ê¸°ë³¸ ì •ë³´ ì„¤ì •</span>
  </div>

  <div class="space-y-4">
    <div>
      <label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1" data-lang="í”„ë¡œê·¸ë¨ ì´ë¦„">í”„ë¡œê·¸ë¨ ì´ë¦„</label>
      <input type="text" id="adminProgramNameInput" 
             class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm font-bold text-slate-700 transition-all"
             data-lang="í”„ë¡œê·¸ë¨ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" placeholder="í”„ë¡œê·¸ë¨ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
    </div>

    <div>
      <label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1" data-lang="íšŒì¤‘ ëª…ì¹­">íšŒì¤‘ ëª…ì¹­</label>
      <input type="text" id="adminCongNameInput" 
             class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm font-bold text-slate-700 transition-all"
             data-lang="íšŒì¤‘ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" placeholder="íšŒì¤‘ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
    </div>

    <div>
      <label class="block text-[10px] font-bold text-slate-400 mb-1 ml-1" data-lang="ê´€ë¦¬ì ì ‘ì† ë¹„ë°€ë²ˆí˜¸">ê´€ë¦¬ì ì ‘ì† ë¹„ë°€ë²ˆí˜¸</label>
      <div class="relative">
        <input type="password" id="adminNewPwInput" 
               class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm font-mono tracking-widest font-bold text-slate-700 transition-all"
               placeholder="â€¢â€¢â€¢â€¢">
        <button onclick="toggleAdminPwVisibility()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-indigo-600 p-1">
          <i id="adminPwEyeIcon" class="fa-solid fa-eye-slash"></i>
        </button>
      </div>
    </div>

    <button onclick="saveGeneralSettings()" id="btnSaveGeneral"
            class="w-full mt-2 bg-slate-800 hover:bg-slate-900 text-white text-xs font-bold py-3 rounded-xl shadow-md transition-all active:scale-95 flex items-center justify-center gap-2">
      <i class="fa-solid fa-floppy-disk"></i>
      <span data-lang="ê¸°ë³¸ ì •ë³´ ì €ì¥">ê¸°ë³¸ ì •ë³´ ì €ì¥</span>
    </button>
  </div>
</div>

<div id="adminSyncSettingArea" class="bg-white p-5 rounded-[1.5rem] shadow-sm border border-slate-200/60 admin-item-fade mt-4">
  
  <div class="flex items-center justify-between mb-4 px-1">
    <div class="flex items-center gap-2 text-indigo-600">
      <i class="fa-solid fa-bolt-lightning"></i>
      <span class="text-sm font-black" data-lang="ì‹¤ì‹œê°„ ë™ê¸°í™” ê´€ë¦¬">ì‹¤ì‹œê°„ ë™ê¸°í™” ê´€ë¦¬</span>
    </div>
    
    <div class="flex bg-slate-100 p-1 rounded-lg border border-slate-200">
      <button onclick="setSyncMode('N')" id="modeBtnGeneral" class="px-3 py-1 text-[10px] font-black rounded-md transition-all" data-lang="ì¼ë°˜">ì¼ë°˜</button>
      <button onclick="setSyncMode('Y')" id="modeBtnHybrid" class="px-3 py-1 text-[10px] font-black rounded-md transition-all" data-lang="í•˜ì´ë¸Œë¦¬ë“œ">í•˜ì´ë¸Œë¦¬ë“œ</button>
    </div>
  </div>

  <div class="mb-5 px-1 space-y-4">
    <div class="group">
      <div class="flex justify-between items-center mb-1.5">
        <div class="flex items-center gap-1.5">
          <i class="fa-solid fa-users text-[10px] text-indigo-400"></i>
          <span class="text-[10px] font-bold text-slate-500" data-lang="ì‚¬ìš©ì ì ‘ì† ë°€ë„">ì‚¬ìš©ì ì ‘ì† ë°€ë„</span>
        </div>
        <span id="userLoadStatus" class="text-[10px] font-black"></span>
      </div>
      <div class="w-full h-1.5 bg-slate-100 rounded-full overflow-hidden shadow-inner flex">
        <div id="userGaugeBar" class="h-full transition-all duration-700" style="width: 0%"></div>
      </div>
    </div>

    <div class="group">
      <div class="flex justify-between items-center mb-1.5">
        <div class="flex items-center gap-1.5">
          <i class="fa-solid fa-bolt text-[10px] text-blue-400"></i>
          <span class="text-[10px] font-bold text-slate-500" data-lang="ë°ì´í„° ì²˜ë¦¬ ë¶€í•˜">ë°ì´í„° ì²˜ë¦¬ ë¶€í•˜ (Write)</span>
        </div>
        <span id="actionLoadStatus" class="text-[10px] font-black"></span>
      </div>
      <div class="w-full h-1.5 bg-slate-100 rounded-full overflow-hidden shadow-inner flex">
        <div id="actionGaugeBar" class="h-full transition-all duration-700" style="width: 0%"></div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-2 gap-3 mb-4">
    <div class="relative">
      <label class="block text-[9px] font-bold text-slate-400 mb-1 ml-1" data-lang="ë™ê¸°í™” ì£¼ê¸°(ë¶„)">ë™ê¸°í™” ì£¼ê¸°(ë¶„)</label>
      <input type="number" id="inputSyncMin" step="0.1" 
             class="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
      <span id="hybridBadgeSync" class="hidden absolute right-2 bottom-2.5 text-[8px] bg-indigo-500 text-white px-1.5 rounded-md font-black">AUTO</span>
    </div>
    <div class="relative">
      <label class="block text-[9px] font-bold text-slate-400 mb-1 ml-1" data-lang="ì ‘ì† í™•ì¸(ë¶„)">ì ‘ì† í™•ì¸(ë¶„)</label>
      <input type="number" id="inputAliveMin" step="0.5" 
             class="w-full px-3 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
      <span id="hybridBadgeAlive" class="hidden absolute right-2 bottom-2.5 text-[8px] bg-indigo-500 text-white px-1.5 rounded-md font-black">AUTO</span>
    </div>
  </div>

  <button onclick="saveSyncSettings()" id="btnSaveSync" 
        class="w-full bg-slate-800 hover:bg-slate-900 text-white text-xs font-bold py-3.5 rounded-xl active:scale-95 transition-all flex items-center justify-center gap-2 shadow-lg">
    <i class="fa-solid fa-cloud-arrow-up"></i>
    <span data-lang="ì„¤ì •ê°’ ì ìš©">ì„¤ì •ê°’ ì ìš©</span>
  </button>
  
  <p id="hybridGuideText" class="hidden mt-3 text-[10px] text-indigo-500 font-bold text-center" data-lang="í•˜ì´ë¸Œë¦¬ë“œ: ì„œë²„ ë¶€í•˜ì— ë”°ë¥¸ ìµœì ê°’ì´ ìë™ ì œì•ˆë©ë‹ˆë‹¤.">
    <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> í•˜ì´ë¸Œë¦¬ë“œ: ì„œë²„ ë¶€í•˜ì— ë”°ë¥¸ ìµœì ê°’ì´ ìë™ ì œì•ˆë©ë‹ˆë‹¤.
  </p>
</div>


<div id="adminBellSettingArea" class="bg-white p-5 rounded-[1.5rem] shadow-sm border border-slate-200/60 admin-item-fade mt-4">
  <div class="flex items-center justify-between mb-4 px-1">
    <div class="flex items-center gap-2 text-indigo-600">
      <i class="fa-solid fa-hand-pointer"></i>
      <span class="text-sm font-black" data-lang="ì‚¬ìš©ì ì„¤ì •">ì‚¬ìš©ì ì„¤ì •</span>
    </div>
  </div>
  
  <div class="space-y-3">
    <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100">
      <div class="flex flex-col">
        <span class="text-xs font-black text-slate-700" data-lang="ë²¨ ëˆ„ë¥´ê¸° í‘œì‹œ">ë²¨ ëˆ„ë¥´ê¸° í‘œì‹œ</span>
        <span class="text-[10px] text-slate-400 font-bold" data-lang="í™œì„±í™” ì‹œ êµ¬ì—­ ì¹´ë“œì— ë²¨ ì•„ì´ì½˜ ë…¸ì¶œ">í™œì„±í™” ì‹œ êµ¬ì—­ ì¹´ë“œì— ë²¨ ì•„ì´ì½˜ ë…¸ì¶œ</span>
      </div>
      <button onclick="toggleBellOptionUI()" id="btnBellOption" class="px-4 py-2 rounded-xl text-[11px] font-black transition-all shadow-sm border active:scale-95"></button>
    </div>

    <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100">
      <div class="flex flex-col">
        <span class="text-xs font-black text-slate-700" data-lang="ì—¬ê¸°ê¹Œì§€ í‘œì‹œ">ì—¬ê¸°ê¹Œì§€ í‘œì‹œ</span>
        <span class="text-[10px] text-slate-400 font-bold" data-lang="í™œì„±í™” ì‹œ êµ¬ì—­ ì¹´ë“œì— ê¹ƒë°œ ì•„ì´ì½˜ ë…¸ì¶œ">í™œì„±í™” ì‹œ êµ¬ì—­ ì¹´ë“œì— ê¹ƒë°œ ì•„ì´ì½˜ ë…¸ì¶œ</span>
      </div>
      <button onclick="toggleMarkOptionUI()" id="btnMarkOption" class="px-4 py-2 rounded-xl text-[11px] font-black transition-all shadow-sm border active:scale-95"></button>
    </div>

    <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100">
      <div class="flex flex-col">
        <span class="text-xs font-black text-slate-700" data-lang="ì„±êµ¬ í‘œì‹œ">ì„±êµ¬ í‘œì‹œ</span>
        <span class="text-[10px] text-slate-400 font-bold" data-lang="ë¡œê·¸ì¸ í™”ë©´ì— ì„±êµ¬ í‘œì‹œ">ë¡œê·¸ì¸ í™”ë©´ì— ì„±êµ¬ í‘œì‹œ</span>
      </div>
      <button onclick="toggleBibleOptionUI()" id="btnBibleOption" class="px-4 py-2 rounded-xl text-[11px] font-black transition-all shadow-sm border active:scale-95"></button>
    </div>
  </div>
</div>

    <div class="bg-white p-5 rounded-[1.5rem] shadow-sm border border-slate-200/60">
  <div class="flex items-center justify-between mb-3 px-1">
    <div class="flex items-center gap-2 text-indigo-600">
      <i class="fa-solid fa-bullhorn"></i>
      <span class="text-sm font-black" data-lang="ê³µì§€ì‚¬í•­ ê´€ë¦¬">ê³µì§€ì‚¬í•­ ê´€ë¦¬</span>
    </div>
    <button onclick="clearNoticeInput()" class="text-xs font-bold text-slate-400 hover:text-red-500 transition-colors">
      <i class="fa-solid fa-eraser"></i> <span data-lang="ë‚´ìš© ì§€ìš°ê¸°">ë‚´ìš© ì§€ìš°ê¸°</span>
    </button>
  </div>
  
    <textarea id="adminNoticeInput" rows="4" 
      data-lang="ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."
      class="w-full p-4 text-sm border border-slate-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-slate-50 resize-none transition-all placeholder:text-slate-300 font-medium leading-relaxed"
      placeholder="ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
    
<button onclick="saveAdminNotice()" id="btnSaveNotice"
  class="w-full mt-3 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-3.5 rounded-xl shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2">
  <i class="fa-solid fa-cloud-arrow-up"></i>
  <span data-lang="ê³µì§€ì‚¬í•­ ì—…ë°ì´íŠ¸">ê³µì§€ì‚¬í•­ ì—…ë°ì´íŠ¸</span>
</button>
</div>

<div class="bg-white p-5 rounded-[1.5rem] shadow-sm border border-slate-200/60">
  <div class="flex items-center justify-between mb-4 px-1">
    <div class="flex items-center gap-2 text-indigo-600">
      <i class="fa-solid fa-chart-pie"></i>
      <h4 class="text-sm font-black" data-lang="êµ¬ì—­ í˜„í™©íŒ">êµ¬ì—­ í˜„í™©íŒ</h4>
    </div>
    <div class="flex items-center gap-1.5 bg-indigo-50 px-3 py-1 rounded-full">
      <span class="text-[10px] font-bold text-indigo-400" data-lang="ì§„í–‰ë¥ ">ì§„í–‰ë¥ </span>
      <span id="stat-total-percent" class="text-xs font-black text-indigo-600">0%</span>
    </div>
  </div>
  
  <div class="mb-5 bg-slate-100 p-1.5 rounded-full overflow-hidden shadow-inner flex">
    <div id="bar-complete" class="h-3 rounded-full bg-emerald-500 transition-all duration-1000 ease-out" style="width: 0%"></div>
    <div id="bar-active" class="h-3 rounded-r-full bg-indigo-500 transition-all duration-1000 ease-out border-l border-white/20" style="width: 0%"></div>
  </div>

  <div class="grid grid-cols-2 gap-3">
    <div class="bg-slate-50 px-4 py-3 rounded-2xl border border-slate-100 flex flex-col">
      <span class="text-[10px] text-slate-400 font-bold uppercase mb-1" data-lang="ì „ì²´ êµ¬ì—­">ì „ì²´ êµ¬ì—­</span>
      <span class="text-xl font-black text-slate-700" id="stat-total">-</span>
    </div>

    <div class="bg-white px-4 py-3 rounded-2xl border border-slate-200 flex flex-col">
      <span class="text-[10px] text-slate-400 font-bold uppercase mb-1" data-lang="ë¯¸ë´‰ì‚¬">ë¯¸ë´‰ì‚¬</span>
      <span class="text-xl font-black text-slate-400" id="stat-clean">-</span>
    </div>

    <div class="bg-indigo-50 px-4 py-3 rounded-2xl border border-indigo-100 flex flex-col">
      <span class="text-[10px] text-indigo-500 font-bold uppercase mb-1" data-lang="ì§„í–‰ ì¤‘">ì§„í–‰ ì¤‘</span>
      <span class="text-xl font-black text-indigo-600" id="stat-active">-</span>
    </div>

    <div class="bg-emerald-50 px-4 py-3 rounded-2xl border border-emerald-100 flex flex-col">
      <span class="text-[10px] text-emerald-500 font-bold uppercase mb-1" data-lang="ì™„ë£Œ">ì™„ë£Œ</span>
      <span class="text-xl font-black text-emerald-600" id="stat-complete">-</span>
    </div>
  </div>
</div>

    <div class="grid grid-cols-1 gap-3">
  <button onclick="openPublisherManager()" class="bg-white hover:bg-slate-50 text-indigo-600 py-4 px-5 rounded-[1.2rem] shadow-sm border border-indigo-100/50 transition-all flex items-center gap-4 active:scale-95 group">
    <div class="w-10 h-10 rounded-full bg-violet-50 flex items-center justify-center group-hover:bg-violet-100 transition-colors">
      <i class="fa-solid fa-user-gear text-violet-500"></i>
    </div>
    <div class="flex-1 text-left">
      <div class="text-sm font-bold text-slate-700" data-lang="â‘  ì „ë„ì¸ ëª…ë‹¨ ê´€ë¦¬">â‘  ì „ë„ì¸ ëª…ë‹¨ ê´€ë¦¬</div>
      <div class="text-[10px] text-slate-400" data-lang="ì „ë„ì¸ ëª…ë‹¨ì„ ìˆ˜ì •í•˜ì˜€ë‹¤ë©´ â‘¡ë²ˆì„ ì‹¤í–‰í•˜ì„¸ìš”.">ì „ë„ì¸ ëª…ë‹¨ì„ ìˆ˜ì •í•˜ì˜€ë‹¤ë©´ â‘¡ë²ˆì„ ì‹¤í–‰í•˜ì„¸ìš”.</div>
    </div>
    <i class="fa-solid fa-chevron-right text-slate-300"></i>
  </button>

  <button onclick="runAdminSync('publishers')" class="bg-white hover:bg-slate-50 text-indigo-600 py-4 px-5 rounded-[1.2rem] shadow-sm border border-indigo-100/50 transition-all flex items-center gap-4 active:scale-95 group">
    <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center group-hover:bg-indigo-100 transition-colors">
      <i class="fa-solid fa-users text-indigo-500"></i>
    </div>
    <div class="flex-1 text-left">
      <div class="text-sm font-bold text-slate-700" data-lang="â‘¡ ì „ë„ì¸ ëª©ë¡ ë™ê¸°í™”">â‘¡ ì „ë„ì¸ ëª©ë¡ ë™ê¸°í™”</div>
      <div class="text-[10px] text-slate-400" data-lang="ì¶”ê°€í•œ ëª…ë‹¨ì„ ì¸ì‹ì‹œí‚µë‹ˆë‹¤.">ì¶”ê°€í•œ ëª…ë‹¨ì„ ì¸ì‹ì‹œí‚µë‹ˆë‹¤.</div>
    </div>
    <i class="fa-solid fa-chevron-right text-slate-300"></i>
  </button>

  <button onclick="runAdminSync('territories')" class="bg-white hover:bg-slate-50 text-indigo-600 py-4 px-5 rounded-[1.2rem] shadow-sm border border-indigo-100/50 transition-all flex items-center gap-4 active:scale-95 group">
    <div class="w-10 h-10 rounded-full bg-amber-50 flex items-center justify-center group-hover:bg-amber-100 transition-colors">
      <i class="fa-solid fa-arrows-rotate text-amber-500"></i>
    </div>
    <div class="flex-1 text-left">
      <div class="text-sm font-bold text-slate-700" data-lang="ì „ì²´ êµ¬ì—­ ëª©ë¡ ë™ê¸°í™”">ì „ì²´ êµ¬ì—­ ëª©ë¡ ë™ê¸°í™”</div>
      <div class="text-[10px] text-slate-400" data-lang="êµ¬ì—­ ì¹´ë“œ ë³€ê²½ ì‹œ ì‹¤í–‰í•˜ì„¸ìš”.">êµ¬ì—­ ì¹´ë“œ ë³€ê²½ ì‹œ ì‹¤í–‰í•˜ì„¸ìš”.</div>
    </div>
    <i class="fa-solid fa-chevron-right text-slate-300"></i>
  </button>

  <button onclick="runVisitReport()" class="bg-white hover:bg-slate-50 text-red-600 py-4 px-5 rounded-[1.2rem] shadow-sm border border-red-100/50 transition-all flex items-center gap-4 active:scale-95 group">
    <div class="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center group-hover:bg-red-100 transition-colors">
      <i class="fa-solid fa-file-pdf text-red-500"></i>
    </div>
    <div class="flex-1 text-left">
      <div class="text-sm font-bold text-slate-700" data-lang="ìˆœíšŒë°©ë¬¸ ìë£Œ">ìˆœíšŒë°©ë¬¸ ìë£Œ</div>
      <div class="text-[10px] text-slate-400" data-lang="PDF íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.">PDF íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.</div>
    </div>
    <i class="fa-solid fa-chevron-right text-slate-300"></i>
  </button>

  <button onclick="runClearCache()" class="bg-white hover:bg-slate-50 text-rose-600 py-4 px-5 rounded-[1.2rem] shadow-sm border border-rose-100/50 transition-all flex items-center gap-4 active:scale-95 group">
    <div class="w-10 h-10 rounded-full bg-rose-50 flex items-center justify-center group-hover:bg-rose-100 transition-colors">
      <i class="fa-solid fa-rotate text-rose-500"></i>
    </div>
    <div class="flex-1 text-left">
      <div class="text-sm font-bold text-slate-700" data-lang="ëª¨ë“  ìºì‹œ ì´ˆê¸°í™”">ëª¨ë“  ìºì‹œ ì´ˆê¸°í™”</div>
      <div class="text-[10px] text-slate-400" data-lang="ë°ì´í„° ì˜¤ë¥˜ ì‹œ ë³µêµ¬í•©ë‹ˆë‹¤.">ë°ì´í„° ì˜¤ë¥˜ ì‹œ ë³µêµ¬í•©ë‹ˆë‹¤.</div>
    </div>
    <i class="fa-solid fa-chevron-right text-slate-300"></i>
  </button>

</div>
    
    <div class="h-10"></div> </div>
</div>

<div id="loginView" class="absolute inset-0 z-50 bg-slate-200 flex items-center justify-center p-4 transition-transform duration-300">
  
  <div class="bg-white rounded-3xl shadow-xl w-full max-w-sm p-8 flex flex-col items-center text-center my-auto">
    
    <div id="bibleSection" class="w-full mb-6 <?= serverBibleData.show ? 'animate-modalFadeIn' : 'hidden' ?>">
      <div class="flex flex-col items-center">
        <div class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-indigo-50 text-indigo-600 border border-indigo-100 mb-2">
          <i class="fa-solid fa-book-open text-[10px]"></i>
          <span id="bibleTitle" class="text-xs font-black tracking-tight"><?= serverBibleData.title ?></span>
        </div>
        <p id="bibleContent" class="text-sm text-slate-600 font-bold leading-relaxed break-keep text-center px-4">
          <?= serverBibleData.content ?>
        </p>
      </div>
    </div>

    <div class="w-24 h-24 mb-6 rounded-3xl overflow-hidden shadow-lg border border-slate-100 bg-white">
      <img id="loginLogoImg" class="w-full h-full object-cover">
    </div>

    <p class="text-sm text-slate-500 mb-8">- <?= congName ?> -</p>
    
    <div class="w-full space-y-4">
      <input type="text" id="nameInput" data-lang="ì´ë¦„ ì…ë ¥" class="w-full text-center py-3 border-b-2 border-slate-200 focus:border-indigo-500 outline-none transition-colors" placeholder="ì´ë¦„ ì…ë ¥">
      
      <input 
        type="number" 
        inputmode="numeric" 
        pattern="[0-9]*" 
        id="numberInput" 
        data-lang="êµ¬ì—­ ë²ˆí˜¸"
        onfocus="warmUpServer()"
        oninput="handleInputPrefetch(this.value)" 
        class="w-full text-center py-3 border-b-2 border-slate-200 focus:border-indigo-500 outline-none transition-colors" 
        placeholder="êµ¬ì—­ ë²ˆí˜¸"
      >

      <button type="button" onclick="handleStart()" id="loginBtn" 
        class="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-xl mt-4 active:bg-indigo-700 transition-all hover:bg-indigo-700 relative z-10"
        style="animation: pulseGlow 2s infinite ease-out;">
        <span data-lang="ì‹œì‘í•˜ê¸°" class="relative z-20">ì‹œì‘í•˜ê¸°</span>
      </button>

      <div class="mt-8 flex flex-col items-center">
        <button type="button" id="adminToggleBtn" class="flex items-center gap-2 text-slate-400 hover:text-indigo-600 transition-all text-sm group">
          <span class="p-2 rounded-full group-hover:bg-indigo-50 transition-all"><i class="fa-solid fa-gear"></i></span>
          <span data-lang="ì„¤ì • ê´€ë¦¬">ì„¤ì • ê´€ë¦¬</span>
        </button>
      </div>
    </div>

    <div id="recentArea" class="hidden pt-6 cursor-pointer group w-full" onclick="loadRecentAndStart()">
      <p data-lang="ìµœê·¼ ì‘ì—…í•œ êµ¬ì—­" class="text-xs text-slate-400 mb-1">ìµœê·¼ ì‘ì—…í•œ êµ¬ì—­</p>
      <div class="inline-flex items-center gap-2 bg-slate-50 border border-slate-200 px-4 py-2 rounded-full text-slate-600 group-hover:bg-indigo-50 group-hover:text-indigo-600 group-hover:border-indigo-200 transition-all">
        <i class="fa-solid fa-clock-rotate-left text-sm"></i>
        <span class="font-bold">
          <span id="recentNumDisplay"></span>
          <span data-lang="ë²ˆ">ë²ˆ</span>
        </span>
        <span class="text-xs text-slate-400 group-hover:text-indigo-400">
          <span data-lang="ë°”ë¡œê°€ê¸°">ë°”ë¡œê°€ê¸°</span> â†’
        </span>
      </div>
    </div>
  </div>
</div>


    <div id="mainView" class="hidden absolute inset-0 z-10 flex flex-col bg-[#F2F2F7]">
    
    <div class="ios-header px-4 pb-3 z-30 relative shrink-0">
        <div class="flex justify-between items-center w-full min-h-[50px]">
            <div class="flex items-center gap-2.5">
                <img id="mainLogoImg" class="w-7 h-7 rounded-[7px] bg-white p-0.5 shadow-sm hidden object-cover">
                <span class="text-2xl font-black text-black tracking-tight" id="headerTarget"></span>
                <span id="statusBadge" class="uppercase">í˜¸ë³„</span>
                <button id="btnLock" onclick="openAdminAuth()" class="ios-round-btn w-9 h-9 flex items-center justify-center">
                    <i id="iconLock" class="fa-solid fa-lock text-[16px]"></i>
                </button>
                <button onclick="handleSOSClick()" class="ios-sos-solid w-9 h-9 rounded-xl flex items-center justify-center active:scale-90 transition-all">
                    <span class="font-black text-[10px]">SOS</span>
                </button>
            </div>
            <div class="flex-none">
                <button onclick="goBack()" class="ios-back-btn flex items-center">
                    <span data-lang="ì¢…ë£Œ">ì¢…ë£Œ</span>
                    <i class="fa-solid fa-chevron-right ml-1 text-sm opacity-70"></i>
                </button>
            </div>
        </div>

        <div id="activeUsersArea" class="hidden mt-0.5 flex justify-start transition-all">
            <div class="flex items-center gap-1.5 px-1 bg-white/40 rounded-full py-0.5 border border-black/5">
                <span class="w-1.5 h-1.5 bg-[#34C759] rounded-full shadow-[0_0_4px_rgba(52,199,89,0.5)]"></span>
                <span id="activeUserList" class="active-user-text"></span>
            </div>
        </div>
    </div>

    <div id="stickyAddressPill" class="fixed left-1/2 -translate-x-1/2 flex flex-col items-center justify-center px-5 py-1.5 transition-all duration-400 opacity-0 -translate-y-4 pointer-events-none min-w-[150px] overflow-hidden">
      <div id="pillProgressBar" style="width: 0%;"></div>
      
      <span id="pillMainText" class="font-bold tracking-tight"></span>
      <div id="pillSubWrapper" class="flex items-center gap-1 font-medium">
          <i class="fa-solid fa-location-dot text-[9px]"></i>
          <span id="pillSubText" class="text-[10px]"></span>
      </div>
    </div>

    <div id="contentArea" class="flex-1 overflow-y-auto no-scrollbar scroll-smooth bg-[#F2F2F7]">

        <div id="imageWrapper" class="w-full bg-slate-100 border-b border-slate-300 hidden overflow-hidden relative" style="height: 300px;">
          <img id="headerInfoImage" class="w-full h-full object-contain origin-center transition-transform duration-75">
        </div>

        <div id="mapContainer" class="w-full h-64 bg-slate-200 relative shrink-0 hidden transition-all duration-300 border-b border-slate-300 group">
              <iframe id="googleMapFrame" class="w-full h-full" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
              <div class="absolute inset-x-0 bottom-3 z-10 flex justify-center pointer-events-none">
                <button onclick="openNativeMap()" class="pointer-events-auto bg-[#03C75A] hover:bg-[#02b351] text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg flex items-center gap-1.5 transition-transform active:scale-95 backdrop-blur-sm opacity-90 hover:opacity-100">
                  <i class="fa-solid fa-location-arrow"></i> ê¸¸ ì°¾ê¸° ì‹¤í–‰
                </button>
              </div>
            </div>
            <div id="listContainer" class="p-4 pb-32"></div>
        </div>
      </div>
    
    <div id="leaderView" class="hidden absolute inset-0 z-20 flex flex-col bg-slate-100">
      
      <div class="bg-slate-800 text-white px-4 sm:px-6 py-3 sm:py-4 shadow-lg flex justify-between items-center shrink-0 z-10">
  
  <div class="flex items-center gap-3 sm:gap-4">
    <img id="leaderLogoImg" class="w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-white p-0.5 hidden object-cover shadow-md">
    
    <div>
   <h1 class="text-base sm:text-xl font-bold leading-tight">
  <span data-lang="ì¸ë„ì">ì¸ë„ì</span>
  <span class="hidden sm:inline" data-lang="ëŒ€ì‹œë³´ë“œ">ëŒ€ì‹œë³´ë“œ</span>
</h1>

<p class="text-[10px] sm:text-xs text-slate-400" id="leaderNameDisplay" data-lang="í™˜ì˜í•©ë‹ˆë‹¤">
  í™˜ì˜í•©ë‹ˆë‹¤
</p>
    </div>

    <div class="flex flex-col gap-0.5 sm:gap-1 text-[10px] sm:text-[11px] text-slate-300 ml-2 sm:ml-6 border-l border-slate-600 pl-3 sm:border-none sm:pl-0">
      
      <div class="flex items-center gap-1 cursor-pointer hover:text-red-200 transition-colors" onclick="openGlobalStatsDetail('BAN')">
        <span class="inline-flex w-2 h-2 sm:w-2.5 sm:h-2.5 rounded-full bg-red-500 shadow-sm"></span>
        <span class="flex items-center"><span data-lang="ë°©ë¬¸ê¸ˆì§€">ë°©ë¬¸ê¸ˆì§€</span><b id="headerStatBan" class="text-white ml-0.5 font-sans">0</b></span>
      </div>

      <div class="flex items-center gap-1 cursor-pointer hover:text-indigo-200 transition-colors" onclick="openGlobalStatsDetail('MEMO')">
        <span class="inline-flex w-2 h-2 sm:w-2.5 sm:h-2.5 rounded-full bg-indigo-500 shadow-sm"></span>
        <span class="flex items-center"><span data-lang="ë©”ëª¨">ë©”ëª¨</span><b id="headerStatMemo" class="text-white ml-0.5 font-sans">0</b></span>
      </div>

      <div class="flex items-center gap-1 cursor-pointer hover:text-emerald-200 transition-colors" onclick="openGlobalStatsDetail('COUNT')">
        <span class="inline-flex items-center justify-center w-2 h-2 sm:w-2.5 sm:h-2.5">
          <i class="fa-solid fa-rotate-right text-[9px] sm:text-[10px] text-red-400"></i>
        </span>
        <span class="tracking-tight text-[11px] sm:text-[11px] max-w-[140px] truncate">
          <b id="headerStatCount" class="text-white font-sans">0íšŒ/0íšŒ</b>
        </span>
      </div>

    </div>
  </div>

  <button onclick="handleLeaderLogout()" class="bg-slate-700 hover:bg-slate-600 px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg text-xs sm:text-sm font-bold transition-colors shadow-md whitespace-nowrap" data-lang="ë¡œê·¸ì•„ì›ƒ">
  ë¡œê·¸ì•„ì›ƒ
</button>
</div>

  <div class="bg-white border-b border-slate-200 px-2 pt-2 shadow-sm shrink-0 overflow-x-auto no-scrollbar">
    <div class="flex gap-2 min-w-max sm:min-w-0 sm:justify-center">
      
      <button onclick="switchLeaderTab('clean')" id="tabBtn-clean" class="flex-1 min-w-[80px] sm:max-w-[120px] pb-2 border-b-[3px] border-transparent text-slate-400 font-medium text-sm transition-all hover:text-slate-600">
        <div class="flex flex-col items-center gap-1">
          <i class="fa-regular fa-file text-lg"></i>
          <span class="text-xs"><span data-lang="ë¯¸ì‚¬ìš©">ë¯¸ì‚¬ìš©</span><span id="countClean" class="bg-slate-100 text-slate-500 px-1.5 rounded-full text-[10px] ml-0.5">0</span></span>
        </div>
      </button>

      <button onclick="switchLeaderTab('house')" id="tabBtn-house" class="flex-1 min-w-[80px] sm:max-w-[120px] pb-2 border-b-[3px] border-emerald-500 text-emerald-600 font-bold text-sm transition-all">
        <div class="flex flex-col items-center gap-1">
          <i class="fa-solid fa-door-open text-lg"></i>
          <span class="text-xs"><span data-lang="í˜¸ë³„">í˜¸ë³„</span><span id="countHouse" class="bg-emerald-100 text-emerald-600 px-1.5 rounded-full text-[10px] ml-0.5">0</span></span>
        </div>
      </button>

      <button onclick="switchLeaderTab('busy')" id="tabBtn-busy" class="flex-1 min-w-[80px] sm:max-w-[120px] pb-2 border-b-[3px] border-transparent text-slate-400 font-medium text-sm transition-all hover:text-amber-600">
        <div class="flex flex-col items-center gap-1">
          <i class="fa-solid fa-person-walking text-lg"></i>
          <span class="text-xs"><span data-lang="ë¶€ì¬">ë¶€ì¬</span><span id="countBusy" class="bg-amber-50 text-amber-600 px-1.5 rounded-full text-[10px] ml-0.5">0</span></span>
        </div>
      </button>

      <button onclick="switchLeaderTab('complete')" id="tabBtn-complete" class="flex-1 min-w-[80px] sm:max-w-[120px] pb-2 border-b-[3px] border-transparent text-slate-400 font-medium text-sm transition-all hover:text-zinc-600">
        <div class="flex flex-col items-center gap-1">
          <i class="fa-solid fa-check-double text-lg"></i>
          <span class="text-xs"><span data-lang="ì™„ë£Œ">ì™„ë£Œ</span><span id="countComplete" class="bg-zinc-100 text-zinc-500 px-1.5 rounded-full text-[10px] ml-0.5">0</span></span>
        </div>
      </button>
    </div>
  </div>

  <div class="flex-1 overflow-hidden relative bg-slate-50 p-3 sm:p-4">
    
    <div id="group-clean" class="hidden w-full h-full flex flex-col">
       <div class="flex justify-between items-center mb-3 px-1">
         <h2 class="text-slate-700 font-bold flex items-center gap-2"><i class="fa-regular fa-file"></i><span data-lang="ë¯¸ì‚¬ìš© ê·¸ë£¹">ë¯¸ì‚¬ìš© ê·¸ë£¹</span></h2>
          <select id="cleanFilterSelect" onchange="filterCleanList()" class="text-xs py-1.5 px-3 border border-slate-300 rounded-lg bg-white">
            <option value="all" data-lang="ì „ì²´ ë³´ê¸°">ì „ì²´ ë³´ê¸°</option>
              </select>
       </div>
       <div id="listClean" class="flex-1 overflow-y-auto no-scrollbar pb-20"></div>
    </div>

    <div id="group-house" class="w-full h-full flex flex-col">
       <div class="flex justify-between items-center mb-3 px-1">
          <h2 class="text-emerald-700 font-bold flex items-center gap-2"><i class="fa-solid fa-door-open"></i><span data-lang="í˜¸ë³„ ê·¸ë£¹">í˜¸ë³„ ê·¸ë£¹</span></h2>
          <select id="sortSelectHouse" onchange="sortAndRenderGroup('house', this.value)" class="text-xs py-1.5 px-3 border border-emerald-300 rounded-lg bg-white text-emerald-700 font-bold focus:ring-2 focus:ring-emerald-500">
            <option value="recent" data-lang="ìµœê·¼ìˆœ">ìµœê·¼ìˆœ</option>
            <option value="number" data-lang="ë²ˆí˜¸ìˆœ">ë²ˆí˜¸ìˆœ</option>
            <option value="oldest" data-lang="ì˜¤ë˜ëœìˆœ">ì˜¤ë˜ëœìˆœ</option>
            <option value="count" data-lang="íšŒì°¨ìˆœ">íšŒì°¨ìˆœ</option>
            <option value="ban" data-lang="ë°©ë¬¸ê¸ˆì§€ìˆœ">ë°©ë¬¸ê¸ˆì§€ìˆœ</option>
            <option value="memo" data-lang="ë©”ëª¨ìˆœ">ë©”ëª¨ìˆœ</option>
            <option value="bell" data-lang="ë²¨ ëˆ„ë¥´ê¸°ìˆœ">ë²¨ ëˆ„ë¥´ê¸°ìˆœ</option>
          </select>
       </div>
       <div id="listHouse" class="flex-1 overflow-y-auto no-scrollbar pb-20"></div>
    </div>

    <div id="group-busy" class="hidden w-full h-full flex flex-col">
       <div class="flex justify-between items-center mb-3 px-1">
          <h2 class="text-amber-700 font-bold flex items-center gap-2"><i class="fa-solid fa-person-walking"></i><span data-lang="ë¶€ì¬ ê·¸ë£¹">ë¶€ì¬ ê·¸ë£¹</span></h2>
          <select id="sortSelectBusy" onchange="sortAndRenderGroup('busy', this.value)" class="text-xs py-1.5 px-3 border border-amber-300 rounded-lg bg-white text-amber-700 font-bold focus:ring-2 focus:ring-amber-500">
            <option value="recent" data-lang="ìµœê·¼ìˆœ">ìµœê·¼ìˆœ</option>
            <option value="number" data-lang="ë²ˆí˜¸ìˆœ">ë²ˆí˜¸ìˆœ</option>
            <option value="oldest" data-lang="ì˜¤ë˜ëœìˆœ">ì˜¤ë˜ëœìˆœ</option>
            <option value="count" data-lang="íšŒì°¨ìˆœ">íšŒì°¨ìˆœ</option>
            <option value="ban" data-lang="ë°©ë¬¸ê¸ˆì§€ìˆœ">ë°©ë¬¸ê¸ˆì§€ìˆœ</option>
            <option value="memo" data-lang="ë©”ëª¨ìˆœ">ë©”ëª¨ìˆœ</option>
            <option value="bell" data-lang="ë²¨ ëˆ„ë¥´ê¸°ìˆœ">ë²¨ ëˆ„ë¥´ê¸°ìˆœ</option>
          </select>
       </div>
       <div id="listBusy" class="flex-1 overflow-y-auto no-scrollbar pb-20"></div>
    </div>

    <div id="group-complete" class="hidden w-full h-full flex flex-col">
       <div class="flex justify-between items-center mb-3 px-1">
        <h2 class="text-zinc-700 font-bold flex items-center gap-2"><i class="fa-solid fa-check-double"></i><span data-lang="ì™„ë£Œ ê·¸ë£¹">ì™„ë£Œ ê·¸ë£¹</span></h2>
        <span class="text-xs text-zinc-500 font-medium" data-lang="ìë™ ì •ë ¬ë¨">ìë™ ì •ë ¬ë¨</span>
       </div>
       <div id="listComplete" class="flex-1 overflow-y-auto no-scrollbar pb-20"></div>
    </div>

  </div>
</div>

    <div id="passwordModal" class="fixed inset-0 bg-transparent backdrop-blur-sm hidden flex items-center justify-center z-[80] p-4">
      <div class="bg-white rounded-2xl p-6 w-full max-w-xs shadow-2xl modal-animate text-center relative">
        <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600">
           <i class="fa-solid fa-lock text-xl"></i>
        </div>
          <h3 class="text-lg font-bold text-slate-800 mb-1" data-lang="ì¸ë„ì ë¡œê·¸ì¸">ì¸ë„ì ë¡œê·¸ì¸</h3>
          <p class="text-slate-500 text-xs mb-4" data-lang="ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.">ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
        
        <input 
            type="password" 
            inputmode="numeric" 
            pattern="[0-9]*"
            id="modalPasswordInput" 
            class="w-full text-center py-3 border border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-colors mb-6 text-lg tracking-widest" 
            placeholder="****"
            onkeyup="if(event.key === 'Enter') submitLeaderPassword()"
        >

        <div class="flex gap-2">
  <button onclick="closePasswordModal()" 
          class="flex-1 py-3 text-slate-500 font-medium hover:bg-slate-100 rounded-xl transition-colors" 
          data-lang="ì·¨ì†Œ">ì·¨ì†Œ</button>
  
  <button onclick="submitLeaderPassword()" 
          class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md" 
          data-lang="í™•ì¸">í™•ì¸</button>
</div>
      </div>
    </div>

    <div id="renameModal" class="fixed inset-0 bg-transparent backdrop-blur-sm hidden flex items-center justify-center z-[100] p-4">
      <div class="bg-white rounded-2xl p-6 w-full max-w-xs shadow-2xl modal-animate text-center relative">
        
        <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600">
          <i class="fa-solid fa-pen text-xl"></i>
        </div>
        
        <h3 class="text-lg font-bold text-slate-800 mb-2" data-lang="í˜¸ìˆ˜ ì´ë¦„ ë³€ê²½">í˜¸ìˆ˜ ì´ë¦„ ë³€ê²½</h3>
        <p class="text-slate-500 text-xs mb-6" data-lang="ë³€ê²½í•  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.">ë³€ê²½í•  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</p>

        <input 
          type="text" 
          id="renameInput" 
          class="w-full text-center py-3 border border-slate-200 rounded-xl focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-colors mb-6 text-lg" 
          placeholder="ì˜ˆ: 101í˜¸"
          autocomplete="off"
          onkeyup="if(event.key === 'Enter') confirmRename()"
        >
        <div class="flex gap-2">
        <button onclick="closeRenameModal()" class="flex-1 py-3 text-slate-500 font-medium hover:bg-slate-100 rounded-xl transition-colors" data-lang="ì·¨ì†Œ">ì·¨ì†Œ</button>
        <button onclick="confirmRename()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md" data-lang="ë³€ê²½">ë³€ê²½</button>
        </div>
      </div>
    </div>

    <div id="deleteConfirmModal" class="fixed inset-0 bg-transparent backdrop-blur-sm hidden flex items-center justify-center z-[90] p-4">
      <div class="bg-white rounded-2xl p-6 w-full max-w-xs shadow-2xl modal-animate text-center relative">
        <div class="w-12 h-12 bg-rose-100 rounded-full flex items-center justify-center mx-auto mb-4 text-rose-500">
          <i class="fa-solid fa-trash-can text-xl"></i>
        </div>
        <h3 class="text-lg font-bold text-slate-800 mb-2" data-lang="í–‰ì„ ì‚­ì œí•˜ê² ìŠµë‹ˆê¹Œ?">í–‰ì„ ì‚­ì œí•˜ê² ìŠµë‹ˆê¹Œ?</h3>
        <p class="text-slate-500 text-xs mb-6" data-lang="ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.">ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        <div class="flex gap-2">

        <button onclick="closeDeleteConfirmModal()" class="flex-1 py-3 text-slate-500 font-medium hover:bg-slate-100 rounded-xl transition-colors" data-lang="ì·¨ì†Œ">ì·¨ì†Œ</button>
        <button id="btnRealDelete" class="flex-1 bg-rose-500 hover:bg-rose-600 text-white font-bold py-3 rounded-xl transition-colors shadow-md" data-lang="ì‚­ì œ">ì‚­ì œ</button>

        </div>
      </div>
    </div>  


<div id="memoModal" class="fixed inset-0 z-[60] bg-transparent backdrop-blur-sm hidden flex items-center justify-center p-4">
  <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl transform transition-all scale-100">
    
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-bold flex items-center gap-2">
        <i class="fa-regular fa-note-sticky text-indigo-500"></i>
        <span data-lang="ë©”ëª¨ / íŠ¹ì´ì‚¬í•­">ë©”ëª¨ / íŠ¹ì´ì‚¬í•­</span>
      </h3>
      <button onclick="clearMemoInput()" class="text-xs font-bold text-slate-400 hover:text-red-500 transition-colors flex items-center gap-1">
        <i class="fa-solid fa-eraser"></i> <span data-lang="ë‚´ìš© ì§€ìš°ê¸°">ë‚´ìš© ì§€ìš°ê¸°</span>
      </button>
    </div>

    <div class="flex gap-2 mb-3">
      <button id="btnBan" onclick="toggleKeyword('ë°©ë¬¸ê¸ˆì§€')" class="flex-1 py-2 rounded-lg border border-slate-200 text-sm font-medium text-slate-600 hover:bg-slate-50 transition-all flex items-center justify-center gap-1">
        <i class="fa-solid fa-ban"></i><span data-lang="ë°©ë¬¸ê¸ˆì§€">ë°©ë¬¸ê¸ˆì§€</span>
      </button>
      <button id="btnPub" onclick="toggleKeyword('ì „ë„ì¸ ì§‘')" class="flex-1 py-2 rounded-lg border border-slate-200 text-sm font-medium text-slate-600 hover:bg-slate-50 transition-all flex items-center justify-center gap-1">
        <i class="fa-solid fa-user-tie"></i><span data-lang="ì „ë„ì¸">ì „ë„ì¸</span>
      </button>
    </div>

    <textarea 
      id="memoText" 
      class="w-full h-32 p-3 border border-slate-200 rounded-xl focus:outline-none focus:border-indigo-500 resize-none bg-slate-50 text-sm mb-4 transition-colors" 
      placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." 
      data-lang="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.">
    </textarea>

    <div class="flex gap-2">
      <div class="flex gap-2 w-full">
        <button onclick="closeMemoModal()" class="flex-1 py-3 text-slate-500 font-medium hover:bg-slate-100 rounded-xl transition-colors" data-lang="ì·¨ì†Œ">ì·¨ì†Œ</button>
        <button id="btnSaveMemo" onclick="saveMemo()" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-md active:bg-indigo-700 transition-colors" data-lang="ì €ì¥">ì €ì¥</button>
      </div>
    </div>
  </div>
</div>



    <div id="imageModal" class="fixed inset-0 z-[65] bg-transparent backdrop-blur-sm hidden flex items-center justify-center p-4"
         onclick="if(event.target.id==='imageModal'){ closeImageModal(); }">
      <div class="bg-slate-900/90 rounded-2xl w-full max-w-3xl max-height-[85vh] flex flex-col overflow-hidden modal-animate">
        <div class="flex items-center justify-between px-4 py-2 border-b border-slate-700 text-xs text-slate-200">
          <div class="flex items-center gap-2">
            <i class="fa-regular fa-image text-sm opacity-80"></i>
            <span>êµ¬ì—­ ì§€ë„ ì´ë¯¸ì§€</span>
          </div>
          <button type="button" 
                  class="px-3 py-1 rounded-full bg-slate-700 hover:bg-slate-600 text-[11px] font-medium"
                  onclick="closeImageModal()">ë‹«ê¸°</button>
        </div>
        <div class="flex-1 bg-black flex items-center justify-center">
          <img id="zoneImage" src="" alt="êµ¬ì—­ ì§€ë„" 
               class="max-w-full max-h-[80vh] object-contain">
        </div>
      </div>
    </div>

    <div id="completionConfirmModal" class="fixed inset-0 bg-transparent backdrop-blur-sm hidden flex items-center justify-center z-[75] p-4">
      <div class="bg-white rounded-2xl p-6 w-full max-w-xs shadow-2xl modal-animate text-center relative">
        <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-3 text-indigo-500">
            <i class="fa-solid fa-clipboard-check text-xl"></i>
        </div>
        <div class="mb-4">
          <span id="modalStatusBadge" data-lang="í˜¸ë³„" class="inline-block rounded-full shadow-md font-extrabold text-base px-5 py-1.5 tracking-tight transition-colors">í˜¸ë³„</span>
        </div>
          <h3 class="text-lg font-bold text-slate-800 mb-2" data-lang="êµ¬ì—­ ë°©ë¬¸ì„ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆê¹Œ?">êµ¬ì—­ ë°©ë¬¸ì„ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆê¹Œ?</h3>
          <p class="text-slate-600 mb-6 text-sm" data-lang="ì™„ë£Œ ì—¬ë¶€ì— ë”°ë¼ êµ¬ì—­ ìƒíƒœê°€ ê¸°ë¡ë©ë‹ˆë‹¤.">ì™„ë£Œ ì—¬ë¶€ì— ë”°ë¼ êµ¬ì—­ ìƒíƒœê°€ ê¸°ë¡ë©ë‹ˆë‹¤.</p>
        
        <div class="flex gap-2">
          <button id="btnCompNo" onclick="handleCompletion('N')" class="flex-1 py-3 text-red-500 font-medium hover:bg-red-50 rounded-xl transition-colors flex flex-col items-center justify-center leading-tight">
            ì•„ë‹ˆì˜¤
          </button>
          <button id="btnCompYes" onclick="handleCompletion('Y')" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md flex flex-col items-center justify-center leading-tight">
            ì˜ˆ
          </button>
        </div>

        <button onclick="closeCompletionConfirmModal()" class="mt-3 w-full py-2.5 text-slate-400 text-xs font-bold rounded-xl hover:bg-slate-50 transition-colors" data-lang="ì·¨ì†Œ">
          ì·¨ì†Œ
        </button>
        </div>
    </div>

    <div id="customConfirmModal" class="fixed inset-0 bg-transparent backdrop-blur-sm hidden flex items-center justify-center z-[70] p-4">
  <div class="bg-white rounded-2xl p-6 w-full max-w-xs shadow-2xl modal-animate text-center relative">
    <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-500">
      <i class="fa-solid fa-arrow-right-from-bracket text-xl"></i>
    </div>
    
    <h3 class="text-lg font-bold text-slate-800 mb-8" data-lang="í˜„ì¬ êµ¬ì—­ì¹´ë“œì—ì„œ ë‚˜ê°ˆê¹Œìš”?">
      í˜„ì¬ êµ¬ì—­ì¹´ë“œì—ì„œ ë‚˜ê°ˆê¹Œìš”?
    </h3>
    
    <div class="flex gap-2">
      <button onclick="closeConfirmModal()" 
              data-lang="ì·¨ì†Œ"
              class="flex-1 py-3 text-slate-500 font-medium hover:bg-slate-100 rounded-xl transition-colors">
        ì·¨ì†Œ
      </button>
      
      <button onclick="handleLogoutConfirm()" 
              data-lang="í™•ì¸"
              class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md">
        í™•ì¸
      </button>
    </div>
  </div>
</div>

<div id="customAlertModal" class="fixed inset-0 bg-transparent backdrop-blur-sm hidden flex items-center justify-center z-[3000] p-4">
  <div class="bg-white rounded-2xl p-6 w-full max-w-xs shadow-2xl modal-animate text-center relative">
    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500">
      <i class="fas fa-exclamation-triangle text-xl"></i>
    </div>
    
    <h3 class="text-lg font-bold text-slate-800 mb-2" data-lang="ì•Œë¦¼">ì•Œë¦¼</h3>
    
    <p class="text-slate-600 mb-6 text-sm break-keep" id="alertMessage">ë©”ì‹œì§€ ë‚´ìš©</p>
    
    <button id="alertOkBtn" 
            onclick="closeAlertModal()" 
            data-lang="í™•ì¸"
            class="w-full bg-slate-800 hover:bg-slate-900 text-white font-medium py-3 rounded-xl transition-colors shadow-md">
      í™•ì¸
    </button>
  </div>
</div>

    <div id="toastContainer" class="fixed bottom-12 left-1/2 transform -translate-x-1/2 z-[1000000] transition-all duration-300 opacity-0 translate-y-10 pointer-events-none flex flex-col items-center gap-2 w-full max-w-sm px-4">
      <div class="bg-slate-800/95 backdrop-blur-sm text-white px-6 py-3.5 rounded-full shadow-2xl flex items-center gap-3 justify-center min-w-[200px] border border-white/10">
          <i id="toastIcon" class="fa-solid fa-check-circle text-emerald-400 text-lg"></i>
          <span id="toastMessage" data-lang="ì•Œë¦¼ ë‚´ìš©" class="font-bold text-sm tracking-tight text-center whitespace-pre-line">ì•Œë¦¼ ë‚´ìš©</span>
      </div>
    </div>

    <div id="editingOverlay" class="fixed inset-0 z-[85] bg-slate-900/80 backdrop-blur-sm hidden flex flex-col items-center justify-center p-6 text-center transition-opacity duration-300">
      <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-xs w-full transform scale-100 border border-slate-200">
        
        <div class="w-20 h-20 bg-amber-50 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
          <i class="fa-solid fa-user-lock text-4xl text-amber-500 animate-pulse"></i>
        </div>
        
        <h3 class="text-xl font-extrabold text-slate-800 mb-2" data-lang="í¸ì§‘ ì¤‘ì…ë‹ˆë‹¤">í¸ì§‘ ì¤‘ì…ë‹ˆë‹¤</h3>
        <p class="text-slate-500 text-sm leading-relaxed mb-6 break-keep" id="overlayMessage" data-lang="ì¸ë„ìê°€ êµ¬ì—­ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ê³  ìˆìŠµë‹ˆë‹¤.">
          ì¸ë„ìê°€ êµ¬ì—­ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ê³  ìˆìŠµë‹ˆë‹¤.
        </p>
        <button onclick="closeLockedOverlay()" 
          data-lang="í™•ì¸" 
          class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3.5 rounded-xl shadow-lg transition-all active:scale-95">
          í™•ì¸
        </button>
        </div>
    </div>

    <div id="detailListModal" class="fixed inset-0 bg-transparent backdrop-blur-sm hidden flex items-center justify-center z-[100] p-4" onclick="if(event.target.id==='detailListModal') closeDetailModal()">
      <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl modal-animate flex flex-col max-h-[80vh]">
        
        <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-2xl">
          <h3 id="detailModalTitle" class="font-bold text-slate-800 flex items-center gap-2">
            </h3>
          <button onclick="closeDetailModal()" class="w-8 h-8 rounded-full bg-white border border-slate-200 text-slate-400 flex items-center justify-center hover:bg-slate-100 transition-colors">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>

        <div id="detailListContent" class="flex-1 overflow-y-auto p-4 space-y-3 min-h-[150px]">
          <div class="flex flex-col items-center justify-center h-full text-slate-400 py-10">
            <i class="fa-solid fa-circle-notch fa-spin text-2xl mb-2 text-indigo-500"></i>
            <span class="text-xs">ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
          </div>
        </div>

        <div class="p-4 border-t border-slate-100">
          <button onclick="closeDetailModal()" data-lang="ë‹«ê¸°" class="w-full py-3 bg-slate-800 text-white font-bold rounded-xl hover:bg-slate-700 transition-colors shadow-md">
            ë‹«ê¸°
          </button>
        </div>
      </div>
    </div>

    <div id="cacheClearModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center z-[3000] p-4">
      <div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl modal-animate text-center relative border-4 border-rose-50">
        <div class="w-16 h-16 bg-rose-100 rounded-full flex items-center justify-center mx-auto mb-4 text-rose-500 animate-pulse">
          <i class="fa-solid fa-triangle-exclamation text-3xl"></i>
        </div>
        <h3 class="text-xl font-black text-slate-800 mb-2" data-lang="ëª¨ë“  ìºì‹œ ì´ˆê¸°í™”">ëª¨ë“  ìºì‹œ ì´ˆê¸°í™”</h3>
        <p class="text-slate-600 text-sm mb-6 break-keep leading-relaxed">
          <span data-lang="ëª¨ë“  ìºì‹œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?">ëª¨ë“  ìºì‹œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</span><br>
          <span class="text-rose-500 font-bold text-xs" data-lang="(ë°ì´í„°ê°€ ì¬ë¡œë”©ë˜ì–´ ì ì‹œ ëŠë ¤ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤)">(ë°ì´í„°ê°€ ì¬ë¡œë”©ë˜ì–´ ì ì‹œ ëŠë ¤ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤)</span>
        </p>
        <div class="flex gap-2">
          <button onclick="closeCacheClearModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition-colors" data-lang="ì·¨ì†Œ">ì·¨ì†Œ</button>
          <button onclick="confirmCacheClear()" class="flex-1 bg-rose-500 hover:bg-rose-600 text-white font-bold py-3 rounded-xl transition-colors shadow-md active:scale-95" data-lang="ì´ˆê¸°í™”">ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div>


    <div id="leaderModeSelectModal" class="fixed inset-0 bg-transparent backdrop-blur-sm hidden flex items-center justify-center z-[130] p-4" onclick="if(event.target.id==='leaderModeSelectModal') closeLeaderModeModal()">
      <div class="bg-white rounded-2xl p-6 w-full max-w-xs shadow-2xl modal-animate text-center relative">
        
        <button onclick="closeLeaderModeModal()" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition-colors">
          <i class="fa-solid fa-xmark text-xl"></i>
        </button>
        
        <div class="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 border border-indigo-100">
          <i class="fa-solid fa-user-gear text-3xl text-indigo-600"></i>
        </div>

        <h3 class="text-xl font-bold text-slate-800 mb-2" data-lang="ì ‘ì† ëª¨ë“œ ì„ íƒ">ì ‘ì† ëª¨ë“œ ì„ íƒ</h3>
        <p class="text-slate-500 text-sm mb-6">
          <span id="targetLeaderZoneNum" class="text-indigo-600 font-bold"></span> 
          <span data-lang="ì–´ë–¤ ëª¨ë“œë¡œ ì ‘ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?">ì–´ë–¤ ëª¨ë“œë¡œ ì ‘ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</span>
        </p>

        <div class="flex flex-col gap-3">
          <button onclick="confirmLeaderMode('EDIT')" class="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95">
            <i class="fa-solid fa-pen-to-square"></i>
            <span data-lang="í¸ì§‘ ëª¨ë“œ">í¸ì§‘ ëª¨ë“œ</span>
          </button>

          <button onclick="confirmLeaderMode('VIEW')" class="w-full py-3.5 bg-white border border-slate-200 text-slate-600 font-bold rounded-xl hover:bg-slate-50 flex items-center justify-center gap-2 transition-transform active:scale-95">
            <i class="fa-solid fa-user"></i>
            <span data-lang="ê¸°ë³¸ ëª¨ë“œ">ê¸°ë³¸ ëª¨ë“œ</span>
          </button>

          <button onclick="closeLeaderModeModal()" class="w-full py-3 text-slate-500 font-medium hover:bg-slate-100 rounded-xl transition-colors">
            ì·¨ì†Œ
          </button>
        </div>

      </div>
   </div>


<div id="sosConfirmModal" class="fixed inset-0 bg-transparent backdrop-blur-sm hidden flex items-center justify-center z-[110] p-4">
  <div class="bg-white rounded-2xl p-6 w-full max-w-xs shadow-2xl modal-animate text-center relative border-4 border-red-100">
    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600 animate-bounce">
      <i class="fa-solid fa-tower-broadcast text-3xl"></i>
    </div>
    <h3 class="text-xl font-black text-slate-800 mb-2" data-lang="ê¸´ê¸‰ ì•Œë¦¼ ë°œì†¡">ê¸´ê¸‰ ì•Œë¦¼ ë°œì†¡</h3>
    <p class="text-slate-600 text-sm mb-6 break-keep" data-lang="ëª¨ë“  ë´‰ì‚¬ìì—ê²Œ ë©”ì‹œì§€ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.">
      ëª¨ë“  ë´‰ì‚¬ìì—ê²Œ ë©”ì‹œì§€ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.
    </p>
    <div class="flex gap-2">
      <button onclick="document.getElementById('sosConfirmModal').classList.add('hidden')" class="flex-1 py-3 text-slate-500 font-medium hover:bg-slate-100 rounded-xl transition-colors" data-lang="ì·¨ì†Œ">ì·¨ì†Œ</button>
      <button onclick="confirmSendSOS()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-xl transition-colors shadow-md" data-lang="ë°œì†¡">ë°œì†¡</button>
    </div>
  </div>
</div>

<div id="noticeModal" class="fixed inset-0 bg-slate-900/70 backdrop-blur-md hidden flex items-center justify-center z-[250] p-6">
  <div class="bg-white rounded-[2.5rem] w-full max-w-sm shadow-2xl modal-animate overflow-hidden border-b-[12px] border-indigo-600">
    <div class="p-8">
      <div class="flex flex-col items-center text-center mb-6">
        <div class="w-20 h-20 bg-indigo-50 rounded-3xl flex items-center justify-center text-indigo-600 mb-4 shadow-inner">
          <i class="fa-solid fa-bullhorn text-4xl animate-bounce"></i>
        </div>
        <h3 class="text-2xl font-black text-slate-800 tracking-tight">ê³µì§€ì‚¬í•­</h3>
        <p class="text-xs text-indigo-500 font-bold uppercase tracking-widest mt-1"><?= congName ?></p>
      </div>
      
      <div class="bg-slate-50 rounded-2xl p-5 border border-slate-100 min-h-[120px] max-h-[250px] overflow-y-auto mb-4 shadow-inner">
        <p id="noticeContent" class="text-slate-700 text-base leading-relaxed whitespace-pre-wrap break-keep font-semibold">
          ê³µì§€ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
        </p>
      </div>

      <div class="flex items-center justify-center gap-2 mb-6 cursor-pointer select-none" onclick="var cb=document.getElementById('hideNoticeToday'); cb.checked=!cb.checked;">
        <input type="checkbox" id="hideNoticeToday" class="w-4 h-4 accent-indigo-600 cursor-pointer" onclick="event.stopPropagation();">
        <label for="hideNoticeToday" class="text-sm text-slate-500 font-bold cursor-pointer">ì˜¤ëŠ˜ í•˜ë£¨ ë³´ì§€ ì•Šê¸°</label>
      </div>

      <button onclick="closeNoticeModal()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 rounded-2xl shadow-lg shadow-indigo-200 active:scale-95 transition-all text-xl">
        í™•ì¸í–ˆìŠµë‹ˆë‹¤
      </button>
    </div>
  </div>
</div>


<div id="sosAlertModal" class="fixed inset-0 bg-red-600/90 backdrop-blur-sm hidden flex items-center justify-center z-[120] p-6 transition-opacity duration-300">
  <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl modal-animate text-center relative overflow-hidden">
    
    <div class="absolute -top-10 -right-10 w-32 h-32 bg-red-100 rounded-full opacity-50"></div>
    <div class="absolute -bottom-10 -left-10 w-24 h-24 bg-red-100 rounded-full opacity-50"></div>
    
    <div class="relative z-10">
      <div class="w-20 h-20 bg-red-500 rounded-full flex items-center justify-center mx-auto mb-5 text-white shadow-lg shadow-red-200">
        <i class="fa-solid fa-bell fa-shake text-4xl"></i>
      </div>
      
      <h3 class="text-2xl font-black text-red-600 mb-1" data-lang="ë„ì›€ ìš”ì²­!">ë„ì›€ ìš”ì²­!</h3>
      <p class="text-xs text-slate-400 mb-6" id="sosTimeDisplay" data-lang="ìˆ˜ì‹  ëŒ€ê¸° ì¤‘...">ìˆ˜ì‹  ëŒ€ê¸° ì¤‘...</p>
      
      <div class="bg-slate-50 rounded-xl p-4 mb-6 border border-slate-200 text-left space-y-2">
        <div class="flex justify-between border-b border-slate-200 pb-2">
          <span class="text-slate-500 text-xs font-bold" data-lang="ìš”ì²­ì">ìš”ì²­ì</span>
          <span class="text-slate-800 font-bold" id="sosSenderDisplay">-</span>
        </div>
        
        <div class="flex justify-between border-b border-slate-200 pb-2 items-center">
          <span class="text-slate-500 text-xs font-bold" data-lang="êµ¬ì—­ ë²ˆí˜¸">êµ¬ì—­ ë²ˆí˜¸</span>
          <span class="text-indigo-600 font-black text-lg" id="sosCardDisplay">-</span>
        </div>

        <div class="flex justify-between border-b border-slate-200 pb-2">
          <span class="text-slate-500 text-xs font-bold mt-1" data-lang="ì£¼ì†Œ/ê±´ë¬¼">ì£¼ì†Œ/ê±´ë¬¼</span>
          <div class="text-right" id="sosAddressDisplay">
            <span class="text-slate-400 text-sm" data-lang="ì •ë³´ ì—†ìŒ">ì •ë³´ ì—†ìŒ</span>
          </div>
        </div>
        
        <div class="flex flex-col pt-1">
          <span class="text-slate-500 text-xs font-bold mb-1" data-lang="í˜„ì¬ ìœ„ì¹˜ (ì—¬ê¸°ê¹Œì§€)">í˜„ì¬ ìœ„ì¹˜ (ì—¬ê¸°ê¹Œì§€)</span>
          <span class="text-slate-800 font-medium text-sm break-words bg-white p-2 rounded border border-slate-100 shadow-sm" id="sosLocDisplay">
            -
          </span>
        </div>
      </div>

      <button onclick="closeSOSModal()" data-lang="í™•ì¸í–ˆìŠµë‹ˆë‹¤" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-all text-lg">
        í™•ì¸í–ˆìŠµë‹ˆë‹¤
      </button>
    </div>
  </div>
</div>

    <div id="loadingOverlay" class="fixed inset-0 z-[4000] bg-white/80 backdrop-blur-sm hidden flex flex-col items-center justify-center gap-4 transition-opacity duration-300">
      <div class="animate-spin rounded-full h-12 w-12 border-4 border-slate-200 border-t-indigo-600"></div>
      <p class="text-slate-600 font-bold text-sm animate-pulse" data-lang="êµ¬ì—­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...">êµ¬ì—­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

<div id="adminPasswordModal" class="fixed inset-0 backdrop-blur-sm bg-white/10 hidden flex items-center justify-center z-[2000] p-4">
  <div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl modal-animate text-center relative">
    <div class="w-14 h-14 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600">
      <i class="fa-solid fa-shield-halved text-2xl"></i>
    </div>
    
    <h3 class="text-lg font-black text-slate-800 mb-1" data-lang="ê´€ë¦¬ì ì¸ì¦">ê´€ë¦¬ì ì¸ì¦</h3>
    
    <p class="text-slate-500 text-xs mb-6" data-lang="ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.">ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
    
    <input 
      type="password" 
      id="adminSecretInput" 
      data-lang="â€¢â€¢â€¢â€¢"
      onkeyup="if(event.key === 'Enter') verifyAdminModal()"
      class="w-full text-center py-3 border border-slate-200 rounded-2xl focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-colors mb-6 text-xl tracking-[0.5em]" 
      placeholder="â€¢â€¢â€¢â€¢"
      autocomplete="off"
    >
    
    <div class="flex gap-2">
      <button onclick="closeAdminModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition-colors" data-lang="ì·¨ì†Œ">ì·¨ì†Œ</button>
      
      <button id="adminVerifyBtn" onclick="verifyAdminModal()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-all shadow-md active:scale-95" data-lang="í™•ì¸">í™•ì¸</button>
    </div>
  </div>
</div>

<div id="publisherManagerModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden z-[2000]">
  <div class="bg-white rounded-[2rem] w-[92%] max-w-md shadow-2xl modal-center-fix flex flex-col h-[72dvh] overflow-hidden relative">
    
    <div class="p-4 sm:p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50 shrink-0">
      <h3 class="font-black text-slate-800 flex items-center gap-2 text-sm sm:text-base">
        <i class="fa-solid fa-users-gear text-indigo-600"></i>
        <span data-lang="ì „ë„ì¸ ëª…ë‹¨ ê´€ë¦¬">ì „ë„ì¸ ëª…ë‹¨ ê´€ë¦¬</span>
      </h3>
      <button onclick="closePublisherManager()" class="w-8 h-8 rounded-full bg-white border border-slate-200 text-slate-400 flex items-center justify-center active:scale-90">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <div class="flex-1 overflow-y-auto no-scrollbar">
      <div class="p-4 sm:p-5 bg-indigo-50/50 border-b border-indigo-100 sticky top-0 z-10 backdrop-blur-sm">
        <div class="relative w-full mb-3">
          <input type="text" id="pubInputName" oninput="checkNamePresence()" 
            data-lang="ì´ë¦„ ì…ë ¥"
            class="w-full pl-4 pr-16 py-3 rounded-xl border border-indigo-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm font-bold shadow-sm bg-white" 
            placeholder="ì´ë¦„ ì…ë ¥">
          
          <button id="pubSaveBtn" onclick="savePublisher()" 
            data-lang="ì¶”ê°€"
            class="absolute right-1.5 top-1.5 bottom-1.5 bg-indigo-600 text-white px-4 rounded-lg font-bold text-sm shadow-md active:scale-95 transition-all whitespace-nowrap">
            ì¶”ê°€
          </button>
        </div>

        <div class="flex items-center justify-between gap-2">
          <div class="flex gap-2 sm:gap-3">
            <label class="flex items-center gap-1.5 cursor-pointer select-none transition-opacity duration-200">
              <input type="checkbox" id="pubCheckPub" class="w-4 h-4 accent-indigo-600" disabled>
              <span class="text-[11px] sm:text-xs font-bold text-slate-600" data-lang="ì „ë„ì¸ ìŠ¹ì¸">ì „ë„ì¸ ìŠ¹ì¸</span>
            </label>
            <label class="flex items-center gap-1.5 cursor-pointer select-none transition-opacity duration-200">
              <input type="checkbox" id="pubCheckLeader" onchange="togglePubPwInput(this.checked)" class="w-4 h-4 accent-indigo-600" disabled>
              <span class="text-[11px] sm:text-xs font-bold text-slate-600" data-lang="ì¸ë„ì ìŠ¹ì¸">ì¸ë„ì ìŠ¹ì¸</span>
            </label>
          </div>
          
          <div id="pubPwArea" class="hidden flex-1 max-w-[80px] sm:max-w-[120px]">
            <input type="password" id="pubInputPw" 
              data-lang="ì•”í˜¸"
              class="w-full px-2 py-1.5 rounded-lg border border-indigo-200 text-xs font-mono tracking-widest text-center" 
              placeholder="ì•”í˜¸">
          </div>

          <button id="pubDeleteBtn" onclick="deletePublisher()" 
            data-lang="ì‚­ì œ"
            class="hidden text-rose-500 text-xs font-bold hover:underline p-1">ì‚­ì œ</button>
        </div>
      </div>

      <div class="p-4 sm:p-5" id="publisherListArea"></div>
    </div>

    <div class="p-3 bg-slate-50 border-t border-slate-100 text-center shrink-0">
      <p class="text-[10px] text-slate-400 font-medium" data-lang="ì´ë¦„ì„ ì„ íƒí•˜ë©´ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.">
        ì´ë¦„ì„ ì„ íƒí•˜ë©´ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </p>
    </div>
  </div>
</div>

<div id="pubDeleteConfirmModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center z-[3000] p-4">
  <div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl modal-animate text-center relative border-4 border-rose-50">
    <div class="w-16 h-16 bg-rose-100 rounded-full flex items-center justify-center mx-auto mb-4 text-rose-600">
      <i class="fa-solid fa-user-minus text-3xl"></i>
    </div>
    
    <h3 class="text-xl font-black text-slate-800 mb-2" data-lang="ëª…ë‹¨ ì‚­ì œ">ëª…ë‹¨ ì‚­ì œ</h3>
    
    <p class="text-slate-600 text-sm mb-6 break-keep">
      <span id="deleteTargetName" class="font-bold text-rose-600"></span>
      <span data-lang="ì„(ë¥¼) ì‚­ì œí• ê¹Œìš”?">ì„(ë¥¼) ì‚­ì œí• ê¹Œìš”?</span>
    </p>

    <div class="flex gap-2">
      <button onclick="closePubDeleteModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition-colors" data-lang="ì·¨ì†Œ">ì·¨ì†Œ</button>
      <button id="btnRealPubDelete" class="flex-1 bg-rose-500 hover:bg-rose-600 text-white font-bold py-3 rounded-xl transition-colors shadow-md active:scale-95" data-lang="ì‚­ì œ">ì‚­ì œ</button>
    </div>
  </div>
</div>

<div id="adminSyncConfirmModal" class="fixed inset-0 bg-transparent backdrop-blur-sm hidden flex items-center justify-center z-[2000] p-4">
  <div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl modal-animate text-center relative">
    <div class="w-14 h-14 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4 text-amber-600">
      <i class="fa-solid fa-arrows-rotate text-2xl"></i>
    </div>
    
    <h3 id="syncModalTitle" class="text-lg font-black text-slate-800 mb-1" data-lang="ë°ì´í„° ë™ê¸°í™”">ë°ì´í„° ë™ê¸°í™”</h3>
    
    <p id="syncModalDesc" class="text-slate-500 text-xs mb-6 break-keep" data-lang="ë™ê¸°í™”ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?">ë™ê¸°í™”ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>

    <div class="flex gap-2">
      <button onclick="closeSyncConfirmModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition-colors" data-lang="ì·¨ì†Œ">ì·¨ì†Œ</button>
      
      <button id="btnConfirmSyncAction" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md active:scale-95" data-lang="í™•ì¸">í™•ì¸</button>
    </div>
  </div>
</div>

<div id="noticeDeleteConfirmModal" class="fixed inset-0 bg-transparent backdrop-blur-sm hidden flex items-center justify-center z-[2000] p-4">
  <div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl modal-animate text-center relative border-4 border-indigo-50">
    <div class="w-14 h-14 bg-rose-100 rounded-full flex items-center justify-center mx-auto mb-4 text-rose-600">
      <i class="fa-solid fa-trash-can text-2xl"></i>
    </div>
    <h3 class="text-lg font-black text-slate-800 mb-1" data-lang="ê³µì§€ì‚¬í•­ ì‚­ì œ">ê³µì§€ì‚¬í•­ ì‚­ì œ</h3>
    <p class="text-slate-500 text-xs mb-6 break-keep" data-lang="ê³µì§€ì‚¬í•­ì„ ì‚­ì œí• ê¹Œìš”?">ê³µì§€ì‚¬í•­ì„ ì‚­ì œí• ê¹Œìš”?</p>
    <div class="flex gap-2">
      <button onclick="closeNoticeDeleteModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition-colors" data-lang="ì·¨ì†Œ">ì·¨ì†Œ</button>
      <button onclick="confirmNoticeDelete()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md active:scale-95" data-lang="í™•ì¸">í™•ì¸</button>
    </div>
  </div>
</div>

<div id="yearEndConfirmModal" class="fixed inset-0 bg-transparent backdrop-blur-sm hidden flex items-center justify-center z-[2000] p-4">
  <div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl modal-animate text-center relative border-4 border-indigo-50">
    <div class="w-14 h-14 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600">
      <i class="fa-solid fa-calendar-check text-2xl"></i>
    </div>
    
    <h3 class="text-lg font-black text-slate-800 mb-2" data-lang="ê¸°ë¡ ë§ˆê°">ê¸°ë¡ ë§ˆê°</h3>
    
    <div class="bg-slate-50 rounded-xl p-3 mb-6 border border-slate-100 text-left">
      <p class="text-xs text-slate-700 font-bold mb-2" data-lang="âš ï¸ ì£¼ì˜ì‚¬í•­">âš ï¸ ì£¼ì˜ì‚¬í•­</p>
      <ul class="text-[11px] text-slate-500 space-y-1.5 list-disc pl-4 leading-tight">
        <li data-lang="ê¸°ë¡ ë‹¤ìŒ ì—°ë„ ì´ë™">ê¸°ë¡ ë‹¤ìŒ ì—°ë„ ì´ë™</li>
        <li data-lang="ë¯¸ë´‰ì‚¬ êµ¬ì—­ '-' í™•ì •">ë¯¸ë´‰ì‚¬ êµ¬ì—­ '-' í™•ì •</li>
        <li data-lang="4ë…„ì°¨ ì¢…ë£Œ ì‹œ ì´ˆê¸°í™”">4ë…„ì°¨ ì¢…ë£Œ ì‹œ ì´ˆê¸°í™”</li>
      </ul>
    </div>

    <div class="flex gap-2">
      <button onclick="closeYearEndModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition-colors" data-lang="ì·¨ì†Œ">ì·¨ì†Œ</button>
      <button onclick="confirmYearEndAction()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md active:scale-95" data-lang="í™•ì¸">í™•ì¸</button>
    </div>
  </div>
</div>

<div id="visitReportConfirmModal" class="fixed inset-0 bg-transparent backdrop-blur-sm hidden flex items-center justify-center z-[2000] p-4">
  <div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl modal-animate text-center relative">
    <div class="w-14 h-14 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-600">
      <i class="fa-solid fa-file-pdf text-2xl"></i>
    </div>
    
    <h3 class="text-lg font-black text-slate-800 mb-1" data-lang="PDF íŒŒì¼ ìƒì„±">PDF íŒŒì¼ ìƒì„±</h3>
    
    <p class="text-slate-500 text-xs mb-6 break-keep">
      <span data-lang="PDF íŒŒì¼ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?">PDF íŒŒì¼ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</span><br>
      <span class="text-red-500 font-bold" data-lang="(ë‚´ìš©ì´ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.)">(ë‚´ìš©ì´ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.)</span>
    </p>

    <div class="flex gap-2">
      <button onclick="closeVisitReportModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition-colors" data-lang="ì·¨ì†Œ">ì·¨ì†Œ</button>
      <button id="btnConfirmVisitReport" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md active:scale-95" data-lang="í™•ì¸">í™•ì¸</button>
    </div>
  </div>
</div>

<div id="pdfOpenConfirmModal" class="fixed inset-0 bg-transparent backdrop-blur-sm hidden flex items-center justify-center z-[2000] p-4">
  <div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl modal-animate text-center relative border-4 border-emerald-50">
    <div class="w-14 h-14 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4 text-emerald-600">
      <i class="fa-solid fa-folder-open text-2xl"></i>
    </div>
    
    <h3 class="text-lg font-black text-slate-800 mb-1" data-lang="ì €ì¥ ì™„ë£Œ">ì €ì¥ ì™„ë£Œ</h3>
    
    <p class="text-slate-500 text-xs mb-6 break-keep" data-lang="PDF íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.">
      PDF íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.
    </p>

    <div class="flex gap-2">
      <button onclick="closePdfOpenModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition-colors" data-lang="ë‹«ê¸°">ë‹«ê¸°</button>
      
      <button id="btnRealOpenPdf" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md active:scale-95" data-lang="íŒŒì¼ ì—´ê¸°">íŒŒì¼ ì—´ê¸°</button>
    </div>
  </div>
</div>

<div id="periodSelectionModal" class="fixed inset-0 bg-transparent backdrop-blur-sm hidden flex items-center justify-center z-[2000] p-4">
  <div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl modal-animate text-center relative border-4 border-indigo-50">
    <div class="w-14 h-14 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600">
      <i class="fa-solid fa-clock-rotate-left text-2xl"></i>
    </div>
    
    <h3 class="text-lg font-black text-slate-800 mb-1" data-lang="ë³´ê³ ì„œ ì£¼ê¸° ì„ íƒ">ë³´ê³ ì„œ ì£¼ê¸° ì„ íƒ</h3>
    
    <p class="text-slate-500 text-xs mb-6 break-keep" data-lang="ì¶œë ¥ì„ ì„ íƒí•˜ì„¸ìš”.">
      ì¶œë ¥ì„ ì„ íƒí•˜ì„¸ìš”.
    </p>

    <div class="flex flex-col gap-2">
      <button onclick="executeVisitReport('sixMonths')" class="w-full py-4 bg-white border-2 border-slate-200 text-slate-700 font-bold rounded-2xl hover:bg-slate-50 transition-all active:scale-95 flex flex-col items-center leading-tight">
        <span class="text-sm" data-lang="6ê°œì›” ì¤‘ê°„ ë§ˆê°">6ê°œì›” ì¤‘ê°„ ë§ˆê°</span>
        <span class="text-[10px] font-normal text-slate-400" data-lang="í˜„ì¬ ì¹¸ì— ê³„ì† ê¸°ë¡">í˜„ì¬ ì¹¸ì— ê³„ì† ê¸°ë¡</span>
      </button>

      <button onclick="executeVisitReport('year')" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-2xl hover:bg-indigo-700 shadow-md transition-all active:scale-95 flex flex-col items-center leading-tight">
        <span class="text-sm" data-lang="1ë…„ ë´‰ì‚¬ ë§ˆê°">1ë…„ ë´‰ì‚¬ ë§ˆê°</span>
        <span class="text-[10px] font-light opacity-80" data-lang="ë‹¤ìŒ ì¹¸ìœ¼ë¡œ ì´ë™í•˜ì—¬ ê¸°ë¡">ë‹¤ìŒ ì¹¸ìœ¼ë¡œ ì´ë™í•˜ì—¬ ê¸°ë¡</span>
      </button>

      <button onclick="closePeriodModal()" class="mt-2 py-2 text-slate-400 text-xs font-medium hover:underline" data-lang="ì·¨ì†Œ">ì·¨ì†Œ</button>
    </div>
  </div>

    <script>

  // 1. ê¸€ì ìˆœì°¨ ë“±ì¥ íš¨ê³¼
  (function() {
    var textEl = document.getElementById('loadingText');
    if (!textEl) return;

    var text = textEl.innerText.trim();
    textEl.innerHTML = ''; 

    for (var i = 0; i < text.length; i++) {
      var char = text[i];
      var span = document.createElement('span');
      
      if (char === ' ') {
        span.innerHTML = '&nbsp;';
      } else {
        span.innerText = char;
      }
      
      span.className = 'letter-span';
      
      // [ìˆ˜ì •] ì£¼ì„ëŒ€ë¡œ 0.1ì´ˆ ê°„ê²© ì ìš© (ê¸°ì¡´ 0.1)
      span.style.animationDelay = (i * 0.1) + 's';
      
      textEl.appendChild(span);
    }

    // âš¡ [í•µì‹¬ ì¶”ê°€] ì´ˆê¸° ê¹œë¹¡ì„ ë°©ì§€ í•´ì œ ë¡œì§
    // ë¸Œë¼ìš°ì €ê°€ í™”ë©´ì„ ê·¸ë¦´ ì¤€ë¹„ê°€ ë˜ë©´ init-hiddenì„ ì œê±°í•˜ì—¬ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    requestAnimationFrame(function() {
      textEl.classList.remove('init-hidden');
    });

  })();

  // 2. ë¡œë”© ì‹œê°„ ì œì–´
  window.addEventListener('load', function() {
    const loader = document.getElementById('app-loading-mask');
    
    // [ìˆ˜ì •] ì£¼ì„ëŒ€ë¡œ 2ì´ˆ(2000ms) ëŒ€ê¸° (ê¸°ì¡´ 4500 -> 2000)
    setTimeout(() => {
        // íˆ¬ëª…í•˜ê²Œ í˜ì´ë“œ ì•„ì›ƒ ì‹œì‘
        loader.style.opacity = '0';
        
        // í˜ì´ë“œ ì•„ì›ƒ ì• ë‹ˆë©”ì´ì…˜(0.5ì´ˆ)ì´ ëë‚œ ë’¤ ì™„ì „íˆ ì œê±°
        setTimeout(() => {
            loader.style.display = 'none';
        }, 500);
        
    }, 4500); 
  });


        // 1. ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì • ì„ ì–¸ (ê°€ì¥ ë¨¼ì €!)
      const sosAlarm = new Audio(); // ë¹ˆ ì˜¤ë””ì˜¤ ê°ì²´ ë¨¼ì € ìƒì„±
      const noticeAlarm = new Audio();  // ğŸš€ ê³µì§€ ì•ŒëŒ (ë¹ˆ ê°ì²´ ìƒì„±)

       let currentSortState = {
        house: 'recent', // í˜¸ë³„ ê¸°ë³¸ê°’ (ìµœê·¼ìˆœ)
        busy: 'recent'   // ë¶€ì¬ ê¸°ë³¸ê°’ (ìµœê·¼ìˆœ)
      };

      let currentData = [];
    // 3. ì£¼ê¸°ì ìœ¼ë¡œ ì ê¸ˆ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” í•µì‹¬ í•¨ìˆ˜ (5ì´ˆë§ˆë‹¤)
      let wasServerLocked = false; // â˜… ì´ì „ ìƒíƒœ ê¸°ì–µ ë³€ìˆ˜
      let isLockAcknowledged = false; // â˜… [ì¶”ê°€] ì‚¬ìš©ìê°€ ì ê¸ˆ ì•Œë¦¼ì„ í™•ì¸í–ˆëŠ”ì§€ ì—¬ë¶€
    // [í•„ìˆ˜ ì¶”ê°€] í¸ì§‘ ì‘ì—… ì¤‘ ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•œ ë³€ìˆ˜
    let pendingRows = new Set(); 
    // [í•„ìˆ˜ ì¶”ê°€] ì‚­ì œ ëª¨ë‹¬ìš© ì¸ë±ìŠ¤ ì €ì¥ ë³€ìˆ˜
    let targetDeleteIndex = -1;


      let currentNumber = ""; 
      let lastNotificationTime = Date.now(); // â˜… [ì¶”ê°€] ì•Œë¦¼ ë™ê¸°í™” ì‹œì‘ ì‹œê°„
      let openMenuIndex = -1; // -1ì€ ì—´ë¦° ë©”ë‰´ê°€ ì—†ë‹¤ëŠ” ëœ»      
      let isAuthModeInZone = false; // â˜… ì¶”ê°€: êµ¬ì—­ ë‚´ë¶€ ì¸ì¦ í”Œë˜ê·¸
      let prefetchTimer = null; // [ì‹ ê·œ] í”„ë¦¬íŒ¨ì¹˜ íƒ€ì´ë¨¸ ë° í•¸ë“¤ëŸ¬
      let lastActiveUserList = []; // â˜… [ì¶”ê°€] ì´ì „ ì ‘ì†ì ëª…ë‹¨ì„ ê¸°ì–µí•  ë³€ìˆ˜
      let localUserCache = null; // â˜… ë¯¸ë¦¬ ë°›ì•„ì˜¨ ì‚¬ìš©ì ëª…ë‹¨ ì €ì¥ì†Œ
      let globalSettings = <?!= serverSettings ?>;

      let sessionStartDate = ""; // ì„¸ì…˜ì´ ì‹œì‘ëœ ë‚ ì§œë¥¼ ì €ì¥


            // [ì¶”ê°€] ì•Œì•½ ìƒíƒœ ì œì–´ ë³€ìˆ˜
      let scrollStopTimer = null;
      let sessionStartTime = new Date(); // ë¡œê·¸ì¸(ì•± ì‹¤í–‰) ì‹œì  ì‹œê°„ ì €ì¥
      let currentProgressText = "";      // í˜„ì¬ ë°©ë¬¸ìœ¨ ì €ì¥ìš©
      let isInteracting = false;         // í´ë¦­ ë“± ì‘ì—… ì¤‘ì¸ì§€ ì—¬ë¶€
 
// -----------------------------------------------------------
      // 2. ì˜¤ë””ì˜¤ ì„¤ì • (SOS & ê³µì§€) - ì„œë²„ ë°ì´í„° ì—°ë™
      // -----------------------------------------------------------
      try {
        // [A] SOS ì•ŒëŒ ì„¤ì • (B13)
        if (globalSettings.sosSoundData && globalSettings.sosSoundData.length > 100) {
           sosAlarm.src = globalSettings.sosSoundData;
           console.log("ğŸ“¢ SOS ì•ŒëŒ(B13) ë¡œë”© ì™„ë£Œ");
        } else {
           console.log("âš ï¸ SOS íŒŒì¼ ì—†ìŒ. ê¸°ë³¸ ì•ŒëŒ ì‚¬ìš©");
        }
        sosAlarm.loop = true; 
        sosAlarm.preload = 'auto';

        // ğŸš€ [B] ê³µì§€ ì•ŒëŒ ì„¤ì • (B14)
        if (globalSettings.noticeSoundData && globalSettings.noticeSoundData.length > 100) {
           noticeAlarm.src = globalSettings.noticeSoundData;
           console.log("ğŸ“¢ ê³µì§€ ì•ŒëŒ(B14) ë¡œë”© ì™„ë£Œ");
        } else {
           console.log("âš ï¸ ê³µì§€ íŒŒì¼ ì—†ìŒ. ê¸°ë³¸ ì•ŒëŒ(Pop) ì‚¬ìš©");
        }
        noticeAlarm.volume = 0.5; // ë³¼ë¥¨ 50%
        noticeAlarm.preload = 'auto';

      } catch (err) {
        console.error("Audio Init Error:", err);
      }


// [ìµœì í™” 2] HTML íŒŒì‹± ì¦‰ì‹œ ëª…ë‹¨ ìš”ì²­ (ì´ë¯¸ì§€ ë¡œë”© ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ -> ì†ë„ í–¥ìƒ)
document.addEventListener('DOMContentLoaded', function() {
    // 1. ì‚¬ìš©ì ëª…ë‹¨ í”„ë¦¬íŒ¨ì¹˜
    google.script.run
      .withSuccessHandler(function(data) { 
          localUserCache = data; 
          console.log("âœ… ì‚¬ìš©ì ëª…ë‹¨ í”„ë¦¬íŒ¨ì¹˜ ì™„ë£Œ (Fast)");
      })
      .withFailureHandler(function(e){ console.log("ëª…ë‹¨ ë¡œë”© ì‹¤íŒ¨(ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©)"); })
      .getSafeUserList();

    // 2. ì…ë ¥ì°½ í¬ì»¤ìŠ¤ ì‹œì  ìµœì í™” (í‚¤ë³´ë“œ íŒì—… ë”œë ˆì´ ê°ì†Œ)
    var numInput = document.getElementById('numberInput');
    if(numInput) {
       // ëª¨ë°”ì¼ì—ì„œ í„°ì¹˜ ë°˜ì‘ì„±ì„ ìœ„í•´ passive ì˜µì…˜ ì‚¬ìš©
       numInput.addEventListener('touchstart', function(){}, {passive: true});
    }
});
      // [ì „ì—­ ë³€ìˆ˜] ë³€ê²½í•  í–‰ì˜ ì¸ë±ìŠ¤ ì €ì¥
      let targetRenameIndex = -1;

      // 1. ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
      function openRenameModal(index) {
        targetRenameIndex = index;
        
        // ê¸°ì¡´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (inputì— ë¯¸ë¦¬ ì±„ì›Œë‘ê¸° ìœ„í•¨)
        var currentName = currentData[index][3] ? currentData[index][3].toString() : "";
        
        var input = document.getElementById('renameInput');
        input.value = currentName;
        
        document.getElementById('renameModal').classList.remove('hidden');
        
        // ëª¨ë‹¬ì´ ëœ¬ ë’¤ ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
        setTimeout(function() { input.focus(); }, 100);
      }

      // 2. ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
      function closeRenameModal() {
        document.getElementById('renameModal').classList.add('hidden');
        targetRenameIndex = -1;
      }

      // 3. ë³€ê²½ í™•ì¸(ì €ì¥) í•¨ìˆ˜
      function confirmRename() {
        if (targetRenameIndex === -1) return;
        
        var input = document.getElementById('renameInput');
        var newName = input.value.toString().trim();
        
        // ë¹ˆì¹¸ ë°©ì§€ (ì„ íƒì‚¬í•­)
        /*
        if (!newName) {
          showToast(t("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."), "fa-solid fa-triangle-exclamation text-red-400");
          return;
        }
        */

        // â˜… ê¸°ì¡´ leaderModifyRow í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë˜, 3ë²ˆì§¸ ì¸ìë¡œ ê°’ì„ ì§ì ‘ ì „ë‹¬í•©ë‹ˆë‹¤.
        leaderModifyRow(targetRenameIndex, "RENAME", newName);
        
        closeRenameModal();
      }

function handleInputPrefetch(val) {
  // 3ìë¦¬ ë¯¸ë§Œ(ì˜ˆ: 10, 1)ì¼ ë•ŒëŠ” ìš”ì²­ ì•ˆ í•¨
  if (!val || val.length < 3) return; 
  
  // [ìµœì í™” 3] ê¸°ì¡´ íƒ€ì´ë¨¸ í™•ì‹¤íˆ ì œê±° (ì„œë²„ ì¤‘ë³µ ìš”ì²­ ë°©ì§€)
  if (prefetchTimer) clearTimeout(prefetchTimer);
  
  // ì—°ì† ì…ë ¥ ì‹œ ë§ˆì§€ë§‰ ì…ë ¥ í›„ 0.4ì´ˆ ë’¤ì— ì‹¤í–‰ (0.3ì´ˆ -> 0.4ì´ˆë¡œ ì•½ê°„ ëŠ˜ë ¤ ì„œë²„ ë¶€í•˜ ê°ì†Œ ë° ì •í™•ë„ í–¥ìƒ)
  prefetchTimer = setTimeout(function() {
    // ì´ë¯¸ ë¡œì»¬ì— ìºì‹œëœ ë°ì´í„°ê°€ ìˆë‹¤ë©´ ì„œë²„ ìš”ì²­ ìŠ¤í‚µ (ë°ì´í„° ì ˆì•½)
    var cacheKey = getLocalKey(val);
    if (localStorage.getItem(cacheKey)) {
        console.log("ğŸš€ ë¡œì»¬ ìºì‹œ ì¡´ì¬: ì„œë²„ ìš”ì²­ ìŠ¤í‚µ (" + val + ")");
        return;
    }

    // console.log("ğŸš€ ë°ì´í„° ë¯¸ë¦¬ ë¡œë”© ìš”ì²­: " + val);
    google.script.run
      .withFailureHandler(function(){}) // ì—ëŸ¬ë‚˜ë„ ë¬´ì‹œ
      .prefetchZoneData(val);
  }, 400);
}

// [ìˆ˜ì •] ì¸ë„ì íƒ­ ì „í™˜ í•¨ìˆ˜
function switchLeaderTab(tabName) {
    // 1. ëª¨ë“  ê·¸ë£¹ ìˆ¨ê¸°ê¸° (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    document.getElementById('group-clean').classList.add('hidden');
    document.getElementById('group-house').classList.add('hidden');
    document.getElementById('group-busy').classList.add('hidden');
    document.getElementById('group-complete').classList.add('hidden');

    // 2. ì„ íƒí•œ íƒ­ í™œì„±í™” ìŠ¤íƒ€ì¼ ì ìš© (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    const activeBtn = document.getElementById('tabBtn-' + tabName);
    // ... (ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½ ë¡œì§ì€ ê¸°ì¡´ëŒ€ë¡œ) ...

    // 3. ë¡œë”© ì˜¤ë²„ë ˆì´ í™œì„±í™” (í•µì‹¬ ì¶”ê°€)
    const tabNamesKor = { 'clean': 'ë¯¸ì‚¬ìš©', 'house': 'í˜¸ë³„', 'busy': 'ë¶€ì¬', 'complete': 'ì™„ë£Œ' };
    const loadingMsg = tabNamesKor[tabName] + ' ê·¸ë£¹ì„ ì •ë ¬/ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...';
    
    // ë¡œë”© ì˜¤ë²„ë ˆì´ë¥¼ ë„ì›ë‹ˆë‹¤.
    showLoading(true, loadingMsg);
    
    // 4. ë Œë”ë§ ì‘ì—…ì„ ë¹„ë™ê¸°(setTimeout)ë¡œ ë¶„ë¦¬ (í•µì‹¬)
    // 10ms ë’¤ì— ì‹¤ì œ ë Œë”ë§ì„ ì‹œì‘í•˜ì—¬ UI ìŠ¤ë ˆë“œê°€ ë§‰íˆëŠ” ê²ƒì„ ë°©ì§€
    setTimeout(function() {
        
        // 5. ì„ íƒí•œ ê·¸ë£¹ ë³´ì´ê¸° (ê¸°ì¡´ 2ë²ˆ ë¡œì§)
        document.getElementById('group-' + tabName).classList.remove('hidden');

        // 6. í•´ë‹¹ ê·¸ë£¹ì— ë§ëŠ” ì •ë ¬ ë° ë Œë”ë§ ì‹¤í–‰
        if (tabName === 'clean') {
            filterCleanList(); // ë¯¸ì‚¬ìš© ê·¸ë£¹ ë¡œë”© í•¨ìˆ˜
        } else if (tabName === 'house') {
            // í˜„ì¬ ì„ íƒëœ ì •ë ¬ ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ë Œë”ë§
            sortAndRenderGroup('house', document.getElementById('sortSelectHouse').value);
        } else if (tabName === 'busy') {
            // í˜„ì¬ ì„ íƒëœ ì •ë ¬ ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ë Œë”ë§
            sortAndRenderGroup('busy', document.getElementById('sortSelectBusy').value);
        }
        // ì™„ë£Œ íƒ­ì€ renderLeaderDashboardì—ì„œ ì²˜ë¦¬ë˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ë¬´ì‹œ ê°€ëŠ¥

        // 7. ë¡œë”© ì˜¤ë²„ë ˆì´ í•´ì œ
        showLoading(false);
        
    }, 10); // 10ms ì§€ì—°
}

// ==========================================
// [í•„ìˆ˜ ì¶”ê°€] ê·¸ë£¹ ì •ë ¬ ë° ë Œë”ë§ í•¨ìˆ˜
// ==========================================
function sortAndRenderGroup(groupType, sortMode) {
  if (!leaderDashboardData) return;

  if (groupType === 'house') {
    currentSortState.house = sortMode;
  } else if (groupType === 'busy') {
    currentSortState.busy = sortMode;
  }

  var list = [];
  var dateMap = {};
  var targetId = "";
  var colorClass = "";
  var countId = "";
  
  if (groupType === 'house') {
    list = (leaderDashboardData.house || []).slice();
    dateMap = leaderDashboardData.houseDates || {};
    targetId = 'listHouse';
    colorClass = 'bg-emerald-100 text-emerald-800 border-emerald-200 hover:bg-emerald-200';
    countId = 'countHouse';
  } else if (groupType === 'busy') {
    list = (leaderDashboardData.busy || []).slice();
    dateMap = leaderDashboardData.busyDates || {};
    targetId = 'listBusy';
    colorClass = 'bg-amber-100 text-amber-800 border-amber-200 hover:bg-amber-200';
    countId = 'countBusy';
  } else {
    return;
  }

  var visitCounts = leaderDashboardData.visitCounts || {};
  var furnitureCounts = leaderDashboardData.furnitureCounts || {};

  if (sortMode === 'number') {
    list.sort(function(a, b) { return parseInt(a, 10) - parseInt(b, 10); });
  } 
  else if (sortMode === 'oldest') {
    list.sort(function(a, b) {
      var dateA = dateMap[a] || "9999.99.99";
      var dateB = dateMap[b] || "9999.99.99";
      if (dateA === dateB) return parseInt(a, 10) - parseInt(b, 10);
      return dateA.localeCompare(dateB);
    });
  } 
  else if (sortMode === 'count') {
    list.sort(function(a, b) {
      var countA = 0, countB = 0;
      var dataA = visitCounts[a] || { h:0, b:0 };
      var dataB = visitCounts[b] || { h:0, b:0 };
      if (groupType === 'house') { countA = dataA.h || 0; countB = dataB.h || 0; } 
      else { countA = dataA.b || 0; countB = dataB.b || 0; }
      if (countA !== countB) return countA - countB;
      return parseInt(a, 10) - parseInt(b, 10);
    });
  }
  else if (sortMode === 'ban') {
    list.sort(function(a, b) {
      var fA = furnitureCounts[a] || { b: 0 };
      var fB = furnitureCounts[b] || { b: 0 };
      var banA = parseInt(fA.b, 10) || 0;
      var banB = parseInt(fB.b, 10) || 0;
      if (banB !== banA) return banB - banA;
      return parseInt(a, 10) - parseInt(b, 10);
    });
  }
  else if (sortMode === 'memo') {
    list.sort(function(a, b) {
      var fA = furnitureCounts[a] || { m: 0 };
      var fB = furnitureCounts[b] || { m: 0 };
      var memoA = parseInt(fA.m, 10) || 0;
      var memoB = parseInt(fB.m, 10) || 0;
      if (memoB !== memoA) return memoB - memoA;
      return parseInt(a, 10) - parseInt(b, 10);
    });
  }
  else {
    list.sort(function(a, b) {
      var dateA = dateMap[a] || "";
      var dateB = dateMap[b] || "";
      if (dateA === dateB) return parseInt(a, 10) - parseInt(b, 10);
      return dateB.localeCompare(dateA);
    });
  }

  // â˜… ë‚ ì§œ ê²½ê³„ì„  ì¡°ê±´: ìµœê·¼ìˆœ/ì˜¤ë˜ëœìˆœì¼ ë•Œë§Œ í‘œì‹œ
  var showDateSeparator = (sortMode === 'recent' || sortMode === 'oldest' || sortMode === undefined);

  renderZoneList(
    targetId,
    list,
    colorClass,
    (groupType === 'house' ? 'emerald' : 'amber'),
    leaderDashboardData.groupLabels || {},
    furnitureCounts,
    dateMap,
    leaderDashboardData.activeZones || {},
    visitCounts,
    showDateSeparator // ì „ë‹¬
  );

  var countEl = document.getElementById(countId);
  if (countEl) countEl.innerText = list.length;
}

      // [ìµœì¢… ìˆ˜ì •] ë¡œê³  ì ìš© ì½”ë“œ (íŒŒì¼ ìµœìƒë‹¨ IIFE ë‚´ë¶€)
(function applyLogo() {
  // SHARED_LOGO_DATAê°€ ë¡œë“œë  ë•Œê¹Œì§€ ì ì‹œ ëŒ€ê¸°í•˜ëŠ” ì•ˆì „ì¥ì¹˜ í¬í•¨
  var logoData = (typeof SHARED_LOGO_DATA !== 'undefined') ? SHARED_LOGO_DATA : "";
  if (!logoData) {
    // ë§Œì•½ ë°ì´í„°ê°€ ì—†ë‹¤ë©´ 0.1ì´ˆ ë’¤ì— ì¬ì‹œë„
    setTimeout(applyLogo, 100);
    return;
  }

  // 1. íŒŒë¹„ì½˜ ì„¤ì •
  var fav = document.getElementById('dynamicFavicon');
  var apple = document.getElementById('dynamicAppleIcon');
  if(fav) fav.href = logoData;
  if(apple) apple.href = logoData;
  
  // 2. ğŸš€ ë¡œë”© í™”ë©´ ë¡œê³  (ê°€ì¥ ë¨¼ì € ì²˜ë¦¬)
  var loadingImg = document.getElementById('loadingLogoImg');
  if(loadingImg) loadingImg.src = logoData;

  // 3. ë¡œê·¸ì¸ í™”ë©´ ë¡œê³ 
  var loginImg = document.getElementById('loginLogoImg');
  if(loginImg) loginImg.src = logoData;

  // 4. ë©”ì¸/ì¸ë„ì í™”ë©´ ë¡œê³ 
  var mainImg = document.getElementById('mainLogoImg');
  var leaderImg = document.getElementById('leaderLogoImg');
  if(mainImg) { mainImg.src = logoData; mainImg.classList.remove('hidden'); }
  if(leaderImg) { leaderImg.src = logoData; leaderImg.classList.remove('hidden'); }
  
  console.log("âœ… ë¡œê³  ë°ì´í„° ì£¼ì… ì™„ë£Œ");
})();


      let selectedRowIndex = -1;
      
      // ğŸš€ [ì™„ì „ í†µì¼] ë°ì´í„° ì „ì†¡ ë° ì™„ë£Œ ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜
      let pendingVisits = new Set();   // ë°©ë¬¸ ì²´í¬ ì „ì†¡ ì¤‘
      let syncedVisits = new Set();    // ë°©ë¬¸ ì²´í¬ ì™„ë£Œ
      let pendingBells = new Set();    // ë²¨ ëˆ„ë¥´ê¸° ì „ì†¡ ì¤‘
      let syncedBells = new Set();     // ë²¨ ëˆ„ë¥´ê¸° ì™„ë£Œ
      
      let currentUserName = "";
      let currentMarkIndex = -1;
      let currentMarkInfo = "";
      let isServerWarmedUp = false;
      let mapAddressTarget = ""; 
      let lastLoadedMapAddress = ""; 
      let lastLoginUsedLocalCache = false;   // âœ… ì´ë²ˆ ë¡œê·¸ì¸ì—ì„œ ë¡œì»¬ ìºì‹œë¥¼ ì¼ëŠ”ì§€ í‘œì‹œ
      let currentZoneStatus = "í˜¸ë³„"; 
      let requestQueue = [];
      let isProcessingQueue = false;
      let translations = {}; 
      let currentLang = 'ko';

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ë‹¤êµ­ì–´ ì´ˆê¸°í™”
      document.addEventListener('DOMContentLoaded', function() {
        initMultiLanguage();
      });


      let lastMarkActionTime = 0;
      let lastMemoActionTime = 0;

      // ê¸°ë³¸ê°’: ë™ê¸°í™” 1ë¶„(60000ms), ìƒì¡´ì‹ ê³  5ë¶„(300000ms)
      let CONFIG_SYNC_INTERVAL = 60000;   
      let CONFIG_ALIVE_INTERVAL = 300000; 
      let todayVisitorSet = new Set();    // ë°©ë¬¸ì ëª…ë‹¨ ëˆ„ì ìš©
      
      // âœ… ê° í–‰(ì§‘)ë³„ë¡œ ë§ˆì§€ë§‰ ì‘ì—… ì‹œê°„ì„ ê¸°ë¡í•˜ëŠ” ê°ì²´
      let lastRowActionTime = {}; 

      let isSyncing = false;
      let syncTimer = null;

      // âœ… ì¸ë„ì ì„¸ì…˜ ê´€ë ¨ í”Œë˜ê·¸
      let isLeaderLoggedIn = false;        
      let cameFromLeader    = false;        
      let leaderDashboardData = null;       
      let leaderTimer = null;                
      
      // âœ… ìë™ ë¡œê·¸ì•„ì›ƒìš© íƒ€ì´ë¨¸ ë³€ìˆ˜
      let autoLogoutTimer = null;

      // âœ… ì „ì²´ êµ¬ì—­ë²ˆí˜¸ ëª©ë¡ (ê°€êµ¬!Aì—´ ê¸°ë°˜)
      let availableZones = [];

    window.onload = function() { 
    checkRecentHistory();
    setTimeout(warmUpServer, 100);

    // ğŸ“¢ [ìˆ˜ì •] ì„œë²„ì—ì„œ ì˜¨ ê³µì§€ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ë§Œ í•´ë‘¡ë‹ˆë‹¤.
    var serverNotice = <?!= JSON.stringify(initialNotice || "") ?>; 
    window.pendingNotice = serverNotice; // ë‚˜ì¤‘ì— ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë³´ê´€
    
    console.log("ğŸ“¥ ì„œë²„ë¡œë¶€í„° ë°›ì€ ê³µì§€ ë³´ê´€ ì™„ë£Œ:", serverNotice);

    // âŒ ê¸°ì¡´ì˜ setTimeout(showNotice...) ë¶€ë¶„ì€ ì‚­ì œí•©ë‹ˆë‹¤.

    // êµ¬ì—­ ëª©ë¡ ë¡œë”© (ê¸°ì¡´ ìœ ì§€)
    google.script.run
      .withSuccessHandler(function(list) {
        if (Array.isArray(list)) {
          availableZones = list.map(function(x){ return x.toString().trim(); });
        }
      })
      .getAllZoneNumbersFromSheetMap_();
};

      function warmUpServer() {
        if (isServerWarmedUp) return;
        google.script.run
          .withSuccessHandler(function() { isServerWarmedUp = true; })
          .doNothing();
      }


// [ì‹ ê·œ] ì ê¸ˆ ì•Œë¦¼ì°½ ë‹«ê¸° ë²„íŠ¼ ë™ì‘
function closeLockedOverlay() {
  // ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
  document.getElementById('editingOverlay').classList.add('hidden');
  
  // "í™•ì¸í–ˆìŒ"ìœ¼ë¡œ í”Œë˜ê·¸ ì„¤ì • -> pollingì´ ëŒì•„ë„ ë‹¤ì‹œ ì°½ì„ ë„ìš°ì§€ ì•ŠìŒ
  isLockAcknowledged = true;
  
  // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ë¡œ í˜„ì¬ ìƒíƒœ ì•ˆë‚´
  showToast("í¸ì§‘ ì¤‘ì—ëŠ” ë‚´ìš©ì„ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "fa-solid fa-eye text-slate-400");
}

// [index.html ìŠ¤í¬ë¦½íŠ¸ ì˜ì—­]
function checkRecentHistory() {
  var savedName = localStorage.getItem('last_user_name');
  var savedNum = localStorage.getItem('last_zone_number');

  // ğŸš€ [ì•„ì´í° ìµœì í™”] ì´ë¦„ì€ ì €ì¥ë˜ì–´ ìˆë‹¤ë©´ ë²ˆí˜¸ ìœ ë¬´ì™€ ìƒê´€ì—†ì´ ë¬´ì¡°ê±´ ë¨¼ì € ì±„ì›Œì¤ë‹ˆë‹¤.
  if (savedName) {
    document.getElementById('nameInput').value = savedName;
  }

  // êµ¬ì—­ ë²ˆí˜¸ì™€ ì´ë¦„ì´ ë‘˜ ë‹¤ ìˆì„ ë•Œë§Œ "ìµœê·¼ ì‘ì—… êµ¬ì—­" ë²„íŠ¼ì„ í‘œì‹œí•©ë‹ˆë‹¤.
  if (savedNum && savedName) {
    // "ë²ˆ"ì„ ì‚­ì œí•˜ê³  ìˆ«ìë§Œ ì…ë ¥ë˜ê²Œ í•©ë‹ˆë‹¤.
    document.getElementById('recentNumDisplay').innerText = savedNum; 
    document.getElementById('recentArea').classList.remove('hidden');
  } else {
    document.getElementById('recentArea').classList.add('hidden');
  }
}

      function loadRecentAndStart() {
        var savedNum = localStorage.getItem('last_zone_number');

        if (savedNum) {
          // 1. êµ¬ì—­ ë²ˆí˜¸ëŠ” ì €ì¥ëœ ë²ˆí˜¸(118ë²ˆ)ë¥¼ ì±„ì›€
          document.getElementById('numberInput').value = savedNum;

          // 2. [ì¤‘ìš”] ì´ë¦„ì€ ì´ë¯¸ ì í˜€ìˆë‹¤ë©´ ë®ì–´ì“°ì§€ ì•ŠìŒ
          var nameInput = document.getElementById('nameInput');
          
          // ì´ë¦„ ì¹¸ì´ ë¹„ì–´ìˆì„ ë•Œë§Œ! ì €ì¥ëœ ì´ë¦„ì„ ê°€ì ¸ì˜´
          if (!nameInput.value.trim()) {
            var savedName = localStorage.getItem('last_user_name');
            if (savedName) {
              nameInput.value = savedName;
            }
          }

          // 3. ì‹œì‘
          handleStart();
        }
      }

      function showModal(msg) {
        if (autoLogoutTimer) clearTimeout(autoLogoutTimer);
        document.getElementById('alertMessage').innerText = msg;
        
        // ê¸°ë³¸ ë²„íŠ¼ ë™ì‘ ì´ˆê¸°í™”
        var alertModal = document.getElementById('customAlertModal');
        var okBtn = document.getElementById('alertOkBtn');
        okBtn.onclick = closeAlertModal;

        alertModal.classList.remove('hidden');
      }

/**
 * [ì‹ ê·œ] ì—ëŸ¬ ì•Œë¦¼ì„ ë„ìš°ê³  í™•ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ ì…ë ¥ì°½ì„ ì´ˆê¸°í™” ë° í¬ì»¤ìŠ¤í•©ë‹ˆë‹¤.
 */
function showAlertAndFocus(msg, clear) {
  var alertModal = document.getElementById('customAlertModal');
  var alertMsg = document.getElementById('alertMessage');
  var okBtn = document.getElementById('alertOkBtn');
  var numInput = document.getElementById('numberInput');

  alertMsg.innerText = msg;
  
  // í™•ì¸ ë²„íŠ¼ ë™ì‘ì„ ì„ì‹œë¡œ ê°€ë¡œì±”
  okBtn.onclick = function() {
    closeAlertModal();      // 1. ëª¨ë‹¬ ë‹«ê¸°
    if (clear) numInput.value = ''; // 2. ì…ë ¥ê°’ ë¹„ìš°ê¸°
    numInput.focus();       // 3. ì»¤ì„œ ë„£ê¸° (í‚¤ë³´ë“œ ì˜¬ë¦¬ê¸°)
    
    // ë²„íŠ¼ ë™ì‘ ì›ë˜ëŒ€ë¡œ(ê¸°ë³¸ ë‹«ê¸°) ë³µêµ¬
    okBtn.onclick = closeAlertModal;
  };

  alertModal.classList.remove('hidden');
}

      // ==========================================
      // âœ… [ì‹ ê·œ] í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ê¸°ëŠ¥ (Toast Function)
      // ==========================================
      let toastTimer = null;

// [ìˆ˜ì •ë¨] í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ê¸°ëŠ¥ (ìŠ¤íƒ€ì¼ ê°•ì œ ì ìš© ë²„ì „)
function showToast(msg, iconClass, duration = 3000) {
  var container = document.getElementById('toastContainer');
  var messageEl = document.getElementById('toastMessage');
  var iconEl = document.getElementById('toastIcon');

  if (!container || !messageEl || !iconEl) return;

  // 1. ë©”ì‹œì§€ ë° ì•„ì´ì½˜ ì„¤ì •
  messageEl.innerText = msg;
  iconEl.className = iconClass || "fa-solid fa-check-circle text-emerald-400 text-lg";

  // 2. íƒ€ì´ë¨¸ ì´ˆê¸°í™”
  if (typeof toastTimer !== 'undefined' && toastTimer) clearTimeout(toastTimer);

  // 3. [í•µì‹¬ ìˆ˜ì •] í´ë˜ìŠ¤ ì œê±° í›„ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ ê°•ì œ í‘œì‹œ
  // Tailwind í´ë˜ìŠ¤ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ style ì†ì„±ì„ ì§ì ‘ ê±´ë“œë¦½ë‹ˆë‹¤.
  container.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
  
  // ê°•ì œ ìŠ¤íƒ€ì¼ ì£¼ì…
  container.style.opacity = '1';
  container.style.transform = 'translate(-50%, 0)'; // í™”ë©´ ì¤‘ì•™ í•˜ë‹¨ ì •ìœ„ì¹˜
  container.style.pointerEvents = 'auto'; // í•„ìš” ì‹œ í´ë¦­ ê°€ëŠ¥

  // 4. ì§€ì •ëœ ì‹œê°„ í›„ ìˆ¨ê¸°ê¸°
  toastTimer = setTimeout(function() {
    container.style.opacity = '0';
    container.style.transform = 'translate(-50%, 20px)'; // ì•„ë˜ë¡œ ì‚´ì§ ì´ë™í•˜ë©° ì‚¬ë¼ì§
    container.style.pointerEvents = 'none';
  }, duration);
}

      // ==========================================
      // âœ… [ìˆ˜ì •] ê¸°ì¡´ ì•Œë¦¼ í•¨ìˆ˜ë¥¼ í† ìŠ¤íŠ¸ ë°©ì‹ìœ¼ë¡œ ë³€ê²½
      // ==========================================

      // 1. ì¼ë°˜ ì‚¬ìš©ì: ì €ì¥ í›„ ìë™ ë¡œê·¸ì•„ì›ƒ
      function showAutoLogoutAlert(msg) {
        if (autoLogoutTimer) clearTimeout(autoLogoutTimer);

        // í† ìŠ¤íŠ¸ ë„ìš°ê¸° (ì•„ì´ì½˜: ê±·ëŠ” ì‚¬ëŒ)
        showToast(msg, "fa-solid fa-person-walking-arrow-right text-amber-400");

        // 1.5ì´ˆ ë’¤ ë¡œê·¸ì•„ì›ƒ ì‹¤í–‰
        autoLogoutTimer = setTimeout(function() {
           handleLogoutConfirm();
        }, 1500);
      }

      // 2. ì¸ë„ì: ì €ì¥ í›„ ëŒ€ì‹œë³´ë“œ ë³µê·€
      function showLeaderReturnAlert(msg) {
        if (autoLogoutTimer) clearTimeout(autoLogoutTimer);

        // í† ìŠ¤íŠ¸ ë„ìš°ê¸° (ì•„ì´ì½˜: í´ë¦½ë³´ë“œ ì²´í¬)
        showToast(msg, "fa-solid fa-clipboard-check text-indigo-400");

        // 1.5ì´ˆ ë’¤ ëŒ€ì‹œë³´ë“œ ë³µê·€
        autoLogoutTimer = setTimeout(returnToLeaderDashboard, 1500);
      }

      function closeAlertModal() { 
        document.getElementById('customAlertModal').classList.add('hidden'); 
      }

      function getLocalKey(num) { return "ZONE_CACHE_V4_" + num; }

function handleStart() {
  if(document.activeElement) document.activeElement.blur();

  var nameInput = document.getElementById('nameInput');
  var numberInput = document.getElementById('numberInput');
  var btn = document.getElementById('loginBtn');

  var name = nameInput.value.toString().trim();
  var number = numberInput.value.toString().trim();
  
  // 1. ì´ë¦„ ë¹ˆì¹¸ ì²´í¬
  if (!name) {
    showModal(t("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."));
    return;
  }

  // ğŸš€ [ì•„ì´í° ìµœì í™” 1] ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ìë§ˆì ê¸°ê¸° ë‚´ë¶€ì— ì´ë¦„ ì €ì¥
  // ì„œë²„ ì‘ë‹µê³¼ ìƒê´€ì—†ì´ ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì´ë¦„ì„ ì¦‰ì‹œ ê¸°ì–µí•˜ë„ë¡ í•©ë‹ˆë‹¤.
  try {
    localStorage.setItem('last_user_name', name);
    // êµ¬ì—­ ë²ˆí˜¸ê°€ ì œëŒ€ë¡œ ì…ë ¥ëœ ê²½ìš°ì—ë§Œ ë²ˆí˜¸ë„ ê¸°ì–µ
    if (number && number !== "0") {
      localStorage.setItem('last_zone_number', number);
    }
  } catch (e) {
    console.warn("ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì‹¤íŒ¨:", e);
  }

  // ğŸ›‘ [1ì°¨ ê´€ë¬¸] ì´ë¦„ ë“±ë¡ ì—¬ë¶€ ì¦‰ì‹œ í™•ì¸ (ë¡œì»¬ ìºì‹œ ì‚¬ìš©)
  if (localUserCache) {
    if (!localUserCache.hasOwnProperty(name)) {
       showModal(t("ë“±ë¡ëœ ì´ë¦„ì´ ì•„ë‹™ë‹ˆë‹¤."));
       return; 
    }
  }

  // ğŸš€ [2ì°¨ ê´€ë¬¸] êµ¬ì—­ë²ˆí˜¸ê°€ ì—†ì„ ë•Œ (ì¸ë„ì/ì¼ë°˜ êµ¬ë¶„)
  if (number === "" || number === "0") {
    if (localUserCache) {
      var user = localUserCache[name];
      if (user && user.leader === 'Y') {
        showPasswordModalAndFocus();
      } else {
        showAlertAndFocus(t("êµ¬ì—­ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
      }
      return;
    }

    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>í™•ì¸ ì¤‘...';
    btn.disabled = true;

    google.script.run
      .withSuccessHandler(function(res) {
        btn.innerHTML = t("ì‹œì‘í•˜ê¸°");
        btn.disabled = false;
        
        if (!res.success && res.message && res.message.indexOf("ë“±ë¡ëœ ì´ë¦„") !== -1) {
           showModal(t("ë“±ë¡ëœ ì´ë¦„ì´ ì•„ë‹™ë‹ˆë‹¤."));
           return;
        }
        
        if (res.isLeader || (res.message && res.message.indexOf("ì¸ë„ì ì•”í˜¸") !== -1)) {
          showPasswordModalAndFocus();
        } else {
          showAlertAndFocus(t("êµ¬ì—­ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."));
        }
      })
      .withFailureHandler(function(e) {
        btn.innerHTML = t("ì‹œì‘í•˜ê¸°");
        btn.disabled = false;
        showModal(t("ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ") + e.message);
      })
      .processLogin(name, "0", "", false);

    return;
  }

  // ğŸ  [3ì°¨ ê´€ë¬¸] êµ¬ì—­ ë²ˆí˜¸ ê²€ì¦ (ì¼ë°˜ ë¡œê·¸ì¸)
  if (typeof availableZones !== 'undefined' && availableZones.length > 0) {
    if (availableZones.indexOf(number) === -1) {
      showAlertAndFocus(t("{num}ë²ˆ êµ¬ì—­ì¹´ë“œëŠ” ì—†ìŠµë‹ˆë‹¤.").replace("{num}", number), true);
      return;
    }
  }
  
  // ëª¨ë“  ê²€ì¦ í†µê³¼ -> ì„œë²„ë¡œ ì ‘ì† ìš”ì²­
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>' + t("ì ‘ì† ì¤‘");
  btn.disabled = true;
  processLoginRequest(name, number, "");
}

      // ê¸°ì¡´ closePasswordModal í•¨ìˆ˜ë¥¼ ì´ê±¸ë¡œ êµì²´í•˜ì„¸ìš”

      function closePasswordModal() {
        document.getElementById('passwordModal').classList.add('hidden');
        document.getElementById('modalPasswordInput').value = '';
        isAuthModeInZone = false; // â˜… ì¶”ê°€: ì·¨ì†Œ ì‹œ í”Œë˜ê·¸ ë„ê¸°
      }

// [ìˆ˜ì •ë¨] ë²„íŠ¼ í´ë¦­ ì‹œ ë™ì‘ (í† ê¸€ ê¸°ëŠ¥)
function openAdminAuth() {
  // [CASE A] ì´ë¯¸ í¸ì§‘ ëª¨ë“œ(ì—´ë¦¼) ìƒíƒœë¼ë©´? -> ì¢…ë£Œ(ì ê¸ˆ) ì²˜ë¦¬
  if (isLeaderLoggedIn) {
    
    // ì„œë²„ì— ì ê¸ˆ í•´ì œ ìš”ì²­ (UNLOCK)
    google.script.run.manageEditingLock(currentNumber, currentUserName, 'UNLOCK');

    isLeaderLoggedIn = false; // ê¶Œí•œ í•´ì œ
    
    // â˜… í•µì‹¬: í¸ì§‘ì´ ëë‚¬ìœ¼ë¯€ë¡œ ìë¬¼ì‡ ë¥¼ ë‹«ìŒ (false)
    updateLockIcon(false);
    
    // ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ê·¸ë ¤ì„œ í†±ë‹ˆë°”í€´ ìˆ¨ê¸°ê¸°
    renderList(); 
    
    // ì¢…ë£Œ ì•Œë¦¼
    showToast(t("í¸ì§‘ ëª¨ë“œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."), "fa-solid fa-lock text-slate-400");
    return;
  }
  
  // [CASE B] í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹ˆë¼ë©´? -> ì•”í˜¸ ì…ë ¥ì°½ ì—´ê¸°
  isAuthModeInZone = true;
  
  // â˜…â˜…â˜… [ìˆ˜ì •ë¨] ì—¬ê¸°ê°€ í•µì‹¬ì…ë‹ˆë‹¤! (ê¸°ì¡´ setTimeout ì œê±° í›„ í—¬í¼ í•¨ìˆ˜ ì‚¬ìš©) â˜…â˜…â˜…
  showPasswordModalAndFocus();
}

// [ìˆ˜ì •ë¨] ì•”í˜¸ ì œì¶œ ë° ì ê¸ˆ íšë“ ì²˜ë¦¬
function submitLeaderPassword() {
  var password = document.getElementById('modalPasswordInput').value.toString().trim();
  
  // êµ¬ì—­ ë‚´ë¶€ ì¸ì¦ì¼ ë•Œ (ìë¬¼ì‡  ë²„íŠ¼ í´ë¦­ ì‹œ)
  if (isAuthModeInZone) {
    if (!currentUserName) {
      showToast("ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.", "fa-solid fa-triangle-exclamation text-red-400");
      return;
    }
    
    closePasswordModal();
    showToast(t("ê¶Œí•œ í™•ì¸ ì¤‘..."), "fa-solid fa-spinner fa-spin text-white");

    google.script.run
      .withSuccessHandler(function(res) {
        if (res.success) {
          // ì¸ì¦ ì„±ê³µ -> ì„œë²„ì— 'LOCK' ìš”ì²­ (ë‚˜ í¸ì§‘í• ê±°ì•¼!)
          google.script.run
            .withSuccessHandler(function(lockRes) {
               if (lockRes.success) {
                 // ë½ íšë“ ì„±ê³µ ì‹œ -> í¸ì§‘ ëª¨ë“œ ì§„ì…
                 isLeaderLoggedIn = true;
                 isAuthModeInZone = false;
                 
                 // â˜… í•µì‹¬: í¸ì§‘ ì‹œì‘ì´ë¯€ë¡œ ìë¬¼ì‡ ë¥¼ ì—´ìŒ (true)
                 updateLockIcon(true);
                 
                 showToast(t("í¸ì§‘ ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤."), "fa-solid fa-lock-open text-emerald-400");
                 renderList(); 
               } else {
                 // ì´ë¯¸ ëˆ„ê°€ í¸ì§‘ ì¤‘ì¼ ë•Œ
                 showToast(lockRes.message, "fa-solid fa-ban text-red-400");
                 isAuthModeInZone = false;
               }
            })
            .manageEditingLock(currentNumber, currentUserName, 'LOCK');
            
        } else {
          showToast(res.message, "fa-solid fa-triangle-exclamation text-red-400");
          isAuthModeInZone = false;
        }
      })
      .withFailureHandler(function(e) {
        showToast(t("ì¸ì¦ ì˜¤ë¥˜: ") + e, "fa-solid fa-bomb text-red-400");
        isAuthModeInZone = false;
      })
      .verifyLeaderPassword(currentUserName, password);

    return;
  }

  // (ê¸°ì¡´ ë¡œê·¸ì¸ í™”ë©´ì—ì„œì˜ ë¡œì§ ìœ ì§€)
  var name = document.getElementById('nameInput').value;
  var number = "0"; 
  closePasswordModal();
  var btn = document.getElementById('loginBtn');
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ì¸ì¦ ì¤‘...';
  btn.disabled = true;
  processLoginRequest(name, number, password);
}


      // [ìˆ˜ì •] ë¡œê·¸ì¸ ìš”ì²­ ì²˜ë¦¬: ë¡œë”© ë©”ì‹œì§€ë¥¼ ë¶„ë¦¬í•˜ì—¬ ì „ë‹¬
// [ìˆ˜ì •ë¨] 4ë²ˆì§¸ ì¸ì forceRefresh ì¶”ê°€
function processLoginRequest(name, number, password, forceRefresh) { // <--- 1. ì—¬ê¸°ì— forceRefresh ì¶”ê°€
  currentUserName = name;
  currentNumber = number;
  var btn = document.getElementById('loginBtn');

  var localDataJson = localStorage.getItem(getLocalKey(number));
  var isLocalLoaded = false;

  // ë§¤ ë¡œê·¸ì¸ë§ˆë‹¤ í”Œë˜ê·¸ ì´ˆê¸°í™”
  lastLoginUsedLocalCache = false;

  // [ìˆ˜ì •ë¨] ê°•ì œ ê°±ì‹ (forceRefresh)ì´ ì•„ë‹ ë•Œë§Œ ë¡œì»¬ ìºì‹œë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
  if (!forceRefresh && number !== "0" && localDataJson) { // <--- 2. ì¡°ê±´ë¬¸ì— !forceRefresh ì¶”ê°€
    try {
      var parsed = JSON.parse(localDataJson);
      
      // ë³´ì•ˆ ê°•í™”: ì…ë ¥í•œ ì´ë¦„ì´ ìºì‹œëœ ì´ë¦„ê³¼ ê°™ì„ ë•Œë§Œ ë¯¸ë¦¬ ë¡œë”©
      if (!parsed.isLeader && parsed.userName === currentUserName) { 
        // ì´ë¦„ì´ ê°™ìœ¼ë©´ ë³¸ì¸ì´ë¯€ë¡œ ìºì‹œ ì¦‰ì‹œ ë¡œë”© (ì†ë„ í–¥ìƒ)
        lastLoginUsedLocalCache = true;
        
        // ë°°ê²½ ë¡œë”© ëª¨ë“œ: ìƒë‹¨ ë°°ì§€ "ë™ê¸°í™” ì¤‘..."
        applyDataToView(parsed, true);
        isLocalLoaded = true;
      } else {
        // ì´ë¦„ì´ ë‹¤ë¥´ë©´(ë‹¤ë¥¸ ì‚¬ëŒì´ê±°ë‚˜ ì˜¤íƒ€) ìºì‹œë¥¼ ì“°ì§€ ì•Šê³  ì„œë²„ í™•ì¸ì„ ê¸°ë‹¤ë¦¼
        console.log("ì‚¬ìš©ì ë³€ê²½ ê°ì§€: ìºì‹œ í”„ë¦¬ë¡œë”© ê±´ë„ˆëœ€ (ë³´ì•ˆ)");
      }
      
    } catch (e) {
      console.log("ë¡œì»¬ ìºì‹œ íŒŒì‹± ì‹¤íŒ¨:", e);
      lastLoginUsedLocalCache = false;
    }
  }

  // ë¡œë”© ë©”ì‹œì§€ ë¶„ë¦¬ ì„¤ì •
  var loadingMsg = "";

if (number === "0" || number === "") {
  // ì¸ë„ììš© ì „ì²´ ëŒ€ì‹œë³´ë“œ ë¡œë”©
  loadingMsg = t("ì¸ë„ì ëŒ€ì‹œë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."); 
} else {
  // íŠ¹ì • êµ¬ì—­ ë²ˆí˜¸ ë¡œë”© (ì˜ˆ: "5ë²ˆ êµ¬ì—­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...")
  loadingMsg = number + t("ë²ˆ êµ¬ì—­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."); 
}

  // ìºì‹œë¡œë„ ëª» ë„ì› ë‹¤ë©´ ë¡œë”© ì˜¤ë²„ë ˆì´ (ìºì‹œê°€ ì—†ê±°ë‚˜, ì´ë¦„ì´ ë‹¬ë¼ì„œ ê±´ë„ˆë›´ ê²½ìš°)
  if (!isLocalLoaded) {
    showLoading(true, loadingMsg);
  }

  google.script.run
    .withSuccessHandler(function(res) {
      btn.innerHTML = t("ì‹œì‘í•˜ê¸°");
      btn.disabled = false;
      showLoading(false);
      onLoginSuccess(res);
    })
    .withFailureHandler(function(e) {
      btn.innerHTML = t("ì‹œì‘í•˜ê¸°");
      btn.disabled = false;
      showLoading(false);
      
      console.error(t("ì„œë²„ ë™ê¸°í™” ì‹¤íŒ¨:"), e);

      if (isLocalLoaded) {
          showToast(t("ì„œë²„ ë™ê¸°í™” ì‹¤íŒ¨: ") + (e.message || t("ì—°ê²° ì˜¤ë¥˜")), "fa-solid fa-triangle-exclamation text-red-400");
        
        var badge = document.getElementById('statusBadge');
        if(badge) {
          badge.innerText = t("ì—°ê²° ëŠê¹€");
          badge.className = "text-[11px] bg-gray-500 text-white px-2 py-0.5 rounded-full font-bold";
        }
      } else {
        onFailure(e);
      }
    })
    // [ìˆ˜ì •ë¨] ì„œë²„ë¡œ 4ë²ˆì§¸ ì¸ì(forceRefresh)ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.
    .processLogin(name, number, password, forceRefresh); // <--- 3. ì—¬ê¸°ì— forceRefresh ì¶”ê°€
}     
      // *** processLoginRequest ë ***




      function checkStatusBadge(statusText) {
  var badge = document.getElementById('statusBadge');
  
  // 1. ê¸°ë³¸ê°’ ì„¤ì • (statusTextê°€ ì—†ìœ¼ë©´ "í˜¸ë³„" í‚¤ ì‚¬ìš©)
  var key = statusText || "í˜¸ë³„"; 
  
  // 2. ë‹¤êµ­ì–´ ë°ì´í„°ì—ì„œ í•´ë‹¹ í‚¤ì˜ ë²ˆì—­ì–´ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ í‚¤ ê·¸ëŒ€ë¡œ ë…¸ì¶œ)
  var translatedText = (translations[key] && translations[key][currentLang]) 
                        ? translations[key][currentLang] 
                        : key;
  
  badge.innerText = translatedText;
  
  // 3. ìŠ¤íƒ€ì¼ ì ìš© (ë¹„êµëŠ” ë°ì´í„°ì˜ ì›í˜•ì¸ 'key'ë¡œ ìˆ˜í–‰)
  if (key === "ì™„ë£Œ") {
     badge.className = "text-[11px] bg-zinc-600 text-white px-2 py-0.5 rounded-full font-bold shadow-sm transition-all align-middle";
  } else if (key === "ë¶€ì¬") {
     badge.className = "text-[11px] bg-amber-500 text-white px-2 py-0.5 rounded-full font-bold shadow-sm transition-all align-middle";
  } else { // "í˜¸ë³„" ë˜ëŠ” ê¸°ë³¸ê°’
     badge.className = "text-[11px] bg-emerald-500 text-white px-2 py-0.5 rounded-full font-bold backdrop-blur-md shadow-sm transition-all align-middle";
  }
}

function applyDataToView(res, isBackgroundLoading) {
  if (res.isLeader) return; 
  
  if (res.userName !== currentUserName || (res.requestNumber && String(res.requestNumber) !== String(currentNumber))) {
      return;
  }

  localStorage.setItem('last_user_name', currentUserName);
  localStorage.setItem('last_zone_number', currentNumber);

  var loginView = document.getElementById('loginView');
  loginView.classList.add('translate-y-full');
  setTimeout(function() {
      loginView.classList.add('hidden');
  }, 300);

  document.getElementById('leaderView').classList.add('hidden'); 
  document.getElementById('mainView').classList.remove('hidden');
  document.getElementById('headerTarget').innerText = res.target;
  
  currentData = res.data;

  var g1Value = "";
  if (res.data && res.data.length > 0 && res.data[0]) {
    g1Value = (res.data[0][6] || "").toString().trim();
  }

  var headerImgEl = document.getElementById('headerInfoImage');
  var mapContainerEl = document.getElementById('mapContainer');
  var addrHeader = document.getElementById('headerAddress');
  var imgWrapper = document.getElementById('imageWrapper');
  var contentArea = document.getElementById('contentArea');

  // [ì´ˆê¸°í™” ë¡œì§]
  [imgWrapper, mapContainerEl].forEach(el => {
    if (el) {
      el.style.marginTop = "0px";
      el.style.marginBottom = "0px";
      el.style.padding = "0px";
      el.style.height = "400px";
      el.style.display = "none";
      el.classList.add('hidden');
    }
  });

  if (contentArea) {
    contentArea.style.paddingTop = "0px";
    contentArea.style.marginTop = "0px";
  }

  // [ì´ë¯¸ì§€ vs ì§€ë„ ì²˜ë¦¬]
  if (g1Value.indexOf('http') === 0) {
    var finalImgUrl = g1Value;
    var driveMatch = g1Value.match(/\/d\/([a-zA-Z0-9_-]+)/);
    if (driveMatch && driveMatch[1]) {
        var fileId = driveMatch[1];
        finalImgUrl = "https://lh3.googleusercontent.com/d/" + fileId;
    }

    if (headerImgEl) {
        headerImgEl.src = finalImgUrl;
        headerImgEl.style.width = "100%";
        headerImgEl.style.height = "100%";
        headerImgEl.style.objectFit = "fill";
        headerImgEl.style.display = "block";
        
        if (imgWrapper) {
            imgWrapper.classList.remove('hidden');
            imgWrapper.style.display = "block";
            imgWrapper.style.marginBottom = "-1px";
        }
        headerImgEl.classList.remove('hidden'); 

        if (headerImgEl.panzoomInstance) {
            headerImgEl.panzoomInstance.destroy();
        }
        
        setTimeout(function() {
            var instance = Panzoom(headerImgEl, {
                maxScale: 5,
                minScale: 1,
                contain: 'outside', 
                startScale: 1
            });
            if (headerImgEl.parentElement) {
                headerImgEl.parentElement.addEventListener('wheel', instance.zoomWithWheel);
            }
            headerImgEl.panzoomInstance = instance;
        }, 100);
    }
    if (addrHeader) addrHeader.innerHTML = "";

  } else {
    if (headerImgEl) {
        headerImgEl.style.display = "none";
        headerImgEl.src = ""; 
        if (headerImgEl.panzoomInstance) {
            headerImgEl.panzoomInstance.destroy();
            headerImgEl.panzoomInstance = null;
        }
    }

    if (res.data && res.data.length > 1) {
      var searchAddr = "";
      for (var i = 1; i < res.data.length; i++) {
          var row = res.data[i];
          var colA = row[0] ? row[0].toString().trim() : "";
          var colB = row[1] ? row[1].toString().trim() : "";
          if (colA === "" || colA.indexOf('*') === 0) continue;
          searchAddr = (colA + " " + colB).trim();
          break; 
      }

      if(searchAddr === "") searchAddr = res.target; 
      mapAddressTarget = searchAddr;
      
      if (mapContainerEl) {
          mapContainerEl.classList.remove('hidden');
          mapContainerEl.style.display = "block";
          mapContainerEl.style.marginTop = "0px";
      }

      setTimeout(function() {
          updateMapPreview(searchAddr); 
      }, 100);

      if (addrHeader) addrHeader.innerHTML = ""; 

    } else {
        if (mapContainerEl) mapContainerEl.style.display = "none";
        if (addrHeader) addrHeader.innerText = "ë°ì´í„° ì—†ìŒ";
    }
  }

  var badge = document.getElementById('statusBadge');
  if (isBackgroundLoading) {
      badge.innerText = t("ë™ê¸°í™” ì¤‘...");
      badge.className = "text-[11px] bg-gray-400 text-white px-2 py-0.5 rounded-full font-bold animate-pulse";
  }

  /**
   * ğŸš© [ë§ˆí¬ ë°ì´í„° ì²˜ë¦¬] (ê¹œë¹¡ì„ í•´ê²°ì˜ í•µì‹¬)
   * renderList()ë¥¼ í˜¸ì¶œí•˜ê¸° ì „ì— ì „ì—­ ë³€ìˆ˜(currentMarkIndex)ë¥¼ í™•ì‹¤íˆ ì„¸íŒ…í•©ë‹ˆë‹¤.
   * ì„œë²„ì—ì„œ ë°ì´í„°ê°€ ì˜¤ë©´(res.markData), ë¡œì»¬ ë³€ìˆ˜ë¥¼ ì¦‰ì‹œ ë®ì–´ì”Œì›Œ ì¼ì¹˜ì‹œí‚µë‹ˆë‹¤.
   */
  if (res.markData) {
    // ì¸ë±ìŠ¤ê°€ ë¹„ì–´ìˆê±°ë‚˜ nullì´ë©´ -1ë¡œ, ê°’ì´ ìˆìœ¼ë©´ ìˆ«ìë¡œ ë³€í™˜
    currentMarkIndex = (res.markData.index === "" || res.markData.index === null) 
                       ? -1 : parseInt(res.markData.index, 10);
    currentMarkInfo = res.markData.info || "";
  }
  
  if (!isBackgroundLoading) {
    currentZoneStatus = res.zoneStatus || "í˜¸ë³„"; 
    checkStatusBadge(currentZoneStatus);
  }
  
  renderList(); // ğŸ¨ ë§ˆí¬ ì •ë³´ê°€ ì„¸íŒ…ëœ ì§í›„ì— ë¦¬ìŠ¤íŠ¸ë¥¼ ê·¸ë¦½ë‹ˆë‹¤.
  recalculateLocalStats(); // âœ… [ì¶”ê°€] ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ ì§í›„ ë°©ë¬¸ìœ¨ì„ ê³„ì‚°í•˜ê³  ì•Œì•½ì„ í‘œì‹œí•©ë‹ˆë‹¤.


  // [ìŠ¤í¬ë¡¤ ì´ë™] ë Œë”ë§ì´ ì™„ë£Œëœ í›„ ë§ˆí¬ ìœ„ì¹˜ë¡œ ë¶€ë“œëŸ½ê²Œ ì´ë™
  if (currentMarkIndex !== -1 && !isBackgroundLoading) {
      var targetCard = document.getElementById('card-' + currentMarkIndex);
      var container = document.getElementById('contentArea');
      if (targetCard && container) {
          // í™”ë©´ ì¤‘ì•™ ê·¼ì²˜ì— ì˜¤ë„ë¡ ìœ„ì¹˜ ì¡°ì •
          container.scrollTop = targetCard.offsetTop - (container.offsetHeight / 3);
      }
  }
}


function updateMapPreview(address) {
    var container = document.getElementById('mapContainer');
    var iframe = document.getElementById('googleMapFrame');

    if (!address) {
        container.classList.add('hidden');
        return;
    }

    // [ìµœì¢… í•´ê²°ì±…] 404 ì—ëŸ¬ê°€ ì—†ëŠ” í‘œì¤€ êµ¬ê¸€ ë§µ ì„ë² ë“œ ì£¼ì†Œì…ë‹ˆë‹¤.
    // maps.google.com/maps ê²½ë¡œì— output=embedë¥¼ ë¶™ì´ëŠ” ê²ƒì´ ê°€ì¥ ì •í™•í•©ë‹ˆë‹¤.
    var embedUrl = "https://maps.google.com/maps?q=" + encodeURIComponent(address) + "&t=m&z=17&output=embed&iwloc=near";

    // ì¤‘ë³µ ë¡œë”© ë°©ì§€ (ê¹œë¹¡ì„ ì œê±°)
    if (address === lastLoadedMapAddress && iframe.src === embedUrl) {
        container.classList.remove('hidden');
        return;
    }

    lastLoadedMapAddress = address;
    iframe.src = embedUrl;
    container.classList.remove('hidden');
}


function openNativeMap() {
  if (!mapAddressTarget) return;

  var target = mapAddressTarget;
  // ì£¼ì†Œì— #map êµ¬ë¶„ìê°€ ìˆë‹¤ë©´ ë’·ë¶€ë¶„ë§Œ ì¶”ì¶œ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
  if (target.indexOf('#map') !== -1) {
    target = target.split('#map')[1].trim();
  }

  // ê²€ìƒ‰ URL ëì— #mapì„ ê°•ì œë¡œ ë¶™ì—¬ì„œ 'ì»¤ì§„ ì§€ë„'ë¡œ ë°”ë¡œ ë³´ëƒ…ë‹ˆë‹¤.
  var naverUrl = "https://m.map.naver.com/search2/search.naver?query=" 
                 + encodeURIComponent(target) 
                 + "#map";
                 
  window.open(naverUrl, '_blank');
}

/**
 * [ìµœì¢… ì™„ì„±ë³¸] ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬
 * 1. ì¸ë„ì/ì „ë„ì¸ ê·¸ë£¹ë³„ UI ì „í™˜
 * 2. ì¼ë°˜ ë°ì´í„° ë™ê¸°í™” (30ì´ˆ) ë° SOS ê³ ì† ê°ì‹œ (5ì´ˆ) ì´ì›í™” ìš´ì˜
 * 3. ë§ˆí¬ ê¹œë¹¡ì„ ë°©ì§€ ë° ë¡œì»¬ ìºì‹œ ìµœì í™” ì ìš©
 */
function onLoginSuccess(res) {
  
  try {
    // 1) ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
    if (!res.success) {
      if (res.message && res.message.indexOf("ì—†ìŠµë‹ˆë‹¤") !== -1) {
        showAlertAndFocus(res.message, true); 
      } 
      else if (document.getElementById('mainView').classList.contains('hidden') === false) {
        showToast(res.message, "fa-solid fa-triangle-exclamation text-amber-400");
      } 
      else {
        showModal(res.message);
      }
      return;
    }

    initHistoryStack();

    // ğŸ“… ë¡œê·¸ì¸ ì„±ê³µ ì‹œì ì˜ ë‚ ì§œ ê¸°ë¡ (ìì • ì²´í¬ìš©)
    sessionStartDate = new Date().toDateString(); 

    // â˜… ì‹œìŠ¤í…œ ì„¤ì •ê°’ ì ìš© ë° ì „ì—­ ë³€ìˆ˜ ì €ì¥
    if (res.settings) {
      globalSettings = res.settings; 
      CONFIG_SYNC_INTERVAL = Math.max(2000, res.settings.syncMin * 60 * 1000);
      CONFIG_ALIVE_INTERVAL = res.settings.aliveMin * 60 * 1000;
      serverSavedBellEnabled = res.settings.isBellEnabled || "N";
    }

    // 2) ì¼ë°˜ ì‚¬ìš©ì ë°±ê·¸ë¼ìš´ë“œ ì ‘ì† ê¸°ë¡
    if (!res.isLeader) {
      var tryRecordLogin = function(isRetry) {
        google.script.run
          .withFailureHandler(function(e) { 
              if (!isRetry) setTimeout(function() { tryRecordLogin(true); }, 3000);
          })
          .asyncRecordLogin(res.requestNumber, res.userName, currentLang);
      };
      tryRecordLogin(false);
    }

    // 3) ğŸ‘‘ ì¸ë„ì(ê´€ë¦¬ì) ë¡œê·¸ì¸ ì²˜ë¦¬
    if (res.isLeader) {
      if (syncTimer) clearTimeout(syncTimer);
      isSyncing = false;
      isLeaderLoggedIn = true;
      cameFromLeader = false;
      leaderDashboardData = res.dashboardData || null;
      
      var loginView = document.getElementById('loginView');
      if (loginView) {
        loginView.classList.add('translate-y-full');
        setTimeout(function() { loginView.classList.add('hidden'); }, 300);
      }
      
      document.getElementById('mainView').classList.add('hidden');
      document.getElementById('leaderView').classList.remove('hidden');
      
      const welcomeMsg = t("{name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤").replace("{name}", res.userName);
      document.getElementById('leaderNameDisplay').innerText = welcomeMsg;
      
      updateBellOptionButton(serverSavedBellEnabled);
      renderLeaderDashboard(res.dashboardData);
      
      // ğŸ•’ [ë°ì´í„° ê°±ì‹ ] ì¸ë„ì ëŒ€ì‹œë³´ë“œ 30ì´ˆ ì£¼ê¸° ì—…ë°ì´íŠ¸
      if (leaderTimer) clearInterval(leaderTimer);
      leaderTimer = setInterval(refreshLeaderDashboardInBackground, 30000); 

      // ğŸ†˜ [SOS ê³ ì† ê°ì‹œ] ì¸ë„ì ëŒ€ì‹œë³´ë“œ ì§„ì… ì¦‰ì‹œ 5ì´ˆ ì£¼ê¸° ê°ì‹œ ì‹œì‘!
      startSOSMonitoring(); 

      if (res.settings && res.settings.notice) {
        setTimeout(function() { showNotice(res.settings.notice); }, 800);
      }
      return; // ì¸ë„ì ì²˜ë¦¬ ì¢…ë£Œ (SOS ê°ì‹œë¥¼ ì‹œì‘í•œ í›„ ì•ˆì „í•˜ê²Œ ì¢…ë£Œ)
    }

    // 4) ì¼ë°˜ ì‚¬ìš©ì ë¡œê·¸ì¸ ì²˜ë¦¬
    if (res.requestNumber && String(res.requestNumber) !== String(currentNumber)) return;

    // ğŸ [ë§ˆí¬ ê¹œë¹¡ì„ ë°©ì§€] applyDataToView ì‹¤í–‰ ì „ ì¸ë±ìŠ¤ ë¨¼ì € í• ë‹¹
    if (res.markData && res.markData.index !== "" && res.markData.index !== null) {
        currentMarkIndex = parseInt(res.markData.index, 10);
        currentMarkInfo = res.markData.info;
    } else {
        currentMarkIndex = -1;
        currentMarkInfo = "";
    }

    saveToLocalStorage(getLocalKey(currentNumber), res);
    applyDataToView(res, false);
    lastLoginUsedLocalCache = false;

    // ğŸ†˜ [SOS ê³ ì† ê°ì‹œ] ì¼ë°˜ ì‚¬ìš©ì í™”ë©´ì—ì„œë„ 5ì´ˆ ì£¼ê¸° ê°ì‹œ ì‹œì‘
    startSOSMonitoring();

    // íƒ€ì´ë¨¸ ì‹œì‘ (ìƒì¡´ ì‹ ê³  ë° ì¼ë°˜ ë°ì´í„° ë™ê¸°í™”)
    startKeepAlive();
    startSync();

    // â–¼â–¼â–¼ [ì¶”ê°€ë¨] ì¼ë°˜ êµ¬ì—­ ì§„ì… ì‹œ ì—°ê²° ì„±ê³µ ì•Œë¦¼ â–¼â–¼â–¼
    showToast(t("ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤."), "fa-solid fa-wifi text-emerald-400");
    // â–²â–²â–² ì¶”ê°€ ë â–²â–²â–²

    sosAlarm.play().then(() => {
      sosAlarm.pause(); // ì¬ìƒë˜ìë§ˆì ë©ˆì¶¤ (ê¶Œí•œ íšë“ìš©)
      sosAlarm.currentTime = 0;
    }).catch(e => console.log("ì´ˆê¸° ë¬´ìŒ ì¬ìƒ ì‹¤íŒ¨(ì •ìƒ):", e));

    if (res.settings && res.settings.notice) {
      setTimeout(function() { showNotice(res.settings.notice); }, 800);
    }

  } catch (err) {
    console.error("Login Process Error:", err);
    showToast("ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "fa-solid fa-bug text-red-400");
  }
}


      function getZoneColorClass(num) {
        const n = parseInt(num, 10);
        if (isNaN(n)) {
          return "bg-slate-50 text-slate-800 border-slate-200 hover:bg-slate-100";
        }

        const h = Math.floor(n / 100);

        switch (h) {
          case 1: return "bg-amber-50 text-amber-900 border-amber-300 hover:bg-amber-100";
          case 2: return "bg-sky-50 text-sky-900 border-sky-300 hover:bg-sky-100";
          case 3: return "bg-violet-50 text-violet-900 border-violet-300 hover:bg-violet-100";
          case 4: return "bg-rose-50 text-rose-900 border-rose-300 hover:bg-rose-100";
          case 5: return "bg-emerald-50 text-emerald-900 border-emerald-300 hover:bg-emerald-100";
          case 6: return "bg-indigo-50 text-indigo-900 border-indigo-300 hover:bg-indigo-100";
          case 7: return "bg-lime-50 text-lime-900 border-lime-300 hover:bg-lime-100";
          case 8: return "bg-cyan-50 text-cyan-900 border-cyan-300 hover:bg-cyan-100";
          case 9: return "bg-fuchsia-50 text-fuchsia-900 border-fuchsia-300 hover:bg-fuchsia-100";
          default: return "bg-slate-50 text-slate-800 border-slate-200 hover:bg-slate-100";
        }
      }

      


      
// [ì „ì—­ ë³€ìˆ˜] ëª¨ë“œ ì„ íƒ ëŒ€ê¸° ì¤‘ì¸ êµ¬ì—­ ë²ˆí˜¸
let pendingLeaderZoneNum = null;

// 1. ëŒ€ì‹œë³´ë“œì—ì„œ êµ¬ì—­ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜ (ëª¨ë‹¬ ì—´ê¸°)
function enterZoneAsLeader(number) {
  pendingLeaderZoneNum = number;
  var numSpan = document.getElementById('targetLeaderZoneNum');
  if (numSpan) numSpan.innerText = number + "ë²ˆ";
  
  document.getElementById('leaderModeSelectModal').classList.remove('hidden');
}

// 2. ëª¨ë‹¬ ë‹«ê¸° (ì·¨ì†Œ/X ë²„íŠ¼)
function closeLeaderModeModal() {
  document.getElementById('leaderModeSelectModal').classList.add('hidden');
  pendingLeaderZoneNum = null;
}

// 3. ëª¨ë“œ ì„ íƒ í™•ì • (EDIT ë˜ëŠ” VIEW)
function confirmLeaderMode(mode) {
  if (!pendingLeaderZoneNum) return;
  var num = pendingLeaderZoneNum;
  closeLeaderModeModal(); // ëª¨ë‹¬ ë‹«ê³ 
  realEnterZoneAsLeader(num, mode); // ì‹¤ì œ ì…ì¥ ë¡œì§ ì‹¤í–‰
}

// 4. ì‹¤ì œ ì…ì¥ ì²˜ë¦¬ ë¡œì§ (ë¬¸êµ¬ ìˆ˜ì •ë¨)
function realEnterZoneAsLeader(number, mode) {
  var name = document.getElementById('nameInput').value || currentUserName || "";
  if (!name) {
    showModal("ì´ë¦„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ ì£¼ì„¸ìš”.");
    return;
  }

  // ìë™ ê°±ì‹  íƒ€ì´ë¨¸ ì¤‘ì§€
  if (leaderTimer) {
    clearInterval(leaderTimer);
    leaderTimer = null;
  }

  currentUserName = name;
  currentNumber = number.toString();
  
  // â˜… ì¤‘ìš”: ëŒ€ì‹œë³´ë“œì—ì„œ ì™”ìŒì„ í‘œì‹œ
  cameFromLeader = true; 

  // â˜… ëª¨ë“œì— ë”°ë¼ ê¶Œí•œ ë¶„ê¸° ì²˜ë¦¬
  if (mode === 'EDIT') {
      isLeaderLoggedIn = true;  // í¸ì§‘ ë„êµ¬ ë³´ì„
  } else {
      isLeaderLoggedIn = false; // í¸ì§‘ ë„êµ¬ ìˆ¨ê¹€ (ì¼ë°˜ ëª¨ë“œì²˜ëŸ¼ ë™ì‘)
  }

  document.getElementById('numberInput').value = currentNumber;
  
  // [ë¬¸êµ¬ ìˆ˜ì •] ë³´ê¸° ëª¨ë“œ -> ì¼ë°˜ ëª¨ë“œ
  var loadingMsg = (mode === 'EDIT') 
      ? currentNumber + t("ë²ˆ êµ¬ì—­ (í¸ì§‘ ëª¨ë“œ) ì ‘ì† ì¤‘") 
      : currentNumber + t("ë²ˆ êµ¬ì—­ (ê¸°ë³¸ ëª¨ë“œ) ì ‘ì† ì¤‘");
  
  showLoading(true, loadingMsg);

  // ë¡œì»¬ ìºì‹œ ì¦‰ì‹œ ë¡œë”©
  var localKey = getLocalKey(currentNumber);
  var localData = localStorage.getItem(localKey);
  var isCachedLoaded = false;

  if (localData) {
    try {
      var parsed = JSON.parse(localData);
      applyDataToView(parsed, true); 
      isCachedLoaded = true;
      updateLockIcon(mode === 'EDIT');
    } catch (e) {}
  }

  // ì„œë²„ ìš”ì²­
  google.script.run
    .withSuccessHandler(function(res) {
      showLoading(false); 
      onLoginSuccess(res); 

      // [í¸ì§‘ ëª¨ë“œ]
      if (mode === 'EDIT' && res.success) {
        updateLockIcon(true); 

        google.script.run
          .withSuccessHandler(function(lockRes) {
             if (!lockRes.success) {
               showToast("ì´ë¯¸ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ í¸ì§‘ ì¤‘ì…ë‹ˆë‹¤. ê¸°ë³¸ ëª¨ë“œë¡œ ì „í™˜ë©ë‹ˆë‹¤.", "fa-solid fa-ban text-red-400");
               isLeaderLoggedIn = false;
               updateLockIcon(false);
               renderList(); 
             } else {
               showToast("í¸ì§‘ ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.", "fa-solid fa-pen-to-square text-emerald-400");
             }
          })
          .manageEditingLock(currentNumber, currentUserName, 'LOCK');
      } 
      // [ì¼ë°˜ ëª¨ë“œ] (ë¬¸êµ¬ ìˆ˜ì •ë¨)
      else {
        updateLockIcon(false); // ìë¬¼ì‡  ë‹«í˜
        if(res.success) {
            showToast("ê¸°ë³¸ ëª¨ë“œ(ì „ë„ì¸)ë¡œ ì ‘ì†í–ˆìŠµë‹ˆë‹¤.", "fa-solid fa-user text-indigo-400");
        }
      }
    })
    .withFailureHandler(function(e) {
      showLoading(false);
      if (!isCachedLoaded) {
        showModal("êµ¬ì—­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + (e.message || e));
        cameFromLeader = false;
      }
    })
    .processLogin(name, currentNumber, "");  
}

      function startSync() {
        if (syncTimer) clearTimeout(syncTimer);
        performSmartSync();
      }

/**
 * [ìµœì¢… ìµœì í™”] Jitter íš¨ê³¼ê°€ ì ìš©ëœ ë™ê¸°í™” ì—”ì§„
 * 100ëª… ë™ì‹œ ì ‘ì† ì‹œ ì„œë²„ ë¶€í•˜ë¥¼ ë¶„ì‚°ì‹œí‚¤ê¸° ìœ„í•´ Â±10%ì˜ ëœë¤ ì˜¤ì°¨ë¥¼ ì ìš©í•©ë‹ˆë‹¤.
 */
function performSmartSync() {
  // 1. ìƒíƒœ ì²´í¬ (êµ¬ì—­ë²ˆí˜¸ ì—†ìŒ, í™”ë©´ ìˆ¨ê¹€, ì´ë¯¸ ë™ê¸°í™” ì¤‘, ì ˆì „ ëª¨ë“œ ì‹œ ì¤‘ë‹¨)
  if (!currentNumber || document.getElementById('mainView').classList.contains('hidden')) return;
  if (isSyncing || isDeepSleeping) return;

  isSyncing = true;

  google.script.run
    .withSuccessHandler(function(res) {
      // ë°ì´í„° ë™ê¸°í™” ì²˜ë¦¬ (UI ì—…ë°ì´íŠ¸ ë“±)
      syncUI(res);
      isSyncing = false;
      
      // ğŸ² [Jitter ë¡œì§] 
      // í˜„ì¬ ì„¤ì •ëœ ì£¼ê¸°(CONFIG_SYNC_INTERVAL)ì˜ 10% ë²”ìœ„ë¥¼ ê³„ì‚°
      // ì˜ˆ: 60ì´ˆ(1.0ë¶„)ì¼ ê²½ìš° jitterRangeëŠ” 6ì´ˆ
      const baseMs = CONFIG_SYNC_INTERVAL;
      const jitterRange = baseMs * 0.1; 
      
      // -jitterRange ~ +jitterRange ì‚¬ì´ì˜ ëœë¤ê°’ ìƒì„±
      const randomJitter = (Math.random() - 0.5) * 2 * jitterRange; 
      
      // ìµœì¢… ëŒ€ê¸° ì‹œê°„ ì‚°ì¶œ (ìµœì†Œ 5ì´ˆ ì•ˆì „ì¥ì¹˜)
      const finalWait = Math.max(5000, baseMs + randomJitter);
      
      // ë‹¤ìŒ ë™ê¸°í™” ì˜ˆì•½
      syncTimer = setTimeout(performSmartSync, finalWait);
      
      // (ë””ë²„ê¹…ìš© ë¡œê·¸ - í•„ìš” ì‹œ í•´ì œ)
      // console.log(`Next sync in: ${(finalWait/1000).toFixed(1)}s (Jitter: ${(randomJitter/1000).toFixed(1)}s)`);
    })
    .withFailureHandler(function(e) {
      isSyncing = false;
      // ì‹¤íŒ¨ ì‹œ ì„œë²„ ì•ˆì •í™”ë¥¼ ìœ„í•´ ê¸°ë³¸ ì£¼ê¸°ì— 5ì´ˆë¥¼ ì¶”ê°€í•˜ì—¬ ì¬ì‹œë„
      syncTimer = setTimeout(performSmartSync, CONFIG_SYNC_INTERVAL + 5000);
      console.error("Sync Error:", e);
    })
    .getLatestData(currentNumber, lastNotificationTime);
}

// [ìµœì¢… ìµœì í™”] ë¦¬ìŠ¤íŠ¸ ì „ì²´ ì¬ë Œë”ë§ ì œê±° + ëŸ¬ë²„ë°´ë”© ë°©ì§€ + ì ê¸ˆ ì²´í¬ í†µí•© ë²„ì „
function syncUI(res) {
  if (!res.success) return;

  // â˜… [í•µì‹¬ ë°©ì–´] ì´ë¯¸ ë©”ì¸ í™”ë©´ì—ì„œ ë‚˜ê°”ë‹¤ë©´ ì¢…ë£Œ
  if (document.getElementById('mainView').classList.contains('hidden')) return;

  // ë¡œê·¸ì¸ ê²€ì‚¬
  if (res.requestNumber && String(res.requestNumber) !== String(currentNumber)) return;

  // ==========================================
  // ğŸ”’ 1. ì ê¸ˆ ìƒíƒœ ì²˜ë¦¬ (Piggybacking - ì¶”ê°€ëœ ë¶€ë¶„)
  // ==========================================
  if (!isLeaderLoggedIn && res.lockInfo) {
    if (res.lockInfo.isLocked) {
      // (A) ëˆ„êµ°ê°€ í¸ì§‘ ì¤‘ì¸ ê²½ìš°
      if (res.lockInfo.data.user !== currentUserName) {
        if (!isLockAcknowledged) {
          toggleLockedOverlay(true, res.lockInfo.data.user);
        }
        wasServerLocked = true; // ì„œë²„ê°€ ì ê²¨ìˆì—ˆìŒì„ ê¸°ì–µ
      }
    } else {
      // (B) ì ê¸ˆì´ í’€ë ¤ìˆëŠ” ê²½ìš°
      if (wasServerLocked) {
        // ë°©ê¸ˆ ì¸ë„ìê°€ í¸ì§‘ì„ ë§ˆì¹œ ìƒíƒœë¼ë©´ í™”ë©´ì„ ìµœì‹ í™”(ìƒˆë¡œê³ ì¹¨)í•¨
        toggleLockedOverlay(false);
        isLockAcknowledged = false;
        showToast(t("ì¸ë„ìê°€ í¸ì§‘ì„ ë§ˆì³¤ìŠµë‹ˆë‹¤. ë°ì´í„°ë¥¼ ë™ê¸°í™”í•©ë‹ˆë‹¤."), "fa-solid fa-rotate text-blue-400");
        
        // ë¡œì»¬ ìºì‹œë¥¼ ë¹„ìš°ê³  ì„œë²„ì—ì„œ ì „ì²´ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë°›ì•„ì˜´ (êµ¬ì¡° ë³€ê²½ ëŒ€ì‘)
        localStorage.removeItem(getLocalKey(currentNumber));
        setTimeout(function() {
          processLoginRequest(currentUserName, currentNumber, "", true); 
        }, 500);
        wasServerLocked = false;
      } else {
        toggleLockedOverlay(false);
      }
    }
  }

  // 2. SOS ê¸´ê¸‰ ì•Œë¦¼
  if (res.sosAlerts) {
      checkSOS(res.sosAlerts);
  }

  // 3. ì‹¤ì‹œê°„ ì ‘ì†ì ëª…ë‹¨
  if (res.activeUsers) {
    var newUserList = res.activeUsers.sort();
    var displayArea = document.getElementById('activeUsersArea');
    var listText = document.getElementById('activeUserList');

    lastActiveUserList.forEach(function(oldUser) {
      if (!newUserList.includes(oldUser)) {
        if (oldUser !== currentUserName) {
          var hasExitLog = false;
          if (res.newLogs && res.newLogs.length > 0) {
            hasExitLog = res.newLogs.some(function(log) {
              return log.u === oldUser && (log.m.indexOf("LOG_EXIT") !== -1 || log.m.indexOf("ë‚˜ê°€ì…¨") !== -1);
            });
          }
          if (!hasExitLog) {
            showToast(oldUser + t("ë‹˜ì˜ ì ‘ì†ì´ ëŠê²¼ìŠµë‹ˆë‹¤."), "fa-solid fa-signal text-slate-400");
          }
        }
      }
    });

    if (newUserList && newUserList.length > 0) {
      listText.innerText = newUserList.join(", ") + " " + t("ì ‘ì† ì¤‘");
      displayArea.classList.remove('hidden');
    } else {
      displayArea.classList.add('hidden');
    }
    lastActiveUserList = newUserList;
  }

  // 4. ìƒˆ ë¡œê·¸ ì•Œë¦¼
  if (res.newLogs && res.newLogs.length > 0) {
    res.newLogs.forEach(function(log) {
      if (log.u !== currentUserName) {
        let finalMsg = log.m;
        let icon = "fa-solid fa-bell text-yellow-400";
        try {
          if (log.m.indexOf('{"key":') === 0) {
            const obj = JSON.parse(log.m);
            let template = "";
            switch(obj.key) {
              case "LOG_ENTRY": template = t("ë‹˜ì´ êµ¬ì—­ì¹´ë“œì— ë“¤ì–´ì™”ìŠµë‹ˆë‹¤."); icon = "fa-solid fa-right-to-bracket text-emerald-400"; break;
              case "LOG_EXIT": template = t("ë‹˜ì´ êµ¬ì—­ì¹´ë“œì—ì„œ ë‚˜ê°€ì…¨ìŠµë‹ˆë‹¤."); icon = "fa-solid fa-right-from-bracket text-rose-400"; break;
              case "LOG_BELL": template = t("ë‹˜ì´ {place}ì˜ ë²¨ì„ ëˆŒë €ìŠµë‹ˆë‹¤."); icon = "fa-solid fa-bell text-amber-400"; break;
              case "LOG_VISIT": template = t("ë‹˜ì´ {place}ì˜ ë°©ë¬¸ì„ ë§ˆì³¤ìŠµë‹ˆë‹¤."); icon = "fa-solid fa-check-circle text-indigo-400"; break;
              default: template = obj.key; 
            }
            finalMsg = template.replace("{place}", obj.place || "");
          }
        } catch(e) {}
        showToast(log.u + finalMsg, icon, 3000);
      }
      if (log.t > lastNotificationTime) lastNotificationTime = log.t;
    });
  }

  // 5. êµ¬ì—­ ë°ì´í„° ë™ê¸°í™” (ğŸš€ ëŸ¬ë²„ë°´ë”© ë°©ì§€ í•µì‹¬ ë¡œì§)
  if (!res.partialData) return;
  
  var newPartialData = res.partialData;
  var now = Date.now();
  var needsLocalSave = false; 
  var needsRecalc = false;

  for (var i = 1; i < newPartialData.length; i++) {
    // [ë³´í˜¸ë§‰ 1] ì „ì†¡ ì¤‘ì´ê±°ë‚˜ ë°©ê¸ˆ ì„±ê³µ ì²´í¬ê°€ ëœ¬ í•­ëª©ì€ ì„œë²„ ë°ì´í„° ë¬´ì‹œ
    if (pendingVisits.has(i) || syncedVisits.has(i) || pendingBells.has(i) || syncedBells.has(i)) continue;

    // [ë³´í˜¸ë§‰ 2] â˜… 20~30ì´ˆ ì‹œê°„ ë³´í˜¸ë§‰ â˜… 
    var lastAction = lastRowActionTime[i] || 0;
    if (now - lastAction < 20000) continue; 

    if (i >= currentData.length) break;

    var oldRow = currentData[i];
    var newVisit = newPartialData[i][0]; 
    var newMemo  = newPartialData[i][1]; 
    var newBell  = newPartialData[i][2]; 

    var isRowChanged = false;
    if (oldRow[4] !== newVisit) { 
      currentData[i][4] = newVisit; 
      isRowChanged = true; 
      needsRecalc = true; 
    }
    if (oldRow[5] !== newMemo) { 
      currentData[i][5] = newMemo; 
      isRowChanged = true; 
    }
    if (oldRow[7] !== newBell) { 
      currentData[i][7] = newBell; 
      isRowChanged = true; 
      needsRecalc = true; 
    }

    if (isRowChanged) {
      updateSingleCardUI(i); 
      needsLocalSave = true; 
    }
  }

  // 6. ë¡œì»¬ ìºì‹œ ê°±ì‹  ë° í†µê³„ ì¬ê³„ì‚°
  if (needsLocalSave) {
      var localKey = getLocalKey(currentNumber);
      var localData = localStorage.getItem(localKey);
      if (localData) {
          try {
              var parsed = JSON.parse(localData);
              parsed.data = currentData; 
              saveToLocalStorage(localKey, parsed);
          } catch(e) {}
      }
      if (needsRecalc && typeof recalculateLocalStats === 'function') {
        recalculateLocalStats(); 
      }
  }

  // 7. 'ì—¬ê¸°ê¹Œì§€' ë§ˆí¬ ë™ê¸°í™”
  if (now - lastMarkActionTime > 5000) { 
        var serverMarkIndex = -1;
        if (res.markData && res.markData.index !== "") {
            serverMarkIndex = parseInt(res.markData.index, 10);
        }
        if (currentMarkIndex !== serverMarkIndex) {
            currentMarkIndex = serverMarkIndex;
            currentMarkInfo = res.markData.info || "";
            renderList(); 
        }
  }

  // 8. êµ¬ì—­ ìƒíƒœ(ë°°ì§€) ì—…ë°ì´íŠ¸
  if (res.zoneStatus && currentZoneStatus !== res.zoneStatus) {
      currentZoneStatus = res.zoneStatus;
      checkStatusBadge(res.zoneStatus);
  }
}

// [ìµœì í™” ì ìš©] ê°œë³„ ì¹´ë“œ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateSingleCardUI(index) {
  var card = document.getElementById('card-' + index);
  if (!card) return;

  var row = currentData[index];
  var visited = row[4] === 'Y';
  var memo = row[5] || "";
  var isBanned = (globalSettings.banKeywords || []).some(k => memo.trim().indexOf(k) === 0);
  var isPub = (globalSettings.pubKeywords || []).some(k => memo.trim().indexOf(k) === 0);

  // 1. ì¹´ë“œ ë°°ê²½ìƒ‰ (ê¸°ì¡´ ìœ ì§€)
  var isMarked = (index === currentMarkIndex);
  var borderClass = isMarked ? 'border-blue-400 border-2' : (visited ? 'border-green-100 border' : 'border-transparent border');
  
  card.className = "relative rounded-2xl p-4 shadow-sm flex items-center justify-between transition-all active:scale-[0.99] tap-highlight-transparent mb-3 border " + 
                   (isBanned ? "bg-red-50 border-red-200" : (isPub ? "bg-sky-50 border-sky-300 border-2" : "bg-white " + borderClass));

  // 2. ë²ˆí˜¸ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ (relative í•„ìˆ˜ ì¶”ê°€)
  var iconDiv = card.querySelector('.icon-div');
  if (iconDiv) {
    var defaultIconStyle = "bg-white border border-slate-200 text-slate-600"; 

    // â˜… í•µì‹¬: relativeë¥¼ ë°˜ë“œì‹œ í¬í•¨í•˜ì—¬ ë°°ì§€ê°€ ì´ ì•ˆì—ì„œ ì •ë ¬ë˜ê²Œ í•¨
    iconDiv.className = "icon-div w-11 h-11 rounded-full flex items-center justify-center transition-all duration-300 shrink-0 relative " + 
                        (isBanned ? "bg-red-100 text-red-400" : 
                        (isPub ? "bg-sky-500 text-white shadow-md" : 
                        (visited ? "bg-green-500 text-white shadow-md" : defaultIconStyle)));
    
    var existingBadge = iconDiv.querySelector('.sync-badge');
    if (existingBadge) existingBadge.remove();
    
    if (pendingVisits.has(index)) {
        var b = document.createElement('div'); b.className = "sync-badge sync-pending";
        b.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>'; iconDiv.appendChild(b);
    } else if (syncedVisits.has(index)) {
        var b = document.createElement('div'); b.className = "sync-badge sync-success animate-pop";
        b.innerHTML = '<i class="fa-solid fa-check"></i>'; iconDiv.appendChild(b);
    }
  }

  // 3. ë²¨ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (relative í•„ìˆ˜ ì¶”ê°€)
  var bellBtn = card.querySelector('.bell-btn');
  if (bellBtn && globalSettings.isBellEnabled === 'Y') {
    var isBellRung = (row[7] === 'Y');
    
    if (!(isBanned || isPub)) {
       var defaultBellStyle = "bg-white border border-slate-200 text-slate-300 hover:bg-slate-50";

       // â˜… í•µì‹¬: relativeë¥¼ ë°˜ë“œì‹œ í¬í•¨í•˜ì—¬ ë°°ì§€ê°€ ë²¨ ë²„íŠ¼ì— ë¶™ê²Œ í•¨
       bellBtn.className = 'bell-btn w-11 h-11 rounded-full flex items-center justify-center transition-all shrink-0 relative active:scale-90 shadow-sm ' + 
                           (isBellRung ? 'text-amber-500 bg-amber-50 border border-amber-100' : defaultBellStyle);
       
       bellBtn.innerHTML = '<i class="fa-solid fa-bell text-lg"></i>';
       
       if (pendingBells.has(index)) {
           var b = document.createElement('div'); b.className = "sync-badge sync-pending"; 
           b.style.bottom = "-2px"; b.style.right = "-2px";
           b.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>'; bellBtn.appendChild(b);
       } else if (syncedBells.has(index)) {
           var b = document.createElement('div'); b.className = "sync-badge sync-success animate-pop"; 
           b.style.bottom = "-2px"; b.style.right = "-2px";
           b.innerHTML = '<i class="fa-solid fa-check"></i>'; bellBtn.appendChild(b);
       }
    }
  }

  // 4. ë©”ëª¨ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
  updateRowUI(index, visited, isBanned, isPub, memo);
}


// ==================================================================================
// [ìˆ˜ì •] ì¸ë„ì íˆ´ë°”: ë²„íŠ¼ ìƒì„± í—¬í¼ (ìœ ì—°í•œ ì¶•ì†Œ ì ìš©)
// ==================================================================================
function createLeaderToolButton(innerHtml, title, onClick, extraClass) {
Â  var btn = document.createElement('button');
Â  btn.type = "button";
Â  
Â  // â˜… ìˆ˜ì •ëœ ë¶€ë¶„ (í•µì‹¬):
Â  // 1. w-9 ì œê±° -> flex-1 min-w-0 ì¶”ê°€ (ìœ ì—°í•˜ê²Œ ì¶•ì†Œ/í™•ì¥)
Â  // 2. h-9 ìœ ì§€ (ë†’ì´ ê³ ì •)
Â  // 3. text-sm ìœ ì§€ (ì•„ì´ì½˜ í¬ê¸° ìœ ì§€)
Â  btn.className =
Â  Â  "flex-1 min-w-0 h-9 rounded-full flex items-center justify-center text-sm " + 
Â  Â  "font-bold transition-all duration-150 bg-transparent text-slate-500 " +
Â  Â  "border border-transparent shadow-sm active:scale-95 " +
Â  Â  (extraClass || "hover:bg-slate-50 hover:text-slate-900 hover:border-slate-300");
Â  Â  
Â  btn.innerHTML = innerHtml;
Â  btn.title = title;
Â  btn.onclick = function (e) {
Â  Â  e.stopPropagation(); Â 
Â  Â  onClick();
Â  };
Â  return btn;
}

// [ìˆ˜ì •ë¨] 3ë²ˆì§¸ ì¸ì(manualValue) ì¶”ê°€: ëª¨ë‹¬ì—ì„œ ê°’ì„ ì§ì ‘ ë°›ê¸° ìœ„í•¨
function leaderModifyRow(index, action, manualValue) {
  if (!isLeaderLoggedIn) return;        // ì¸ë„ìë§Œ ì‚¬ìš©
  if (!currentNumber) return;
  if (index <= 0 || index >= currentData.length) return; // 0ì€ í—¤ë”

  // ê°„ë‹¨í•œ ê²½ê³„ ì²´í¬
  if (action === "MOVE_UP" && index === 1) {
    showToast("ì²« ë²ˆì§¸ í–‰ì€\nìœ„ë¡œ ì˜®ê¸¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "fa-solid fa-triangle-exclamation text-amber-400");
    return;
  }
  if (action === "MOVE_DOWN" && index === currentData.length - 1) {
    showToast("ë§ˆì§€ë§‰ í–‰ì…ë‹ˆë‹¤.", "fa-solid fa-triangle-exclamation text-amber-400");
    return;
  }

  var value = "";

  // ===============================================
  // â˜… [í•µì‹¬] RENAME ë¡œì§ ë³€ê²½ (ëª¨ë‹¬ ì§€ì›)
  // ===============================================
  if (action === "RENAME") {
    // 1. ëª¨ë‹¬ì—ì„œ ë„˜ì–´ì˜¨ ê°’ì´ ìˆìœ¼ë©´(ë¹ˆ ë¬¸ìì—´ í¬í•¨) ê·¸ê±¸ ì‚¬ìš©
    if (manualValue !== undefined) {
       value = manualValue;
    } 
    // 2. (ë¹„ìƒìš©) ê°’ì´ ì—†ìœ¼ë©´ ê¸°ì¡´ì²˜ëŸ¼ prompt ë„ì›€
    else {
       var oldName = currentData[index][3] ? currentData[index][3].toString() : "";
       var promptVal = prompt("ìƒˆ í˜¸ìˆ˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.", oldName);
       if (promptVal === null) return; // ì·¨ì†Œ
       value = promptVal.toString().trim();
    }
  }

  // âœ… 1) ë³€ê²½ ì „ ìƒíƒœ ë°±ì—… (ì‹¤íŒ¨ ì‹œ ë¡¤ë°±ìš©)
  var backupData = JSON.parse(JSON.stringify(currentData));
  var backupMarkIndex = currentMarkIndex;
  var backupMarkInfo = currentMarkInfo;

  // âœ… 2) í™”ë©´ ë¨¼ì € ì¦‰ì‹œ ì ìš© (í˜„ì¬ êµ¬ì—­ì¹´ë“œì— ë°”ë¡œ ë°˜ì˜)
  applyLeaderRowChangeLocally(index, action, value);

  // âœ… 3) ì„œë²„ì— ë°˜ì˜ + ì„±ê³µ/ì‹¤íŒ¨ì— ë”°ë¼ ì²˜ë¦¬
  google.script.run
    .withSuccessHandler(function (res) {
      if (!res || !res.success) {
        // âŒ ì„œë²„ì—ì„œ ì‹¤íŒ¨ ì‘ë‹µ â†’ ë°±ì—… ìƒíƒœë¡œ ë¡¤ë°±
        currentData = backupData;
        currentMarkIndex = backupMarkIndex;
        currentMarkInfo = backupMarkInfo;
        renderList();
        syncLocalCacheWithCurrentData();

        var msg = (res && res.message) ? res.message : "ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
        showToast(msg, "fa-solid fa-triangle-exclamation text-red-400");
        return;
      }

      // âœ… ì„±ê³µ: ì´ë¯¸ í™”ë©´ì€ ë°”ë€Œì–´ ìˆìœ¼ë‹ˆ, ë¡œì»¬ìºì‹œ ë™ê¸°í™” + í† ìŠ¤íŠ¸ë§Œ
      syncLocalCacheWithCurrentData();
      showToast("ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.", "fa-solid fa-check-circle text-emerald-400");
    })
    .withFailureHandler(function (e) {
      console.log(e);

      // âŒ í†µì‹  ì—ëŸ¬ ì‹œì—ë„ ë¡¤ë°± + ë¡œì»¬ìºì‹œ ì›ë³µ
      currentData = backupData;
      currentMarkIndex = backupMarkIndex;
      currentMarkInfo = backupMarkInfo;
      renderList();
      syncLocalCacheWithCurrentData();

      showToast("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "fa-solid fa-triangle-exclamation text-red-400");
    })
    .modifyZoneRow(currentNumber, index, action, value);
}

// ==========================
// ì‹œíŠ¸ í¸ì§‘ í›„ í˜„ì¬ í˜ì´ì§€ ë°ì´í„° ê°±ì‹ 
// ==========================
function applyLeaderRowChangeLocally(index, action, value) {
  // êµ¬ì¡°ê°€ ë°”ë€Œë©´ ì¸ë±ìŠ¤ë“¤ì´ ëª¨ë‘ í”ë“¤ë¦¬ë¯€ë¡œ ê´€ë ¨ ìƒíƒœ ì´ˆê¸°í™”
  pendingRows.clear();
  lastRowActionTime = {};

  if (action === "RENAME") {
    // Dì—´(í˜¸ìˆ˜ ì´ë¦„)ë§Œ ë³€ê²½
    currentData[index][3] = value;

  } else if (action === "MOVE_UP") {
    if (index <= 1) return;
    var tmpUp = currentData[index - 1];
    currentData[index - 1] = currentData[index];
    currentData[index] = tmpUp;
    adjustMarkIndexForMove(index, index - 1);

  } else if (action === "MOVE_DOWN") {
    if (index >= currentData.length - 1) return;
    var tmpDown = currentData[index + 1];
    currentData[index + 1] = currentData[index];
    currentData[index] = tmpDown;
    adjustMarkIndexForMove(index, index + 1);

  } else if (action === "ADD_ABOVE") {
    var baseRow = currentData[index];
    var newRow = [
      baseRow[0] || "",  // ë„ë¡œëª…
      baseRow[1] || "",  // ë²ˆì§€
      baseRow[2] || "",  // ê±´ë¬¼ëª…
      "",                // í˜¸ìˆ˜
      "",                // ë°©ë¬¸ì—¬ë¶€
      "",                // ë©”ëª¨
      ""                 // ì´ë¯¸ì§€
    ];
    currentData.splice(index, 0, newRow);
    if (currentMarkIndex >= index) currentMarkIndex++;

  } else if (action === "ADD_BELOW") {
    var baseRow2 = currentData[index];
    var newRow2 = [
      baseRow2[0] || "",
      baseRow2[1] || "",
      baseRow2[2] || "",
      "",
      "",
      "",
      ""
    ];
    currentData.splice(index + 1, 0, newRow2);
    if (currentMarkIndex > index) currentMarkIndex++;

  } else if (action === "DELETE") {
    currentData.splice(index, 1);
    if (currentMarkIndex === index) {
      currentMarkIndex = -1;
      currentMarkInfo = "";
    } else if (currentMarkIndex > index) {
      currentMarkIndex--;
    }
  }

   renderList();
}

// í–‰ ì´ë™ ì‹œ 'ì—¬ê¸°ê¹Œì§€' ë§ˆí¬ ì¸ë±ìŠ¤ ì¡°ì •
function adjustMarkIndexForMove(fromIdx, toIdx) {
  if (currentMarkIndex === fromIdx) currentMarkIndex = toIdx;
  else if (currentMarkIndex === toIdx) currentMarkIndex = fromIdx;
}

// currentData ì „ì²´ë¥¼ ë¡œì»¬ ìºì‹œì— ë‹¤ì‹œ ì €ì¥
function syncLocalCacheWithCurrentData() {
  try {
    var key = getLocalKey(currentNumber);
    var saved = localStorage.getItem(key);
    if (!saved) return;
    var parsed = JSON.parse(saved);
    parsed.data = currentData;
    parsed.markData = {
      index: currentMarkIndex === -1 ? "" : currentMarkIndex,
      info: currentMarkInfo || ""
    };
    localStorage.setItem(key, JSON.stringify(parsed));
  } catch (e) {
    console.log("ë¡œì»¬ ìºì‹œ ë™ê¸°í™” ì‹¤íŒ¨:", e);
  }
}


function renderList() {
  var container = document.getElementById('listContainer');
  container.innerHTML = "";
  
  var fragment = document.createDocumentFragment(); 

  var lastHeaderKey = "";
  var displayCount = 0; 

  var inheritRoad = "";  
  var inheritNum = "";   
  var inheritBuild = ""; 

  for (var i = 1; i < currentData.length; i++) {
    var row = currentData[i];

    // 1. ë°ì´í„° íŒŒì‹±
    var roadNameRaw   = row[0] ? row[0].toString() : ""; 
    var buildNumRaw   = row[1] ? row[1].toString() : ""; 
    var buildingName  = row[2] ? row[2].toString() : ""; 
    var houseNum      = row[3];                          
    var buildNumDisplay = buildNumRaw; 

    // 2. ì•ˆë‚´ ê·¸ë£¹(*) ì²˜ë¦¬
    if (roadNameRaw.indexOf('*') === 0) {
        var groupTitle = roadNameRaw.replace(/^\*+/, '').trim(); 
        var groupDiv = document.createElement('div');
        groupDiv.className = "mt-0 mb-4 px-4 py-3 rounded-2xl bg-gradient-to-r from-sky-500 to-indigo-500 text-white text-sm sm:text-base font-extrabold flex items-center gap-3 shadow-lg border border-sky-600";
        groupDiv.innerHTML = `<div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center shrink-0"><i class="fa-solid fa-layer-group text-lg"></i></div><div class="flex flex-col leading-tight"><span class="text-[11px] uppercase tracking-[0.12em] opacity-80">êµ¬ì—­ ì•ˆë‚´</span><span>${groupTitle || "ê·¸ë£¹"}</span></div>`;
        fragment.appendChild(groupDiv);
        lastHeaderKey = "GROUP_RESET_" + i; inheritRoad = ""; inheritNum = ""; inheritBuild = ""; continue; 
    }

    // 3. ì£¼ì†Œ ìƒì† ë¡œì§
    if (roadNameRaw.trim() !== "") inheritRoad = roadNameRaw; else roadNameRaw = inheritRoad;
    if (buildNumDisplay.trim() !== "") inheritNum = buildNumDisplay; else buildNumDisplay = inheritNum;
    if (buildingName.trim() !== "") inheritBuild = buildingName; else { if (buildNumRaw.trim() !== "") inheritBuild = ""; buildingName = inheritBuild; }

    var statusVal     = row[4]; 
    var visited       = statusVal === 'Y';
    var memo          = row[5] || "";
    var imgUrl        = row[6] ? row[6].toString() : "";
    var hasImage      = imgUrl.trim().length > 0;
    displayCount++; 

// ì£¼ì†Œ í—¤ë” êµ¬ì„±
var roadAddress = (roadNameRaw + " " + buildNumDisplay).trim();
var currentHeaderKey = roadAddress + "||" + buildingName;

if (currentHeaderKey !== lastHeaderKey) {
    // â–¼ [ìˆ˜ì •ë¨] ê±´ë¬¼ëª…(buildingName)ì„ ì œì™¸í•˜ê³  ë„ë¡œëª…ì£¼ì†Œ(roadAddress)ë§Œ ê²€ìƒ‰ì–´ë¡œ ì‚¬ìš©
    var mapQuery = roadAddress; 
    
    // 1. #map ë¡œì§ ì ìš©: #mapì´ ìˆìœ¼ë©´ ë’·ë¶€ë¶„ë§Œ ê²€ìƒ‰ì–´ë¡œ ì‚¬ìš©
    var finalMapQuery = mapQuery;
    if (finalMapQuery.indexOf('#map') !== -1) {
        finalMapQuery = finalMapQuery.split('#map')[1].trim();
    }

    var headerLink = document.createElement('a');
    
    // 2. ê²€ìƒ‰ ê²½ë¡œ ìµœì í™”: search2/search.naver ì‚¬ìš© ë° ëì— #mapì„ ë¶™ì—¬ ì»¤ì§„ ì§€ë„ë¡œ ë°”ë¡œ ì´ë™
    headerLink.href = "https://m.map.naver.com/search2/search.naver?query=" + encodeURIComponent(finalMapQuery) + "#map";
    headerLink.target = "_blank"; 
    headerLink.className = "section-header block mt-6 mb-3 no-underline group select-none tap-highlight-transparent"; 
    
    // 3. UI í‘œì‹œìš© í…ìŠ¤íŠ¸ ì²˜ë¦¬: í™”ë©´ì—ì„œëŠ” #map ë’·ë¶€ë¶„ì´ ë³´ì´ì§€ ì•Šë„ë¡ ì œê±°
    // (í™”ë©´ì—ëŠ” ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ê±´ë¬¼ëª…ì´ ìˆìœ¼ë©´ ê±´ë¬¼ëª…ì„ ë³´ì—¬ì¤Œ)
    var displayName = (buildingName && buildingName.trim() !== "") ? buildingName : roadAddress;
    var subText = (buildingName && buildingName.trim() !== "") ? roadAddress : "ì£¼ì†Œì§€";
    
    var cleanDisplayName = displayName.split('#map')[0].trim();
    var cleanSubText = subText.split('#map')[0].trim();

    headerLink.dataset.title = cleanDisplayName; 
    headerLink.dataset.sub = cleanSubText;
    
    headerLink.innerHTML = `
        <div class="relative pl-4 py-2 border-l-4 border-indigo-500 bg-gradient-to-r from-indigo-50 to-transparent rounded-r-xl transition-all active:opacity-70 active:from-indigo-100">
            <div class="flex items-center gap-1.5 text-xs font-bold text-slate-400 mb-0.5">
                <i class="fa-solid fa-location-dot text-indigo-300 text-[10px]"></i>
                <span>${cleanSubText}</span>
            </div>
            <div class="flex items-center justify-between pr-2">
                <h2 class="text-lg font-black text-slate-800 tracking-tight leading-tight group-hover:text-indigo-600 transition-colors">${cleanDisplayName}</h2>
                <div class="w-6 h-6 rounded-full bg-white text-indigo-300 flex items-center justify-center shadow-sm group-hover:text-indigo-500 transition-colors">
                    <i class="fa-solid fa-chevron-right text-[10px]"></i>
                </div>
            </div>
        </div>`;

    fragment.appendChild(headerLink); 
    lastHeaderKey = currentHeaderKey;
}
    
    var isBanned = (globalSettings.banKeywords || [t("ë°©ë¬¸ê¸ˆì§€")]).some(function(k) { return memo.trim().indexOf(k) === 0; });
    var isPub    = (globalSettings.pubKeywords || [t("ì „ë„ì¸ ì§‘")]).some(function(k) { return memo.trim().indexOf(k) === 0; });
    
    var cardBaseClass = "relative rounded-2xl p-4 shadow-sm flex items-center justify-between transition-all tap-highlight-transparent mb-3 border ";
    var cardStyleClass = "";
    var houseNumClass = "house-num text-xl font-bold ml-1 ";
    var iconClass = "icon-div w-11 h-11 rounded-full flex items-center justify-center transition-all duration-300 ";
    var memoBtnClass = "memo-btn w-10 h-10 rounded-full flex items-center justify-center transition-colors shrink-0 "; 
    var isMarked = (i === currentMarkIndex);

    var borderClass = 'border-transparent';
    if (isMarked) borderClass = 'border-blue-400 border-2';
    else if (visited) borderClass = 'border-green-100';

    if (isBanned) { cardStyleClass = "bg-red-50 border-red-200"; houseNumClass += "text-red-400 line-through decoration-red-300"; iconClass += "bg-red-100 text-red-400"; memoBtnClass += "bg-red-100 text-red-500";
    } else if (isPub) { cardStyleClass = "bg-green-50 border-sky-300 border-2"; houseNumClass += "text-sky-700"; iconClass += "bg-sky-500 text-white shadow-md"; memoBtnClass += "bg-sky-100 text-sky-600";
    } else { 
        cardStyleClass = "bg-white " + borderClass; houseNumClass += "text-slate-800";
        // â˜… [ìˆ˜ì •] ë²ˆí˜¸ ì•„ì´ì½˜ ë¯¸ë°©ë¬¸ ìƒíƒœ ê°œì„ : ë°°ê²½+í…Œë‘ë¦¬+ìˆ«ììƒ‰ ê°•í™”
        iconClass += visited ? "bg-green-500 text-white shadow-md" : "bg-slate-50 border border-slate-200 text-slate-500";
        var hasMemo = memo && memo.toString().trim().length > 0; memoBtnClass += hasMemo ? "bg-indigo-50 text-indigo-500" : "text-slate-300 hover:bg-slate-50";
    }

    var card = document.createElement('div');
    card.id = 'card-' + i;
    card.className = cardBaseClass + cardStyleClass;

    if (isMarked) {
      var markBadge = document.createElement('div');
      markBadge.className = "mark-badge absolute -top-2 left-4 bg-blue-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm z-10 flex items-center gap-1";
      markBadge.innerHTML = '<i class="fa-solid fa-flag"></i> ì—¬ê¸°ê¹Œì§€ (' + currentMarkInfo.split(' ')[0] + ')';
      card.appendChild(markBadge);
    }

    var leftSection = document.createElement('div');
    leftSection.className = "left-section flex items-center gap-3 flex-1 min-w-0"; 

    // 1ï¸âƒ£ ë²ˆí˜¸í‘œ (ì•„ì´ì½˜ í´ë¦­ ì‹œë§Œ ë°©ë¬¸ì²´í¬)
    var iconDiv = document.createElement('div');
    iconDiv.className = iconClass + " shrink-0 relative cursor-pointer active:scale-90 shadow-sm"; 
    iconDiv.innerHTML = '<span class="text-lg font-bold font-sans">' + displayCount + '</span>';

    if (!isBanned && !isPub) {
      (function(idx, vNum) { 
        iconDiv.onclick = function(e) { e.stopPropagation(); toggleVisit(idx, vNum); }; 
      })(i, displayCount);
    }

    if (pendingVisits.has(i)) {
        var vBadge = document.createElement('div'); vBadge.className = "sync-badge sync-pending"; vBadge.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>'; iconDiv.appendChild(vBadge);
    } else if (syncedVisits.has(i)) {
        var vBadge = document.createElement('div'); vBadge.className = "sync-badge sync-success animate-pop"; vBadge.innerHTML = '<i class="fa-solid fa-check"></i>'; iconDiv.appendChild(vBadge);
    }
    leftSection.appendChild(iconDiv);

    // 2ï¸âƒ£ ë²¨ ë²„íŠ¼ (ë²¨ ì•„ì´ì½˜ í´ë¦­ ì‹œë§Œ ì‘ë™)
    if (globalSettings.isBellEnabled === 'Y' && !isBanned && !isPub) {
        var isBellRung = (row[7] === 'Y'); 
        var bellBtn = document.createElement('button');
        // â˜… [ìˆ˜ì •] ë²¨ ì•„ì´ì½˜ í•´ì œ ìƒíƒœ ê°€ë…ì„± ê°•í™”: í…Œë‘ë¦¬ì™€ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ì¡°ì •
        bellBtn.className = 'bell-btn w-11 h-11 rounded-full flex items-center justify-center transition-all shrink-0 relative active:scale-90 shadow-sm ' + 
                            (isBellRung ? 'text-amber-500 bg-amber-50 border border-amber-200' : 'text-slate-400 bg-slate-50 border border-slate-200 hover:bg-slate-100');
        bellBtn.innerHTML = '<i class="fa-solid fa-bell text-lg"></i>';
        
        (function(idx, vNum) { 
              bellBtn.onclick = function(e) { e.stopPropagation(); toggleBell(idx, vNum); };
        })(i, displayCount);

        if (pendingBells.has(i)) {
            var bBadge = document.createElement('div'); bBadge.className = "sync-badge sync-pending"; bBadge.style.bottom = "-2px"; bBadge.style.right = "-2px"; bBadge.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>'; bellBtn.appendChild(bBadge);
        } else if (syncedBells.has(i)) {
            var bBadge = document.createElement('div'); bBadge.className = "sync-badge sync-success animate-pop"; bBadge.style.bottom = "-2px"; bBadge.style.right = "-2px"; bBadge.innerHTML = '<i class="fa-solid fa-check"></i>'; bellBtn.appendChild(bBadge);
        }
        leftSection.appendChild(bellBtn);
    }

    // 3ï¸âƒ£ í…ìŠ¤íŠ¸ ì˜ì—­ (ê°€êµ¬ëª… + ë©”ëª¨)
    var textDiv = document.createElement('div');
    textDiv.className = "flex flex-col justify-center min-w-0 ml-1"; 
    var houseNumDiv = document.createElement('div');
    houseNumDiv.className = houseNumClass;
    houseNumDiv.innerText = houseNum;
    textDiv.appendChild(houseNumDiv);

    if (memo && memo.toString().trim().length > 0) {
      var memoColorClass = isBanned ? 'text-red-500' : (isPub ? 'text-green-600' : 'text-indigo-600');
      var memoDisplay = document.createElement('div');
      memoDisplay.className = "memo-display text-xs " + memoColorClass + " font-medium mt-0.5 truncate max-w-[150px]";
      memoDisplay.innerText = memo;
      textDiv.appendChild(memoDisplay);
    }
    leftSection.appendChild(textDiv);

    var rightSection = document.createElement('div');
    rightSection.className = "pl-2 flex items-center gap-1 shrink-0 ml-auto"; 

    if (hasImage) {
        var mapBtn = document.createElement('button');
        mapBtn.className = 'image-btn w-10 h-10 rounded-full flex items-center justify-center transition-colors text-sky-500 hover:bg-sky-50 active:scale-95 shrink-0';
        mapBtn.innerHTML = '<i class="fa-regular fa-image text-xl"></i>';
        (function(idx) { mapBtn.onclick = function(e) { e.stopPropagation(); openImageModalFromIndex(idx); }; })(i);
        rightSection.appendChild(mapBtn);
    }

    if (isLeaderLoggedIn) {
      var toolsWrap = document.createElement('div');
      toolsWrap.id = 'leader-tools-' + i; toolsWrap.className = "mr-1 flex items-center transition-all duration-300"; 
      renderLeaderSettingsIcon(toolsWrap, i);
      rightSection.appendChild(toolsWrap);
    }

    if (globalSettings.isMarkEnabled !== 'N') {
        var markBtn = document.createElement('button');
        var markActive = (i === currentMarkIndex);
        markBtn.className = 'mark-btn w-10 h-10 rounded-full flex items-center justify-center transition-colors shrink-0 active:scale-90 ' + (markActive ? 'text-blue-500 bg-blue-50' : 'text-slate-300 hover:text-blue-300');
        markBtn.innerHTML = '<i class="fa-solid fa-flag"></i>';
        (function(idx, vNum) { markBtn.onclick = function(e) { e.stopPropagation(); toggleMark(idx, vNum); }; })(i, displayCount);
        rightSection.appendChild(markBtn);
    }

    var menuBtn = document.createElement('button');
    menuBtn.className = memoBtnClass + " active:scale-90"; 
    menuBtn.innerHTML = '<i class="fa-solid fa-ellipsis-vertical"></i>';
    (function(idx) { menuBtn.onclick = function(e) { e.stopPropagation(); openMemoModal(idx); }; })(i);
    rightSection.appendChild(menuBtn);

    card.appendChild(leftSection);
    card.appendChild(rightSection);
    fragment.appendChild(card);
  }
  container.appendChild(fragment);
}

/**
 * ë°©ë¬¸ ì²´í¬ í† ê¸€ í•¨ìˆ˜ (ìµœì í™”: ì „ì²´ ë Œë”ë§ ì œê±° + ê°œë³„ ì¹´ë“œ ì—…ë°ì´íŠ¸ ì ìš©)
 */
function toggleVisit(index, visualNumber) {
  if (Date.now() - lastWakeUpTime < 500) return;
  
  var memo = currentData[index][5] || "";
  var isBannedAction = (globalSettings.banKeywords || [t("ë°©ë¬¸ê¸ˆì§€")]).some(k => memo.trim().indexOf(k) === 0);
  var isPubAction = (globalSettings.pubKeywords || [t("ì „ë„ì¸ ì§‘")]).some(k => memo.trim().indexOf(k) === 0);
  if (isBannedAction || isPubAction) return;

  var previousMarkIndex = currentMarkIndex;
  var isCurrentlyVisited = currentData[index][4] === 'Y';
  var newValue = isCurrentlyVisited ? 'N' : 'Y';

  // ğŸš€ [ë³´í˜¸ë§‰ í•µì‹¬] ì•¡ì…˜ ë°œìƒ ì¦‰ì‹œ ì‹œê°„ ê¸°ë¡
  lastRowActionTime[index] = Date.now(); 

  // --- [STEP 1] ë‚™ê´€ì  UI ì ìš© (ë°©ë¬¸ + ë²¨ ë™ì‹œ ë°˜ì˜) ---
  pendingVisits.delete(index); 

  if (newValue === 'Y') {
    syncedVisits.add(index); 
    
    // ğŸ”¥ [ì¶”ê°€] ë°©ë¬¸ ì²´í¬ ì‹œ ë²¨ë„ ì•„ì§ ì•ˆ ëˆŒë ¸ë‹¤ë©´ 'Y'ë¡œ ë³€ê²½í•˜ê³  UI ë°˜ì˜
    if (currentData[index][7] !== 'Y') {
        currentData[index][7] = 'Y'; // ë°ì´í„° ëª¨ë¸ ì¦‰ì‹œ ë³€ê²½
        syncedBells.add(index);      // ë²¨ ì•„ì´ì½˜ì— V í‘œì‹œ ì¶”ê°€
    }
  } else {
    syncedVisits.delete(index); 
    // (ì„ íƒì‚¬í•­) ë°©ë¬¸ ì·¨ì†Œ ì‹œ ë²¨ë„ ê°™ì´ ë„ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ (ë³´í†µì€ ë†”ë‘ )
    // if (currentData[index][7] === 'Y') {
    //    currentData[index][7] = '';
    //    syncedBells.delete(index);
    // }
  }

  // --- [STEP 2] UI ë° ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì¦‰ì‹œ ë°˜ì˜ ---
  currentData[index][4] = newValue;
  
  if (currentMarkIndex !== -1 && index >= currentMarkIndex) {
    currentMarkIndex = -1;
    currentMarkInfo = "";
    lastMarkActionTime = Date.now();
    renderList(); // â˜… ë§ˆí¬ê°€ ë°”ë€ŒëŠ” íŠ¹ìˆ˜í•œ ê²½ìš°ì—ë§Œ ì „ì²´ ë‹¤ì‹œ ê·¸ë¦¬ê¸° í—ˆìš©
  } else {
    // âš¡ [ìµœì í™” í•µì‹¬] ì „ì²´ renderList() ëŒ€ì‹  í•´ë‹¹ ì¹´ë“œë§Œ ê°±ì‹ 
    updateSingleCardUI(index); 
  }

  // ìƒë‹¨ í†µê³„ ìˆ˜ì¹˜ë§Œ ë‹¤ì‹œ ê³„ì‚° (ê°€ë³ìŒ)
  if (typeof recalculateLocalStats === 'function') recalculateLocalStats();

  var localKey = getLocalKey(currentNumber);
  var localData = localStorage.getItem(localKey);
  if (localData) {
    try {
        var parsed = JSON.parse(localData);
        parsed.data[index][4] = newValue;
        
        // ğŸ”¥ [ìˆ˜ì •] ë°©ë¬¸(Y) ì‹œ ë¡œì»¬ ìºì‹œì˜ ë²¨ ê°’ë„ 'Y'ë¡œ ì €ì¥
        if (newValue === 'Y') parsed.data[index][7] = 'Y'; 
        
        saveToLocalStorage(localKey, parsed);
    } catch(e) {}
  }

  // --- [STEP 3] ì„œë²„ ì „ì†¡ (ë°°ê²½ì—ì„œ ì²˜ë¦¬) ---
  addToQueue(() => {
    return new Promise((resolve, reject) => {
      var hVal = currentData[index][3] || ""; 
      var detailedPlace = visualNumber + "ë²ˆ " + hVal;

      google.script.run
        .withSuccessHandler(function(res) {
          // ì„œë²„ ì‘ë‹µ ì„±ê³µ ì‹œ
          if (newValue === 'Y') {
            // ì´ë¯¸ ì²´í¬ê°€ ë–  ìˆëŠ” ìƒíƒœì´ë¯€ë¡œ, 1.5ì´ˆ ë’¤ì— ì•„ì´ì½˜ë§Œ ìì—°ìŠ¤ëŸ½ê²Œ ì œê±°
            setTimeout(function() {
              syncedVisits.delete(index);
              syncedBells.delete(index); // ğŸ”¥ [ì¶”ê°€] ë²¨ ì²´í¬ í‘œì‹œë„ ê°™ì´ ì œê±°
              updateSingleCardUI(index); // â˜… ì—¬ê¸°ë„ renderList ëŒ€ì‹  ê°œë³„ ì—…ë°ì´íŠ¸
            }, 1500);
          } else {
            updateSingleCardUI(index); // â˜… ì—¬ê¸°ë„ renderList ëŒ€ì‹  ê°œë³„ ì—…ë°ì´íŠ¸
          }

          if (res.markData && res.markData.index !== "") {
            if (Date.now() - lastMarkActionTime > 5000) {
              currentMarkIndex = parseInt(res.markData.index, 10);
              currentMarkInfo = res.markData.info;
              renderList(); // ë§ˆí¬ ë³€ê²½ì€ ì „ì²´ ë ˆì´ì•„ì›ƒì— ì˜í–¥ ì£¼ë¯€ë¡œ ì „ì²´ ë Œë”ë§
            }
          }
          if (res.zoneStatus) {
            currentZoneStatus = res.zoneStatus;
            checkStatusBadge(res.zoneStatus);
          }
          resolve(res);
        })
        .withFailureHandler(function(e) {
          // âŒ ì‹¤íŒ¨ ì‹œ: ì¦‰ì‹œ ì²´í¬ í‘œì‹œë¥¼ ì§€ìš°ê³  ë°ì´í„° ë¡¤ë°±
          syncedVisits.delete(index);
          syncedBells.delete(index); // ğŸ”¥ [ì¶”ê°€] ë²¨ ì²´í¬ í‘œì‹œë„ ë¡¤ë°±
          pendingVisits.delete(index); 
          lastRowActionTime[index] = 0; 
          
          currentData[index][4] = isCurrentlyVisited ? 'Y' : 'N';
          
          updateSingleCardUI(index); // â˜… ë³µêµ¬ ì‹œì—ë„ ê°œë³„ ì—…ë°ì´íŠ¸
          recalculateLocalStats();
          showToast(t("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”."), "fa-solid fa-triangle-exclamation text-red-400");
          reject(e);
        })
        .saveVisitAndHandleMark(currentNumber, index, newValue, previousMarkIndex, currentUserName, detailedPlace, currentLang);
    });
  });
}



// ==========================================
// [ì‹ ê·œ] ì¸ë„ì íˆ´ë°”: ì‚­ì œ ëª¨ë‹¬ ì œì–´ í•¨ìˆ˜
// ==========================================
function requestDeleteRow(index) {
  targetDeleteIndex = index; // ì „ì—­ë³€ìˆ˜ í•„ìš” (script ìƒë‹¨ì— let targetDeleteIndex = -1; ì¶”ê°€ ê¶Œì¥, ì—†ìœ¼ë©´ ì•„ë˜ì—ì„œ ìë™ ìƒì„±ë¨)
  if (typeof targetDeleteIndex === 'undefined') window.targetDeleteIndex = index;
  
  document.getElementById('deleteConfirmModal').classList.remove('hidden');
  
  var confirmBtn = document.getElementById('btnRealDelete');
  // ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€ë¥¼ ìœ„í•´ onclick ì¬ì •ì˜
  confirmBtn.onclick = function() {
    confirmDeleteRow();
  };
}

function closeDeleteConfirmModal() {
  document.getElementById('deleteConfirmModal').classList.add('hidden');
  targetDeleteIndex = -1;
}

function confirmDeleteRow() {
  if (targetDeleteIndex === -1) return;
  leaderModifyRow(targetDeleteIndex, "DELETE");
  closeDeleteConfirmModal();
}


// ==================================================================================
//2ï¸âƒ£ [ìˆ˜ì •] ì¸ë„ì íˆ´ë°”: ì„¤ì •(Gear) ì•„ì´ì½˜ ë Œë”ë§ (ë©”ë‰´ ë‹«ê¸° ê¸°ëŠ¥ í¬í•¨)
// ==================================================================================
function renderLeaderSettingsIcon(container, index) {
  container.innerHTML = ""; 
  // â˜… [ì¤‘ìš”] ë‹«í˜”ì„ ë•ŒëŠ” ê¸°ë³¸ ìƒíƒœ ìœ ì§€ (absolute ì œê±°)
  container.className = "mr-1 flex items-center justify-center";

  // ============================================================
  // â˜… [í•µì‹¬ ì¶”ê°€] ë©”ë‰´ê°€ ë‹«íˆë©´ ì¹´ë“œ z-index ì´ˆê¸°í™” (ì›ìƒë³µêµ¬)
  // ============================================================
  var parentCard = document.getElementById('card-' + index);
  if (parentCard) {
    parentCard.classList.remove('z-[50]'); // ë†’ì•˜ë˜ ë ˆë²¨ ì œê±°
    parentCard.classList.add('z-0');      // ë‹¤ì‹œ ê¸°ë³¸ ë ˆë²¨ë¡œ ë³µê·€
  }
  // ============================================================

  // â˜… ë§Œì•½ ì´ í•­ëª©ì´ 'í˜„ì¬ ì—´ë¦° ë©”ë‰´'ì˜€ë‹¤ë©´, ë‹«íˆëŠ” ê±°ë‹ˆê¹Œ ë³€ìˆ˜ ì´ˆê¸°í™”
  if (openMenuIndex === index) {
    openMenuIndex = -1;
  }

  container.appendChild(
    createLeaderToolButton(
      '<i class="fa-solid fa-gear text-slate-400"></i>',
      "í¸ì§‘ ë©”ë‰´ ì—´ê¸°",
      function () { renderLeaderExpandedMenu(container, index); }, 
      "hover:text-indigo-600 hover:bg-slate-100"
    )
  );
}


// ==================================================================================
// [ìˆ˜ì •] ì¸ë„ì íˆ´ë°”: "ë¹„ë¹„ë“œ íŒŒìŠ¤í…”" ìŠ¤íƒ€ì¼ (ë²„íŠ¼ í­ 5% ë¯¸ì„¸ í™•ëŒ€ - ì•½ 38px)
// ==================================================================================
function renderLeaderExpandedMenu(container, index) {
  // 1. ë‹¤ë¥¸ ì—´ë ¤ìˆëŠ” ë©”ë‰´ê°€ ìˆë‹¤ë©´ ë‹«ê¸°
  if (openMenuIndex !== -1 && openMenuIndex !== index) {
    var otherContainer = document.getElementById('leader-tools-' + openMenuIndex);
    if (otherContainer) {
      renderLeaderSettingsIcon(otherContainer, openMenuIndex);
    }
  }

  // 2. í˜„ì¬ ì¸ë±ìŠ¤ ì„¤ì • ë° ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
  openMenuIndex = index;
  container.innerHTML = "";
  
  // ============================================================
  // â˜… [í•µì‹¬ ì¶”ê°€] ë©”ë‰´ê°€ ì—´ë¦° ì¹´ë“œë¥¼ í™”ë©´ ì œì¼ ìœ„ë¡œ ì˜¬ë¦¼ (ê°€ë ¤ì§ ë°©ì§€)
  // ============================================================
  var parentCard = document.getElementById('card-' + index); 
  if (parentCard) {
    parentCard.classList.remove('z-0');   // ê¸°ë³¸ ë ˆë²¨ ì œê±°
    parentCard.classList.add('z-[50]');  // ìµœìƒìœ„ ë ˆë²¨ë¡œ ìƒìŠ¹
  }
  // ============================================================

  // ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼
  container.className = "absolute bottom-full right-0 mb-3 flex items-stretch gap-1 bg-white border border-slate-300 shadow-2xl rounded-full px-3 py-2 z-[100] animate-modalFadeIn min-w-max ring-4 ring-slate-50/50";
  
  // ë§í’ì„  ê¼¬ë¦¬
  var arrow = document.createElement('div');
  arrow.className = "absolute -bottom-1.5 right-4 w-3 h-3 bg-white border-b border-r border-slate-300 rotate-45";
  container.appendChild(arrow);
  
  // ============================================================
  // â˜… ë²„íŠ¼ ì¶”ê°€ (w-[38px] í´ë˜ìŠ¤ë¡œ 5% ë¯¸ì„¸ í™•ëŒ€)
  // ============================================================
  
  // 1. ì´ë¦„ ë³€ê²½
  container.appendChild(createLeaderToolButton(
    '<i class="fa-solid fa-pen"></i>', 
    "ì´ë¦„ ë³€ê²½", 
    function () { 
        openRenameModal(index); 
        renderLeaderSettingsIcon(container, index); 
    }, 
    "h-9 w-[38px] bg-slate-100 text-slate-700 hover:bg-slate-200 hover:scale-110 transition-transform font-bold"
  ));

  // 2. ìœ„ë¡œ ì´ë™
  container.appendChild(createLeaderToolButton(
    '<i class="fa-solid fa-arrow-up"></i>', 
    "ìœ„ë¡œ ì´ë™", 
    function () { leaderModifyRow(index, "MOVE_UP"); }, 
    "h-9 w-[38px] bg-violet-100 text-violet-700 hover:bg-violet-200 hover:scale-110 transition-transform font-bold"
  ));

  // 3. ì•„ë˜ë¡œ ì´ë™
  container.appendChild(createLeaderToolButton(
    '<i class="fa-solid fa-arrow-down"></i>', 
    "ì•„ë˜ë¡œ ì´ë™", 
    function () { leaderModifyRow(index, "MOVE_DOWN"); }, 
    "h-9 w-[38px] bg-violet-100 text-violet-700 hover:bg-violet-200 hover:scale-110 transition-transform font-bold"
  ));

  // êµ¬ë¶„ì„ 
  var sep1 = document.createElement('div'); sep1.className = "w-[1px] h-5 bg-slate-300 mx-0.5"; container.appendChild(sep1);

  // 4. ìœ„ì— ì¶”ê°€
  container.appendChild(createLeaderToolButton(
    '<div class="relative"><i class="fa-solid fa-plus text-[10px] font-black absolute -top-1.5 -left-1.5"></i><i class="fa-solid fa-arrow-up"></i></div>', 
    "í˜„ì¬ í–‰ ìœ„ì— ì¶”ê°€", 
    function () { leaderModifyRow(index, "ADD_ABOVE"); renderLeaderSettingsIcon(container, index); }, 
    "h-9 w-[38px] bg-amber-100 text-amber-700 hover:bg-amber-200 hover:scale-110 transition-transform"
  ));

  // 5. ì•„ë˜ì— ì¶”ê°€
  container.appendChild(createLeaderToolButton(
    '<div class="relative"><i class="fa-solid fa-plus text-[10px] font-black absolute -top-1.5 -left-1.5"></i><i class="fa-solid fa-arrow-down"></i></div>', 
    "í˜„ì¬ í–‰ ì•„ë˜ì— ì¶”ê°€", 
    function () { leaderModifyRow(index, "ADD_BELOW"); renderLeaderSettingsIcon(container, index); }, 
    "h-9 w-[38px] bg-amber-100 text-amber-700 hover:bg-amber-200 hover:scale-110 transition-transform"
  ));

  // êµ¬ë¶„ì„ 
  var sep2 = document.createElement('div'); sep2.className = "w-[1px] h-5 bg-slate-300 mx-0.5"; container.appendChild(sep2);

  // 6. ì‚­ì œ
  container.appendChild(createLeaderToolButton(
    '<i class="fa-solid fa-trash-can"></i>', 
    "ì‚­ì œ", 
    function () { requestDeleteRow(index); }, 
    "h-9 w-[38px] bg-rose-100 text-rose-600 hover:bg-rose-200 hover:scale-110 transition-transform"
  ));

  // 7. ë‹«ê¸° (w-9 ìœ ì§€)
  container.appendChild(createLeaderToolButton(
    '<i class="fa-solid fa-xmark text-lg"></i>', 
    "ë©”ë‰´ ë‹«ê¸°", 
    function () { renderLeaderSettingsIcon(container, index); }, 
    "h-9 w-9 bg-transparent text-slate-400 hover:bg-slate-100 hover:text-slate-600 hover:scale-110 ml-1 transition-transform border border-transparent hover:border-slate-200 !flex-none"
  ));
}


function updateRowUI(index, isVisited, isBanned, isPub, memoContent) {
  var card = document.getElementById('card-' + index);
  if (!card) return;

  var isMarked = (index === currentMarkIndex);

  var leftSection = card.querySelector('.left-section');
  var iconDiv = leftSection.querySelector('.icon-div');
  var houseNumDiv = leftSection.querySelector('.house-num');
  var memoBtn = card.querySelector('.memo-btn');
  var textWrapper = houseNumDiv.parentElement;
  var existingMemo = textWrapper.querySelector('.memo-display');

  // 1. ë©”ëª¨ ì²˜ë¦¬ ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
  if (memoContent && memoContent.toString().trim().length > 0) {
    var memoColorClass = isBanned ? 'text-red-500' : (isPub ? 'text-green-600' : 'text-indigo-600');
    if (existingMemo) {
      existingMemo.innerText = memoContent;
      existingMemo.className = "memo-display text-xs font-medium mt-0.5 truncate max-w-[160px] " + memoColorClass;
    } else {
      var newMemo = document.createElement('div');
      newMemo.className = "memo-display text-xs font-medium mt-0.5 truncate max-w-[160px] " + memoColorClass;
      newMemo.innerText = memoContent;
      textWrapper.appendChild(newMemo);
    }
  } else {
    if (existingMemo) existingMemo.remove();
  }

  // 2. í…Œë‘ë¦¬ ì„¤ì • (ê¸°ì¡´ ìœ ì§€)
  var borderClass = 'border-transparent border';
  if (isMarked) borderClass = 'border-blue-400 border-2';
  else if (isVisited) borderClass = 'border-green-100 border';

  // 3. ìƒíƒœë³„ ìŠ¤íƒ€ì¼ ì ìš© (relativeì™€ shrink-0ë¥¼ ëª¨ë“  ì¡°ê±´ì— ì¶”ê°€)
  if (isBanned) {
    card.className = "relative rounded-2xl p-4 shadow-sm flex items-center justify-between transition-all active:scale-[0.99] tap-highlight-transparent border mb-3 bg-red-50 border-red-200 border";
    leftSection.classList.add('pointer-events-none');
    leftSection.classList.remove('opacity-40');
    houseNumDiv.className = 'house-num text-xl font-bold ml-1 text-red-400 line-through decoration-red-300';
    // â˜… [ìˆ˜ì •] ë°©ë¬¸ê¸ˆì§€ ìƒíƒœì—ì„œë„ ë°°ì§€ ìœ„ì¹˜ ë³´ì¡´ì„ ìœ„í•´ relative shrink-0 ì¶”ê°€
    iconDiv.className = 'icon-div w-11 h-11 rounded-full flex items-center justify-center transition-all duration-300 shrink-0 relative bg-red-100 text-red-400';
  } else if (isPub) {
    card.className = "relative rounded-2xl p-4 shadow-sm flex items-center justify-between transition-all active:scale-[0.99] tap-highlight-transparent border mb-3 bg-green-50 border-green-300 border-2";
    leftSection.classList.add('pointer-events-none');
    houseNumDiv.className = 'house-num text-xl font-bold ml-1 text-green-700';
    // â˜… [ìˆ˜ì •] ì „ë„ì¸ ì§‘ ìƒíƒœì—ì„œë„ ë°°ì§€ ìœ„ì¹˜ ë³´ì¡´ì„ ìœ„í•´ relative shrink-0 ì¶”ê°€
    iconDiv.className = 'icon-div w-11 h-11 rounded-full flex items-center justify-center transition-all duration-300 shrink-0 relative bg-green-600 text-white shadow-md';
  } else {
    card.className = "relative rounded-2xl p-4 shadow-sm flex items-center justify-between transition-all active:scale-[0.99] tap-highlight-transparent border mb-3 bg-white " + borderClass;
    leftSection.classList.remove('pointer-events-none', 'opacity-40');

    houseNumDiv.className = 'house-num text-xl font-bold ml-1 text-slate-800'; 

    // â˜… [ìˆ˜ì •] ì¼ë°˜ ìƒíƒœ (ì´ë¯¸ ì ìš©í•˜ì‹  ë¶€ë¶„ ìœ ì§€ ë° ë³´ê°•)
    iconDiv.className = 'icon-div w-11 h-11 rounded-full flex items-center justify-center transition-all duration-300 shrink-0 relative ' + 
                        (isVisited ? 'bg-green-500 text-white shadow-md' : 'bg-slate-50 border border-slate-200 text-slate-500');
  }

  // 4. ë©”ëª¨ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìœ ì§€)
  var hasMemo = memoContent && memoContent.toString().trim().length > 0;
  memoBtn.className = 'memo-btn w-10 h-10 rounded-full flex items-center justify-center transition-colors ' + 
                      (hasMemo ? (isPub ? 'bg-green-100 text-green-600' : (isBanned ? 'bg-red-100 text-red-500' : 'bg-indigo-50 text-indigo-500')) : 'text-slate-300 hover:bg-slate-50');
}




// â˜… [ìµœì¢… ìˆ˜ì •] 'ì—¬ê¸°ê¹Œì§€' ì„¤ì •: ëŒ€ì‹œë³´ë“œ ì§„ì… ì‹œ ë¬´ì¡°ê±´ ëŒ€ì‹œë³´ë“œ ë³µê·€
function toggleMark(index, visualNumber) {
  var oldIndex = currentMarkIndex;
  var newIndex = index;
  var displayInfo = "";

  // 1. ê°™ì€ ê³³ì„ ëˆ„ë¥´ë©´ í•´ì œ(null), ì•„ë‹ˆë©´ ì„¤ì •
  if (oldIndex === newIndex) {
    newIndex = null;
    displayInfo = null;
  } else {
    var now = new Date();
    var dateStr = now.getFullYear() + "." + (now.getMonth() + 1) + "." + now.getDate();
    displayInfo = dateStr + " " + currentUserName;
  }

  // 2. í™”ë©´ ë³€ìˆ˜ ì¦‰ì‹œ ê°±ì‹ 
  currentMarkIndex = (newIndex === null) ? -1 : newIndex;
  currentMarkInfo = displayInfo || "";
  lastMarkActionTime = Date.now();

  renderList(); // í™”ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°

  // 3. ë¡œì»¬ ìºì‹œ ì—…ë°ì´íŠ¸
  var localKey = getLocalKey(currentNumber);
  var localData = localStorage.getItem(localKey);
  if (localData) {
    try {
      var parsed = JSON.parse(localData);
      parsed.markData = {
        index: (newIndex === null ? "" : newIndex),
        info: (displayInfo === null ? "" : displayInfo)
      };
      saveToLocalStorage(localKey, parsed);
    } catch (e) {}
  }

  var nameToSend = (newIndex === null) ? "" : currentUserName;
  
  var houseInfo = "";
  if (newIndex !== null) {
    var hVal = currentData[newIndex][3] || "";
    var showNum = visualNumber || newIndex;
    if (hVal) {
      houseInfo = showNum + "ë²ˆ " + hVal;
    } else {
      houseInfo = showNum + "ë²ˆ ê°€êµ¬";
    }
  }

  // ============================================================
  // ğŸš€ [í•µì‹¬ ìˆ˜ì •] ì§„ì… ê²½ë¡œ(cameFromLeader)ì— ë”°ë¼ ë¶„ê¸° ì²˜ë¦¬
  // ============================================================
  if (newIndex !== null) {
      // [Case A] ëŒ€ì‹œë³´ë“œì—ì„œ ë“¤ì–´ì˜¨ ê²½ìš° (í¸ì§‘ëª¨ë“œ OR ë³´ê¸°ëª¨ë“œ ëª¨ë‘ í¬í•¨)
      if (cameFromLeader) {
          // í† ìŠ¤íŠ¸ ë„ìš°ê³  -> ëŒ€ì‹œë³´ë“œë¡œ ë³µê·€
          showLeaderReturnAlert(t("ëŒ€ì‹œë³´ë“œë¡œ ë³µê·€í•©ë‹ˆë‹¤."));
      } 
      // [Case B] ì¼ë°˜ ë¡œê·¸ì¸ (ìˆœìˆ˜ ë´‰ì‚¬ì)
      else {
          var targetNum = currentNumber;
          var targetName = currentUserName;

          if (typeof autoLogoutTimer !== 'undefined' && autoLogoutTimer) clearTimeout(autoLogoutTimer);
          
            showToast(t("ì—¬ê¸°ê¹Œì§€ ì²´í¬í–ˆê¸°ì— ì¢…ë£Œë©ë‹ˆë‹¤"), "fa-solid fa-flag text-blue-400", 2000);

          // 1.5ì´ˆ í›„ ë¡œê·¸ì•„ì›ƒ(í™”ë©´ ì´ˆê¸°í™”)
          autoLogoutTimer = setTimeout(function() {
            handleLogoutConfirm();
          }, 1500);

          // ë¡œê·¸ ì§€ì—° ì „ì†¡
          setTimeout(function() {
            google.script.run.withFailureHandler(function(){}).notifyExit(targetNum, targetName);
          }, 2500); 
      }
  }
  // ============================================================

 // 5. ì„œë²„ ì €ì¥ ìš”ì²­
google.script.run
  .withSuccessHandler(function() {
    // ì„±ê³µ ì‹œ í•  ì¼ ì—†ìŒ (ì´ë¯¸ ìœ„ì—ì„œ ì•Œë¦¼ ë„ì›€)
  })
  .withFailureHandler(function(e) {
    // ì‹¤íŒ¨ ì‹œì—ë§Œ ë³µêµ¬ ë° ì—ëŸ¬ ì•Œë¦¼
    if (cameFromLeader) {
      currentMarkIndex = oldIndex;
      renderList();
      showModal('ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + e);
    }
  })
  // â˜… ë§ˆì§€ë§‰ ì¸ìë¡œ currentLangì„ ì¶”ê°€í•˜ì—¬ ì„œë²„ê°€ í˜„ì¬ ì–¸ì–´ë¥¼ ì•Œê²Œ í•©ë‹ˆë‹¤.
  .saveMark(currentNumber, newIndex, nameToSend, houseInfo, isLeaderLoggedIn, currentLang);
}

      function openMemoModal(index) {
        if (Date.now() - lastWakeUpTime < 500) return;

        selectedRowIndex = index;
        var currentMemo = currentData[index][5] || "";
        var textarea = document.getElementById('memoText');
        textarea.value = currentMemo;
        updateModalButtons(currentMemo);
        document.getElementById('memoModal').classList.remove('hidden');
      }

function updateModalButtons(text) {
  var btnBan = document.getElementById('btnBan');
  var btnPub = document.getElementById('btnPub');
  var textarea = document.getElementById('memoText');
  var btnSave = document.getElementById('btnSaveMemo');
  
  // ğŸš€ ë©”ëª¨ì°½ì„ ì—´ì—ˆì„ ë•Œ í‚¤ì›Œë“œ ê°ì§€ ë¡œì§
  var isBan = (globalSettings.banKeywords || [t("ë°©ë¬¸ê¸ˆì§€")])
                .some(function(k) { return text.trim().indexOf(k) === 0; });

  var isPub = (globalSettings.pubKeywords || [t("ì „ë„ì¸ ì§‘")])
                .some(function(k) { return text.trim().indexOf(k) === 0; });

  // 1. ìƒë‹¨ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ í‘œì‹œ
  if (isBan) { btnBan.classList.add('btn-active-ban'); } else { btnBan.classList.remove('btn-active-ban'); }
  if (isPub) { btnPub.classList.add('btn-active-pub'); } else { btnPub.classList.remove('btn-active-pub'); }

  // 2. ì¡°ê±´ë³„ UI ìƒ‰ìƒ í…Œë§ˆ ì ìš©
  if (isBan) {
    // [ë°©ë¬¸ê¸ˆì§€: Red í…Œë§ˆ]
    textarea.classList.add('bg-red-50', 'border-red-300', 'text-red-600', 'focus:border-red-500');
    textarea.classList.remove('bg-slate-50', 'border-slate-200', 'bg-green-50', 'border-green-300', 'bg-sky-50', 'border-sky-300', 'text-green-600', 'text-sky-600');
    
    btnSave.classList.remove('bg-indigo-600', 'bg-green-600', 'bg-sky-500');
    btnSave.classList.add('bg-red-500', 'active:bg-red-600', 'hover:bg-red-600');

  } else if (isPub) {
    // ğŸ”µ [í•µì‹¬ ìˆ˜ì •] ì „ë„ì¸ ì§‘: Sky Blue í…Œë§ˆ ì ìš©
    textarea.classList.add('bg-sky-50', 'border-sky-300', 'text-sky-600', 'focus:border-sky-500');
    textarea.classList.remove('bg-red-50', 'border-red-300', 'text-red-600', 'bg-slate-50', 'border-slate-200', 'bg-green-50', 'border-green-300', 'text-green-600');
    
    btnSave.classList.remove('bg-indigo-600', 'bg-red-500', 'bg-green-600');
    btnSave.classList.add('bg-sky-500', 'active:bg-sky-600', 'hover:bg-sky-600');

  } else {
    // [ì¼ë°˜ ë©”ëª¨: Slate/Indigo í…Œë§ˆ]
    textarea.classList.remove('bg-red-50', 'border-red-300', 'text-red-600', 'bg-green-50', 'border-green-300', 'text-green-600', 'bg-sky-50', 'border-sky-300', 'text-sky-600');
    textarea.classList.add('bg-slate-50', 'border-slate-200');
    
    btnSave.classList.add('bg-indigo-600', 'active:bg-indigo-700', 'hover:bg-indigo-700');
    btnSave.classList.remove('bg-red-500', 'bg-green-600', 'bg-sky-500');
  }
}


function toggleKeyword(keyword) {
  var textarea = document.getElementById('memoText');
  var currentText = textarea.value.trim();
  
  // í˜„ì¬ ì„¤ì •ëœ ì–¸ì–´ì— ë§ëŠ” ë²ˆì—­ëœ í‚¤ì›Œë“œ ê°€ì ¸ì˜¤ê¸°
  var translatedKeyword = t(keyword); 

  // í† ê¸€ ë¡œì§: ì´ë¯¸ í•´ë‹¹ í‚¤ì›Œë“œ(ë²ˆì—­ë³¸)ë¡œ ì‹œì‘í•˜ë©´ ë¹„ìš°ê¸°
  if (currentText.indexOf(translatedKeyword) === 0) {
    textarea.value = "";
  } 
  else {
    // í‚¤ì›Œë“œ + ë‚ ì§œ + ì´ë¦„ ì¡°í•©
    var now = new Date();
    var dateStr = now.getFullYear() + "." + (now.getMonth() + 1) + "." + now.getDate();
    textarea.value = translatedKeyword + " (" + dateStr + " " + currentUserName + ")";
  }

  // ì¤‘ìš”: ê°’ì´ ë°”ë€ í›„ ìƒ‰ìƒ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë¥¼ ì¦‰ì‹œ í˜¸ì¶œ
  // updateModalButtons í•¨ìˆ˜ ë‚´ë¶€ì—ì„œë„ t(keyword)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¹„êµí•˜ê³  ìˆëŠ”ì§€ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
  updateModalButtons(textarea.value);
}

      function closeMemoModal() {
        document.getElementById('memoModal').classList.add('hidden');
        selectedRowIndex = -1;
      }

/**
 * ë©”ëª¨ ì €ì¥ í•¨ìˆ˜ (ìŠ¤í”¼ë„ˆ ë° ì„±ê³µ ì²´í¬ í‘œì‹œ ì™„ì „ ì œê±° ë²„ì „)
 */
function saveMemo() {
  if (selectedRowIndex === -1) return;
  var newMemo = document.getElementById('memoText').value.trim();
  var index = selectedRowIndex;

  // 1. íŠ¹ìˆ˜ ìƒíƒœ íŒë³„ (ë°©ë¬¸ê¸ˆì§€, ì „ë„ì¸ ì§‘)
  var isBanned = (globalSettings.banKeywords || [t("ë°©ë¬¸ê¸ˆì§€")])
                  .some(function(k) { return newMemo.trim().indexOf(k) === 0; });

  var isPub = (globalSettings.pubKeywords || [t("ì „ë„ì¸ ì§‘")])
                  .some(function(k) { return newMemo.trim().indexOf(k) === 0; });
  
  var isSpecial = isBanned || isPub;

  // ğŸš€ [ë°ì´í„° ì •í•©ì„±] íŠ¹ìˆ˜ ìƒíƒœë¼ë©´ ë©”ëª¨ë¦¬ ìƒì˜ ë²¨ ë°ì´í„°(index 7) ì¦‰ì‹œ í•´ì œ
  if (isSpecial) {
    currentData[index][7] = ""; 
  }
  
  // 2. ì¼ë°˜ ë©”ëª¨ì¼ ê²½ìš° ë‚ ì§œ + ì´ë¦„ ì¶”ê°€ ë¡œì§
  if (!isSpecial && newMemo.length > 0) {
    var now = new Date();
    var dateStr = (now.getMonth() + 1) + "." + now.getDate(); 
    var nameStr = (typeof currentUserName !== 'undefined' && currentUserName) ? " " + currentUserName : "";
    
    if (!newMemo.includes("/ " + dateStr)) { 
      newMemo = newMemo + " / " + dateStr + nameStr; 
    }
  }

  // ì´ì „ ë°ì´í„° ë°±ì—… (ì‹¤íŒ¨ ì‹œ ë³µêµ¬ìš©)
  var oldMemo = currentData[index][5];
  var oldStatus = currentData[index][4];
  var oldBell = currentData[index][7]; 

  // UI ì¦‰ì‹œ ë°˜ì˜ (ë‚™ê´€ì  ì—…ë°ì´íŠ¸)
  currentData[index][5] = newMemo;
  var isVisited = currentData[index][4] === 'Y';
  var checkValue = null;

  if (isSpecial) {
    currentData[index][4] = 'N';
    checkValue = 'N';
    isVisited = false;
  }
  
  // ğŸš€ [ì¤‘ìš”] ë³´í˜¸ë§‰ ì‹œê°„ ê¸°ë¡: ì„œë²„ ë°ì´í„°ê°€ ë‚´ ìˆ˜ì •ì„ ë®ì–´ì“°ì§€ ëª»í•˜ê²Œ ë°©ì–´ (20ì´ˆ)
  lastRowActionTime[index] = Date.now();
  lastMemoActionTime = Date.now();

  // ğŸ¨ [UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸] ìŠ¤í”¼ë„ˆ í‘œì‹œ ë¡œì§ ì—†ìŒ
  updateRowUI(index, isVisited, isBanned, isPub, newMemo);
  renderList(); 
  closeMemoModal();

  // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
  var localKey = getLocalKey(currentNumber);
  var localData = localStorage.getItem(localKey);
  if(localData) {
    try {
        var parsed = JSON.parse(localData);
        parsed.data[index][4] = currentData[index][4];
        parsed.data[index][5] = newMemo;
        parsed.data[index][7] = currentData[index][7]; 
        saveToLocalStorage(localKey, parsed);
    } catch(e) { console.error("Cache update failed", e); }
  }

  // --- [STEP 2] ì„œë²„ ì „ì†¡ ---
  google.script.run
    .withSuccessHandler(function() { 
      // âœ… [í•µì‹¬ ìˆ˜ì •] ì„±ê³µ ì‹œ ì²´í¬ í‘œì‹œ(syncedVisits)ë¥¼ ë„ìš°ëŠ” ë¡œì§ì„ ì™„ì „íˆ ì œê±°í–ˆìŠµë‹ˆë‹¤.
      // ì´ì œ ì„œë²„ ì €ì¥ì´ ì™„ë£Œë˜ì–´ë„ í™”ë©´ì—ëŠ” ì•„ë¬´ëŸ° ì‹œê°ì  ë³€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.
    })
    .withFailureHandler(function(e) {
      // âŒ [ì‹¤íŒ¨ ì‹œ ë³µêµ¬] ì €ì¥ì— ì‹¤íŒ¨í–ˆì„ ë•Œë§Œ ë³´í˜¸ë§‰ì„ í’€ê³  ë°ì´í„°ë¥¼ ì›ë³µí•©ë‹ˆë‹¤.
      lastRowActionTime[index] = 0; 
      
      currentData[index][5] = oldMemo;
      currentData[index][4] = oldStatus;
      currentData[index][7] = oldBell;

      var memoToRestore = oldMemo || "";
      var isBannedRestore = (globalSettings.banKeywords || [t("ë°©ë¬¸ê¸ˆì§€")]).some(k => memoToRestore.trim().indexOf(k) === 0);
      var isPubRestore    = (globalSettings.pubKeywords || [t("ì „ë„ì¸ ì§‘")]).some(k => memoToRestore.trim().indexOf(k) === 0);

      updateRowUI(index, oldStatus === 'Y', isBannedRestore, isPubRestore, oldMemo);
      renderList();
      showToast(t("ì €ì¥ ì‹¤íŒ¨"), "fa-solid fa-triangle-exclamation text-red-400");
    })
    .updateRowStatus(currentNumber, index, checkValue, newMemo, currentUserName, isSpecial);
}


/**
 * ë©”ëª¨ ì…ë ¥ì°½ì˜ ë‚´ìš©ì„ ì¦‰ì‹œ ë¹„ìš°ëŠ” í•¨ìˆ˜
 */
function clearMemoInput() {
  const textarea = document.getElementById('memoText');
  if (textarea) {
    textarea.value = ""; // í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
    
    // ğŸ¨ ë°©ë¬¸ê¸ˆì§€/ì „ë„ì¸ ë“± ë²„íŠ¼ì´ í™œì„±í™”ë˜ì–´ ìƒ‰ìƒì´ ë³€í•´ìˆì„ ê²½ìš°ë¥¼ ìœ„í•´ ì´ˆê¸°í™” í˜¸ì¶œ
    if (typeof updateModalButtons === 'function') {
      updateModalButtons(""); 
    }
    
    textarea.focus(); // ë°”ë¡œ ì…ë ¥í•  ìˆ˜ ìˆë„ë¡ í¬ì»¤ìŠ¤ ìœ ì§€
  }
}


/**
 * ë‚˜ê°€ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰: êµ¬ì—­ ë°©ë¬¸ ë‹¨ê³„ë³„ ì¢…ë£Œ í™•ì¸ ëª¨ë‹¬ ì œì–´
 */
function goBack() { 
    const modalBadge = document.getElementById('modalStatusBadge');
    const btnNo = document.getElementById('btnCompNo');
    const btnYes = document.getElementById('btnCompYes');
    const modalTitle = document.querySelector('#completionConfirmModal h3');
    const modalDesc = document.querySelector('#completionConfirmModal p');

    // 1. í˜„ì¬ ìƒíƒœ ë°°ì§€ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (ë‹¤êµ­ì–´ ë²ˆì—­ ì ìš©)
    modalBadge.innerText = t(currentZoneStatus); 
    const baseStyle = "inline-block rounded-full shadow-md transition-colors font-extrabold text-base px-5 py-1.5 tracking-tight";

    // 2. ê¸°ë³¸ í´ë¦­ ë™ì‘ ì´ˆê¸°í™” (handleCompletion í•¨ìˆ˜ì™€ ì—°ê²°)
    // 'N'ì€ ìƒíƒœ ìœ ì§€ í˜¹ì€ ì·¨ì†Œ, 'Y'ëŠ” ì™„ë£Œ í˜¹ì€ ë‹¤ìŒ ë‹¨ê³„ ì´ë™ì„ ì˜ë¯¸í•¨
    btnNo.onclick = () => handleCompletion('N');
    btnYes.onclick = () => handleCompletion('Y');

    // 3. êµ¬ì—­ì˜ ìƒíƒœ(Workflow)ì— ë”°ë¥¸ ë™ì  UI êµ¬ì„±
    // [íë¦„ìƒ ë‹¨ê³„: í˜¸ë³„(ì´ˆê¸°) -> ë¶€ì¬(ì¤‘ê°„) -> ì™„ë£Œ(ìµœì¢…)]
    
    if (currentZoneStatus === "ì™„ë£Œ") {
        // [CASE 1] ì´ë¯¸ ì™„ë£Œëœ êµ¬ì—­: "ì™„ë£Œë¥¼ ì·¨ì†Œí•˜ê³  ì´ì „ ë‹¨ê³„ë¡œ ëŒì•„ê°ˆì§€" í™•ì¸
        modalBadge.className = `${baseStyle} bg-zinc-600 text-white`;
        modalTitle.innerText = t("ì™„ë£Œë¥¼ ì·¨ì†Œí• ê¹Œìš”?");
        modalDesc.innerText = t("ì˜ˆë¥¼ ëˆ„ë¥´ë©´ ë¶€ì¬ ê·¸ë£¹ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");

        // ì™„ë£Œ ìƒíƒœì—ì„œëŠ” 'ì•„ë‹ˆì˜¤'ê°€ ìƒíƒœ ìœ ì§€(Y), 'ì˜ˆ'ê°€ ì·¨ì†Œ/ë³µêµ¬(N)ë¡œ ì‘ë™í•˜ë„ë¡ ë²„íŠ¼ ë¡œì§ ì—­ì „
        btnNo.onclick = () => handleCompletion('Y'); 
        btnNo.innerHTML = `${t("ì•„ë‹ˆì˜¤")}<br><span class="text-[11px] font-normal opacity-80">(${t("ìœ ì§€")})</span>`;
        
        btnYes.onclick = () => handleCompletion('N');
        btnYes.innerHTML = `${t("ì˜ˆ")}<br><span class="text-[11px] font-normal opacity-90">(${t("ë¶€ì¬ê·¸ë£¹ìœ¼ë¡œ")})</span>`;

    } else if (currentZoneStatus === "ë¶€ì¬") {
        // [CASE 2] ë¶€ì¬(ì¤‘ê°„) ë‹¨ê³„: "ì „ì²´ ë§ˆê°(ì™„ë£Œ)" ì²˜ë¦¬ë¥¼ í• ì§€ í™•ì¸
        modalBadge.className = `${baseStyle} bg-amber-500 text-white`;
        modalTitle.innerText = t("êµ¬ì—­ ë°©ë¬¸ì„ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆê¹Œ?");
        modalDesc.innerText = t("ì™„ë£Œ ì—¬ë¶€ì— ë”°ë¼ êµ¬ì—­ ìƒíƒœê°€ ê¸°ë¡ë©ë‹ˆë‹¤.");
        
        btnNo.innerHTML = `${t("ì•„ë‹ˆì˜¤")}<br><span class="text-[11px] font-normal opacity-80">(${t("ìœ ì§€")})</span>`;
        btnYes.innerHTML = `${t("ì˜ˆ")}<br><span class="text-[11px] font-normal opacity-90">(${t("ì™„ë£Œê·¸ë£¹ìœ¼ë¡œ")})</span>`;
        
    } else {
        // [CASE 3] í˜¸ë³„ ë°©ë¬¸(ì´ˆê¸°) ë‹¨ê³„: "ë¶€ì¬ ê°€êµ¬ ì‘ì—…(ì¤‘ê°„ ë‹¨ê³„)ìœ¼ë¡œ ë„˜ê¸¸ì§€" í™•ì¸
        modalBadge.className = `${baseStyle} bg-emerald-500 text-white`;
        modalTitle.innerText = t("êµ¬ì—­ ë°©ë¬¸ì„ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆê¹Œ?");
        modalDesc.innerText = t("ì™„ë£Œ ì—¬ë¶€ì— ë”°ë¼ êµ¬ì—­ ìƒíƒœê°€ ê¸°ë¡ë©ë‹ˆë‹¤.");
        
        btnNo.innerHTML = `${t("ì•„ë‹ˆì˜¤")}<br><span class="text-[11px] font-normal opacity-80">(${t("ìœ ì§€")})</span>`;
        btnYes.innerHTML = `${t("ì˜ˆ")}<br><span class="text-[11px] font-normal opacity-90">(${t("ë¶€ì¬ê·¸ë£¹ìœ¼ë¡œ")})</span>`;
    }

    // ëª¨ë‹¬ì°½ í‘œì‹œ
    document.getElementById('completionConfirmModal').classList.remove('hidden');
}


      // [ìˆ˜ì •] ì¸ë„ì ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­ ì‹œ ë™ì‘
function handleLeaderLogout() {
  // ë¶ˆì•ˆì •í•œ ì•Œë¦¼ì°½(Alert) ëŒ€ì‹ , ì˜ˆ/ì•„ë‹ˆì˜¤ ì„ íƒì´ ê°€ëŠ¥í•œ 'í™•ì¸ ëª¨ë‹¬(Confirm)'ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
  var modal = document.getElementById('customConfirmModal');
  var title = modal.querySelector('h3');
  
  // ëª¨ë‹¬ ë¬¸êµ¬ë¥¼ ë¡œê·¸ì•„ì›ƒìš©ìœ¼ë¡œ ë³€ê²½ (ë‹¤êµ­ì–´ ì§€ì›)
  // ê¸°ì¡´ ë¬¸êµ¬: "í˜„ì¬ êµ¬ì—­ì¹´ë“œì—ì„œ ë‚˜ê°ˆê¹Œìš”?" -> ë³€ê²½: "ëŒ€ì‹œë³´ë“œë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
  title.innerText = t("ëŒ€ì‹œë³´ë“œë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
  
  // ëª¨ë‹¬ ë„ìš°ê¸°
  // (ì´ ëª¨ë‹¬ì˜ 'í™•ì¸' ë²„íŠ¼ì€ HTML ìƒì—ì„œ ì´ë¯¸ handleLogoutConfirm()ê³¼ ì—°ê²°ë˜ì–´ ìˆì–´ ì‘ë™ì´ 100% ë³´ì¥ë©ë‹ˆë‹¤)
  modal.classList.remove('hidden');
}


// ==========================================
// [ì‹ ê·œ] SOS ê¸´ê¸‰ ì•Œë¦¼ ë¡œì§ (ì™„ì „ì²´)
// ==========================================

let currentSOSAlertId = 0; // í˜„ì¬ ë– ìˆëŠ” ì•Œë¦¼ì˜ ID

// 1. SOS ë²„íŠ¼ í´ë¦­ (ë°œì‹ ì)
function handleSOSClick() {
  document.getElementById('sosConfirmModal').classList.remove('hidden');
}

// 2. SOS ë°œì†¡ í™•ì • (ë°œì‹ ì) - ì£¼ì†Œ/ê±´ë¬¼ëª… ì¶”ì¶œ ë¡œì§ ì¶”ê°€ë¨
function confirmSendSOS() {
  document.getElementById('sosConfirmModal').classList.add('hidden');
  
  // (1) ìœ„ì¹˜ ë° ì£¼ì†Œ ì •ë³´ ì°¾ê¸°
  var locInfo = "ë°©ë¬¸ ê¸°ë¡ ì—†ìŒ";
  var addrRoad = "";
  var addrBuild = "";
  var targetIndex = -1;

  // ë§ˆí¬ê°€ ìˆìœ¼ë©´ ë§ˆí¬ ìœ„ì¹˜, ì—†ìœ¼ë©´ ë§ˆì§€ë§‰ ë°©ë¬¸ ìœ„ì¹˜ ìš°ì„ 
  if (currentMarkIndex !== -1) {
      targetIndex = currentMarkIndex;
      var hName = currentData[targetIndex][3] || (targetIndex + "ë²ˆ í•­ëª©");
      locInfo = hName + " (ì™„ë£Œ)";
  } else {
      for (var i = currentData.length - 1; i >= 1; i--) {
          if (currentData[i][4] === 'Y') {
             targetIndex = i;
             var hName = currentData[i][3] || (i + "ë²ˆ í•­ëª©");
             locInfo = "ìµœê·¼ ë°©ë¬¸: " + hName;
             break;
          }
      }
  }

  // (2) ì£¼ì†Œì™€ ê±´ë¬¼ëª… ì¶”ì¶œ (currentDataì˜ 0:ë„ë¡œëª…, 1:ë²ˆì§€, 2:ê±´ë¬¼ëª…)
  if (targetIndex !== -1 && currentData[targetIndex]) {
      var row = currentData[targetIndex];
      // ë„ë¡œëª… + ë²ˆì§€ í•©ì¹˜ê¸°
      addrRoad = (row[0] || "") + " " + (row[1] || "");
      addrBuild = row[2] || "";
  }
  
  // ì£¼ì†Œê°€ ì—†ìœ¼ë©´ í˜„ì¬ êµ¬ì—­ ì´ë¦„ì´ë¼ë„ ë„£ìŒ
  if (!addrRoad.trim()) addrRoad = document.getElementById('headerTarget').innerText;

  var addressObj = { road: addrRoad.trim(), build: addrBuild.trim() };

  showToast(t("ê¸´ê¸‰ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤."), "fa-solid fa-spinner fa-spin text-white");

  // (3) ì„œë²„ ì „ì†¡
  google.script.run
    .withSuccessHandler(function(res) {
     if(res.success) showToast(t("ì•Œë¦¼ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤."), "fa-solid fa-check text-white");
       else showModal(t("ì „ì†¡ ì‹¤íŒ¨: " + res.message));
        })
    .withFailureHandler(function(e) { showModal("í†µì‹  ì˜¤ë¥˜: " + e); })
    .sendGlobalSOS(currentNumber, currentUserName, locInfo, addressObj);
    }

// [ìˆ˜ì •ë¨] SOS ì•Œë¦¼ ìˆ˜ì‹  ì²´í¬ (ëŒ€ì‹œë³´ë“œ í—ˆìš© + ì˜¤ë””ì˜¤ ì‚¬ì´ë Œ ì¶”ê°€ ë²„ì „)
function checkSOS(alerts) {
  if (!alerts || alerts.length === 0) return;
  
  // 1. í™”ë©´ ìƒíƒœ í™•ì¸
  var mainHidden = document.getElementById('mainView').classList.contains('hidden');
  var leaderHidden = document.getElementById('leaderView').classList.contains('hidden');

  // â˜… [í•µì‹¬] "ë©”ì¸í™”ë©´ë„ êº¼ì ¸ìˆê³  && ëŒ€ì‹œë³´ë“œë„ êº¼ì ¸ìˆìœ¼ë©´" -> ë¬´ì‹œ (ë¡œê·¸ì¸ í™”ë©´)
  if (mainHidden && leaderHidden) return;

  // ê°€ì¥ ìµœì‹  ì•Œë¦¼ ê°€ì ¸ì˜¤ê¸°
  var latestAlert = alerts.sort((a,b) => b.id - a.id)[0];
  
  // ë‚´ê°€ ë³´ë‚¸ ê±´ ë¬´ì‹œ
  if (latestAlert.sender === currentUserName) return;

  // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í™•ì¸ (ì´ë¯¸ ë³¸ ì•Œë¦¼ì¸ì§€)
  var lastConfirmedId = parseInt(localStorage.getItem("LAST_CONFIRMED_SOS_ID") || "0", 10);
  if (latestAlert.id <= lastConfirmedId) return;

  // --- ì•Œë¦¼ í‘œì‹œ ë° ì‚¬ì´ë Œ ì‘ë™ ---
  currentSOSAlertId = latestAlert.id;

  // ğŸš¨ [ì¶”ê°€] ì‚¬ì´ë Œ ì†Œë¦¬ ì¬ìƒ (ì‚¬ìš©ì í„°ì¹˜ ì´ë ¥ì´ ìˆì–´ì•¼ ì¬ìƒë¨)
  sosAlarm.play().catch(e => console.log("ì˜¤ë””ì˜¤ ì¬ìƒ ì°¨ë‹¨ë¨:", e));

  // í…ìŠ¤íŠ¸ ì±„ìš°ê¸°
  document.getElementById('sosSenderDisplay').innerText = latestAlert.sender + " ì „ë„ì¸";
  document.getElementById('sosCardDisplay').innerText = latestAlert.card + "ë²ˆ ì¹´ë“œ";
  document.getElementById('sosLocDisplay').innerText = latestAlert.loc || "ìœ„ì¹˜ ì •ë³´ ì—†ìŒ";
  document.getElementById('sosTimeDisplay').innerText = latestAlert.time + " ìˆ˜ì‹ ë¨";

  // ì£¼ì†Œ ì •ë³´ í‘œì‹œ
  var addrDiv = document.getElementById('sosAddressDisplay');
  if (latestAlert.addr) {
      var r = latestAlert.addr.road || "ì£¼ì†Œ ë¯¸ìƒ";
      var b = latestAlert.addr.build || "";
      addrDiv.innerHTML = `
        <span class="text-slate-800 font-bold block">${r}</span>
        ${b ? `<span class="text-slate-600 text-sm font-medium">${b}</span>` : ""}
      `;
  } else {
      addrDiv.innerHTML = '<span class="text-slate-400 text-sm">ì£¼ì†Œ ì •ë³´ ì—†ìŒ</span>';
  }
  
  // ëª¨ë‹¬ ë„ìš°ê¸°
  document.getElementById('sosAlertModal').classList.remove('hidden');
  
  // ì§„ë™ ë°œìƒ
  if (navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 1000]); 
}

// 4. ëª¨ë‹¬ ë‹«ê¸° (í™•ì¸ ë²„íŠ¼) - ì˜êµ¬ ë‹«í˜ ì²˜ë¦¬ ë° ì‚¬ì´ë Œ ì •ì§€
function closeSOSModal() {
  // (A) ëª¨ë‹¬ì°½ ìˆ¨ê¸°ê¸°
  document.getElementById('sosAlertModal').classList.add('hidden');
  
  // ğŸ”‡ (B) [ì¶”ê°€] SOS ì‚¬ì´ë Œ ì •ì§€ ë° ì¬ìƒ ì‹œê°„ ì´ˆê¸°í™”
  // sosAlarm ê°ì²´ê°€ ìƒë‹¨ì— ì„ ì–¸ë˜ì–´ ìˆì–´ì•¼ ì‘ë™í•©ë‹ˆë‹¤.
  if (typeof sosAlarm !== 'undefined') {
      sosAlarm.pause();
      sosAlarm.currentTime = 0; 
  }
  
  // â˜… ì¤‘ìš”: í˜„ì¬ ì•Œë¦¼ IDë¥¼ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥í•˜ì—¬ ë‹¤ì‹œ ì•ˆ ëœ¨ê²Œ í•¨
  if (currentSOSAlertId > 0) {
      localStorage.setItem("LAST_CONFIRMED_SOS_ID", currentSOSAlertId.toString());
  }
}


      function closeConfirmModal() { document.getElementById('customConfirmModal').classList.add('hidden'); }
      function closeCompletionConfirmModal() { document.getElementById('completionConfirmModal').classList.add('hidden'); }

      function updateLocalLeaderData(number, fromGroup, toGroup) {
        if (!leaderDashboardData) return;
        var numStr = number.toString();

        if (fromGroup === 'house' && leaderDashboardData.house) {
            leaderDashboardData.house = leaderDashboardData.house.filter(n => n !== numStr);
        } else if (fromGroup === 'busy' && leaderDashboardData.busy) {
            leaderDashboardData.busy = leaderDashboardData.busy.filter(n => n !== numStr);
        } else if (fromGroup === 'complete' && leaderDashboardData.complete) {
            leaderDashboardData.complete = leaderDashboardData.complete.filter(n => n !== numStr);
        }

        if (toGroup === 'house') {
            if (!leaderDashboardData.house) leaderDashboardData.house = [];
            if (!leaderDashboardData.house.includes(numStr)) leaderDashboardData.house.push(numStr);
        } else if (toGroup === 'busy') {
            if (!leaderDashboardData.busy) leaderDashboardData.busy = [];
            if (!leaderDashboardData.busy.includes(numStr)) leaderDashboardData.busy.push(numStr);
        } else if (toGroup === 'complete') {
            if (!leaderDashboardData.complete) leaderDashboardData.complete = [];
            if (!leaderDashboardData.complete.includes(numStr)) leaderDashboardData.complete.push(numStr);
            
            if (!leaderDashboardData.completionDates) leaderDashboardData.completionDates = {};
            var today = new Date();
            var dateStr = today.getFullYear() + "." + (today.getMonth() + 1) + "." + today.getDate();
            leaderDashboardData.completionDates[numStr] = dateStr;
        }
      }

      // [handleCompletion í•¨ìˆ˜ ìˆ˜ì •]
    function handleCompletion(result) {
      closeCompletionConfirmModal();
      
      if (currentNumber === "" || currentNumber === "0") {
        document.getElementById('customConfirmModal').classList.remove('hidden');
        return;
      }

      var isCompleted = (result === 'Y');
      
      var targetNum = currentNumber;
      var targetUser = currentUserName;
      var targetStatus = currentZoneStatus;

      // ì„œë²„ì— ì™„ë£Œ/ë¯¸ì™„ë£Œ ì²˜ë¦¬ ìš”ì²­
      google.script.run
        .withSuccessHandler(function(res) {
          if (res && res.success) {
            if (isCompleted) {
              localStorage.removeItem(getLocalKey(targetNum));
            }
          }
          // ì¸ë„ìë¼ë©´ ëŒ€ì‹œë³´ë“œ ë°ì´í„° ê°±ì‹ 
          if (cameFromLeader) {
            refreshLeaderDashboardInBackground();
          }
        })
        .withFailureHandler(function(e) { 
            console.log(e); 
            if (cameFromLeader) refreshLeaderDashboardInBackground(); 
        })
        .completeZone(targetNum, isCompleted, targetUser, targetStatus);


      // â˜…â˜…â˜… [í•µì‹¬ ìˆ˜ì •] isLeaderLoggedIn ì¡°ê±´ ì œê±° â˜…â˜…â˜…
      // í¸ì§‘ ëª¨ë“œë¥¼ ê»ë”ë¼ë„, ëŒ€ì‹œë³´ë“œì—ì„œ ì™”ë‹¤ë©´(cameFromLeader) ëŒ€ì‹œë³´ë“œë¡œ ë³µê·€í•©ë‹ˆë‹¤.
      if (cameFromLeader) {
          
          var fromGroup = "";
          var toGroup = "";
          
          if (targetStatus === "í˜¸ë³„") {
              fromGroup = "house";
              toGroup = (result === 'Y') ? "busy" : "house"; 
          } else if (targetStatus === "ë¶€ì¬") {
              fromGroup = "busy";
              toGroup = (result === 'Y') ? "complete" : "busy"; 
          } else if (targetStatus === "ì™„ë£Œ") {
              fromGroup = "complete";
              toGroup = (result === 'N') ? "busy" : "complete"; 
          }

          if (fromGroup !== "" && toGroup !== "" && fromGroup !== toGroup) {
              updateLocalLeaderData(targetNum, fromGroup, toGroup);
          }

          if (leaderDashboardData) {
            renderLeaderDashboard(leaderDashboardData);
          }
          var msg = (result === 'Y') ? t("ëŒ€ì‹œë³´ë“œë¡œ ë³µê·€í•©ë‹ˆë‹¤.") : t("ëŒ€ì‹œë³´ë“œë¡œ ë³µê·€í•©ë‹ˆë‹¤.");
          showLeaderReturnAlert(msg);

      } else {
          // ì¼ë°˜ ì „ë„ì¸ì€ ë¡œê·¸ì•„ì›ƒ
          handleLogoutConfirm();
      }
    }


// [ìµœì¢… ìˆ˜ì •] ë¡œê·¸ì•„ì›ƒ í™•ì • ì²˜ë¦¬ í•¨ìˆ˜ (ì•ˆì „ì„± ê°•í™” + SOS ì •ì§€ ì¶”ê°€)
function handleLogoutConfirm() {
  // 1. ëª¨ë‹¬ ë‹«ê¸°
  closeConfirmModal();

  // 2. â˜… [í•µì‹¬] í™”ë©´ ì „í™˜ì„ ìµœìš°ì„ ìœ¼ë¡œ ì‹¤í–‰ (ë‚´ë¶€ ì˜¤ë¥˜ê°€ ë‚˜ë„ í™”ë©´ì€ ë¬´ì¡°ê±´ ë°”ë€œ)
  var loginView = document.getElementById('loginView');
  var mainView = document.getElementById('mainView');
  var leaderView = document.getElementById('leaderView');

  // ë¡œê·¸ì¸ í™”ë©´ ì¦‰ì‹œ ë“±ì¥
  if (loginView) {
    loginView.classList.remove('hidden');
    // ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼
    requestAnimationFrame(function() {
        loginView.classList.remove('translate-y-full');
    });
  }

  // ê¸°ì¡´ í™”ë©´ë“¤ ìˆ¨ê¸°ê¸° (0.3ì´ˆ ë’¤ ì™„ì „íˆ ìˆ¨ê¹€)
  setTimeout(function() {
    if(mainView) mainView.classList.add('hidden');
    if(leaderView) leaderView.classList.add('hidden');
  }, 300);

  // 3. í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ì •ë¦¬
  var toastContainer = document.getElementById('toastContainer');
  if (toastContainer) toastContainer.classList.add('opacity-0', 'translate-y-10');
  if (typeof toastTimer !== 'undefined' && toastTimer) { clearTimeout(toastTimer); toastTimer = null; }

  // 4. ëª¨ë“  íƒ€ì´ë¨¸ ê°•ì œ ì •ì§€ (ë°±ê·¸ë¼ìš´ë“œ ë°ì´í„° ê°±ì‹  ë° SOS ê°ì§€ ì°¨ë‹¨)
  if (typeof leaderTimer !== 'undefined' && leaderTimer) { clearInterval(leaderTimer); leaderTimer = null; }
  if (typeof syncTimer !== 'undefined' && syncTimer) { clearTimeout(syncTimer); syncTimer = null; }
  if (typeof autoLogoutTimer !== 'undefined' && autoLogoutTimer) { clearTimeout(autoLogoutTimer); autoLogoutTimer = null; }
  if (typeof lockCheckInterval !== 'undefined' && lockCheckInterval) { clearInterval(lockCheckInterval); lockCheckInterval = null; }
  
  // ğŸš€ [ì¶”ê°€] SOS ì´ˆê³ ì† ê°ì‹œ íƒ€ì´ë¨¸ ì •ì§€
  if (typeof sosFastTimer !== 'undefined' && sosFastTimer) { 
    clearInterval(sosFastTimer); 
    sosFastTimer = null; 
    console.log("ğŸ†˜ SOS ê°ì‹œ ì—”ì§„ ì •ì§€ë¨");
  }
  
  stopKeepAlive();

  // 5. ì„œë²„ ì •ë¦¬ ì‘ì—… (ì—ëŸ¬ê°€ ë‚˜ë„ ë¬´ì‹œí•˜ê³  ì§„í–‰í•˜ë„ë¡ failureHandler ì²˜ë¦¬)
  if (isLeaderLoggedIn) {
      updateLockIcon(false);
      // êµ¬ì—­ ë²ˆí˜¸ê°€ ìœ íš¨í•  ë•Œë§Œ ì ê¸ˆ í•´ì œ ìš”ì²­
      if (currentNumber && currentNumber !== "0") {
        google.script.run.withFailureHandler(function(){})
          .manageEditingLock(currentNumber, currentUserName, 'UNLOCK');
      }
  }

  if (currentNumber && currentUserName) {
      google.script.run.withFailureHandler(function(){})
        .notifyExit(currentNumber, currentUserName, currentLang, false);
  }

  // 6. ë³€ìˆ˜ ì´ˆê¸°í™”
  isSyncing = false;
  currentNumber = "";
  isLeaderLoggedIn = false;
  cameFromLeader = false;
  leaderDashboardData = null;
  lastRowActionTime = {};
  if (typeof pendingRows !== 'undefined') pendingRows.clear();
  
  // SOS ê´€ë ¨ ìƒíƒœê°’ ì´ˆê¸°í™”
  currentSOSAlertId = 0; 

  // 7. ì…ë ¥ì°½ ë¹„ìš°ê¸°
  var numInput = document.getElementById('numberInput');
  if(numInput) numInput.value = '';
  var pwInput = document.getElementById('modalPasswordInput');
  if(pwInput) pwInput.value = '';

  // 8. ìµœê·¼ ê¸°ë¡ í™•ì¸
  checkRecentHistory();
}



function returnToLeaderDashboard() {
  closeAlertModal();
  
  // 1. [í•µì‹¬ ìˆ˜ì •] ë–  ìˆëŠ” í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ê°•ì œ ì‚­ì œ
  var toastContainer = document.getElementById('toastContainer');
  if (toastContainer) {
    // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ì„ ì§ì ‘ ì¡°ì‘í•´ì•¼ CSS í´ë˜ìŠ¤ ìš°ì„ ìˆœìœ„ ë¬¸ì œë¥¼ ë¬´ì‹œí•˜ê³  ì¦‰ì‹œ ì‚¬ë¼ì§‘ë‹ˆë‹¤.
    toastContainer.style.opacity = '0';
    toastContainer.style.transform = 'translate(-50%, 20px)';
    toastContainer.style.pointerEvents = 'none';
    
    // ê¸°ì¡´ í´ë˜ìŠ¤ ìƒíƒœë„ ë™ê¸°í™”
    toastContainer.classList.add('opacity-0', 'translate-y-10');
  }
  
  // ì˜ˆì•½ëœ í† ìŠ¤íŠ¸ íƒ€ì´ë¨¸ê°€ ìˆë‹¤ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ì—¬ ì”ìƒì´ ë‚¨ì§€ ì•Šê²Œ í•¨
  if (typeof toastTimer !== 'undefined' && toastTimer) {
    clearTimeout(toastTimer);
    toastTimer = null;
  }

  // --- ì´í•˜ ê¸°ì¡´ ë¡œì§ ìœ ì§€ ---
  if (autoLogoutTimer) clearTimeout(autoLogoutTimer);
  if (syncTimer) clearTimeout(syncTimer);
  isSyncing = false;
  
  // â˜… [í•µì‹¬] í¸ì§‘ ê°ì‹œ ë ˆì´ë” ì¤‘ë‹¨
  if (typeof lockCheckInterval !== 'undefined' && lockCheckInterval) { 
      clearInterval(lockCheckInterval); 
      lockCheckInterval = null; 
  }

  stopKeepAlive();

  var targetNum = currentNumber;
  var targetName = currentUserName;

  if (targetNum && targetName) {
      google.script.run.withFailureHandler(function(){}).notifyExit(targetNum, targetName, true); 
      setTimeout(function() {
         google.script.run.withFailureHandler(function(){}).notifyExit(targetNum, targetName, true);
      }, 2500);
  }

  if (targetNum) {
      google.script.run.withFailureHandler(function(){}).manageEditingLock(targetNum, targetName, 'UNLOCK');
  }

  currentNumber = "";
  cameFromLeader = false;
  
  updateLockIcon(false);
  lastRowActionTime = {};

  document.getElementById('mainView').classList.add('hidden');
  document.getElementById('leaderView').classList.remove('hidden');

  refreshLeaderDashboardInBackground();
}



      function closeAllMenus(e) { }
      function onFailure(e) { showLoading(false); showModal("ì‹œìŠ¤í…œ ì˜¤ë¥˜: " + (e.message || "ì•Œ ìˆ˜ ì—†ìŒ")); }

// [ìµœì í™”] ë‹¤êµ­ì–´ ëŒ€ì‘ ë¡œë”© ë©”ì‹œì§€ í•¨ìˆ˜
function showLoading(show, customMessage) {
    var el = document.getElementById('loadingOverlay');
    var msgEl = el.querySelector('p');

    if (show) {
        if (customMessage) {
            // [ìˆ˜ì •] ì¸ìë¡œ ë°›ì€ ë©”ì‹œì§€ í‚¤ë¥¼ ë²ˆì—­í•˜ì—¬ í‘œì‹œ
            msgEl.innerText = t(customMessage);
        } else {
            // [ìˆ˜ì •] ê¸°ë³¸ ë©”ì‹œì§€ í‚¤ë¥¼ ë²ˆì—­í•˜ì—¬ í‘œì‹œ
            msgEl.innerText = t("êµ¬ì—­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
        }
        el.classList.remove('hidden');
    } else {
        el.classList.add('hidden');
    }
}

// =========================
//  êµ¬ì—­ ì§€ë„ ì´ë¯¸ì§€ ê´€ë ¨ (ì•„ì´í° í˜¸í™˜ì„± ìˆ˜ì •ë¨)
// =========================

// =========================
//  êµ¬ì—­ ì§€ë„ ì´ë¯¸ì§€ ê´€ë ¨ (ìƒˆ ì°½ ì—´ê¸° ë°©ì‹)
// =========================

// 1. êµ¬ê¸€ ë“œë¼ì´ë¸Œ ID ì¶”ì¶œ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
function extractDriveFileId(rawUrl) {
  if (!rawUrl) return null;
  var v = rawUrl.toString().trim();
  if (!v) return null;
  if (v.indexOf("http") !== 0) return v;

  var m1 = v.match(/\/d\/([^\/?]+)/);
  if (m1 && m1[1]) return m1[1];

  var m2 = v.match(/[?&]id=([^&]+)/);
  if (m2 && m2[1]) return m2[1];

  return null;
}

// 2. ìµœì í™”ëœ ì´ë¯¸ì§€ ì£¼ì†Œ ìƒì„± (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
// ì•„ì´í°/ê°¤ëŸ­ì‹œ ë“±ì—ì„œ ë¡œê·¸ì¸ ì—†ì´ ë°”ë¡œ ì´ë¯¸ì§€ê°€ ë³´ì´ë„ë¡ ë³€í™˜í•©ë‹ˆë‹¤.
function getPrimaryImageUrl(rawUrl) {
  if (!rawUrl) return "";
  var v = rawUrl.toString().trim();

  // ì´ë¯¸ ì¼ë°˜ ì´ë¯¸ì§€ í™•ì¥ìë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
  if (/^https?:\/\/.+\.(png|jpe?g|gif|webp)(\?.*)?$/i.test(v)) {
    return v;
  }

  var fileId = extractDriveFileId(v);
  if (fileId) {
    // êµ¬ê¸€ CDN ì§ë§í¬ë¡œ ë³€í™˜ (ê°€ì¥ í˜¸í™˜ì„± ì¢‹ìŒ)
    return "https://lh3.googleusercontent.com/d/" + fileId;
  }

  return v;
}

// 3. ë¦¬ìŠ¤íŠ¸ì˜ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ (ìˆ˜ì •ë¨)
function openImageModalFromIndex(index) {
  try {
    var row = currentData[index];
    var url = row && row[6] ? row[6].toString() : "";
    
    if (!url) {
      showModal("ì´ë¯¸ì§€ ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    // ë³€í™˜ëœ ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸°
    var finalUrl = getPrimaryImageUrl(url);
    
    // ìƒˆ ì°½(ìƒˆ íƒ­)ìœ¼ë¡œ ì—´ê¸°
    var newWin = window.open(finalUrl, '_blank');

    // íŒì—… ì°¨ë‹¨ ê°ì§€
    if (!newWin || newWin.closed || typeof newWin.closed == 'undefined') {
       showModal("íŒì—… ì°¨ë‹¨ì´ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì°¨ë‹¨ì„ í•´ì œí•´ì£¼ì„¸ìš”.");
    }

  } catch (e) {
    console.log("ì´ë¯¸ì§€ ì—´ê¸° ì˜¤ë¥˜:", e);
    showModal("ì´ë¯¸ì§€ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }
}

// 4. ëª¨ë‹¬ ê´€ë ¨ êµ¬ í•¨ìˆ˜ë“¤ (ì—ëŸ¬ ë°©ì§€ìš©ìœ¼ë¡œ ê»ë°ê¸°ë§Œ ë‚¨ê¹€)
function openImageModal(url) { /* ì‚¬ìš© ì•ˆ í•¨ */ }
function closeImageModal() { /* ì‚¬ìš© ì•ˆ í•¨ */ }

function renderMainTools(container, index) {
  container.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš© ë¹„ì›€

  // 1. ì´ë¦„ ë³€ê²½ (ëª¨ë‹¬ ì—°ê²°ë¨)
  container.appendChild(
    createLeaderToolButton(
      '<i class="fa-solid fa-pen text-[10px]"></i>',
      "ì´ë¦„ ë³€ê²½",
      function () { openRenameModal(index); }, // â˜… ëª¨ë‹¬ ì—´ê¸°
      "text-slate-400 hover:text-sky-600"
    )
  );

  // 2. ì´ë™ ë©”ë‰´ ì§„ì… ë²„íŠ¼
  container.appendChild(
    createLeaderToolButton(
      '<i class="fa-solid fa-arrows-up-down text-[10px]"></i>',
      "ìˆœì„œ ì´ë™ ë©”ë‰´ ì—´ê¸°",
      function () { renderMoveMenu(container, index); }, 
      "text-slate-400 hover:text-indigo-600"
    )
  );

  // 3. ì¶”ê°€ ë©”ë‰´ ì§„ì… ë²„íŠ¼
  container.appendChild(
    createLeaderToolButton(
      '<i class="fa-solid fa-plus text-[11px]"></i>',
      "í–‰ ì¶”ê°€ ë©”ë‰´ ì—´ê¸°",
      function () { renderAddMenu(container, index); }, 
      "text-amber-500 hover:text-amber-700"
    )
  );

  // 4. ì‚­ì œ
  container.appendChild(
    createLeaderToolButton(
      '<i class="fa-solid fa-xmark text-[11px]"></i>',
      "ì‚­ì œ",
      function () { leaderModifyRow(index, "DELETE"); },
      "text-rose-400 hover:text-rose-600"
    )
  );
}

// ==========================================
// [ìˆ˜ì •] ì¸ë„ì íˆ´ë°”: ì´ë™ ì„œë¸Œ ë©”ë‰´ (íŒ¨ë”© ë¯¸ì„¸ ì¡°ì • px-2.5)
// ==========================================
function renderMoveMenu(container, index) {
  container.innerHTML = "";
  container.classList.add("bg-indigo-50", "border-indigo-100");

  // 1. ë’¤ë¡œê°€ê¸° (<)
  container.appendChild(
    createLeaderToolButton(
      '<i class="fa-solid fa-chevron-left text-[10px]"></i>',
      "ì·¨ì†Œ",
      function () { 
        container.classList.remove("bg-indigo-50", "border-indigo-100");
        renderMainTools(container, index); 
      },
      "text-slate-400 hover:text-slate-600 w-9"
    )
  );

  // 2. ìœ„ë¡œ ì´ë™
  container.appendChild(
    createLeaderToolButton(
      '<span class="flex items-center gap-1 text-[10px] font-bold">ìœ„ë¡œ<i class="fa-solid fa-arrow-up"></i></span>',
      "ìœ„ë¡œ ì´ë™",
      function () { leaderModifyRow(index, "MOVE_UP"); renderMainTools(container, index); },
      "text-indigo-600 w-auto px-2.5" // â˜… px-2.5 ì ìš©
    )
  );

  // 3. ì•„ë˜ë¡œ ì´ë™
  container.appendChild(
    createLeaderToolButton(
      '<span class="flex items-center gap-1 text-[10px] font-bold">ì•„ë˜<i class="fa-solid fa-arrow-down"></i></span>',
      "ì•„ë˜ë¡œ ì´ë™",
      function () { leaderModifyRow(index, "MOVE_DOWN"); renderMainTools(container, index); },
      "text-indigo-600 w-auto px-2.5" // â˜… px-2.5 ì ìš©
    )
  );
}

// ==========================================
// [ìˆ˜ì •] ì¸ë„ì íˆ´ë°”: ì¶”ê°€ ì„œë¸Œ ë©”ë‰´ (íŒ¨ë”© ë¯¸ì„¸ ì¡°ì • px-2.5)
// ==========================================
function renderAddMenu(container, index) {
  container.innerHTML = "";
  container.classList.add("bg-amber-50", "border-amber-100");

  // 1. ë’¤ë¡œê°€ê¸° (<)
  container.appendChild(
    createLeaderToolButton(
      '<i class="fa-solid fa-chevron-left text-[10px]"></i>',
      "ì·¨ì†Œ",
      function () { 
        container.classList.remove("bg-amber-50", "border-amber-100");
        renderMainTools(container, index); 
      },
      "text-slate-400 hover:text-slate-600 w-9"
    )
  );

  // 2. ìœ„ì— ì¶”ê°€
  container.appendChild(
    createLeaderToolButton(
      '<span class="flex items-center gap-1 text-[10px] font-bold"><i class="fa-solid fa-plus"></i>ìœ„</span>',
      "ìœ„ì— ì¶”ê°€",
      function () { leaderModifyRow(index, "ADD_ABOVE"); renderMainTools(container, index); },
      "text-amber-600 w-auto px-2.5" // â˜… px-2.5 ì ìš©
    )
  );

  // 3. ì•„ë˜ì— ì¶”ê°€
  container.appendChild(
    createLeaderToolButton(
      '<span class="flex items-center gap-1 text-[10px] font-bold"><i class="fa-solid fa-plus"></i>ì•„ë˜</span>',
      "ì•„ë˜ì— ì¶”ê°€",
      function () { leaderModifyRow(index, "ADD_BELOW"); renderMainTools(container, index); },
      "text-amber-600 w-auto px-2.5" // â˜… px-2.5 ì ìš©
    )
  );
}

// ==========================================
// [ìµœì¢… ìˆ˜ì •] ë’¤ë¡œê°€ê¸° ë²„íŠ¼ í†µí•© (ëŒ€ì‹œë³´ë“œ ì¢…ë£Œ / êµ¬ì—­ ì™„ë£Œ ì²´í¬ ë¶„ê¸°)
// ==========================================

// 1. ë’¤ë¡œê°€ê¸° ë™ì‘ ê°ì§€
window.addEventListener('popstate', function(event) {
  // ë¡œê·¸ì¸ í™”ë©´ì—ì„œëŠ” ë¸Œë¼ìš°ì € ê¸°ë³¸ ë™ì‘ í—ˆìš©
  if (!document.getElementById('loginView').classList.contains('hidden')) {
    return;
  }

  // â˜… í•µì‹¬: ì•±ì´ êº¼ì§€ì§€ ì•Šê²Œ íˆìŠ¤í† ë¦¬ Lock
  history.pushState(null, null, location.href);

  // [ìš°ì„ ìˆœìœ„ 1] ì—´ë ¤ìˆëŠ” ëª¨ë‹¬ë¶€í„° ë‹«ê¸°
  if (!document.getElementById('imageModal').classList.contains('hidden')) { closeImageModal(); return; }
  if (!document.getElementById('memoModal').classList.contains('hidden')) { closeMemoModal(); return; }
  if (!document.getElementById('passwordModal').classList.contains('hidden')) { closePasswordModal(); return; }
  if (!document.getElementById('deleteConfirmModal').classList.contains('hidden')) { closeDeleteConfirmModal(); return; }
  if (!document.getElementById('completionConfirmModal').classList.contains('hidden')) { closeCompletionConfirmModal(); return; }
  if (!document.getElementById('customAlertModal').classList.contains('hidden')) { closeAlertModal(); return; }
  if (!document.getElementById('leaderModeSelectModal').classList.contains('hidden')) { closeLeaderModeModal(); return; }
  if (!document.getElementById('sosConfirmModal').classList.contains('hidden')) { document.getElementById('sosConfirmModal').classList.add('hidden'); return; }
  if (!document.getElementById('sosAlertModal').classList.contains('hidden')) { closeSOSModal(); return; }
  
  // [ìš°ì„ ìˆœìœ„ 2] ì´ë¯¸ 'ë‚˜ê°€ê¸° í™•ì¸ì°½'ì´ ë–  ìˆë‹¤ë©´? -> ë‹«ê¸°
  if (!document.getElementById('customConfirmModal').classList.contains('hidden')) {
    closeConfirmModal();
    return;
  }

  // [ìš°ì„ ìˆœìœ„ 3] ì¸ë„ì ëª¨ë“œ + êµ¬ì—­ì¹´ë“œ í™”ë©´ì— ìˆìŒ -> ëŒ€ì‹œë³´ë“œë¡œ ì¦‰ì‹œ ë³µê·€ (ì™„ë£Œ ì²´í¬ ì—†ì´ ë¹ ë¥¸ ì´ë™)
  if (cameFromLeader && !document.getElementById('mainView').classList.contains('hidden')) {
      showToast(t("ëŒ€ì‹œë³´ë“œë¡œ ë³µê·€í•©ë‹ˆë‹¤."), "fa-solid fa-rotate-left text-indigo-400");
      returnToLeaderDashboard(); 
      return; 
  }

  // [ìš°ì„ ìˆœìœ„ 4] ìƒí™©ë³„ ë™ì‘ ë¶„ê¸°
  
  // [Case A] ì¸ë„ì ëŒ€ì‹œë³´ë“œ í™”ë©´ì— ìˆëŠ” ê²½ìš° -> ëŒ€ì‹œë³´ë“œ ì¢…ë£Œ ì§ˆë¬¸
  if (isLeaderLoggedIn && !document.getElementById('leaderView').classList.contains('hidden')) {
      var confirmModal = document.getElementById('customConfirmModal');
      var confirmTitle = confirmModal.querySelector('h3');
      confirmTitle.innerText = t("ëŒ€ì‹œë³´ë“œë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
      confirmModal.classList.remove('hidden');
  } 
  // [Case B] ì¼ë°˜ ì‚¬ìš©ì (êµ¬ì—­ ì¹´ë“œ í™”ë©´) -> â˜… goBack() ì‹¤í–‰ (ì™„ë£Œ ì²´í¬ ëª¨ë‹¬ ë„ìš°ê¸°) â˜…
  else {
      goBack(); // í™”ë©´ì˜ 'ë‚˜ê°€ê¸°' ë²„íŠ¼ê³¼ ë™ì¼í•˜ê²Œ ë™ì‘
  }
});


// 2. íˆìŠ¤í† ë¦¬ ìŠ¤íƒ ì´ˆê¸°í™” í•¨ìˆ˜
function initHistoryStack() {
  // ë¡œê·¸ì¸ ì§í›„ ì´ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•´ ë’¤ë¡œê°€ê¸° ë°©ì–´ë§‰ì„ í˜•ì„±í•¨
  history.pushState(null, null, location.href);
}

// [ì‹ ê·œ] ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì•ˆì „ ì €ì¥ í—¬í¼ (ìš©ëŸ‰ ë¶€ì¡± ì‹œ ë°©ì–´)
function saveToLocalStorage(key, dataObj) {
  try {
    localStorage.setItem(key, JSON.stringify(dataObj));
  } catch (e) {
    console.warn("âš ï¸ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì‹¤íŒ¨ (ìš©ëŸ‰ ë¶€ì¡± ë˜ëŠ” ì°¨ë‹¨ë¨):", e);
    // ì„ íƒ ì‚¬í•­: ìš©ëŸ‰ì´ ê½‰ ì°¼ë‹¤ë©´ ì˜¤ë˜ëœ ë°ì´í„° ì¼ë¶€ë¥¼ ì§€ìš°ê³  ì¬ì‹œë„í•˜ëŠ” ë¡œì§ì„ ë„£ì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
    // ì—¬ê¸°ì„œëŠ” ì•±ì´ ë©ˆì¶”ì§€ ì•Šë„ë¡ ì˜ˆì™¸ë§Œ ì¡ìŠµë‹ˆë‹¤.
  }
}

// [ìˆ˜ì •] ìë¬¼ì‡  ëª¨ì–‘ê³¼ ìƒ‰ìƒì„ ìƒíƒœì— ë”°ë¼ ë³€ê²½
function updateLockIcon(isEditMode) {
  var icon = document.getElementById('iconLock');
  var btn = document.getElementById('btnLock');

  if (!icon || !btn) return;

  if (isEditMode) {
    // ğŸ”“ í¸ì§‘ ëª¨ë“œ(ì—´ë¦¼): ëª¨ì–‘ì€ lock-open, ìƒ‰ìƒì€ ë…¹ìƒ‰(lock-green)
    icon.className = "fa-solid fa-lock-open text-xl drop-shadow-md lock-green";
    
    // ë²„íŠ¼ ë°°ê²½ ì‚´ì§ ê°•ì¡°
    btn.classList.add('text-emerald-200');
    btn.classList.remove('text-white/90');
  } else {
    // ğŸ”’ ë³´ê¸° ëª¨ë“œ(ë‹«í˜): ëª¨ì–‘ì€ lock, ìƒ‰ìƒì€ íŒŒë‘(lock-blue)
    icon.className = "fa-solid fa-lock text-xl drop-shadow-md lock-blue";
    
    // ë²„íŠ¼ ë°°ê²½ ì›ë³µ
    btn.classList.remove('text-emerald-200');
    btn.classList.add('text-white/90');
  }
}


    // 2. ì˜¤ë²„ë ˆì´ë¥¼ ë„ìš°ê±°ë‚˜ ìˆ¨ê¸°ëŠ” í•¨ìˆ˜
    function toggleLockedOverlay(isLocked, lockerName) {
        var overlay = document.getElementById('editingOverlay');
        var messageEl = document.getElementById('overlayMessage');
        
        if (!overlay) return;

        if (isLocked) {
            messageEl.innerHTML = `**[${lockerName}]** êµ¬ì—­ì„ ìˆ˜ì •í•˜ê³  ìˆìŠµë‹ˆë‹¤.`;
            overlay.classList.remove('hidden');
        } else {
            overlay.classList.add('hidden');
        }
    }


  /**
 * 3. ì£¼ê¸°ì ìœ¼ë¡œ ì ê¸ˆ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” í•µì‹¬ í•¨ìˆ˜ (5ì´ˆë§ˆë‹¤)
 * ì¸ë„ìê°€ í¸ì§‘ ëª¨ë“œë¥¼ ì¢…ë£Œí•˜ë©´ ìë™ìœ¼ë¡œ ì§€ë„ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ëŠ” ë¡œì§ í¬í•¨
 */
function startLockPolling() {
  if (!currentNumber) return;
  if (lockCheckInterval) clearInterval(lockCheckInterval);

  lockCheckInterval = setInterval(function() {
    // 1. ë‚´ê°€ ì¸ë„ì(í¸ì§‘ì)ë¼ë©´ ì²´í¬í•  í•„ìš” ì—†ìŒ
    if (isLeaderLoggedIn) {
      toggleLockedOverlay(false);
      wasServerLocked = false; 
      isLockAcknowledged = false; 
      return; 
    }
    
    // 2. ì„œë²„ì— í˜„ì¬ êµ¬ì—­ì˜ ì ê¸ˆ ìƒíƒœ í™•ì¸ ìš”ì²­
    google.script.run
      .withSuccessHandler(function(res) {
        if (res.isLocked) {
          // [A] ì ê¸ˆ ìƒíƒœ (ì¸ë„ìê°€ í¸ì§‘ ì¤‘)
          if (res.data.user !== currentUserName) {
            // ë‹¤ë¥¸ ì‚¬ëŒì´ í¸ì§‘ ì¤‘ì¼ ë•Œë§Œ ì˜¤ë²„ë ˆì´ í‘œì‹œ
            if (!isLockAcknowledged) {
              toggleLockedOverlay(true, res.data.user);
            }
            wasServerLocked = true; // ì„œë²„ê°€ ì ê²¨ìˆì—ˆìŒì„ ê¸°ì–µ
          }
        } else {
          // [B] ì ê¸ˆ í•´ì œ ìƒíƒœ (í¸ì§‘ì´ ì—†ê±°ë‚˜ ë°©ê¸ˆ ëë‚¨)
          if (wasServerLocked) {
            // â˜… [í•µì‹¬ ë¡œì§] ì„œë²„ê°€ ì ê²¨ìˆë‹¤ê°€ ë°©ê¸ˆ í’€ë¦° ê²½ìš° (í¸ì§‘ ì™„ë£Œ ì‹œì )
            toggleLockedOverlay(false);
            isLockAcknowledged = false;
            
            showToast("ì¸ë„ìê°€ í¸ì§‘ì„ ë§ˆì³¤ìŠµë‹ˆë‹¤. ìµœì‹  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.", "fa-solid fa-rotate text-blue-400");
            
            // 1. ë‚´ ê¸°ê¸°ì˜ ë¡œì»¬ ìºì‹œ ì‚­ì œ (êµ¬ì¡° ë³€ê²½ ëŒ€ì‘ì„ ìœ„í•´ í•„ìˆ˜)
            localStorage.removeItem(getLocalKey(currentNumber));
            
            // 2. ë©”ëª¨ë¦¬ ìƒì˜ ë°ì´í„° ì´ˆê¸°í™”
            currentData = [];

            // 3. 0.5ì´ˆ ë’¤ ì„œë²„ ì›ë³¸ ë°ì´í„°ë¥¼ ê°•ì œë¡œ ë‹¤ì‹œ ë¡œë“œ (forceRefresh = true)
            setTimeout(function() {
              // processLoginRequestì˜ 4ë²ˆì§¸ ì¸ìì— trueë¥¼ ì „ë‹¬í•˜ì—¬ ì‹œíŠ¸ì—ì„œ ì§ì ‘ ì½ì–´ì˜¤ê²Œ í•¨
              processLoginRequest(currentUserName, currentNumber, "", true); 
            }, 500);
            
            wasServerLocked = false; // ìƒíƒœ ë¦¬ì…‹
          } else {
            // í‰ì†Œì— ì ê²¨ìˆì§€ ì•Šì€ ìƒíƒœë¼ë©´ ì¡°ìš©íˆ ë ˆì´ì–´ë§Œ ìˆ¨ê¹€
            toggleLockedOverlay(false);
          }
        }
      })
      .withFailureHandler(function(e) { 
        console.error("Lock Check Error:", e);
      })
      .manageEditingLock(currentNumber, currentUserName, 'CHECK'); 
      
  }, 5000); // 5ì´ˆ ê°„ê²© ìœ ì§€
}

// [index.html] script íƒœê·¸ ë§¨ ì•„ë˜ì— ì¶”ê°€

// 1. ìƒì„¸ ëª¨ë‹¬ ì—´ê¸° ë° ë°ì´í„° ìš”ì²­
function openDetailModal(zoneNum, type) {
  var modal = document.getElementById('detailListModal');
  var titleEl = document.getElementById('detailModalTitle');
  var contentEl = document.getElementById('detailListContent');

  // ëª¨ë‹¬ í‘œì‹œ
  modal.classList.remove('hidden');

  // ì´ˆê¸° ë¡œë”© ìƒíƒœ UI
  contentEl.innerHTML = `
    <div class="flex flex-col items-center justify-center h-full text-slate-400 py-8 gap-2">
      <i class="fa-solid fa-circle-notch fa-spin text-2xl text-indigo-500"></i>
      <span class="text-xs font-medium">${zoneNum}ë²ˆ êµ¬ì—­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
    </div>
  `;

  // ì œëª© ì„¤ì •
  if (type === 'BAN') {
  // ë°©ë¬¸ê¸ˆì§€ ìƒì„¸ ì œëª© (ìˆ«ìë§Œ ì¶”ì¶œ + ë²ˆì—­ì–´)
  titleEl.innerHTML = `<i class="fa-solid fa-ban text-red-500"></i> <span class="text-red-500">${zoneNum.toString().replace(/[^0-9]/g, '')} ${t("ë°©ë¬¸ê¸ˆì§€ ëª©ë¡")}</span>`;
} else {
  titleEl.innerHTML = `<i class="fa-solid fa-note-sticky text-indigo-500"></i> <span class="text-indigo-600">${zoneNum.toString().replace(/[^0-9]/g, '')} ${t("ë©”ëª¨ ëª©ë¡")}</span>`;
}
  // ì„œë²„ ìš”ì²­
  google.script.run
    .withSuccessHandler(function(res) {
      if (res.success) {
        var list = (type === 'BAN') ? res.bans : res.memos;
        renderDetailList(list, type);
      } else {
        contentEl.innerHTML = `<div class="text-center text-red-500 py-4"><i class="fa-solid fa-triangle-exclamation mb-1"></i><br>${res.message}</div>`;
      }
    })
    .withFailureHandler(function(e) {
      contentEl.innerHTML = `<div class="text-center text-red-500 py-4">ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`;
    })
    .getZoneMemoDetails(zoneNum);
}

// 2. ë°ì´í„° ë Œë”ë§
function renderDetailList(list, type) {
  var contentEl = document.getElementById('detailListContent');
  contentEl.innerHTML = ""; // ì´ˆê¸°í™”

  if (!list || list.length === 0) {
    contentEl.innerHTML = `
      <div class="flex flex-col items-center justify-center py-8 text-slate-300">
        <i class="fa-regular fa-folder-open text-4xl mb-2"></i>
        <span class="text-sm">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</span>
      </div>
    `;
    return;
  }

  // ìŠ¤íƒ€ì¼ ì„¤ì •
  var iconClass = (type === 'BAN') ? "fa-ban text-red-500" : "fa-note-sticky text-indigo-500";
  var bgClass = (type === 'BAN') ? "bg-red-50 border-red-100" : "bg-indigo-50 border-indigo-100";
  var textClass = (type === 'BAN') ? "text-red-700" : "text-indigo-700";

  // ë¦¬ìŠ¤íŠ¸ ìƒì„±
  list.forEach(function(item) {
    var row = document.createElement('div');
    row.className = `p-3 rounded-xl border ${bgClass} flex items-start gap-3`;
    
    row.innerHTML = `
      <div class="mt-0.5 shrink-0 w-6 h-6 rounded-full bg-white flex items-center justify-center shadow-sm">
        <i class="fa-solid ${iconClass} text-xs"></i>
      </div>
      <div class="flex-1 min-w-0">
        <p class="text-sm font-bold text-slate-700 break-keep leading-tight mb-1">${item.name}</p>
        <p class="text-xs ${textClass} font-medium break-words bg-white/60 p-1.5 rounded-lg inline-block">
          ${item.content}
        </p>
      </div>
    `;
    contentEl.appendChild(row);
  });
}

// 3. ëª¨ë‹¬ ë‹«ê¸°
function closeDetailModal() {
  document.getElementById('detailListModal').classList.add('hidden');
}


let pendingEnterNum = null; // ì…ì¥ ëŒ€ê¸° ì¤‘ì¸ ë²ˆí˜¸ ì €ì¥ ì „ì—­ ë³€ìˆ˜
// 1. ëª¨ë‹¬ ì—´ê¸° (ë¦¬ìŠ¤íŠ¸ì—ì„œ ì¹´ë“œ í´ë¦­ ì‹œ í˜¸ì¶œ)
function openZoneEnterModal(num) {
  pendingEnterNum = num; // ë²ˆí˜¸ ê¸°ì–µ
  
  // ë¬¸êµ¬ ì„¤ì •
  var numSpan = document.getElementById('enterTargetNum');
  if (numSpan) numSpan.innerText = num + "ë²ˆ";
  
  // ëª¨ë‹¬ ë³´ì´ê¸°
  document.getElementById('zoneEnterConfirmModal').classList.remove('hidden');
}

// 2. 'ì˜ˆ' ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ (HTML onclick="confirmEnterZone()"ì— ì—°ê²°ë¨)
function confirmEnterZone() {
  // ëª¨ë‹¬ ë‹«ê¸°
  closeZoneEnterModal();

  // ê¸°ì–µí•´ë‘” ë²ˆí˜¸ê°€ ìˆìœ¼ë©´ ì…ì¥ ì‹¤í–‰
  if (pendingEnterNum) {
    // ëª¨ë‹¬ ë‹«íˆëŠ” ì• ë‹ˆë©”ì´ì…˜(0.1ì´ˆ) í›„ ì‹¤í–‰
    setTimeout(function() {
      console.log("ì…ì¥ ì‹œë„: " + pendingEnterNum); // ë””ë²„ê¹…ìš© ë¡œê·¸
      enterZoneAsLeader(pendingEnterNum);
      pendingEnterNum = null; // ì´ˆê¸°í™”
    }, 100);
  } else {
    alert("êµ¬ì—­ ë²ˆí˜¸ ì˜¤ë¥˜ì…ë‹ˆë‹¤.");
  }
}

// 3. ëª¨ë‹¬ ë‹«ê¸° ('ì•„ë‹ˆì˜¤' ë˜ëŠ” ë°°ê²½ í´ë¦­)
function closeZoneEnterModal() {
  document.getElementById('zoneEnterConfirmModal').classList.add('hidden');
}

// [1. êµì²´] ê¸°ì¡´ renderLeaderDashboardë¥¼ ì§€ìš°ê³  ì´ê±¸ë¡œ ë„£ìœ¼ì„¸ìš”
function renderLeaderDashboard(data) {
  if (!data) return;

  // ğŸ“¢ [ìˆ˜ì •] ê´€ë¦¬ì ê³µì§€ì‚¬í•­ ì…ë ¥ì°½ì— ê¸°ì¡´ ë‚´ìš© ì±„ìš°ê¸°
  var noticeInput = document.getElementById('adminNoticeInput');
  if (noticeInput) {
    // ë””ë²„ê¹…ìš© ë¡œê·¸: ì½˜ì†”ì°½(F12)ì—ì„œ í™•ì¸ ê°€ëŠ¥
    console.log("ğŸ“¥ ì„œë²„ì—ì„œ ë°›ì€ ê³µì§€ì‚¬í•­:", data.currentNotice);

    if (noticeInput.dataset.loaded !== "true") {
      noticeInput.value = data.currentNotice || "";
      noticeInput.dataset.loaded = "true"; 
    }
  }

  // 1. ë°ì´í„° ì „ì—­ ì €ì¥
  leaderDashboardData = data;
  fullCleanList = data.clean || []; 

  var groupLabels = data.groupLabels || {};
  var furnitureCounts = data.furnitureCounts || {};
  
  // 2. ë¯¸ì‚¬ìš© êµ¬ì—­ í•„í„°ë§ ì…€ë ‰íŠ¸ë°•ìŠ¤ ì˜µì…˜ ì±„ìš°ê¸°
  var filterSelect = document.getElementById('cleanFilterSelect');
  if (filterSelect) {
      var currentSelection = filterSelect.value;
      
      filterSelect.innerHTML = `<option value="all">${t("ì „ì²´ ë³´ê¸°")}</option>`;
      
      if (data.filterLabels && Array.isArray(data.filterLabels)) {
        data.filterLabels.forEach(function(label) {
          var option = document.createElement('option');
          option.value = label;
          option.innerText = label;
          filterSelect.appendChild(option);
        });
      }
      
      if (currentSelection && (currentSelection === 'all' || (data.filterLabels && data.filterLabels.includes(currentSelection)))) {
        filterSelect.value = currentSelection;
      } else {
        filterSelect.value = 'all';
      }
  }

  // 3. ê°€êµ¬ ìˆ˜ ì •ë³´ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ìºì‹±
  if (Object.keys(furnitureCounts).length > 0) {
      localStorage.setItem("LOCAL_FURNITURE_MAP", JSON.stringify(furnitureCounts));
  } else {
      var cached = localStorage.getItem("LOCAL_FURNITURE_MAP");
      if (cached) {
          furnitureCounts = JSON.parse(cached);
      }
  }

  var completionDates = data.completionDates  || {};
  var activeZones     = data.activeZones      || {};
  var visitCounts     = data.visitCounts      || {};

  // ====================================================
  // 4. ê° íƒ­ ë°ì´í„° ë Œë”ë§
  // ====================================================

  // (1) ë¯¸ì‚¬ìš©(Clean) ê·¸ë£¹
  filterCleanList(); 

  // (2) í˜¸ë³„(House) ê·¸ë£¹
  var selHouse = document.getElementById('sortSelectHouse');
  if (selHouse && currentSortState.house) {
      selHouse.value = currentSortState.house; 
  }
  sortAndRenderGroup('house', currentSortState.house);

  // (3) ë¶€ì¬(Busy) ê·¸ë£¹
  var selBusy = document.getElementById('sortSelectBusy');
  if (selBusy && currentSortState.busy) {
      selBusy.value = currentSortState.busy;
  }
  sortAndRenderGroup('busy', currentSortState.busy);

  // (4) ì™„ë£Œ(Complete) ê·¸ë£¹
  renderZoneList(
    'listComplete',
    data.complete,
    'bg-zinc-100 text-zinc-800 border-zinc-200 hover:bg-zinc-200',
    'zinc',
    groupLabels,
    furnitureCounts,
    completionDates,
    activeZones,
    visitCounts,
    true // ë‚ ì§œ êµ¬ë¶„ì„  í‘œì‹œ
  );
  
  // ì™„ë£Œ íƒ­ ë±ƒì§€ ì¹´ìš´íŠ¸ ê°±ì‹ 
  var countCompleteEl = document.getElementById('countComplete');
  if (countCompleteEl) {
      countCompleteEl.innerText = data.complete ? data.complete.length : 0;
  }

  // â˜…â˜…â˜… [ìˆ˜ì •ë¨] í™•ì‹¤í•œ ë°ì´í„°ë¥¼ ì¸ìë¡œ ë„˜ê²¨ì¤ë‹ˆë‹¤ (data -> furnitureCounts, visitCounts) â˜…â˜…â˜…
  updateHeaderStats(furnitureCounts, visitCounts);
}

// 2. ë¯¸ì‚¬ìš© ê·¸ë£¹ í•„í„°ë§ (ë‚ ì§œì„  ë¯¸í‘œì‹œ)
function filterCleanList() {
  var selectEl = document.getElementById('cleanFilterSelect');
  var selectedLabel = selectEl.value;
  var groupLabels = (leaderDashboardData && leaderDashboardData.groupLabels) ? leaderDashboardData.groupLabels : {};
  var furnitureCounts = (leaderDashboardData && leaderDashboardData.furnitureCounts) ? leaderDashboardData.furnitureCounts : {};
  var activeZones = (leaderDashboardData && leaderDashboardData.activeZones) ? leaderDashboardData.activeZones : {};

  var filteredList = [];

  if (selectedLabel === 'all') {
    filteredList = fullCleanList;
  } else {
    filteredList = fullCleanList.filter(function(num) {
      var n = parseInt(num, 10);
      if (isNaN(n)) return false;
      var groupKey = Math.ceil(n / 100) * 100;
      var label = groupLabels[groupKey.toString()] || "";
      return label === selectedLabel;
    });
  }

  document.getElementById('countClean').innerText = filteredList.length;

  // ë Œë”ë§ (ë‚ ì§œì„  ë¯¸í‘œì‹œ: false)
  renderZoneList(
    'listClean',
    filteredList,
    'bg-slate-50 text-slate-600 border-slate-200 hover:bg-slate-100',
    'slate',
    groupLabels,
    furnitureCounts,
    {}, 
    activeZones,
    {}, 
    false // <--- false: ë‚ ì§œì„  ìˆ¨ê¹€
  );
}

// 3. êµ¬ì—­ ëª©ë¡ ê·¸ë¦¬ê¸° (ë¯¸ì‚¬ìš© ê·¸ë£¹ ê°€êµ¬ìˆ˜ í‘œì‹œ ì ìš©ë¨)
function renderZoneList(elementId, list, colorClass, colorName, groupLabels, furnitureCounts, dateMap, activeZones, visitCounts, useDateSeparator) {

  var container = document.getElementById(elementId);
  if (!container) return; 

  if (!visitCounts) visitCounts = {}; 

  // ëª©ë¡ì´ ì—†ì„ ê²½ìš°ì˜ ì²˜ë¦¬
  if (!list || list.length === 0) {
    container.innerHTML = `<div class="py-4 text-center text-slate-400 text-sm mt-10">${t("ëª©ë¡ ì—†ìŒ")}</div>`;
    return;
  }

  // ë¯¸ì‚¬ìš© ê·¸ë£¹ ì •ë ¬
  if (elementId === 'listClean') {
    list.sort(function(a, b) { return parseInt(a, 10) - parseInt(b, 10); });
  }

  // ğŸš€ [ê°œì„  1] ë©”ëª¨ë¦¬ì— ê·¸ë¦¬ë“œë¥¼ ë¨¼ì € ìƒì„± (í™”ë©´ ê¹œë¹¡ì„ ë°©ì§€ í•µì‹¬)
  var grid = document.createElement('div');
  grid.className = "grid grid-cols-3 sm:grid-cols-6 lg:grid-cols-10 xl:grid-cols-14 2xl:grid-cols-16 gap-3";

  var lastDate = "";

  list.forEach(function(num) {
    var n = parseInt(num, 10);
    if (isNaN(n)) return;
    var numStr = num.toString();

    var groupKey = Math.ceil(n / 100) * 100;
    var groupKeyStr = groupKey.toString();
    var groupLabel = groupLabels && groupLabels[groupKeyStr] ? groupLabels[groupKeyStr] : "";
    
    // ğŸš€ [ê°œì„  2] ê°€êµ¬ ë°ì´í„° ëˆ„ë½ ë°©ì–´
    var dataObj = (furnitureCounts && furnitureCounts[numStr]) ? furnitureCounts[numStr] : { t:0, v:0, b:0, m:0, bl:0 };
    
    var totalCount = 0;
    var visitCount = 0;
    var banCount   = 0;
    var memoCount  = 0; 
    var bellVal    = 0; 

    if (typeof dataObj === 'object') {
      totalCount = parseInt(dataObj.t, 10) || 0;
      visitCount = parseInt(dataObj.v, 10) || 0;
      banCount   = parseInt(dataObj.b, 10) || 0;
      memoCount  = parseInt(dataObj.m, 10) || 0;
      bellVal    = parseInt(dataObj.bl, 10) || 0; 
    } else {
      totalCount = parseInt(dataObj, 10) || 0;
    }

    var activeData = (activeZones && activeZones[numStr]) ? activeZones[numStr] : null;
    var isActive = !!activeData;

    var raw = (dateMap && dateMap[numStr]) ? dateMap[numStr] : "";
    var dateText = raw;
    var workerText = "";

    if (elementId === 'listComplete' && raw) {
      var parts = raw.split("||");
      dateText = (parts[0] || "").trim();
      workerText = (parts[1] || "").trim();
    }

    // ë‚ ì§œ êµ¬ë¶„ì„  ë Œë”ë§
    if (useDateSeparator && elementId !== 'listClean' && dateText && dateText !== lastDate) {
      lastDate = dateText;
      var dateRow = document.createElement('div');
      dateRow.className = "col-span-full mt-6 mb-3";
       dateRow.innerHTML = `
        <div class="flex items-center gap-3 text-xs text-slate-600 font-semibold">
          <span class="inline-flex items-center px-3 py-1 rounded-full bg-slate-800 text-white shadow-md tracking-tight">
            <i class="fa-regular fa-calendar-days mr-1 text-[11px] opacity-80"></i>${dateText}
          </span>
          <div class="flex-1 border-t-2 border-dashed border-slate-300"></div>
        </div>`;
      grid.appendChild(dateRow);
    }

    var item = document.createElement('div');
    
    var baseClass = "relative py-3 px-2 rounded-xl border font-bold text-center text-sm cursor-pointer transition-transform active:scale-95 shadow-sm flex flex-col items-center justify-center min-h-[92px] z-0 ";
    var colorByNumber = getZoneColorClass(num);

    item.className = baseClass + " " + colorByNumber;
    item.id = 'card-' + n; 
    item.onclick = function() { enterZoneAsLeader(num); };

    var topLeftContainer = document.createElement('div');
    topLeftContainer.className = "absolute top-1.5 left-1.5 flex items-center gap-1.5 z-20 pointer-events-none";
    item.appendChild(topLeftContainer);

    // 1ï¸âƒ£ í™œë™ ë¨í”„ (ì ‘ì†ì í‘œì‹œ)
    if (isActive) {
      var nameBadge = document.createElement('div');
      var lampClass = "px-1.5 py-0 rounded-full text-[9px] font-bold shadow-sm whitespace-nowrap max-w-[65px] overflow-hidden text-ellipsis flex items-center justify-center transition-all ";
      var displayText = "";

      if (activeData.users && Array.isArray(activeData.users)) {
          lampClass += "bg-violet-600 text-white ring-1 ring-violet-300 animate-pulse";
          var userCount = activeData.users.length;
          displayText = (userCount > 1) ? activeData.users[0] + "+" : activeData.users[0];
      } else if (activeData && typeof activeData === 'object' && activeData.name) {
          lampClass += activeData.isFinished ? "bg-slate-400 text-white" : "bg-violet-600 text-white animate-pulse";
          displayText = activeData.name;
      }
      
      nameBadge.className = lampClass;
      nameBadge.textContent = displayText;
      topLeftContainer.appendChild(nameBadge);
    }

    // 2ï¸âƒ£ [ìˆ˜ì •ë¨] ë²¨ ëˆ„ë¥´ê¸° ì•„ì´ì½˜ + % ìˆ«ì í‘œì‹œ (ê°’ì´ ì—†ìœ¼ë©´ ìˆ¨ê¹€ + í¬ê¸°/ìƒ‰ìƒ ê°•ì¡°)
    var isBellVisible = false;
    
    if (globalSettings.isBellEnabled === 'Y') {
      var denominator = totalCount; 
      
      var bellPercent = (denominator > 0) ? Math.min(Math.round((bellVal / denominator) * 100), 100) : 0;
      if (isNaN(bellPercent)) bellPercent = 0;

      if (bellPercent > 0) {
          isBellVisible = true; 

          var bellIconWrapper = document.createElement('div');
          // ml-1.5: ì•„ì´ì½˜ì´ ì»¤ì¡Œìœ¼ë¯€ë¡œ ì™¼ìª½ ê°„ê²©ì„ ì‚´ì§ ë” ì¤Œ
          bellIconWrapper.className = "flex items-center justify-center ml-1.5";
          
          // [ìƒ‰ìƒ ë³€ê²½] ë” ì§„í•˜ê³  ì˜ ë³´ì´ëŠ” Orange-600 ì ìš©
          var iconColorClass = "text-orange-600";
          var fontWeightClass = "font-black";

          bellIconWrapper.innerHTML = `
            <div class="flex items-baseline gap-0.5 ${iconColorClass}">
              <i class="fa-solid fa-bell text-[13px]"></i>
              
              <span class="text-[14px] ${fontWeightClass} tracking-tighter leading-none">
                ${bellPercent}
                <span class="text-[10px] opacity-90">%</span>
              </span>
            </div>`;
            
          topLeftContainer.appendChild(bellIconWrapper);
      }
    }

    // [ìš°ì¸¡ ë±ƒì§€ ì»¨í…Œì´ë„ˆ]
    var badgeContainer = document.createElement('div');
    badgeContainer.className = "absolute top-1 right-1 flex flex-col items-center gap-1 z-10 pointer-events-none";

    if (banCount > 0) {
      var redDot = document.createElement('div');
      var badgeText = banCount > 9 ? "9+" : String(banCount);
      redDot.className = "w-5 h-5 rounded-full bg-red-600 text-[10px] text-white font-bold flex items-center justify-center shadow-md leading-none alive-badge cursor-pointer pointer-events-auto"; 
      redDot.onclick = function(e) { e.stopPropagation(); openDetailModal(num, 'BAN'); };
      redDot.innerHTML = `<span style="position:relative; top:-1px;">${badgeText}</span>`;
      badgeContainer.appendChild(redDot);
    }

    if (memoCount > 0) {
      var blueDot = document.createElement('div');
      var memoText = memoCount > 9 ? "9+" : String(memoCount);
      blueDot.className = "w-5 h-5 rounded-full bg-indigo-600 text-[10px] text-white font-bold flex items-center justify-center shadow-md leading-none alive-badge cursor-pointer pointer-events-auto";
      blueDot.onclick = function(e) { e.stopPropagation(); openDetailModal(num, 'MEMO'); };
      blueDot.innerHTML = `<span style="position:relative; top:-1px;">${memoText}</span>`;
      badgeContainer.appendChild(blueDot);
    }

    var counts = (visitCounts && visitCounts[numStr]) ? visitCounts[numStr] : { h: 0, b: 0 };
    var usedCount = (elementId === 'listHouse') ? counts.h : (elementId === 'listBusy' ? counts.b : 0);

    if (usedCount > 0) {
      var badgeDiv = document.createElement('div');
      badgeDiv.className = "relative pointer-events-auto"; 
      badgeDiv.innerHTML = `
        <div class="relative w-5 h-5 flex items-center justify-center">
           <i class="fa-solid fa-rotate-right text-rose-500 text-[22px]"></i>
           <div class="absolute inset-0 flex items-center justify-center pb-[1px]">
             <span class="text-[10px] font-black text-slate-800 leading-none">${usedCount}</span>
           </div>
        </div>`;
      badgeContainer.appendChild(badgeDiv);
    }
    item.appendChild(badgeContainer);

    // ğŸ“ ì¤‘ì•™ í…ìŠ¤íŠ¸ & í•˜ë‹¨ ë°©ë¬¸í˜„í™©
    var inner = document.createElement('div');
    inner.className = "flex flex-col items-center justify-center leading-tight w-full";

    var numberClass = "text-xl font-extrabold tracking-tight relative z-0";
    if (isActive || isBellVisible) { numberClass += " mt-2"; } 
    
    var countHtml = "";
    
    // [ì™„ë£Œ] ê·¸ë£¹ì€ ê¸°ì¡´ì²˜ëŸ¼ ë‚ ì§œ/ë´‰ì‚¬ì í‘œì‹œ
    if (elementId === 'listComplete') {
      countHtml = `<div class="mt-2 text-[10px] bg-white border border-slate-200 px-2 py-0.5 rounded-full text-slate-600 font-medium shadow-sm">${workerText || dateText || ""}</div>`;
    } 
    // âœ… [ìˆ˜ì •] ê·¸ ì™¸(ë¯¸ì‚¬ìš©, í˜¸ë³„, ë¶€ì¬)ëŠ” ëª¨ë‘ ê°€êµ¬ ìˆ˜(ë°©ë¬¸/ì „ì²´)ë¥¼ í‘œì‹œ
    else { 
      countHtml = `
        <div class="mt-2 flex items-center justify-center gap-1.5 border border-slate-200 px-2.5 py-0.5 rounded-full shadow-sm bg-white">
          <i class="fa-solid fa-house text-[10px] text-slate-400"></i>
          <div class="flex items-baseline gap-0.5 text-xs relative z-10">
            <span class="font-black text-indigo-700 text-[13px]">${visitCount}</span>
            <span class="text-slate-300 text-[10px] font-light">/</span>
            <span class="font-bold text-slate-500">${totalCount}</span>
          </div>
        </div>`;
    }

    inner.innerHTML = `<div class="${numberClass}">${num}</div>${groupLabel ? `<div class="mt-0.5 text-[11px] font-medium opacity-80 relative z-0">${groupLabel}</div>` : ""}${countHtml}`;
    item.appendChild(inner);

    grid.appendChild(item);
  });

  // ğŸš€ [í•µì‹¬ êµì²´] ëª¨ë“  í•­ëª©ì´ ë‹¤ ì¤€ë¹„ëœ ì°°ë‚˜ì— ê¸°ì¡´ ë‚´ìš©ì„ ì§€ìš°ê³  ì¦‰ì‹œ êµì²´
  container.innerHTML = "";
  container.appendChild(grid);
  
  if (typeof translateContainer === 'function') {
    translateContainer(container);
  }
}

// 4. ê·¸ë£¹ ì •ë ¬ ë° ë Œë”ë§ (ë‚ ì§œì„  ì—¬ë¶€ ê²°ì •)
function sortAndRenderGroup(groupType, sortMode) {
  if (!leaderDashboardData) return;

  if (groupType === 'house') {
    currentSortState.house = sortMode;
  } else if (groupType === 'busy') {
    currentSortState.busy = sortMode;
  }

  var list = [];
  var dateMap = {};
  var targetId = "";
  var colorClass = "";
  var countId = "";
  
  if (groupType === 'house') {
    list = (leaderDashboardData.house || []).slice();
    dateMap = leaderDashboardData.houseDates || {};
    targetId = 'listHouse';
    colorClass = 'bg-emerald-100 text-emerald-800 border-emerald-200 hover:bg-emerald-200';
    countId = 'countHouse';
  } else if (groupType === 'busy') {
    list = (leaderDashboardData.busy || []).slice();
    dateMap = leaderDashboardData.busyDates || {};
    targetId = 'listBusy';
    colorClass = 'bg-amber-100 text-amber-800 border-amber-200 hover:bg-amber-200';
    countId = 'countBusy';
  } else {
    return;
  }

  var visitCounts = leaderDashboardData.visitCounts || {};
  var furnitureCounts = leaderDashboardData.furnitureCounts || {};

  if (sortMode === 'number') {
    list.sort(function(a, b) { return parseInt(a, 10) - parseInt(b, 10); });
  } 
  else if (sortMode === 'oldest') {
    list.sort(function(a, b) {
      var dateA = dateMap[a] || "9999.99.99";
      var dateB = dateMap[b] || "9999.99.99";
      if (dateA === dateB) return parseInt(a, 10) - parseInt(b, 10);
      return dateA.localeCompare(dateB);
    });
  } 
  else if (sortMode === 'count') {
    list.sort(function(a, b) {
      var countA = 0, countB = 0;
      var dataA = visitCounts[a] || { h:0, b:0 };
      var dataB = visitCounts[b] || { h:0, b:0 };
      if (groupType === 'house') { countA = dataA.h || 0; countB = dataB.h || 0; } 
      else { countA = dataA.b || 0; countB = dataB.b || 0; }
      if (countA !== countB) return countA - countB;
      return parseInt(a, 10) - parseInt(b, 10);
    });
  }
  else if (sortMode === 'ban') {
    list.sort(function(a, b) {
      var fA = furnitureCounts[a] || { b: 0 };
      var fB = furnitureCounts[b] || { b: 0 };
      var banA = parseInt(fA.b, 10) || 0;
      var banB = parseInt(fB.b, 10) || 0;
      if (banB !== banA) return banB - banA;
      return parseInt(a, 10) - parseInt(b, 10);
    });
  }
  else if (sortMode === 'memo') {
    list.sort(function(a, b) {
      var fA = furnitureCounts[a] || { m: 0 };
      var fB = furnitureCounts[b] || { m: 0 };
      var memoA = parseInt(fA.m, 10) || 0;
      var memoB = parseInt(fB.m, 10) || 0;
      if (memoB !== memoA) return memoB - memoA;
      return parseInt(a, 10) - parseInt(b, 10);
    });
  }
  // â–¼â–¼â–¼ [ì¶”ê°€ëœ ë¶€ë¶„] ë²¨ ëˆ„ë¥´ê¸° ìˆœ ì •ë ¬ (ì ì€ ìˆœì„œê°€ ìœ„ë¡œ) â–¼â–¼â–¼
  else if (sortMode === 'bell') {
    list.sort(function(a, b) {
      // A êµ¬ì—­ ë¹„ìœ¨ ê³„ì‚°
      var fA = furnitureCounts[a] || { t: 0, bl: 0 };
      var totalA = parseInt(fA.t, 10) || 0;
      var bellA  = parseInt(fA.bl, 10) || 0; 
      var perA   = (totalA > 0) ? (bellA / totalA) : 0;

      // B êµ¬ì—­ ë¹„ìœ¨ ê³„ì‚°
      var fB = furnitureCounts[b] || { t: 0, bl: 0 };
      var totalB = parseInt(fB.t, 10) || 0;
      var bellB  = parseInt(fB.bl, 10) || 0;
      var perB   = (totalB > 0) ? (bellB / totalB) : 0;

      // ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ (ë¹„ìœ¨ì´ ë‚®ì€ ìˆœì„œëŒ€ë¡œ)
      if (perA !== perB) return perA - perB;

      // ë¹„ìœ¨ì´ ê°™ìœ¼ë©´ ë²ˆí˜¸ìˆœ ì •ë ¬
      return parseInt(a, 10) - parseInt(b, 10);
    });
  }
  // â–²â–²â–² [ì¶”ê°€ ì™„ë£Œ] â–²â–²â–²
  else {
    list.sort(function(a, b) {
      var dateA = dateMap[a] || "";
      var dateB = dateMap[b] || "";
      if (dateA === dateB) return parseInt(a, 10) - parseInt(b, 10);
      return dateB.localeCompare(dateA);
    });
  }

  // â˜… ë‚ ì§œ ê²½ê³„ì„  ì¡°ê±´: ìµœê·¼ìˆœ/ì˜¤ë˜ëœìˆœì¼ ë•Œë§Œ í‘œì‹œ
  var showDateSeparator = (sortMode === 'recent' || sortMode === 'oldest' || sortMode === undefined);

  renderZoneList(
    targetId,
    list,
    colorClass,
    (groupType === 'house' ? 'emerald' : 'amber'),
    leaderDashboardData.groupLabels || {},
    furnitureCounts,
    dateMap,
    leaderDashboardData.activeZones || {},
    visitCounts,
    showDateSeparator // ì „ë‹¬
  );

  var countEl = document.getElementById(countId);
  if (countEl) countEl.innerText = list.length;
}


// [3. ì¶”ê°€] ë§¨ ì•„ë˜ì— ì´ í•¨ìˆ˜ë¥¼ ìƒˆë¡œ ì¶”ê°€í•˜ì„¸ìš”
function switchLeaderTab(tabName) {
  // 1. ëª¨ë“  ê·¸ë£¹ ìˆ¨ê¸°ê¸°
  document.getElementById('group-clean').classList.add('hidden');
  document.getElementById('group-house').classList.add('hidden');
  document.getElementById('group-busy').classList.add('hidden');
  document.getElementById('group-complete').classList.add('hidden');

  // 2. ì„ íƒí•œ ê·¸ë£¹ ë³´ì´ê¸°
  document.getElementById('group-' + tabName).classList.remove('hidden');

  // 3. ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
  const inactiveClass = "border-transparent text-slate-400 font-medium";
  const btnClean = document.getElementById('tabBtn-clean');
  const btnHouse = document.getElementById('tabBtn-house');
  const btnBusy = document.getElementById('tabBtn-busy');
  const btnComplete = document.getElementById('tabBtn-complete');

  const resetBtn = (btn) => {
     if(btn) btn.className = "flex-1 min-w-[80px] sm:max-w-[120px] pb-2 border-b-[3px] text-sm transition-all " + inactiveClass;
  };
  resetBtn(btnClean);
  resetBtn(btnHouse);
  resetBtn(btnBusy);
  resetBtn(btnComplete);

  // 4. ì„ íƒí•œ íƒ­ í™œì„±í™”
  const activeBtn = document.getElementById('tabBtn-' + tabName);
  if (!activeBtn) return;

  let colorClass = "";
  if (tabName === 'clean') colorClass = "border-slate-500 text-slate-600";
  else if (tabName === 'house') colorClass = "border-emerald-500 text-emerald-600";
  else if (tabName === 'busy') colorClass = "border-amber-500 text-amber-600";
  else if (tabName === 'complete') colorClass = "border-zinc-500 text-zinc-600";

  activeBtn.className = "flex-1 min-w-[80px] sm:max-w-[120px] pb-2 border-b-[3px] text-sm transition-all font-bold " + colorClass;
}

// ==========================================
// [ìµœì í™”] ìŠ¤í¬ë¡¤ ì‹œ ìƒë‹¨ ì£¼ì†Œ ì•Œì•½ í‘œì‹œ ë¡œì§ (requestAnimationFrame ì ìš©)
// ==========================================
var scrollTicking = false; // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ í”Œë˜ê·¸

// [ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ì—°ë™]
document.getElementById('contentArea').addEventListener('scroll', function() {
  // 1. í—¤ë” ì¶•ì†Œ ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
  var scrollTop = this.scrollTop;
  var mainView = document.getElementById('mainView');
  if (scrollTop > 20) {
    mainView.classList.add('header-shrunk');
  } else {
    mainView.classList.remove('header-shrunk');
  }

  // 2. ìŠ¤í¬ë¡¤ ì¤‘ì—ëŠ” "ì£¼ì†Œ"ë¥¼ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
  if (!scrollTicking) {
    window.requestAnimationFrame(function() {
      updateScrollPill(); // ì—¬ê¸°ì„œ ë‚´ë¶€ì ìœ¼ë¡œ ì£¼ì†Œë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
      scrollTicking = false;
    });
    scrollTicking = true;
  }

  // 3. ğŸš€ ìŠ¤í¬ë¡¤ ë©ˆì¶¤ ê°ì§€: 1.5ì´ˆ í›„ í†µê³„(ë°©ë¬¸ìœ¨/ì‹œê°„)ë¡œ ë³µê·€
  if (scrollStopTimer) clearTimeout(scrollStopTimer);
  scrollStopTimer = setTimeout(function() {
    showPillStats();
  }, 1500); 
});

/**
 * [ìµœì¢… ìˆ˜ì •] ì£¼ì†Œ ëª¨ë“œ ë° ì§„í–‰ë„ ì—…ë°ì´íŠ¸
 * ì§€ë„/ì´ë¯¸ì§€ êµ¬ê°„ì€ ë¬´ì‹œí•˜ê³ , 'ì²« ë²ˆì§¸ ê°€êµ¬'ê°€ í™”ë©´ ìƒë‹¨ì— ë„ë‹¬í•œ ì‹œì ë¶€í„°
 * 'ë§ˆì§€ë§‰ ê°€êµ¬'ê¹Œì§€ì˜ ê±°ë¦¬ë¥¼ ê³„ì‚°í•˜ì—¬ ë¶€ë“œëŸ½ê²Œ ì±„ì›ë‹ˆë‹¤.
 */
function updateScrollPill() {
  var container = document.getElementById('contentArea');
  var mainView = document.getElementById('mainView');
  var pill = document.getElementById('stickyAddressPill');
  var pillMain = document.getElementById('pillMainText');
  var pillSub = document.getElementById('pillSubText');
  var pillSubWrapper = document.getElementById('pillSubWrapper');
  var pillBar = document.getElementById('pillProgressBar');

  // 1. í—¤ë”(ì£¼ì†Œ) í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
  var headers = document.querySelectorAll('.section-header');
  var isShrunk = mainView.classList.contains('header-shrunk');
  var triggerPoint = isShrunk ? 65 : 85; 

  if (headers.length > 0) {
    var currentHeader = null;
    headers.forEach(function(header) {
      var rect = header.getBoundingClientRect();
      if (rect.top < triggerPoint) {
        currentHeader = header;
      }
    });

    if (currentHeader) {
      pillMain.textContent = currentHeader.dataset.title;
      pillSub.textContent = currentHeader.dataset.sub;
      if (pillSubWrapper) {
        var icon = pillSubWrapper.querySelector('i');
        if (icon) icon.style.display = 'inline-block';
      }
      pill.classList.remove('opacity-0', '-translate-y-2');
      pill.classList.add('opacity-100', 'translate-y-0');
    } else {
      // í—¤ë” ë¯¸ë…¸ì¶œ ì‹œ ìˆ¨ê¹€ (í†µê³„ ëª¨ë“œ ì•„ë‹ ë•Œ)
      if (!currentProgressText) { 
         pill.classList.add('opacity-0', '-translate-y-2');
      }
    }
  }

  // ğŸš€ 2. [í•µì‹¬ ë³€ê²½] ë¦¬ìŠ¤íŠ¸ ë²”ìœ„ ê¸°ë°˜ í”½ì…€ ê²Œì´ì§€ (ì²« ê°€êµ¬ ~ ë ê°€êµ¬)
  var cards = container.querySelectorAll('[id^="card-"]');
  
  if (cards.length > 0 && pillBar) {
    var firstCard = cards[0];
    var lastCard = cards[cards.length - 1];

    // [A] ì‹œì‘ì : ì²« ë²ˆì§¸ ì¹´ë“œê°€ í™”ë©´ ìƒë‹¨(í—¤ë” ì•„ë˜ ì¯¤)ì— ë„ë‹¬í–ˆì„ ë•Œ 0% ì‹œì‘
    // í—¤ë” ë†’ì´(ì•½ 60px) ì •ë„ì˜ ì—¬ìœ ë¥¼ ë‘ì–´ ìì—°ìŠ¤ëŸ½ê²Œ ì‹œì‘í•˜ë„ë¡ ë³´ì • (-60)
    var startY = firstCard.offsetTop - 60; 

    // [B] ëì : ë§ˆì§€ë§‰ ì¹´ë“œê°€ í™”ë©´ì— ë³´ì¼ ë•Œì¯¤ 100% ë‹¬ì„±
    // (ì „ì²´ ìŠ¤í¬ë¡¤ ê°€ëŠ¥ ë²”ìœ„ - í™”ë©´ ë†’ì´)ë¥¼ ê³ ë ¤í•´ì•¼ ë°”ë‹¥ì— ë‹¿ì•˜ì„ ë•Œ 100%ê°€ ë¨
    var endY = (lastCard.offsetTop + lastCard.clientHeight) - container.clientHeight;

    // ì˜ˆì™¸ ì²˜ë¦¬: ë‚´ìš©ì´ ë„ˆë¬´ ì ì–´ì„œ ìŠ¤í¬ë¡¤ì´ ì•ˆ ìƒê¸°ëŠ” ê²½ìš° ë°©ì§€
    if (endY <= startY) endY = startY + 1;

    // [C] í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
    var currentY = container.scrollTop;

    // [D] ì§„í–‰ë¥  ê³„ì‚° (0 ~ 100 ì‚¬ì´ë¡œ ì œí•œ)
    var percent = ((currentY - startY) / (endY - startY)) * 100;
    percent = Math.max(0, Math.min(100, percent));

    // ìŠ¤íƒ€ì¼ ì ìš© (CSS transition ë•ë¶„ì— ë¶€ë“œëŸ½ê²Œ ì›€ì§ì„)
    pillBar.style.width = percent + "%";
  }
}


// [ìµœì¢…] updateHeaderStats í•¨ìˆ˜ (ë§¨ ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸)
function updateHeaderStats(furnitureCounts, visitCounts) {
  // ë°ì´í„° ì•ˆì „ ì¥ì¹˜
  furnitureCounts = furnitureCounts || {};
  visitCounts = visitCounts || {};
  
  var totalBan = 0;
  var totalMemo = 0;
  var countHouse = 0; 
  var countBusy = 0;  

  // 1. ê¸ˆì§€/ë©”ëª¨ ì§‘ê³„
  for (var key in furnitureCounts) {
    var item = furnitureCounts[key];
    if (item && typeof item === 'object') {
      totalBan += (parseInt(item.b, 10) || 0);
      totalMemo += (parseInt(item.m, 10) || 0);
    }
  }

  // 2. íšŒì°¨ ì§‘ê³„
  for (var key in visitCounts) {
    var vData = visitCounts[key];
    if (vData) {
      countHouse += (parseInt(vData.h, 10) || 0);
      countBusy += (parseInt(vData.b, 10) || 0);
    }
  }

  // 3. í™”ë©´ í‘œì‹œ
  var banEl = document.getElementById('headerStatBan');
  var memoEl = document.getElementById('headerStatMemo');
  var countEl = document.getElementById('headerStatCount');

  if (banEl) banEl.innerText = totalBan;
  if (memoEl) memoEl.innerText = totalMemo;
  
  // â˜…â˜…â˜… [ìµœì¢… í˜•ì‹] í˜¸ë³„(N)/ë¶€ì¬(N) (ìˆ«ì ë’¤ 'íšŒ' ì‚­ì œ) â˜…â˜…â˜…
  if (countEl) {
      const format = t("í˜¸ë³„({h})/ë¶€ì¬({b})");
      countEl.innerText = format.replace("{h}", countHouse).replace("{b}", countBusy);
  }
}

// ==========================================
// [ì‹ ê·œ] ì¸ë„ì í—¤ë” í†µê³„ ìƒì„¸ ë³´ê¸° í•¨ìˆ˜
// ==========================================
function openGlobalStatsDetail(type) {
  if (!leaderDashboardData) return;

  var furnitureCounts = leaderDashboardData.furnitureCounts || {};
  var visitCounts = leaderDashboardData.visitCounts || {};
  
  var listHtml = "";
  var title = "";
  var totalCount = 0;

  // êµ¬ì—­ ë²ˆí˜¸ ì •ë ¬ì„ ìœ„í•œ í‚¤ ë°°ì—´ ìƒì„±
  var sortedZones = Object.keys(type === 'COUNT' ? visitCounts : furnitureCounts).sort(function(a, b) {
    return parseInt(a, 10) - parseInt(b, 10);
  });

  if (type === 'BAN') {
    title = '<span class="text-red-500"><i class="fa-solid fa-ban"></i> ' + t("ë°©ë¬¸ê¸ˆì§€") + '</span>';
    listHtml = '<div class="max-h-[60vh] overflow-y-auto pr-1 space-y-1">';
    
    sortedZones.forEach(function(zone) {
      var data = furnitureCounts[zone];
      var val = parseInt(data.b || 0, 10);
      if (val > 0) {
        totalCount += val;
        listHtml += `
          <div class="flex justify-between items-center p-2 bg-slate-50 rounded-lg border border-slate-100 text-sm">
            <span class="font-bold text-slate-700 w-16">${zone.toString().replace(/[^0-9]/g, '')}</span>
            <span class="font-bold text-red-500">${val}${t("ëª…")}</span>
          </div>`;      }
    });
    listHtml += '</div>';
    if (totalCount === 0) listHtml = '<div class="text-slate-400 py-4">' + t("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.") + '</div>';

  } else if (type === 'MEMO') {
    title = '<span class="text-indigo-500"><i class="fa-regular fa-note-sticky"></i> ' + t("ë©”ëª¨") + '</span>';
    listHtml = '<div class="max-h-[60vh] overflow-y-auto pr-1 space-y-1">';
    
    sortedZones.forEach(function(zone) {
      var data = furnitureCounts[zone];
      var val = parseInt(data.m || 0, 10);
      if (val > 0) {
        totalCount += val;
        listHtml += `
          <div class="flex justify-between items-center p-2 bg-slate-50 rounded-lg border border-slate-100 text-sm">
            <span class="font-bold text-slate-700 w-16">${zone.toString().replace(/[^0-9]/g, '')}</span>
            <span class="font-bold text-indigo-500">${val}${t("ê°œ")}</span>
          </div>`;
      }
    });
    listHtml += '</div>';
    if (totalCount === 0) listHtml = '<div class="text-slate-400 py-4">' + t("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.") + '</div>';

  } else if (type === 'COUNT') {
    title = '<span class="text-slate-700"><i class="fa-solid fa-rotate-right text-emerald-500"></i> ' + t("íšŒì°¨") + '</span>';
    listHtml = '<div class="max-h-[60vh] overflow-y-auto pr-1 space-y-1">';
    
    sortedZones.forEach(function(zone) {
      var data = visitCounts[zone];
      var h = parseInt(data.h || 0, 10);
      var b = parseInt(data.b || 0, 10);
      
      // í˜¸ë³„ì´ë‚˜ ë¶€ì¬ ì¤‘ í•˜ë‚˜ë¼ë„ 0ë³´ë‹¤ í¬ë©´ í‘œì‹œ
      if (h > 0 || b > 0) {
        listHtml += `
          <div class="flex justify-between items-center p-2 bg-slate-50 rounded-lg border border-slate-100 text-sm">
            <span class="font-bold text-slate-700 w-16">${zone.toString().replace(/[^0-9]/g, '')}</span>
            
            <div class="flex gap-2 text-xs">
              <span class="bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded">
                ${t("í˜¸ë³„")} <b>${h}</b>
              </span>
              
              <span class="bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded">
                ${t("ë¶€ì¬")} <b>${b}</b>
              </span>
            </div>
          </div>`;
      }
    });
    listHtml += '</div>';
  }

  // ì•Œë¦¼ì°½ ë„ìš°ê¸° (ê¸°ì¡´ showModal í•¨ìˆ˜ í™œìš©, HTML ë‚´ìš© ì£¼ì…)
  var alertModal = document.getElementById('customAlertModal');
  var alertTitle = alertModal.querySelector('h3');
  var alertMsg = document.getElementById('alertMessage');
  var okBtn = document.getElementById('alertOkBtn');

  alertTitle.innerHTML = title;
  alertMsg.innerHTML = listHtml;
  
  // í™•ì¸ ë²„íŠ¼ ëˆ„ë¥´ë©´ ë‹«ê¸°
  okBtn.onclick = closeAlertModal;
  
  alertModal.classList.remove('hidden');
}


// ==========================================
// [ì‹ ê·œ] ì¸ë„ì ëŒ€ì‹œë³´ë“œ íƒ­ ìŠ¤ì™€ì´í”„ ê¸°ëŠ¥
// ==========================================

let startX = 0;
let startY = 0;
const SWIPE_THRESHOLD_X = 70; // ì¢Œìš° ìŠ¤ì™€ì´í”„ ìµœì†Œ ê±°ë¦¬ (í”½ì…€)
const SWIPE_THRESHOLD_Y = 50; // ìˆ˜ì§ ìŠ¤í¬ë¡¤ ì˜¤ì°¨ í—ˆìš©ì¹˜ (í”½ì…€)
const TAB_ORDER = ['clean', 'house', 'busy', 'complete']; // íƒ­ ìˆœì„œ

// íƒ­ ì „í™˜ ë¡œì§
function changeTabOnSwipe(direction) {
    // 1. í˜„ì¬ í™œì„±í™”ëœ íƒ­ ì°¾ê¸°
    let currentTabIndex = -1;
    for (let i = 0; i < TAB_ORDER.length; i++) {
        const groupEl = document.getElementById('group-' + TAB_ORDER[i]);
        if (groupEl && !groupEl.classList.contains('hidden')) {
            currentTabIndex = i;
            break;
        }
    }

    if (currentTabIndex === -1) return;

    let nextTabIndex = -1;

    // 2. ì´ë™í•  íƒ­ ì¸ë±ìŠ¤ ê³„ì‚°
    if (direction === 'left') {
        // í˜„ì¬ íƒ­ì˜ ì™¼ìª½ (ì¸ë±ìŠ¤ëŠ” ì¦ê°€: clean(0) -> house(1))
        nextTabIndex = currentTabIndex + 1;
    } else if (direction === 'right') {
        // í˜„ì¬ íƒ­ì˜ ì˜¤ë¥¸ìª½ (ì¸ë±ìŠ¤ëŠ” ê°ì†Œ: house(1) -> clean(0))
        nextTabIndex = currentTabIndex - 1;
    }

    // 3. ê²½ê³„ ì²´í¬ ë° íƒ­ ì „í™˜
    if (nextTabIndex >= 0 && nextTabIndex < TAB_ORDER.length) {
        const nextTabName = TAB_ORDER[nextTabIndex];
        // íƒ­ ì „í™˜ í•¨ìˆ˜ í˜¸ì¶œ
        switchLeaderTab(nextTabName); 
    }
}

// í„°ì¹˜ ì‹œì‘ ì‹œ ì¢Œí‘œ ì €ì¥
function handleTouchStart(e) {
    if (e.touches.length === 1) {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
    }
}

// í„°ì¹˜ ì¢…ë£Œ ì‹œ ìŠ¤ì™€ì´í”„ íŒë‹¨
function handleTouchEnd(e) {
    if (e.changedTouches.length === 1) {
        const endX = e.changedTouches[0].clientX;
        const endY = e.changedTouches[0].clientY;

        const deltaX = endX - startX;
        const deltaY = endY - startY;

        // 1. ìˆ˜í‰ ì´ë™ ê±°ë¦¬ê°€ ì„ê³„ê°’ì„ ë„˜ëŠ”ì§€ í™•ì¸
        if (Math.abs(deltaX) > SWIPE_THRESHOLD_X) {
            // 2. ìˆ˜ì§ ì´ë™ì´ ìˆ˜í‰ ì´ë™ë³´ë‹¤ í˜„ì €íˆ í¬ì§€ ì•Šì€ì§€ í™•ì¸ (ì¸ì‹ë¥  í–¥ìƒ)
            if (Math.abs(deltaY) < SWIPE_THRESHOLD_Y || Math.abs(deltaX) > Math.abs(deltaY) * 2) {
                
                // ìŠ¤ì™€ì´í”„ ë™ì‘ ê°ì§€
                if (deltaX < 0) {
                    // ì™¼ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ (ë‹¤ìŒ íƒ­ìœ¼ë¡œ ì´ë™, ì¸ë±ìŠ¤ ì¦ê°€)
                    changeTabOnSwipe('left');
                } else {
                    // ì˜¤ë¥¸ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ (ì´ì „ íƒ­ìœ¼ë¡œ ì´ë™, ì¸ë±ìŠ¤ ê°ì†Œ)
                    changeTabOnSwipe('right');
                }
            }
        }
    }
}

// ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
function attachSwipeListeners() {
    // íƒ­ ì˜ì—­ì´ ë‹´ê²¨ ìˆëŠ” ë¶€ëª¨ ìš”ì†Œ (ì—¬ê¸°ì„œëŠ” #leaderViewì˜ ìŠ¤í¬ë¡¤ ì˜ì—­)
    // ë¦¬ìŠ¤íŠ¸ ì˜ì—­ë§Œ ì¡ëŠ” ê²ƒë³´ë‹¤ ë¶€ëª¨ ìš”ì†Œì¸ #leaderView > .flex-1.overflow-hidden.relative.bg-slate-50.p-3.sm:p-4 ë¥¼ ì¡ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
    // í•˜ì§€ë§Œ ê° íƒ­ ì˜ì—­ì— ì´ë²¤íŠ¸ë¥¼ ë°”ì¸ë”©í•˜ì—¬ íƒ­ ì „í™˜ì„ ë”ìš± ëª…í™•í•˜ê²Œ ë¶„ë¦¬í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

    const tabContents = [
        document.getElementById('group-clean'), 
        document.getElementById('group-house'), 
        document.getElementById('group-busy'), 
        document.getElementById('group-complete')
    ];

    tabContents.forEach(groupEl => {
        if (groupEl) {
            // ë¦¬ìŠ¤íŠ¸ ì˜ì—­(listClean, listHouse ë“±)ë§Œ ë°”ì¸ë”©
            const listEl = groupEl.querySelector('div[id^="list"]');
            if (listEl) {
                // ì£¼ì˜: passive: true ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ ìŠ¤í¬ë¡¤ ì„±ëŠ¥ ì €í•˜ ë°©ì§€
                listEl.addEventListener('touchstart', handleTouchStart, { passive: true });
                listEl.addEventListener('touchend', handleTouchEnd, { passive: true });
            }
        }
    });
    
    console.log("âœ… ì¸ë„ì ëŒ€ì‹œë³´ë“œ ìŠ¤ì™€ì´í”„ ë¦¬ìŠ¤ë„ˆ ë¶€ì°© ì™„ë£Œ");
}

// í˜ì´ì§€ ë¡œë“œ ë˜ëŠ” ëŒ€ì‹œë³´ë“œ ì§„ì… ì‹œ ë¦¬ìŠ¤ë„ˆ ë¶€ì°©
window.addEventListener('load', attachSwipeListeners);
// NOTE: leaderDashboardData ë¡œë“œ í›„ì—ë„ attachSwipeListenersë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆìœ¼ë‚˜, 
// list ì—˜ë¦¬ë¨¼íŠ¸ê°€ ì •ì  ìš”ì†Œì´ë¯€ë¡œ window.onloadì— í•œ ë²ˆë§Œ í˜¸ì¶œí•´ë„ ì¶©ë¶„í•©ë‹ˆë‹¤.


// ==========================================
// [ì‹ ê·œ] ìŠ¤ë§ˆíŠ¸ ìƒì¡´ ì‹ ê³  ì‹œìŠ¤í…œ (ì •í™•ë„ UP)
// ==========================================

// íƒ€ì´ë¨¸ ë³€ìˆ˜
let keepAliveTimer = null;

// [ìˆ˜ì •] ìŠ¤ë§ˆíŠ¸ ìƒì¡´ ì‹ ê³  í•¨ìˆ˜
function startKeepAlive() {
  if (keepAliveTimer) clearInterval(keepAliveTimer);
  
  sendHeartbeat(); // ì¦‰ì‹œ 1íšŒ ì‹¤í–‰

  // â˜… ë³€í™˜ëœ ì„¤ì •ê°’(CONFIG_ALIVE_INTERVAL) ì‚¬ìš©
  keepAliveTimer = setInterval(sendHeartbeat, CONFIG_ALIVE_INTERVAL);
}

function stopKeepAlive() {
  if (keepAliveTimer) {
    clearInterval(keepAliveTimer);
    keepAliveTimer = null;
  }
}

// ì‹¤ì œ ì„œë²„ë¡œ ì‹ í˜¸ë¥¼ ë³´ë‚´ëŠ” ë‚´ë¶€ í•¨ìˆ˜
function sendHeartbeat() {
  if (currentNumber && currentUserName) { 
    google.script.run
      .withFailureHandler(function(){}) 
      .keepAlive(currentNumber, currentUserName);
  }
}

// ==========================================
// ğŸ‘ï¸ [í•µì‹¬] ë”´ì§“ ê°ì§€ & ì°½ ë‹«ê¸° ê°ì§€ ë¦¬ìŠ¤ë„ˆ
// ==========================================

// 1. í™”ë©´ ê°€ì‹œì„± ê°ì§€ (í™”ë©´ êº¼ì§, ë‹¤ë¥¸ íƒ­ ì´ë™, í™ˆ í™”ë©´ ë‚˜ê° ë“±)
document.addEventListener('visibilitychange', function() {
  if (document.hidden) {
    // ğŸ™ˆ í™”ë©´ì´ ì•ˆ ë³´ì´ë©´ -> ì‹¬ì¥ë°•ë™ ì •ì§€ (ì„œë²„ì—ì„œ 35ì´ˆ ë’¤ ìë™ ì‚­ì œë¨)
    // ë°°í„°ë¦¬ë„ ì•„ë¼ê³ , "ì§€ê¸ˆ ì•ˆ ë³´ê³  ìˆìŒ"ì„ ì •í™•íˆ ë°˜ì˜
    stopKeepAlive();
  } else {
    // ğŸµ ë‹¤ì‹œ í™”ë©´ì„ ì¼œë©´ -> ì¦‰ì‹œ ì‹¬ì¥ë°•ë™ ì¬ê°œ (ë¨í”„ ë°”ë¡œ ì¼œì§)
    // ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œë§Œ ì¬ê°œ
    if (!document.getElementById('mainView').classList.contains('hidden')) {
        startKeepAlive();
    }
  }
});

// 2. ë¸Œë¼ìš°ì € ì°½ ë‹«ê¸° / ìƒˆë¡œê³ ì¹¨ ê°ì§€ (ìµœí›„ì˜ í†µì²©)
window.addEventListener('pagehide', function() {
  if (currentNumber && currentUserName) {
     google.script.run.notifyExit(currentNumber, currentUserName, currentLang, true);
  }
});


// [ê°•ë ¥ ë²„ì „] ì•”í˜¸ ëª¨ë‹¬ì„ ì—´ê³  í¬ì»¤ìŠ¤ë¥¼ ê°•ì œí•˜ëŠ” í•¨ìˆ˜
function showPasswordModalAndFocus() {
  var modal = document.getElementById('passwordModal');
  var input = document.getElementById('modalPasswordInput');
  
  // 1. ëª¨ë‹¬ ì¦‰ì‹œ í‘œì‹œ
  modal.classList.remove('hidden');
  input.value = ''; 
  
  // 2. ë¸Œë¼ìš°ì €ê°€ í™”ë©´ì„ ê·¸ë¦´ ì‹œê°„ì„ ì•„ì£¼ ì ê¹ ì¤Œ (ë”ë¸” ì²´í¬)
  // ë°©ë²• A: ì¦‰ì‹œ ì‹œë„
  input.focus();
  input.click();

  // ë°©ë²• B: ì•½ê°„ì˜ ì§€ì—° í›„ ì¬ì‹œë„ (ì• ë‹ˆë©”ì´ì…˜/ë Œë”ë§ ì™„ë£Œ í›„)
  setTimeout(function() { 
    input.focus(); 
    input.click(); 
  }, 100);

  // ë°©ë²• C: í™•ì‹¤í•œ ì§€ì—° í›„ ë§ˆì§€ë§‰ ì‹œë„ (ëª¨ë°”ì¼ ë°©ì–´ìš©)
  setTimeout(function() { 
    input.focus(); 
  }, 400); 
}

// [ì „ì—­ ë³€ìˆ˜ ì¶”ê°€]
let pendingSyncType = null;      // ì–´ë–¤ ë™ê¸°í™”ì¸ì§€ ì €ì¥ (publishers ë˜ëŠ” territories)
let lastSyncButtonClicked = null; // ë¡œë”© í‘œì‹œë¥¼ í•  ë²„íŠ¼ ì €ì¥
let isAdminAuthenticated = false; // ê´€ë¦¬ì ì¸ì¦ ì—¬ë¶€ ê¸°ì–µ ë³€ìˆ˜


// [ìµœì¢… ìˆ˜ì •] ì„¤ì • ê´€ë¦¬ ë²„íŠ¼ í´ë¦­ ì‹œ ë¡œì§ (ì¤‘ë³µ ì• ë‹ˆë©”ì´ì…˜ ì œê±° + í¬ì»¤ìŠ¤ ê°•í™”)
document.getElementById('adminToggleBtn').addEventListener('click', function() {
  const panel = document.getElementById('adminActionPanel');
  const modal = document.getElementById('adminPasswordModal');
  const input = document.getElementById('adminSecretInput');

  // 1. ì´ë¯¸ ì¸ì¦ëœ ìƒíƒœë¼ë©´?
  if (typeof isAdminAuthenticated !== 'undefined' && isAdminAuthenticated) {
    // [ê°œì„ ] íŒ¨ë„ì´ ì´ë¯¸ ì—´ë ¤ìˆë‹¤ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ (ì¤‘ë³µ ì• ë‹ˆë©”ì´ì…˜ ë°©ì§€)
    if (panel.classList.contains('hidden')) {
      if (typeof loadCurrentAdminSettings === 'function') loadCurrentAdminSettings(); 
      
      // â˜… í•µì‹¬ ìˆ˜ì •: í´ë˜ìŠ¤ë¥¼ ëºë‹¤ ê¼ˆë‹¤ í•˜ì§€ ì•Šê³  hiddenë§Œ ì œê±°í•©ë‹ˆë‹¤.
      // ì´ë ‡ê²Œ í•˜ë©´ CSSì— ì •ì˜ëœ ì• ë‹ˆë©”ì´ì…˜ì´ ìì—°ìŠ¤ëŸ½ê²Œ 1íšŒë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
      panel.classList.remove('hidden');
      
      if (typeof updateAdminStats === 'function') updateAdminStats();
    }
    return;
  }

  // 2. ì¸ì¦ë˜ì§€ ì•Šì•˜ë‹¤ë©´? -> ì•”í˜¸ ì…ë ¥ ëª¨ë‹¬ ì—´ê¸°
  modal.classList.remove('hidden');
  input.value = '';

  // ğŸš€ [ê°•ë ¥ í¬ì»¤ìŠ¤ íŠ¸ë¦­] 
  input.focus();
  
  // ì•„ì´í°/ëª¨ë°”ì¼ ëŒ€ì‘: ë¸Œë¼ìš°ì € ë Œë”ë§ ì£¼ê¸°ì— ë§ì¶° 2ë‹¨ê³„ ê°•ì œ í¬ì»¤ìŠ¤
  requestAnimationFrame(() => {
    input.focus();
    // ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ focusë§Œìœ¼ë¡œ í‚¤ë³´ë“œê°€ ì•ˆ ì˜¬ë¼ì˜¬ ë•Œë¥¼ ëŒ€ë¹„í•´ í´ë¦­ íŠ¸ë¦¬ê±°
    input.click(); 
  });

  setTimeout(() => {
    if (document.activeElement !== input) {
      input.focus();
    }
  }, 150);
});

// 2. ê´€ë¦¬ì ì•”í˜¸ ëª¨ë‹¬ ë‹«ê¸° (ê¸°ì¡´ ìœ ì§€)
function closeAdminModal() {
  document.getElementById('adminPasswordModal').classList.add('hidden');
}

// [ìˆ˜ì •ë³¸] ê´€ë¦¬ì ì¸ì¦ í•¨ìˆ˜ - ì¤‘ë³µ ì‹¤í–‰ ë° ì• ë‹ˆë©”ì´ì…˜ ëœì»¥ê±°ë¦¼ ë°©ì§€
function verifyAdminModal() {
  const input = document.getElementById('adminSecretInput');
  const btn = document.getElementById('adminVerifyBtn');
  const pw = input.value.trim();
  
  // 1. ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ë©´ ì¤‘ë‹¨ (ì—°íƒ€ ë°©ì§€)
  if (btn.disabled) return;

  if (!pw) {
    showToast(t("ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."), "fa-solid fa-circle-exclamation text-amber-500");
    input.focus();
    return;
  }

  // ë²„íŠ¼ ë¡œë”© ìƒíƒœ í‘œì‹œ
  btn.disabled = true;
  const originalText = btn.innerText;
  btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i>`;

  google.script.run
    .withSuccessHandler(function(isValid) {
      btn.disabled = false;
      btn.innerText = originalText;
      
      if (isValid) {
        isAdminAuthenticated = true;
        updateAdminAuthUI(true); 
        closeAdminModal(); // ì•”í˜¸ì°½ ë‹«ê¸°

        const panel = document.getElementById('adminActionPanel');
        
        // â˜… [í•µì‹¬ ìˆ˜ì •] íŒ¨ë„ì´ ì´ë¯¸ ì—´ë ¤ìˆì§€ ì•Šì„ ë•Œë§Œ ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
        if (panel.classList.contains('hidden')) {
            panel.classList.remove('hidden');
            // 'admin-slide-up' í´ë˜ìŠ¤ëŠ” ì´ë¯¸ HTMLì— ìˆê±°ë‚˜ CSS animationìœ¼ë¡œ ì‘ë™í•˜ë¯€ë¡œ 
            // êµ³ì´ ì—¬ê¸°ì„œ ì œê±° í›„ ì¬ì¶”ê°€ë¥¼ ë°˜ë³µí•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
        }

        // ë°±ê·¸ë¼ìš´ë“œ ë°ì´í„° ê°±ì‹  ë° ì„¤ì • ë¡œë“œ ì‹¤í–‰
        if (typeof refreshLeaderDashboardInBackground === 'function') {
          refreshLeaderDashboardInBackground();
          if (typeof leaderTimer !== 'undefined' && !leaderTimer) {
            leaderTimer = setInterval(refreshLeaderDashboardInBackground, 30000);  //ì¸ë„ì ëŒ€ì‹œë³´ë“œ ê°±ì‹  30ì´ˆ
          }
        }
        
        if (typeof loadCurrentAdminSettings === 'function') {
          loadCurrentAdminSettings();
        }

        // í†µê³„ ìˆ˜ì¹˜ ì—…ë°ì´íŠ¸
        updateAdminStats();
        showToast(t("ì¸ì¦ë˜ì—ˆìŠµë‹ˆë‹¤."), "fa-solid fa-user-shield text-indigo-400");
        
      } else {
        showToast(t("ì•”í˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."), "fa-solid fa-circle-exclamation text-red-400");
        input.value = ''; 
        input.focus();
      }
    })
    .withFailureHandler(function(err) {
      btn.disabled = false;
      btn.innerText = originalText;
      showToast(t("ì„œë²„ ì—°ê²° ì˜¤ë¥˜"), "fa-solid fa-bomb text-red-500");
    })
    .checkAdminSecret(pw); 
}

// [1] í˜ì´ì§€ ë¡œë“œ ì‹œ ì—”í„°í‚¤ ê°ì§€ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
document.addEventListener('DOMContentLoaded', function() {
  const adminInput = document.getElementById('adminSecretInput');
  if (adminInput) {
    adminInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€
        verifyAdminModal(); // ì¸ì¦ í•¨ìˆ˜ ì‹¤í–‰
      }
    });
  }
});

// 4. [ë³€ê²½ë¨] ë™ê¸°í™” ë²„íŠ¼ í´ë¦­ ì‹œ - ë°”ë¡œ ì‹¤í–‰í•˜ì§€ ì•Šê³  'í™•ì¸ ëª¨ë‹¬'ë§Œ ë„ì›ë‹ˆë‹¤.
function runAdminSync(type) {
  // â˜… [ìˆ˜ì •] ì „ì²´ êµ¬ì—­ ë™ê¸°í™” ì‹œ 30ë¶„ ê°„ê²© ì œí•œ ì²´í¬
  if (type === 'territories') {
    const lastSync = localStorage.getItem('last_territory_sync_time');
    const now = Date.now();
    const interval = 30 * 60 * 1000; // 30ë¶„ (ë°€ë¦¬ì´ˆ)

    if (lastSync && (now - lastSync < interval)) {
      const remainingMin = Math.ceil((interval - (now - lastSync)) / (60 * 1000));
      let msg = t("ë™ê¸°í™” ì œí•œ ì•Œë¦¼").replace("{min}", remainingMin);
      showToast(msg, "fa-solid fa-clock text-amber-400");
      return; // 30ë¶„ì´ ì•ˆ ì§€ë‚¬ìœ¼ë©´ ì—¬ê¸°ì„œ ì¤‘ë‹¨í•˜ì—¬ ëª¨ë‹¬ì„ ë„ìš°ì§€ ì•ŠìŒ
    }
  }

  pendingSyncType = type;
  lastSyncButtonClicked = event.currentTarget;
  
  const titleEl = document.getElementById('syncModalTitle');
  const descEl = document.getElementById('syncModalDesc');

  if (type === 'publishers') {
  // ì „ë„ì¸ ëª…ë‹¨ ë™ê¸°í™” ì œëª© ë° ì„¤ëª… ë²ˆì—­
  titleEl.innerText = t("ì „ë„ì¸ ëª…ë‹¨ ë™ê¸°í™”");
  descEl.innerHTML = t("ì „ë„ì¸ ëª©ë¡ì´ ìµœì‹  ìƒíƒœë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.");
} else if (type === 'territories') {
  // ì „ì²´ êµ¬ì—­ ë™ê¸°í™” ì œëª© ë° ì„¤ëª… ë²ˆì—­
  titleEl.innerText = t("ì „ì²´ êµ¬ì—­ ë™ê¸°í™”");
  // [30ë¶„ ì œí•œ] ë¬¸êµ¬ í¬í•¨ ë²ˆì—­
  descEl.innerHTML = t("ì „ì²´ êµ¬ì—­ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.[30ë¶„ ì œí•œ]");
}

  document.getElementById('adminSyncConfirmModal').classList.remove('hidden');
}

// 5. [ì‹ ê·œ] ë™ê¸°í™” í™•ì¸ ëª¨ë‹¬ì˜ 'ë‹«ê¸°' ë²„íŠ¼
function closeSyncConfirmModal() {
  document.getElementById('adminSyncConfirmModal').classList.add('hidden');
  pendingSyncType = null;
}

// 6. ë™ê¸°í™” í™•ì¸ ëª¨ë‹¬ì—ì„œ 'í™•ì¸'ì„ ëˆŒë €ì„ ë•Œ ì‹¤í–‰ë˜ëŠ” ì‹¤ì œ ë¡œì§
document.getElementById('btnConfirmSyncAction').onclick = function() {
  const type = pendingSyncType;
  const btn = lastSyncButtonClicked;
  const originalHtml = btn.innerHTML;
  
  closeSyncConfirmModal(); // ëª¨ë‹¬ ë¨¼ì € ë‹«ê¸°

  btn.disabled = true;
  btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> ${t("ì§„í–‰ ì¤‘...")}`;
  showToast(t("ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."), "fa-solid fa-spinner fa-spin text-white");

  google.script.run
    .withSuccessHandler(function(res) {
      let successMsg = "";
      if (type === 'publishers') {
        // ì „ë„ì¸ ë™ê¸°í™” ì™„ë£Œ ë©”ì‹œì§€ ë²ˆì—­
        successMsg = t("ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      } else if (type === 'territories') {
        // êµ¬ì—­ ë™ê¸°í™” ì™„ë£Œ ë©”ì‹œì§€ ë²ˆì—­
        successMsg = t("ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        
        // â˜… [í•µì‹¬ ì¶”ê°€] ì „ì²´ êµ¬ì—­ ë™ê¸°í™” ì„±ê³µ ì‹œì—ë§Œ ë§ˆì§€ë§‰ ì‹¤í–‰ ì‹œê°„ ì €ì¥
        localStorage.setItem('last_territory_sync_time', Date.now()); 
        
      } else {
        successMsg = res.message;
      }

      showToast(successMsg, "fa-solid fa-check-circle text-emerald-500");
      
      btn.disabled = false;
      btn.innerHTML = originalHtml;
    })
    .withFailureHandler(function(err) {
      showToast(`${t("ë™ê¸°í™” ì˜¤ë¥˜ ë°œìƒ:")}\n${err}`, "fa-solid fa-bomb text-red-500");
      btn.disabled = false;
      btn.innerHTML = originalHtml;
    })
    .executeSyncTask(type);
};


// [ê³µí†µ] ì „ì—­ ë³€ìˆ˜ë¡œ íŒŒì¼ ì£¼ì†Œ ì €ì¥
let pendingPdfUrl = "";

// 1. ì£¼ê¸° ì„ íƒ ëª¨ë‹¬ ì œì–´
function runVisitReport() {
  // ì‚¬ìš©ìê°€ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ "6ê°œì›”ì…ë‹ˆê¹Œ? 1ë…„ì…ë‹ˆê¹Œ?" ëª¨ë‹¬ì„ ë„ì›€
  document.getElementById('periodSelectionModal').classList.remove('hidden');
}

function closePeriodModal() {
  document.getElementById('periodSelectionModal').classList.add('hidden');
}

// 2. íŒŒì¼ ì—´ê¸° ê²°ê³¼ ëª¨ë‹¬ ë‹«ê¸°
function closePdfOpenModal() {
  document.getElementById('pdfOpenConfirmModal').classList.add('hidden');
  pendingPdfUrl = "";
}


// [2. ì‹ ê·œ] ì—°ë„ ë§ˆê° ëª¨ë‹¬ ë‹«ê¸° (ì·¨ì†Œ ë²„íŠ¼ìš©)
function closeYearEndModal() {
  document.getElementById('yearEndConfirmModal').classList.add('hidden');
}


// [4. ê³µí†µ] ì‹¤ì œ ì„œë²„ë¡œ PDF ìƒì„±ì„ ìš”ì²­í•˜ëŠ” í•¨ìˆ˜ (ë¡œì§ ë¶„ë¦¬ë¨)
function requestPDFGeneration(type) {
  showLoading(true, t("PDF íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤."));
  
  google.script.run
    .withSuccessHandler(function(res) {
      showLoading(false);
      if (res.success) {
        showToast(res.message, "fa-solid fa-file-circle-check text-emerald-500");
        if (res.fileUrl) {
          pendingPdfUrl = res.fileUrl;
          document.getElementById('pdfOpenConfirmModal').classList.remove('hidden');
        }
      } else {
        showToast(res.message, "fa-solid fa-triangle-exclamation text-amber-500");
      }
    })
    .withFailureHandler(function(err) {
      showLoading(false);
      showToast(t("ì—ëŸ¬ ë°œìƒ: ") + err, "fa-solid fa-bomb text-red-500");
    })
    .generateVisitReport(type);
}

// 4. 'íŒŒì¼ ì—´ê¸°' ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤ì œ ë™ì‘ ì²˜ë¦¬
// ì´ ë¶€ë¶„ì´ ìˆì–´ì•¼ ìµœì¢… ëª¨ë‹¬ì—ì„œ 'íŒŒì¼ ì—´ê¸°'ë¥¼ ëˆŒë €ì„ ë•Œ ìƒˆ ì°½ì´ ëœ¹ë‹ˆë‹¤.
document.getElementById('btnRealOpenPdf').onclick = function() {
  if (pendingPdfUrl) {
    window.open(pendingPdfUrl, '_blank');
  }
  closePdfOpenModal();
};


/**
 * ê´€ë¦¬ììš© ì‹¤ì‹œê°„ í˜„í™©íŒ ëª¨ë‹¬ì„ ìƒì„±í•˜ê³  í‘œì‹œí•©ë‹ˆë‹¤.
 */
function openAdminStatsBoard() {
  // ë°ì´í„° ë¡œë”© í™•ì¸
  if (!leaderDashboardData) {
    showToast(t("ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."), "fa-solid fa-spinner fa-spin");
    return;
  }

  const d = leaderDashboardData;
  const nClean = (d.clean || []).length;
  const nHouse = (d.house || []).length;
  const nBusy = (d.busy || []).length;
  const nComp = (d.complete || []).length;
  
  // ì‹¤ì§ˆì ì¸ í™œë™ êµ¬ì—­ í•©ê³„ ë° ì§„í–‰ë¥  ê³„ì‚°
  const activeTotal = nHouse + nBusy + nComp;
  const progress = activeTotal > 0 ? Math.round((nComp / activeTotal) * 100) : 0;
  const totalZones = nClean + activeTotal;

  // í˜„í™©íŒ HTML ì»¨í…ì¸  ìƒì„±
  const statsHtml = `
    <div class="space-y-4 text-left">
      <div class="flex gap-2">
        <div class="flex-1 bg-indigo-50 p-3 rounded-2xl border border-indigo-100 text-center">
          <p class="text-[10px] text-indigo-400 font-bold uppercase">ì „ì²´ ì§„í–‰ë¥ </p>
          <p class="text-2xl font-black text-indigo-600">${progress}%</p>
        </div>
        <div class="flex-1 bg-slate-50 p-3 rounded-2xl border border-slate-100 text-center">
          <p class="text-[10px] text-slate-400 font-bold uppercase">ì´ êµ¬ì—­ ìˆ˜</p>
          <p class="text-2xl font-black text-slate-700">${totalZones}</p>
        </div>
      </div>

      <div class="group relative">
        <div class="flex justify-between items-center mb-1.5 px-1">
          <span class="text-xs font-bold text-slate-600">ì§„í–‰ ìƒíƒœ ë¶„í¬</span>
          <span class="text-[10px] text-slate-400">${nComp}ê°œ ì™„ë£Œ / ${activeTotal}ê°œ í™œë™</span>
        </div>
        <div class="w-full h-6 bg-slate-100 rounded-full overflow-hidden flex border border-slate-200 shadow-inner">
          <div style="width: ${(nComp/activeTotal*100)||0}%" class="bg-zinc-500 h-full transition-all duration-700" title="ì™„ë£Œ"></div>
          <div style="width: ${(nBusy/activeTotal*100)||0}%" class="bg-amber-400 h-full transition-all duration-700" title="ë¶€ì¬"></div>
          <div style="width: ${(nHouse/activeTotal*100)||0}%" class="bg-emerald-500 h-full transition-all duration-700" title="í˜¸ë³„"></div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-2 mt-2">
        <div class="flex items-center gap-2 p-2.5 bg-emerald-50 rounded-xl border border-emerald-100">
          <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
          <div class="flex-1"><p class="text-[10px] text-emerald-600 font-bold">í˜¸ë³„ ë°©ë¬¸</p><p class="text-sm font-black text-emerald-700">${nHouse}</p></div>
        </div>
        <div class="flex items-center gap-2 p-2.5 bg-amber-50 rounded-xl border border-amber-100">
          <span class="w-2 h-2 rounded-full bg-amber-400"></span>
          <div class="flex-1"><p class="text-[10px] text-amber-600 font-bold">ë¶€ì¬ ì¤‘</p><p class="text-sm font-black text-amber-700">${nBusy}</p></div>
        </div>
        <div class="flex items-center gap-2 p-2.5 bg-zinc-100 rounded-xl border border-zinc-200">
          <span class="w-2 h-2 rounded-full bg-zinc-500"></span>
          <div class="flex-1"><p class="text-[10px] text-zinc-500 font-bold">ì™„ë£Œ ì²˜ë¦¬</p><p class="text-sm font-black text-zinc-600">${nComp}</p></div>
        </div>
        <div class="flex items-center gap-2 p-2.5 bg-slate-100 rounded-xl border border-slate-200 opacity-60">
          <span class="w-2 h-2 rounded-full bg-slate-400"></span>
          <div class="flex-1"><p class="text-[10px] text-slate-500 font-bold">ë¯¸ì‚¬ìš© ëŒ€ê¸°</p><p class="text-sm font-black text-slate-600">${nClean}</p></div>
        </div>
      </div>
    </div>
  `;

  // ê¸°ì¡´ Alert ëª¨ë‹¬ UI ì—…ë°ì´íŠ¸
  const alertModal = document.getElementById('customAlertModal');
  const alertTitle = alertModal.querySelector('h3');
  const alertMsg = document.getElementById('alertMessage');
  const okBtn = document.getElementById('alertOkBtn');

  alertTitle.innerHTML = '<i class="fa-solid fa-gauge-high text-indigo-500 mr-1"></i> êµ¬ì—­ ê´€ë¦¬ í˜„í™©íŒ';
  alertMsg.innerHTML = statsHtml;
  okBtn.innerText = t("ë‹«ê¸°");
  
  // ëª¨ë‹¬ í‘œì‹œ
  alertModal.classList.remove('hidden');
}



/**
 * ê´€ë¦¬ì íŒ¨ë„ì˜ ìˆ˜ì¹˜ë¥¼ ì‹¤ì‹œê°„ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
 */
function updateAdminStats() {
  if (!leaderDashboardData) return;

  const d = leaderDashboardData;
  const nClean = Array.isArray(d.clean) ? d.clean.length : 0;
  const nHouse = Array.isArray(d.house) ? d.house.length : 0;
  const nBusy  = Array.isArray(d.busy)  ? d.busy.length  : 0;
  const nComp  = Array.isArray(d.complete) ? d.complete.length : 0;

  const total = nClean + nHouse + nBusy + nComp;
  const active = nHouse + nBusy;

  // ë¹„ìœ¨ ê³„ì‚° í•¨ìˆ˜ (0ìœ¼ë¡œ ë‚˜ëˆ„ê¸° ë°©ì§€)
  const getP = (count) => (total === 0) ? 0 : (count / total * 100);

  try {
    // 1. ì „ì²´ êµ¬ì—­ ìˆ«ì
    document.getElementById('stat-total').innerText = total;

    // 2. ê°€ë¡œ ìŠ¬ë¦¼í˜• ë°ì´í„° í¬ë§· (ìˆ«ì + í¼ì„¼íŠ¸)
    const formatStat = (count, colorClass) => {
      const p = getP(count).toFixed(0);
      return `<span class="text-sm">${count}</span><span class="ml-1 text-[10px] font-bold ${colorClass}">${p}%</span>`;
    };

    document.getElementById('stat-clean').innerHTML = formatStat(nClean, 'text-slate-300');
    document.getElementById('stat-active').innerHTML = formatStat(active, 'text-indigo-300');
    document.getElementById('stat-complete').innerHTML = formatStat(nComp, 'text-emerald-400');

    // 3. í†µí•© ì§„í–‰ ë°”(Progress Bar) ì—…ë°ì´íŠ¸
    const pComp = getP(nComp);
    const pActive = getP(active);
    const pClean = getP(nClean);

    document.getElementById('bar-complete').style.width = pComp + "%";
    document.getElementById('bar-active').style.width = pActive + "%";
    document.getElementById('bar-clean').style.width = pClean + "%";
    
    // ì „ì²´ ì™„ë£Œìœ¨ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    document.getElementById('stat-total-percent').innerText = pComp.toFixed(1) + "%";

    console.log("âœ… ê´€ë¦¬ì êµ¬ì—­ í˜„í™©íŒ ì—…ë°ì´íŠ¸ ì™„ë£Œ");
  } catch (e) {
    console.error("âŒ í˜„í™©íŒ ìˆ˜ì¹˜ ì£¼ì… ì˜¤ë¥˜:", e);
  }
}


// ==========================================
// ğŸ“± [ìŠ¤ë§ˆíŠ¸ PDF ì €ì¥ & ê³µìœ  ì‹œìŠ¤í…œ] (ìµœì¢… ì™„ì„±)
// ==========================================
// ==============================================================
// ğŸ“± [ìŠ¤ë§ˆíŠ¸ PDF ì €ì¥ & ê³µìœ  ì‹œìŠ¤í…œ] (ë“œë¼ì´ë¸Œ ì €ì¥ ì œê±° / ë‹¤ìš´ë¡œë“œ ì „ìš©)
// ==============================================================

// [ì „ì—­ ë³€ìˆ˜] ì„ íƒëœ ì£¼ê¸° ì €ì¥
window.pendingPeriodType = null;

// 1. ê¸°ê¸° ì •ë°€ ê°ì§€ í•¨ìˆ˜ (ëª¨ë°”ì¼/íƒœë¸”ë¦¿ ì—¬ë¶€)
function isMobileDevice() {
  const userAgent = navigator.userAgent.toLowerCase();
  return /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent) || 
         (navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /macintosh/.test(userAgent)); // ì•„ì´íŒ¨ë“œ ëŒ€ì‘
}

// 2. 1ë…„ ë§ˆê° í´ë¦­ ì‹œ ì—°ì°¨ì— ë”°ë¥¸ ê²½ê³  ë¬¸êµ¬ ë‹¤ë³€í™”
function executeVisitReport(periodType) {
  closePeriodModal();
  window.pendingPeriodType = periodType;

  if (periodType === 'year') {
    const cycle = globalSettings.cycle || 1;
    const modal = document.getElementById('yearEndConfirmModal');
    const title = modal.querySelector('h3');
    const list = modal.querySelector('ul');

    if (cycle === 4) {
      title.innerText = t("4ê°œë…„ ì£¼ê¸° ëŒ€ë§ˆê°");
      list.innerHTML = `
        <li class="text-red-600 font-bold">${t("ì „ì²´ ê¸°ë¡ ë°±ì—… ë° ì´ˆê¸°í™”")}</li>
        <li class="font-bold">${t("ì§€ë‚œ 4ë…„ì˜ ìµœì¢… ì™„ë£Œì¼ì´ PDF Bì—´ë¡œ ì´ì›”ë©ë‹ˆë‹¤.")}</li>
        <li>${t("ì‹ ê·œ 1ë…„ì°¨(5ë…„ì°¨)ë¡œ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.")}</li>
      `;
    } else {
      title.innerText = t("ë´‰ì‚¬ ì—°ë„ ë§ˆê°");
      list.innerHTML = `
        <li>${t("ê¸°ë¡ ìë™ ë³µì‚¬")}</li>
        <li>${t("ëª¨ë“  ê¸°ë¡ ì´ˆê¸°í™”")}</li>
        <li>${t("S-21ì˜ ë‹¤ìŒì¹¸ìœ¼ë¡œ ê¸°ë¡({next}ë…„ì°¨)ì´ ì´ë™í•©ë‹ˆë‹¤.").replace("{next}", parseInt(cycle)+1)}</li>
      `;
    }
    modal.classList.remove('hidden');
  } else {
    runSmartPDFGeneration();
  }
}

// 3. ì—°ë„ ë§ˆê° 'í™•ì¸' ë²„íŠ¼ í´ë¦­ ì‹œ (2ì°¨ ê´€ë¬¸)
function confirmYearEndAction() {
  closeYearEndModal(); // ê²½ê³ ì°½ ë‹«ê³ 
  runSmartPDFGeneration(); // ì‹¤í–‰
}

// 4. [í•µì‹¬] ë¬´ì¡°ê±´ 'ë‹¤ìš´ë¡œë“œ' ë°©ì‹ìœ¼ë¡œ ìš”ì²­
function runSmartPDFGeneration() {
  const periodType = window.pendingPeriodType;
  // â˜… ì¤‘ìš”: ë¬´ì¡°ê±´ 'device'ë¡œ ì„¤ì •í•˜ì—¬ êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì €ì¥ì„ ë°©ì§€í•˜ê³  Base64 ë°ì´í„°ë¥¼ ë°›ìŒ
  const saveMethod = 'device'; 

  // ì•ˆë‚´ ë©”ì‹œì§€ë§Œ ê¸°ê¸°ì— ë”°ë¼ ë‹¤ë¥´ê²Œ í‘œì‹œ
      let msg = isMobileDevice() 
        ? "ğŸ“± PDF ìƒì„± ì¤‘... (ì™„ë£Œ ì‹œ ê³µìœ ì°½ì´ ëœ¹ë‹ˆë‹¤)" 
        : "ğŸ’» PDF ìƒì„± ì¤‘... (ì™„ë£Œ ì‹œ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤)";

      showLoading(true, msg);
  
  google.script.run
    .withSuccessHandler(function(res) {
      showLoading(false);
      
      if (res.success) {
        // ì„±ê³µ ì‹œ ë¬´ì¡°ê±´ íŒŒì¼ ë°ì´í„°(Base64) ì²˜ë¦¬
        if (res.base64) {
          handlePdfResult(res.base64, res.fileName);
        } else {
          // ë§Œì•½ ë°ì´í„°ê°€ ì—†ë‹¤ë©´ ì—ëŸ¬ ì²˜ë¦¬
          showToast("PDF ë°ì´í„°ë¥¼ ë°›ì•„ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", "fa-solid fa-triangle-exclamation text-amber-500");
        }
      } else {
        showToast(res.message, "fa-solid fa-triangle-exclamation text-amber-500");
      }
    })
    .withFailureHandler(function(err) {
      showLoading(false);
      showToast("ì—ëŸ¬ ë°œìƒ: " + err, "fa-solid fa-bomb text-red-500");
    })
    .generateVisitReport(periodType, saveMethod); 
}

// 5. [í•µì‹¬] ê²°ê³¼ ì²˜ë¦¬ (ëª¨ë°”ì¼ì€ ê³µìœ , PCëŠ” ë‹¤ìš´ë¡œë“œ)
function handlePdfResult(base64Data, fileName) {
  // Base64 -> Blob ë³€í™˜
  const blob = base64ToBlob(base64Data, 'application/pdf');
  const file = new File([blob], fileName, { type: 'application/pdf' });

  // [Case A] ëª¨ë°”ì¼ ê¸°ê¸°ì´ë©´ì„œ 'ê³µìœ í•˜ê¸°' ê¸°ëŠ¥ì„ ì§€ì›í•˜ëŠ” ê²½ìš° (ì¹´í†¡ ë“±)
  if (isMobileDevice() && navigator.canShare && navigator.canShare({ files: [file] })) {
    navigator.share({
      files: [file],
      title: 'ìˆœíšŒë°©ë¬¸ ë³´ê³ ì„œ',
      text: fileName + ' íŒŒì¼ì„ ê³µìœ í•©ë‹ˆë‹¤.'
    })
    .then(() => showToast("ê³µìœ ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", "fa-solid fa-share-nodes text-indigo-500"))
    .catch((error) => {
      // ì‚¬ìš©ìê°€ ì·¨ì†Œí•˜ê±°ë‚˜ ì—ëŸ¬ ë°œìƒ ì‹œ ë‹¤ìš´ë¡œë“œë¡œ ëŒ€ì²´
      if (error.name !== 'AbortError') {
        console.log('ê³µìœ  ì‹¤íŒ¨, ë‹¤ìš´ë¡œë“œë¡œ ì „í™˜', error);
        forceDownloadBlob(blob, fileName);
      }
    });
  } 
  // [Case B] PC ë˜ëŠ” ê³µìœ  ë¯¸ì§€ì› ë¸Œë¼ìš°ì € -> ì¦‰ì‹œ ë‹¤ìš´ë¡œë“œ
  else {
    forceDownloadBlob(blob, fileName);
    showToast("íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.", "fa-solid fa-download text-emerald-500");
  }
}

// [ìœ í‹¸] Base64 ë³€í™˜ í•¨ìˆ˜ (ê¸°ì¡´ ìœ ì§€)
function base64ToBlob(base64, mimeType) {
  const byteCharacters = atob(base64);
  const byteNumbers = new Array(byteCharacters.length);
  for (let i = 0; i < byteCharacters.length; i++) {
    byteNumbers[i] = byteCharacters.charCodeAt(i);
  }
  const byteArray = new Uint8Array(byteNumbers);
  return new Blob([byteArray], { type: mimeType });
}

// [ìœ í‹¸] ê°•ì œ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (ê¸°ì¡´ ìœ ì§€)
function forceDownloadBlob(blob, fileName) {
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.href = url;
  link.download = fileName;
  document.body.appendChild(link);
  link.click();
  setTimeout(() => {
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
  }, 100);
}

// ==========================================
// ğŸ“¢ [ìµœì¢… ìµœì í™”] ê³µì§€ì‚¬í•­ ì‹œìŠ¤í…œ (ì—ëŸ¬ ë°©ì–´í˜•)
// ==========================================

function showNotice(content) {
  try {
    const modal = document.getElementById('noticeModal');
    const contentEl = document.getElementById('noticeContent');
    if (!modal || !contentEl) return;

    const todayStr = new Date().toISOString().split('T')[0];
    const savedDate = localStorage.getItem('HIDE_NOTICE_DATE');
    const savedContent = localStorage.getItem('HIDE_NOTICE_TEXT');

    // â˜… ì¤„ë°”ê¿ˆ ë¬¸ìë¥¼ ì œê±°í•˜ê³  í…ìŠ¤íŠ¸ë§Œ ë¹„êµí•˜ì—¬ "ë³´ì§€ ì•Šê¸°" ì •í™•ë„ í–¥ìƒ
    const normalize = (str) => str ? str.toString().replace(/\s+/g, '') : '';

    if (savedDate === todayStr && normalize(savedContent) === normalize(content)) {
      console.log("ğŸ™ˆ ì´ë¯¸ ì½ì€ ê³µì§€ì…ë‹ˆë‹¤.");
      return;
    }

    contentEl.innerText = content; // \nì„ ì¤„ë°”ê¿ˆìœ¼ë¡œ ìë™ ë³€í™˜í•˜ì—¬ í‘œì‹œ
    modal.classList.remove('hidden');

    // ğŸš€ [ì¶”ê°€] ê³µì§€ì‚¬í•­ ì•Œë¦¼ìŒ ì¬ìƒ (ì—¬ê¸°ì— ì¶”ê°€!)
    // B14ì— íŒŒì¼ì´ ìˆìœ¼ë©´ ê·¸ ì†Œë¦¬ê°€, ì—†ìœ¼ë©´ ê¸°ë³¸ 'Pop' ì†Œë¦¬ê°€ ë‚©ë‹ˆë‹¤.
    if (typeof noticeAlarm !== 'undefined') {
        noticeAlarm.play().catch(e => console.log("ê³µì§€ ì˜¤ë””ì˜¤ ì¬ìƒ ì°¨ë‹¨ë¨(ì‚¬ìš©ì ì¸í„°ë™ì…˜ í•„ìš”):", e));
    }

  } catch (e) { console.error(e); }
}

// 2. ê³µì§€ì‚¬í•­ ëª¨ë‹¬ ë‹«ê¸° (í™•ì¸í–ˆìŠµë‹ˆë‹¤ ë²„íŠ¼) - â˜…ë¨¹í†µ í•´ê²°ìš© í•µì‹¬ ì½”ë“œâ˜…
function closeNoticeModal() {
  try {
    const modal = document.getElementById('noticeModal');
    const checkBox = document.getElementById('hideNoticeToday');
    const contentEl = document.getElementById('noticeContent');

    if (modal) {
      // "ì˜¤ëŠ˜ í•˜ë£¨ ë³´ì§€ ì•Šê¸°" ì²˜ë¦¬
      if (checkBox && checkBox.checked && contentEl) {
        const content = contentEl.innerText;
        const todayStr = new Date().toISOString().split('T')[0];
        localStorage.setItem('HIDE_NOTICE_DATE', todayStr);
        localStorage.setItem('HIDE_NOTICE_TEXT', content);
      }
      
      // ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
      modal.classList.add('hidden');
      console.log("âœ… ê³µì§€ì‚¬í•­ ë‹«ê¸° ì„±ê³µ");
    } else {
      console.warn("âš ï¸ noticeModal ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
  } catch (e) {
    console.error("closeNoticeModal Error:", e);
    // ìµœí›„ì˜ ìˆ˜ë‹¨: ì—ëŸ¬ê°€ ë‚˜ë„ ê°•ì œë¡œ ë‹«ê¸° ì‹œë„
    document.getElementById('noticeModal').style.display = 'none';
  }
}

// 3. ê´€ë¦¬ììš©: ê³µì§€ì‚¬í•­ ì‚­ì œ(ì§€ìš°ê¸°) í™•ì¸ ëª¨ë‹¬ ì œì–´
function clearNoticeInput() {
  const delModal = document.getElementById('noticeDeleteConfirmModal');
  if (delModal) delModal.classList.remove('hidden');
}

function closeNoticeDeleteModal() {
  const delModal = document.getElementById('noticeDeleteConfirmModal');
  if (delModal) delModal.classList.add('hidden');
}

function confirmNoticeDelete() {
  closeNoticeDeleteModal();
  const noticeInput = document.getElementById('adminNoticeInput');
  if (noticeInput) {
    noticeInput.value = "";
    saveAdminNotice(); // ì„œë²„ì— ë¹ˆ ê°’ ì „ì†¡í•˜ì—¬ ì‚­ì œ ì²˜ë¦¬
  }
}

function saveAdminNotice() {
  const content = document.getElementById('adminNoticeInput').value.trim();
  const btn = document.getElementById('btnSaveNotice');
  // ë²„íŠ¼ ë‚´ë¶€ì˜ ê¸€ì span ì°¾ê¸°
  const btnText = btn.querySelector('span'); 
  
  btn.disabled = true;
  // ë°˜ì˜ ì¤‘ì¼ ë•Œë„ ë²ˆì—­ ì ìš©
  btnText.innerText = t("ë°˜ì˜ ì¤‘..."); 
  btn.classList.add('opacity-70', 'scale-95');

  google.script.run
    .withSuccessHandler(function(res) {
      btn.disabled = false;
      btn.classList.remove('opacity-70', 'scale-95');
      
      // âœ… ì¤‘ìš”: ì›ë˜ ë²„íŠ¼ ì´ë¦„ìœ¼ë¡œ ë³µêµ¬í•  ë•Œ t() í•¨ìˆ˜ ì‚¬ìš©
      btnText.innerText = t("ê³µì§€ì‚¬í•­ ì—…ë°ì´íŠ¸");
      
      if(res.success) {
        showToast(t(res.message), "fa-solid fa-check-circle text-emerald-500");
      }
    })
    .withFailureHandler(function(e) {
      btn.disabled = false;
      btn.classList.remove('opacity-70', 'scale-95');
      
      // âœ… ì‹¤íŒ¨ ì‹œì—ë„ ë²ˆì—­ëœ í…ìŠ¤íŠ¸ë¡œ ë³µêµ¬
      btnText.innerText = t("ê³µì§€ì‚¬í•­ ì—…ë°ì´íŠ¸");
      showToast(t("ì„œë²„ í†µì‹  ì‹¤íŒ¨"), "fa-solid fa-bomb text-red-500");
    })
    .updateSystemNotice(content);
}


// ì „ë„ì¸ ê´€ë¦¬ì°½ ì—´ê¸°
function openPublisherManager() {
  document.getElementById('publisherManagerModal').classList.remove('hidden');
  loadPublisherList();
}

function closePublisherManager() {
  document.getElementById('publisherManagerModal').classList.add('hidden');
  resetPubForm();
}

function resetPubForm() {
  const nameInput = document.getElementById('pubInputName');
  const saveBtn = document.getElementById('pubSaveBtn');

  // 1. ì…ë ¥ í•„ë“œ ë° ìˆ˜ì • ëª¨ë“œ ì´ˆê¸°í™”
  nameInput.value = "";
  nameInput.disabled = false; 
  nameInput.style.backgroundColor = "#ffffff"; 
  
  // 2. ì²´í¬ë°•ìŠ¤ ë° íŠ¹ìˆ˜ ì˜ì—­ ì´ˆê¸°í™”
  document.getElementById('pubCheckPub').checked = false;
  document.getElementById('pubCheckLeader').checked = false;
  document.getElementById('pubInputPw').value = "";
  document.getElementById('pubPwArea').classList.add('hidden');
  document.getElementById('pubDeleteBtn').classList.add('hidden');
  
  // 3. ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³µêµ¬
  if(saveBtn) saveBtn.innerText = t("ì¶”ê°€");

  // 4. [ê²€ìƒ‰ ì´ˆê¸°í™”] ê²°ê³¼ ì—†ìŒ ë©”ì‹œì§€ ì œê±° ë° í•„í„° í•´ì œ
  const noResultEl = document.getElementById('noSearchResultMsg');
  if (noResultEl) noResultEl.remove();

  const allPills = document.querySelectorAll('#publisherListArea button');
  allPills.forEach(pill => pill.style.display = "");

  // 5. ê¶Œí•œ ì œì–´ ìƒíƒœ ë™ê¸°í™” (ì…ë ¥ë€ì´ ë¹„ì—ˆìœ¼ë¯€ë¡œ ì²´í¬ë°•ìŠ¤ ë¹„í™œì„±í™”)
  checkNamePresence();
}

// ëª…ë‹¨ ë¡œë“œ ë° ë Œë”ë§
function loadPublisherList() {
  const area = document.getElementById('publisherListArea');
  area.innerHTML = `<div class="text-center py-10 text-slate-400 text-xs"><i class="fa-solid fa-circle-notch fa-spin mr-1"></i> ${t("ëª…ë‹¨ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...")}</div>`;
  
  google.script.run
    .withSuccessHandler(function(res) {
      if (res.success) {
        renderPublisherPills(res.data);
      } else {
        area.innerHTML = '<div class="text-center text-red-500 py-10 text-xs">ë¡œë”© ì‹¤íŒ¨</div>';
      }
    })
    .getPublisherListDetail();
}

function renderPublisherPills(list) {
  const area = document.getElementById('publisherListArea');
  area.innerHTML = "";
  
  if (!list || list.length === 0) {
    area.innerHTML = '<div class="text-center py-10 text-slate-300 text-xs">ë“±ë¡ëœ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  // 1. ì „ì²´ ëª…ë‹¨ ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬
  list.sort((a, b) => a.name.localeCompare(b.name, 'ko'));

  // 2. ë°ì´í„° ë¶„ë¥˜
  const leaders = list.filter(item => item.leader); 
  const regularPubs = list.filter(item => !item.leader); 

  // ê·¸ë£¹ ë Œë”ë§ìš© ë‚´ë¶€ í•¨ìˆ˜
  function createGroupSection(title, items, isLeaderGroup) {
    if (items.length === 0) return;

    const header = document.createElement('div');
    header.className = "w-full font-black text-[11px] mt-5 mb-2 px-1 flex items-center gap-2 uppercase tracking-wider " + 
                       (isLeaderGroup ? "text-indigo-500" : "text-emerald-500");
    // í—¤ë” ì•„ì´ì½˜ì€ ìœ ì§€í•˜ì—¬ ê·¸ë£¹ ì„±ê²© í‘œì‹œ
    header.innerHTML = `<i class="fa-solid ${isLeaderGroup ? 'fa-crown' : 'fa-users'} text-[10px]"></i> <span>${title} (${items.length}ëª…)</span>`;
    area.appendChild(header);

    const wrapper = document.createElement('div');
    wrapper.className = "flex flex-wrap gap-2 mb-2";

    items.forEach(item => {
      const pill = document.createElement('button');
      let colorClass = "";
      if (item.leader) {
        colorClass = "bg-indigo-100 text-indigo-700 border-indigo-200 hover:bg-indigo-200";
      } else {
        colorClass = item.pub ? "bg-emerald-50 text-emerald-700 border-emerald-100 hover:bg-emerald-100" 
                             : "bg-slate-100 text-slate-400 border-slate-200";
      }
      
      pill.className = `px-3 py-1.5 rounded-full border text-xs font-bold transition-all active:scale-95 shadow-sm ${colorClass}`;
      
      // â˜… [ìˆ˜ì •] ì™•ê´€ ì•„ì´ì½˜ ì œê±°: ì˜¤ì§ ì´ë¦„ë§Œ í‘œì‹œí•©ë‹ˆë‹¤.
      pill.innerHTML = `${item.name}`;
      
      pill.onclick = function() {
        const nameInput = document.getElementById('pubInputName');
        const deleteBtn = document.getElementById('pubDeleteBtn');
        const saveBtn = document.querySelector('button[onclick="savePublisher()"]');

        nameInput.value = item.name;
        nameInput.disabled = true; 
        nameInput.style.backgroundColor = "#f1f5f9"; 
        
        document.getElementById('pubCheckPub').checked = item.pub;
        document.getElementById('pubCheckLeader').checked = item.leader;
        document.getElementById('pubInputPw').value = item.pw || "";
        
        if(saveBtn) saveBtn.innerText = t("ë³€ê²½ ì €ì¥");
        deleteBtn.classList.remove('hidden');
        
        checkNamePresence(); // ì²´í¬ë°•ìŠ¤ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
        togglePubPwInput(item.leader); // ì•”í˜¸ì°½ ë…¸ì¶œ ë¡œì§
        
        showToast(item.name + " " + t("ìˆ˜ì • ëª¨ë“œì…ë‹ˆë‹¤."));
      };
      wrapper.appendChild(pill);
    });
    area.appendChild(wrapper);
  }

  createGroupSection(t("ì¸ë„ì ê·¸ë£¹"), leaders, true);
  createGroupSection(t("ì „ë„ì¸ ê·¸ë£¹"), regularPubs, false);
}


// [ìµœì¢… ìˆ˜ì •ë³¸] ì „ë„ì¸ ì‚­ì œ í•¨ìˆ˜
function deletePublisher() {
  const name = document.getElementById('pubInputName').value.trim();
  if (!name) {
    showToast("ì‚­ì œí•  ì´ë¦„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", "fa-solid fa-exclamation text-amber-500");
    return;
  }

  // 1. ì‚­ì œ í™•ì¸ ëª¨ë‹¬ì— ì´ë¦„ í‘œì‹œ
  const nameDisplay = document.getElementById('deleteTargetName');
  if (nameDisplay) nameDisplay.innerText = name;
  
  // 2. ëª¨ë‹¬ ì—´ê¸°
  document.getElementById('pubDeleteConfirmModal').classList.remove('hidden');
  
  // 3. 'ì§„ì§œ ì‚­ì œ' ë²„íŠ¼ì— ì´ë²¤íŠ¸ ì—°ê²° (ê¸°ì¡´ ì´ë²¤íŠ¸ë¥¼ ì´ˆê¸°í™”í•˜ê³  ìƒˆë¡œ í• ë‹¹)
  const btnRealDelete = document.getElementById('btnRealPubDelete');
  btnRealDelete.onclick = function() {
    // ëª¨ë‹¬ ë¨¼ì € ë‹«ê¸°
    closePubDeleteModal();
    
    // --- [A] í™”ë©´ì—ì„œ ì¦‰ì‹œ ì œê±° (ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ) ---
    const allPills = document.querySelectorAll('#publisherListArea button');
    let targetFound = false;
    allPills.forEach(pill => {
      if (pill.innerText.trim() === name) {
        pill.style.transition = "all 0.2s ease";
        pill.style.opacity = "0";
        pill.style.transform = "scale(0.8)";
        setTimeout(() => pill.remove(), 200);
        targetFound = true;
      }
    });

    // ë¡œì»¬ ìºì‹œì—ì„œë„ ì‚­ì œ
    if (localUserCache && localUserCache.hasOwnProperty(name)) {
      delete localUserCache[name];
    }

    // --- [B] ì„œë²„ ì‹¤ì œ ì‚­ì œ ìš”ì²­ ---
    // ì‚¬ìš©ìì—ê²ŒëŠ” ì§„í–‰ ì¤‘ì„ì„ ì•Œë¦¬ì§€ ì•Šê³ (ì´ë¯¸ ì§€ì›Œì¡Œìœ¼ë¯€ë¡œ) ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬
    google.script.run
      .withSuccessHandler(function(res) {
        if (res.success) {
          showToast(name + " ë‹˜ì´ ëª…ë‹¨ì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.", "fa-solid fa-trash-can text-rose-400");
          resetPubForm(); // ì…ë ¥ì°½ ì´ˆê¸°í™”
          // loadPublisherList(); // <- ì „ì²´ ìƒˆë¡œê³ ì¹¨ì€ í•˜ì§€ ì•ŠìŒ (ì†ë„ í–¥ìƒ)
        } else {
          showModal("ì‚­ì œ ì‹¤íŒ¨: " + res.message);
          loadPublisherList(); // ì‹¤íŒ¨ ì‹œì—ë§Œ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
        }
      })
      .withFailureHandler(function(e) {
        showModal("ì„œë²„ ì˜¤ë¥˜ë¡œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        loadPublisherList();
      })
      .updatePublisherData("DELETE", { name: name });
  };
}


function closePubDeleteModal() {
  document.getElementById('pubDeleteConfirmModal').classList.add('hidden');
}

// [ìµœì¢… í†µí•©] ì´ë¦„ ì…ë ¥ ì—¬ë¶€ ì²´í¬ + ì‹¤ì‹œê°„ ëª…ë‹¨ í•„í„°ë§(ê²€ìƒ‰)
function checkNamePresence() {
  const nameInput = document.getElementById('pubInputName');
  const pubCheck = document.getElementById('pubCheckPub');
  const leaderCheck = document.getElementById('pubCheckLeader');
  const listArea = document.getElementById('publisherListArea');
  const nameValue = nameInput.value.trim();
  const isNameEmpty = nameValue === "";

  // 1. ì²´í¬ë°•ìŠ¤ í™œì„±í™” ì œì–´
  const labels = [pubCheck, leaderCheck].map(el => el.closest('label'));
  if (isNameEmpty) {
    pubCheck.disabled = true; leaderCheck.disabled = true;
    pubCheck.checked = false; leaderCheck.checked = false;
    labels.forEach(l => { if(l) l.style.opacity = "0.4"; });
    togglePubPwInput(false);
  } else {
    pubCheck.disabled = false; leaderCheck.disabled = false;
    labels.forEach(l => { if(l) l.style.opacity = "1"; });
  }

  // 2. ì‹¤ì‹œê°„ ëª…ë‹¨ í•„í„°ë§ (ì…ë ¥ì°½ í™œì„± ìƒíƒœì—ì„œë§Œ ì‘ë™)
  if (!nameInput.disabled) {
    const allPills = listArea.querySelectorAll('button');
    let visibleCount = 0;

    allPills.forEach(pill => {
      const pillName = pill.innerText.trim();
      const isMatch = isNameEmpty || pillName.includes(nameValue);
      pill.style.display = isMatch ? "" : "none";
      if (isMatch) visibleCount++;
    });

    // ê²€ìƒ‰ ê²°ê³¼ê°€ 0ê°œì¼ ë•Œ ì•ˆë‚´ ë¬¸êµ¬ í‘œì‹œ
    let noResultEl = document.getElementById('noSearchResultMsg');
    if (visibleCount === 0 && !isNameEmpty) {
      if (!noResultEl) {
        noResultEl = document.createElement('div');
        noResultEl.id = 'noSearchResultMsg';
        noResultEl.className = "w-full py-14 text-center text-slate-400 text-xs flex flex-col items-center justify-center";
        noResultEl.innerHTML = '<i class="fa-solid fa-magnifying-glass mb-3 text-2xl opacity-10"></i>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
        listArea.appendChild(noResultEl);
      }
    } else {
      if (noResultEl) noResultEl.remove();
    }

    // ê²€ìƒ‰ ì‹œ ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ ê³ ì • (ì–´ì§€ëŸ¬ì›€ ë°©ì§€)
    const scrollContainer = document.querySelector('#publisherManagerModal .overflow-y-auto');
    if (scrollContainer && !isNameEmpty) scrollContainer.scrollTop = 0;

    // ì¤‘ë³µ ì´ë¦„ ì²´í¬ ì•Œë¦¼
    if (!isNameEmpty && localUserCache && localUserCache.hasOwnProperty(nameValue)) {
       showToast("ì´ë¯¸ ë“±ë¡ëœ ì´ë¦„ì…ë‹ˆë‹¤.", "fa-solid fa-circle-info text-amber-400");
    }
  }
}

// [ìˆ˜ì •] ì¸ë„ì ìŠ¹ì¸ ì²´í¬ ì‹œ ì „ë„ì¸ ìŠ¹ì¸ ìë™ ì²´í¬ ë° ì•”í˜¸ì°½ ì œì–´
function togglePubPwInput(show) {
  const area = document.getElementById('pubPwArea');
  const pwInput = document.getElementById('pubInputPw');
  const pubCheck = document.getElementById('pubCheckPub');
  
  if (area) area.classList.toggle('hidden', !show);
  
  if (show) {
    // 1. ì¸ë„ì ìŠ¹ì¸ì´ ì²´í¬ë˜ë©´ ì „ë„ì¸ ìŠ¹ì¸ë„ ìë™ìœ¼ë¡œ ì²´í¬í•¨
    if (pubCheck) pubCheck.checked = true;
    
    // 2. ì•”í˜¸ ì…ë ¥ì°½ ìë™ í¬ì»¤ìŠ¤ (ëª¨ë°”ì¼ í˜¸í™˜ì„± ìœ„í•´ 150ms ì§€ì—°)
    if (pwInput) {
      setTimeout(() => {
        pwInput.focus();
        pwInput.click();
      }, 150);
    }
  } else {
    if (pwInput) pwInput.value = "";
  }
}




// [ìˆ˜ì •ë³¸] ì „ë„ì¸ ì €ì¥/ìˆ˜ì • í•¨ìˆ˜
function savePublisher() {
  const nameInput = document.getElementById('pubInputName');
  const name = nameInput.value.trim();
  
  if (!name) { 
    showToast("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.", "fa-solid fa-exclamation text-red-400"); 
    return; 
  }
  
  // ì‹ ê·œ ì¶”ê°€ ëª¨ë“œì¼ ë•Œ ì¤‘ë³µ ì²´í¬
  if (!nameInput.disabled && localUserCache && localUserCache.hasOwnProperty(name)) {
    showModal("'" + name + "' ì´ë¦„ì„ ì„ íƒí•˜ë©´ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    return; 
  }

  const isLeader = document.getElementById('pubCheckLeader').checked;
  const isPub = document.getElementById('pubCheckPub').checked;
  const pw = document.getElementById('pubInputPw').value.trim();
  
  if (isLeader && !pw) { 
    showToast(t("ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."), "fa-solid fa-key text-red-400");
    return; 
  }

  const data = { name: name, pub: isPub, leader: isLeader, pw: pw };

  // ë²„íŠ¼ ë¡œë”© ìƒíƒœ í‘œì‹œ
  const saveBtn = document.getElementById('pubSaveBtn');
  const originalText = saveBtn.innerText;
  saveBtn.disabled = true;
  saveBtn.innerText = "ì²˜ë¦¬ ì¤‘...";

  google.script.run
    .withSuccessHandler(function(res) {
      saveBtn.disabled = false;
      saveBtn.innerText = originalText;
      
      if (res.success) {
        showToast(res.message, "fa-solid fa-check text-emerald-500");
        
        // --- [í•µì‹¬] í™”ë©´ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ ---
        if (!nameInput.disabled) {
          // ì‹ ê·œ ì¶”ê°€ì¼ ê²½ìš°: ëª©ë¡ì— ìƒˆ ì•Œì•½ ì¦‰ì‹œ ìƒì„±
          addNewPillToUI(data);
        } else {
          // ê¸°ì¡´ ìˆ˜ì •ì¼ ê²½ìš°: ê¸°ì¡´ ì•Œì•½ ìŠ¤íƒ€ì¼ ì¦‰ì‹œ ë³€ê²½
          updatePillUI(data);
        }

        // í¼ ì´ˆê¸°í™” ë° ë¡œì»¬ ìºì‹œ ê°±ì‹ 
        resetPubForm();
        if (!localUserCache) localUserCache = {};
        localUserCache[name] = { leader: isLeader ? "Y" : "N", pub: isPub ? "Y" : "N" };
        
      } else {
        showModal(res.message);
      }
    })
    .withFailureHandler(function(e) {
      saveBtn.disabled = false;
      saveBtn.innerText = originalText;
      showModal("í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    })
    .updatePublisherData("SAVE", data);
}


// [ì‹ ê·œ] í™”ë©´ ëª©ë¡ì— ìƒˆ ì „ë„ì¸ ì•Œì•½ì„ ì¦‰ì‹œ ì¶”ê°€í•˜ëŠ” ê¸°ëŠ¥
function addNewPillToUI(data) {
  const area = document.getElementById('publisherListArea');
  const targetSectionTitle = data.leader ? "ì¸ë„ì ê·¸ë£¹" : "ì „ë„ì¸ ê·¸ë£¹";
  let targetWrapper = null;
  
  // í•´ë‹¹ ê·¸ë£¹ì˜ ì„¹ì…˜(ì¸ë„ì/ì „ë„ì¸)ì„ ì°¾ìŒ
  const headers = area.querySelectorAll('div.font-black');
  headers.forEach(h => {
    if (h.innerText.includes(targetSectionTitle)) {
      targetWrapper = h.nextElementSibling; // í—¤ë” ë°”ë¡œ ë°‘ì˜ flex div
    }
  });

  if (!targetWrapper) {
    loadPublisherList(); // ì„¹ì…˜ì„ ëª» ì°¾ìœ¼ë©´ ì „ì²´ ìƒˆë¡œê³ ì¹¨
    return;
  }

  // ìƒˆ ì•Œì•½(ë²„íŠ¼) ìƒì„±
  const pill = document.createElement('button');
  let colorClass = data.leader 
    ? "bg-indigo-100 text-indigo-700 border-indigo-200"
    : (data.pub ? "bg-emerald-50 text-emerald-700 border-emerald-100" : "bg-slate-100 text-slate-400 border-slate-200");
    
  pill.className = `px-3 py-1.5 rounded-full border text-xs font-bold shadow-sm transition-all active:scale-95 ${colorClass}`;
  pill.innerHTML = data.name;
  
  // í´ë¦­ ì‹œ ìˆ˜ì • ëª¨ë“œë¡œ ì—°ê²°
  pill.onclick = function() {
    loadInfoToInput(data);
  };

  targetWrapper.appendChild(pill);
  
  // ê°€ë‚˜ë‹¤ ìˆœìœ¼ë¡œ ìë™ ì •ë ¬
  const buttons = Array.from(targetWrapper.children);
  buttons.sort((a, b) => a.innerText.localeCompare(b.innerText, 'ko'));
  buttons.forEach(btn => targetWrapper.appendChild(btn));
  
  // ê·¸ë£¹ ì¸ì›ìˆ˜ í…ìŠ¤íŠ¸ ê°±ì‹ 
  const countMatch = headers[data.leader ? 0 : 1].innerText.match(/\d+/);
  if (countMatch) {
    const newCount = parseInt(countMatch[0]) + 1;
    headers[data.leader ? 0 : 1].innerHTML = headers[data.leader ? 0 : 1].innerHTML.replace(/\d+/, newCount);
  }
}

// [ì‹ ê·œ] ê¸°ì¡´ ì „ë„ì¸ì˜ ìŠ¤íƒ€ì¼(ìƒ‰ìƒ)ì„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
function updatePillUI(data) {
  const allPills = document.querySelectorAll('#publisherListArea button');
  allPills.forEach(pill => {
    if (pill.innerText.trim() === data.name) {
      let colorClass = data.leader 
        ? "bg-indigo-100 text-indigo-700 border-indigo-200 hover:bg-indigo-200"
        : (data.pub ? "bg-emerald-50 text-emerald-700 border-emerald-100 hover:bg-emerald-100" : "bg-slate-100 text-slate-400 border-slate-200");
      
      pill.className = `px-3 py-1.5 rounded-full border text-xs font-bold transition-all active:scale-95 shadow-sm ${colorClass}`;
    }
  });
}

// [í—¬í¼] ì•Œì•½ í´ë¦­ ì‹œ ë°ì´í„°ë¥¼ ì…ë ¥ì°½ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ëŠ” ê¸°ëŠ¥ (pill.onclick ëŒ€ì²´ìš©)
function loadInfoToInput(item) {
  const nameInput = document.getElementById('pubInputName');
  const deleteBtn = document.getElementById('pubDeleteBtn');
  const saveBtn = document.getElementById('pubSaveBtn');

  nameInput.value = item.name;
  nameInput.disabled = true; 
  nameInput.style.backgroundColor = "#f1f5f9"; 
  
  document.getElementById('pubCheckPub').checked = item.pub;
  document.getElementById('pubCheckLeader').checked = item.leader;
  document.getElementById('pubInputPw').value = item.pw || "";
  
  if(saveBtn) saveBtn.innerText = "ë³€ê²½";
  deleteBtn.classList.remove('hidden');
  
  checkNamePresence(); 
  togglePubPwInput(item.leader);
  showToast(item.name + " ìˆ˜ì • ëª¨ë“œì…ë‹ˆë‹¤.");
}

function closeAdminPanel() {
  document.getElementById('adminActionPanel').classList.add('hidden');
  
  // ğŸš€ [ìì› ì ˆì•½] ì¸ë„ì ë·°ë„ ì•ˆ ë³´ì´ê³  ì„¤ì •ì°½ë„ ë‹«í˜”ë‹¤ë©´ íƒ€ì´ë¨¸ ì¤‘ë‹¨
  const leaderView = document.getElementById('leaderView');
  if (leaderView && leaderView.classList.contains('hidden')) {
    if (leaderTimer) {
      clearInterval(leaderTimer);
      leaderTimer = null;
    }
  }
}

// [ì‹ ê·œ] ê´€ë¦¬ì ì¸ì¦ ìƒíƒœì— ë”°ë¥¸ ë²„íŠ¼ UI ì—…ë°ì´íŠ¸
function updateAdminAuthUI(isAuthenticated) {
  const btn = document.getElementById('adminToggleBtn');
  if (!btn) return;

  if (isAuthenticated) {
  // ì¸ì¦ ì„±ê³µ ìƒíƒœ (ë…¹ìƒ‰ í…Œë§ˆ + ì¸ì¦ë¨ ë¬¸êµ¬)
  btn.innerHTML = `
    <span class="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-emerald-50 text-emerald-600 border border-emerald-100 animate-pulse">
      <i class="fa-solid fa-unlock-keyhole text-xs"></i>
      <span class="font-black text-xs">${t("ì„¤ì • ê´€ë¦¬(ì¸ì¦ë¨)")}</span>
    </span>
  `;
} else {
  // ê¸°ë³¸ ìƒíƒœ (í†±ë‹ˆë°”í€´ ì•„ì´ì½˜)
  btn.innerHTML = `
    <span class="p-2 rounded-full group-hover:bg-indigo-50 transition-all">
      <i class="fa-solid fa-gear"></i> ${t("ì„¤ì • ê´€ë¦¬")}
    </span>
  `;
}
}

/**
 * ì–¸ì–´ ë³€ê²½ ë²„íŠ¼ í´ë¦­ ì‹œ (KO í¬í•¨ ì‹¤ì‹œê°„ ë°˜ì˜ + ì„œë²„ ì €ì¥)
 */
function changeSystemLanguage(langCode) {
  // í˜„ì¬ ì–¸ì–´ì™€ ê°™ë‹¤ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
  if (currentLang === langCode) return;
  
  currentLang = langCode;
  
  // 1. ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼ ì¦‰ì‹œ ë³€ê²½ (KO ë²„íŠ¼ í¬í•¨)
  updateLanguageUI(langCode);
  
  // 2. í™”ë©´ì˜ ì •ì  í…ìŠ¤íŠ¸ë“¤ ì¦‰ì‹œ ë²ˆì—­
  translatePage();
  
  // 3. ë™ì  ìš”ì†Œ(ë±ƒì§€, ë¦¬ìŠ¤íŠ¸, ëŒ€ì‹œë³´ë“œ ë“±) ì¬ë Œë”ë§
  // ë©”ì¸ í™”ë©´(êµ¬ì—­ì¹´ë“œ)ì´ ì—´ë ¤ìˆë‹¤ë©´
  if (!document.getElementById('mainView').classList.contains('hidden')) {
    checkStatusBadge(currentZoneStatus); // ìƒíƒœ ë±ƒì§€ (í˜¸ë³„/ë¶€ì¬/ì™„ë£Œ) ë²ˆì—­
    renderList(); // êµ¬ì—­ ë¦¬ìŠ¤íŠ¸ ë²ˆì—­ ì¬ë Œë”ë§
  }
  // ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œê°€ ì—´ë ¤ìˆë‹¤ë©´
  if (!document.getElementById('leaderView').classList.contains('hidden')) {
    renderLeaderDashboard(leaderDashboardData);
  }

  // 4. ì„œë²„ ì„¤ì • ì‹œíŠ¸(B11)ì— ì €ì¥ ë° í† ìŠ¤íŠ¸ ì•Œë¦¼
  const langNames = { ko: 'í•œêµ­ì–´', en: 'English', zh: 'ä¸­æ–‡', ru: 'Ğ ÑƒÑÑĞºĞ¸Ğ¹', ja: 'æ—¥æœ¬èª' };
  showToast(`${langNames[langCode]} ì„¤ì • ì €ì¥ ì¤‘...`, "fa-solid fa-spinner fa-spin");

  google.script.run
    .withSuccessHandler(function(res) {
      if (res.success) {
        showToast(`${langNames[langCode]}ë¡œ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, "fa-solid fa-globe text-emerald-500");
      }
    })
    .saveLanguageSetting(langCode);
}

/**
 * ì–¸ì–´ ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ (KO í¬í•¨)
 */
function updateLanguageUI(langCode) {
  const langs = ['ko', 'en', 'zh', 'ru', 'ja'];
  
  langs.forEach(code => {
    const btn = document.getElementById('lang-' + code);
    if (!btn) return;
    
    // ì„ íƒëœ ì–¸ì–´ ë²„íŠ¼ì€ ë³´ë¼ìƒ‰/ì§„í•œ ìŠ¤íƒ€ì¼ë¡œ, ë‚˜ë¨¸ì§€ëŠ” íšŒìƒ‰/ê¸°ë³¸ ìŠ¤íƒ€ì¼ë¡œ
    if (code === langCode) {
      btn.className = "flex flex-col items-center gap-1 p-2 rounded-xl border-2 border-indigo-600 bg-indigo-50 transition-all active:scale-95";
      btn.querySelector('span:first-child').className = "text-xs font-black text-indigo-700";
      btn.querySelector('span:last-child').className = "text-[9px] font-bold text-indigo-400";
    } else {
      btn.className = "flex flex-col items-center gap-1 p-2 rounded-xl border-2 border-slate-100 bg-white hover:border-indigo-200 transition-all active:scale-95";
      btn.querySelector('span:first-child').className = "text-xs font-black text-slate-700";
      btn.querySelector('span:last-child').className = "text-[9px] font-bold text-slate-400";
    }
  });
}



// 1. ì•± ì‹œì‘ ì‹œ ì‹¤í–‰ë˜ëŠ” ì´ˆê¸°í™” í•¨ìˆ˜
function initMultiLanguage() {
  // ì„œë²„ì—ì„œ B11 ì„¤ì •ê°’ê³¼ ë‹¤êµ­ì–´ ì‹œíŠ¸ ë°ì´í„°ë¥¼ í•œ ë²ˆì— ê°€ì ¸ì˜´
  google.script.run
    .withSuccessHandler(function(res) {
      if (res.translations) {
        translations = res.translations;
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ë°±ì—… (ì˜¤í”„ë¼ì¸/ì¬ì ‘ì† ëŒ€ë¹„)
        localStorage.setItem('APP_TRANSLATIONS', JSON.stringify(res.translations));
      }
      
      // ì„¤ì • ì‹œíŠ¸ B11ì—ì„œ ê°€ì ¸ì˜¨ ì–¸ì–´ ì ìš©
      currentLang = res.currentLang || 'ko';
      
      // UI ì—…ë°ì´íŠ¸
      updateLanguageUI(currentLang); // ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½
      translatePage();              // ì •ì  í…ìŠ¤íŠ¸ ë²ˆì—­
      
      // ë§Œì•½ ì´ë¯¸ ë¡œê·¸ì¸ëœ ìƒíƒœë¼ë©´ ë™ì  ìš”ì†Œë„ ë²ˆì—­
      if (currentNumber) {
        checkStatusBadge(currentZoneStatus);
        renderList();
      }
    })
    .getAppInitData(); // Code.gsì— ì‘ì„±í•œ í•¨ìˆ˜ í˜¸ì¶œ
}

// 2. ì–¸ì–´ ë³€ê²½ ë²„íŠ¼ í´ë¦­ ì‹œ (ì‹¤ì‹œê°„ ë°˜ì˜ + ì‹œíŠ¸ B11 ì €ì¥)
function changeSystemLanguage(langCode) {
  if (currentLang === langCode) return;
  
  currentLang = langCode;
  
  // (1) UI ìŠ¤íƒ€ì¼ ì¦‰ì‹œ ë³€ê²½
  updateLanguageUI(langCode);
  
  // (2) í™”ë©´ ì „ì²´ ë²ˆì—­ ì‹¤í–‰
  translatePage();
  
  // (3) ë™ì  ìš”ì†Œ(ë±ƒì§€, ë¦¬ìŠ¤íŠ¸, ëŒ€ì‹œë³´ë“œ) ì¬ë Œë”ë§
  if (!document.getElementById('mainView').classList.contains('hidden')) {
    checkStatusBadge(currentZoneStatus);
    renderList();
  }
  if (!document.getElementById('leaderView').classList.contains('hidden')) {
    renderLeaderDashboard(leaderDashboardData);
  }

  showToast("Language saving...", "fa-solid fa-spinner fa-spin");

  // (4) ì„œë²„ ì„¤ì • ì‹œíŠ¸ B11ì— ì €ì¥
  google.script.run
    .withSuccessHandler(function(res) {
      if (res.success) {
        showToast("ì–¸ì–´ ì„¤ì •ì´ ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", "fa-solid fa-globe text-emerald-500");
      }
    })
    .saveLanguageSetting(langCode);
}

// 3. í˜ì´ì§€ ë‚´ data-lang ì†ì„± ìš”ì†Œ ë²ˆì—­
function translatePage() {
  if (!translations || Object.keys(translations).length === 0) return;
  
  const elements = document.querySelectorAll('[data-lang]');
  elements.forEach(el => {
    const key = el.getAttribute('data-lang');
    if (translations[key]) {
      const targetText = translations[key][currentLang] || translations[key]['ko'];
      
      // 1. ì…ë ¥ì°½(INPUT, TEXTAREA)ì˜ ê²½ìš° placeholder ë²ˆì—­
      if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
        el.placeholder = targetText;
      } 
      // 2. ì¼ë°˜ ìš”ì†Œì˜ ê²½ìš° innerHTML ì‚¬ìš© (íƒœê·¸ í¬í•¨ëœ ê°•ì¡° ë¬¸êµ¬ ëŒ€ì‘)
      else {
        el.innerHTML = targetText;
      }
    }
  });
}

// 4. ìš”ì²­í•˜ì‹  ë±ƒì§€ ë²ˆì—­ í•¨ìˆ˜ ì ìš©
function checkStatusBadge(statusText) {
  var badge = document.getElementById('statusBadge');
  if (!badge) return;

  var key = statusText || "í˜¸ë³„"; // í‚¤ê°’ ì¶”ì¶œ
  
  // ë‹¤êµ­ì–´ ë°ì´í„°ì—ì„œ ë²ˆì—­ì–´ ì¶”ì¶œ (ì—†ìœ¼ë©´ í•œêµ­ì–´ ê·¸ëŒ€ë¡œ)
  var translatedText = (translations[key] && translations[key][currentLang]) 
                        ? translations[key][currentLang] 
                        : key;
  
  badge.innerText = translatedText;
  
  // ìŠ¤íƒ€ì¼ ë¡œì§ (ë¹„êµëŠ” ë°ì´í„° ì›í˜•ì¸ keyë¡œ ìˆ˜í–‰)
  if (key === "ì™„ë£Œ") {
     badge.className = "text-[11px] bg-zinc-600 text-white px-2 py-0.5 rounded-full font-bold shadow-sm transition-all align-middle";
  } else if (key === "ë¶€ì¬") {
     badge.className = "text-[11px] bg-amber-500 text-white px-2 py-0.5 rounded-full font-bold shadow-sm transition-all align-middle";
  } else {
     badge.className = "text-[11px] bg-emerald-500 text-white px-2 py-0.5 rounded-full font-bold backdrop-blur-md shadow-sm transition-all align-middle";
  }
}

/**
 * íŠ¹ì • ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ ëª¨ë“  [data-lang] ìš”ì†Œë¥¼ ë²ˆì—­í•©ë‹ˆë‹¤.
 */
function translateContainer(container) {
  if (!container || !translations) return;
  const elements = container.querySelectorAll('[data-lang]');
  elements.forEach(el => {
    const key = el.getAttribute('data-lang');
    if (translations[key]) {
      el.innerText = translations[key][currentLang] || translations[key]['ko'];
    }
  });
}

/**
 * [ë™ì  ë²ˆì—­ í—¬í¼] ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œ ë‚´ì—ì„œ ê¸€ìë¥¼ ê°€ì ¸ì˜¬ ë•Œ ì‚¬ìš©
 * ì‚¬ìš©ë²•: t("ì™¸") -> ì‹œíŠ¸ì—ì„œ "ì™¸"ë¥¼ ì°¾ì•„ í˜„ì¬ ì–¸ì–´ë¡œ ë°˜í™˜
 */
function t(key) {
  if (!translations || !translations[key]) return key;
  return translations[key][currentLang] || translations[key]['ko'];
}

/**
 * 2. ì‹œìŠ¤í…œ ì„¤ì •(B11)ì— ë”°ë¼ ì´ˆê¸° ì–¸ì–´ ì ìš©
 */
function applyInitialLanguage() {
  google.script.run
    .withSuccessHandler(function(settings) {
      currentLang = settings.lang || "ko";
      updateLanguageUI(currentLang); // ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼
      translatePage(); // ì „ì²´ í…ìŠ¤íŠ¸ ë²ˆì—­
    })
    .getSystemSettings();
}

/**
 * 4. ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ ìœ í‹¸ë¦¬í‹°
 */
function updateLanguageUI(langCode) {
  const langs = ['ko', 'en', 'zh', 'ru', 'ja'];
  langs.forEach(code => {
    const btn = document.getElementById('lang-' + code);
    if (!btn) return;
    
    if (code === langCode) {
      btn.className = "flex flex-col items-center gap-1 p-2 rounded-xl border-2 border-indigo-600 bg-indigo-50 transition-all active:scale-95";
      btn.querySelector('span:first-child').classList.add('text-indigo-700');
      btn.querySelector('span:first-child').classList.remove('text-slate-700');
    } else {
      btn.className = "flex flex-col items-center gap-1 p-2 rounded-xl border-2 border-slate-100 bg-white hover:border-indigo-200 transition-all active:scale-95";
      btn.querySelector('span:first-child').classList.add('text-slate-700');
      btn.querySelector('span:first-child').classList.remove('text-indigo-700');
    }
  });
}

let currentSyncMode = 'N'; 
// ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ì‹¤ì œ ì…€ ê°’ì„ ë³´ê´€í•  ë³€ìˆ˜
let serverSavedSyncMin = 1;
let serverSavedAliveMin = 5;

// ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ (í•¨ìˆ˜ ë°– ìƒë‹¨ì— ìœ„ì¹˜)
let serverSavedBellEnabled = "N"; 

/**
 * ğŸš€ [ìµœì¢… í†µí•©] ê´€ë¦¬ì íŒ¨ë„ ë¡œë“œ ì‹œ ì‹¤í–‰ (ì—°ì°¨ ë°°ì§€, í”„ë¡œê·¸ë¨ ì´ë¦„, ì„±êµ¬ ì„¤ì • í¬í•¨)
 */
function loadCurrentAdminSettings() {
  const progInput = document.getElementById('adminProgramNameInput');
  const congInput = document.getElementById('adminCongNameInput');
  const pwInput = document.getElementById('adminNewPwInput');
  const syncInput = document.getElementById('inputSyncMin');
  const aliveInput = document.getElementById('inputAliveMin');

  // 1. ì „ì—­ ì„¤ì • ë°ì´í„° ì¶”ì¶œ
  const settings = globalSettings; 

  if (!settings) {
    console.error("ì„¤ì • ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }

  // ============================================================
  // ğŸ“… [ì—°ì°¨ ì¸ì‹ ë° UI ë°°ì¹˜] 'ìˆœíšŒë°©ë¬¸ ìë£Œ' ë²„íŠ¼ ìœ„ë¡œ ì´ë™
  // ============================================================
  const cycle = settings.cycle || 1; 
  
  // ğŸ¯ 'ìˆœíšŒë°©ë¬¸ ìë£Œ' ë²„íŠ¼ì„ ì •ë°€í•˜ê²Œ ì°¾ì•„ëƒ…ë‹ˆë‹¤.
  const pdfBtn = document.querySelector('button[onclick="runVisitReport()"]');
  
  if (pdfBtn) {
    let cycleBadge = document.getElementById('adminCycleBadge');
    
    if (!cycleBadge) {
      cycleBadge = document.createElement('div');
      cycleBadge.id = 'adminCycleBadge';
      cycleBadge.className = "flex justify-center mb-1 admin-item-fade"; 
      pdfBtn.parentNode.insertBefore(cycleBadge, pdfBtn);
    }
    
    cycleBadge.innerHTML = `
      <span class="px-3 py-0.5 rounded-full bg-indigo-600 text-white text-[10px] font-black shadow-md ring-2 ring-white">
        ${cycle}${t("ë…„ì°¨ ê¸°ë¡ ì¤‘")}
      </span>
    `;
  }

  // ============================================================
  // ğŸ› ï¸ [ê¸°ì¡´ í•µì‹¬ ë¡œì§ ë° ë³´ì•ˆ ìœ ì§€]
  // ============================================================

  // 1. ê¸°ë³¸ ì •ë³´ ì…ë ¥
  // ğŸš€ í”„ë¡œê·¸ë¨ ì´ë¦„ ë¡œë“œ (B15 ì…€ ë°ì´í„°)
  if (progInput) {
    progInput.value = settings.programName || "";
    progInput.placeholder = t("í”„ë¡œê·¸ë¨ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”");
  }

  // íšŒì¤‘ ëª…ì¹­ ë¡œë“œ (B8 ì…€ ë°ì´í„°)
  if (congInput) {
    congInput.value = settings.congName || "";
    congInput.placeholder = t("íšŒì¤‘ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”");
  }

  /** ğŸ›¡ï¸ ë³´ì•ˆ: ë¹„ë°€ë²ˆí˜¸ëŠ” ì…ë ¥ì°½ì„ í•­ìƒ ë¹„ì›Œë‘  */
  if (pwInput) pwInput.value = ""; 

  // ë™ê¸°í™” ìˆ˜ì¹˜ ë³´ê´€
  serverSavedSyncMin = settings.syncMin;
  serverSavedAliveMin = settings.aliveMin;

  // ğŸ”” ë²¨ ì„¤ì • ë™ê¸°í™” (B5)
  serverSavedBellEnabled = settings.isBellEnabled || "N";
  if (typeof globalSettings === 'undefined') window.globalSettings = {};
  globalSettings.isBellEnabled = serverSavedBellEnabled; 
  updateBellOptionButton(serverSavedBellEnabled);

  // ğŸš© ì—¬ê¸°ê¹Œì§€(ë§ˆí¬) ì„¤ì • ë™ê¸°í™” (B6)
  globalSettings.isMarkEnabled = settings.isMarkEnabled || "Y"; 
  updateMarkOptionButton(globalSettings.isMarkEnabled);

  // ğŸ“– [ì¶”ê°€] ì˜¤ëŠ˜ì˜ ì„±êµ¬ ì„¤ì • ë™ê¸°í™” (B16)
  globalSettings.isShowBible = settings.isShowBible || "Y";
  if (typeof updateBibleOptionButton === 'function') {
    updateBibleOptionButton(globalSettings.isShowBible);
  }

  // 2. ë™ê¸°í™” ëª¨ë“œ ë° í•˜ì´ë¸Œë¦¬ë“œ UI ì´ˆê¸°í™”
  setSyncMode(settings.isHybrid === "Y" ? "Y" : "N"); 
  updateHybridLogic(); 

  console.log(`âœ… ê´€ë¦¬ì ì„¤ì • ë¡œë“œ ì™„ë£Œ: ${settings.programName} / ${cycle}ë…„ì°¨`);
}

// 1. ë²¨ ë²„íŠ¼ UI ì—…ë°ì´íŠ¸ (ìƒ‰ìƒ/í…ìŠ¤íŠ¸)
function updateBellOptionButton(val) {
  const btn = document.getElementById('btnBellOption');
  if (!btn) return;
  if (val === 'Y') {
    btn.innerText = t("ì‚¬ìš© ì¤‘");
    btn.className = "px-4 py-2 rounded-xl text-[11px] font-black transition-all shadow-sm border bg-indigo-600 text-white border-indigo-500";
  } else {
    btn.innerText = t("ë¯¸ì‚¬ìš©");
    btn.className = "px-4 py-2 rounded-xl text-[11px] font-black transition-all shadow-sm border bg-white text-slate-400 border-slate-200";
  }
}


// ë¹„ë°€ë²ˆí˜¸ ëˆˆ ì•„ì´ì½˜ í† ê¸€ í•¨ìˆ˜ (ê¸°ì¡´ ìœ ì§€)
function toggleAdminPwVisibility() {
  const pwInput = document.getElementById('adminNewPwInput');
  const eyeIcon = document.getElementById('adminPwEyeIcon');
  if (pwInput.type === 'password') {
    pwInput.type = 'text';
    eyeIcon.className = 'fa-solid fa-eye';
  } else {
    pwInput.type = 'password';
    eyeIcon.className = 'fa-solid fa-eye-slash';
  }
}

// 2. ê´€ë¦¬ì íŒ¨ë„ ì—´ë¦´ ë•Œ ê°’ ë™ê¸°í™” (ê¸°ì¡´ verifyAdminModal ì„±ê³µ ë¡œì§ ë‚´ë¶€ì— ì¶”ê°€ ê¶Œì¥)
// í˜¹ì€ ë³„ë„ì˜ ì´ˆê¸°í™” í•¨ìˆ˜ë¡œ ê´€ë¦¬
function syncAdminGeneralInputs() {
  google.script.run
    .withSuccessHandler(function(settings) {
      document.getElementById('adminCongNameInput').value = settings.congName || "";
      document.getElementById('adminNewPwInput').value = settings.adminPw || "";
      // ë¹„ë°€ë²ˆí˜¸ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë‹¤ì‹œ ìˆ¨ê¹€ ì²˜ë¦¬
      document.getElementById('adminNewPwInput').type = 'password';
      document.getElementById('adminPwEyeIcon').className = 'fa-solid fa-eye-slash';
    })
    .getSystemSettings();
}

// 3. ì„¤ì • ì €ì¥ ì‹¤í–‰ (í”„ë¡œê·¸ë¨ ì´ë¦„ B15 í¬í•¨ ë²„ì „)
function saveGeneralSettings() {
  // ğŸš€ í”„ë¡œê·¸ë¨ ì´ë¦„ ì…ë ¥ë€ ì¶”ê°€
  const progName = document.getElementById('adminProgramNameInput').value.trim();
  const congName = document.getElementById('adminCongNameInput').value.trim();
  const adminPw = document.getElementById('adminNewPwInput').value.trim();
  const btn = document.getElementById('btnSaveGeneral');
  
  // ğŸš€ ìœ íš¨ì„± ê²€ì‚¬ì— progName ì¶”ê°€
  if (!progName || !congName || !adminPw) {
    showToast(t("ëª¨ë“  ë¹ˆì¹¸ì„ ì±„ì›Œì£¼ì„¸ìš”."), "fa-solid fa-circle-exclamation text-amber-500");
    return;
  }

  btn.disabled = true;
  btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> ${t("ì €ì¥ ì¤‘...")}`;

  google.script.run
    .withSuccessHandler(function(res) {
      btn.disabled = false;
      btn.innerHTML = `<i class="fa-solid fa-floppy-disk"></i> <span data-lang="ê¸°ë³¸ ì •ë³´ ì €ì¥">${t("ê¸°ë³¸ ì •ë³´ ì €ì¥")}</span>`;
      
      if (res.success) {
        showToast(t(res.message), "fa-solid fa-check-circle text-emerald-500");
        
        // ğŸš€ ì„±ê³µ ì‹œ ë¡œì»¬ ì „ì—­ ë³€ìˆ˜(globalSettings) ë°ì´í„° ë™ê¸°í™”
        if (typeof globalSettings !== 'undefined') {
          globalSettings.programName = progName;
          globalSettings.congName = congName;
        }
      } else {
        showModal(res.message);
      }
    })
    .withFailureHandler(function(err) {
      btn.disabled = false;
      btn.innerHTML = `<i class="fa-solid fa-floppy-disk"></i> <span data-lang="ê¸°ë³¸ ì •ë³´ ì €ì¥">${t("ê¸°ë³¸ ì •ë³´ ì €ì¥")}</span>`;
      showToast(t("ì„œë²„ í†µì‹  ì‹¤íŒ¨"), "fa-solid fa-bomb text-red-500");
    })
    // ğŸš€ ì„œë²„ í•¨ìˆ˜ë¡œ 3ê°œì˜ ì¸ì ì „ë‹¬ (ìˆœì„œ: íšŒì¤‘ëª…, ë¹„ë²ˆ, í”„ë¡œê·¸ë¨ëª…)
    // â€» ì„œë²„(Code.gs)ì˜ í•¨ìˆ˜ ì •ì˜ì™€ ìˆœì„œë¥¼ ë§ì¶°ì£¼ì„¸ìš”.
    .saveGeneralSettings(congName, adminPw, progName);
}


// 3. ì„¤ì •ê°’ ë¡œë“œ ì—°ë™ (loadCurrentAdminSettings ë‚´ë¶€ ìˆ˜ì •)
// ê¸°ì¡´ loadCurrentAdminSettingsì˜ ì„±ê³µ ì½œë°± ë‚´ë¶€ì— ì¶”ê°€í•˜ì„¸ìš”.
function loadSyncSettingsToUI(settings) {
  document.getElementById('inputSyncMin').value = settings.syncMin;
  document.getElementById('inputAliveMin').value = settings.aliveMin;
  setSyncMode(settings.isHybrid === "Y" ? "Y" : "N");
}


let lastDashboardDataJSON = ""; 

function refreshLeaderDashboardInBackground() {
  if (!isLeaderLoggedIn && !isAdminAuthenticated) return; 
  if (isDeepSleeping) return; 

  google.script.run
    .withSuccessHandler(function(newData) {
      if (!newData || !newData.furnitureCounts) return; // ğŸš€ ë°ì´í„°ê°€ ë¶ˆì™„ì „í•˜ë©´ ë¬´ì‹œ
      
      // 1. í™”ë©´ ë Œë”ë§ì— ì§ì ‘ ì˜í–¥ì„ ì£¼ëŠ” í•µì‹¬ ë°ì´í„°ë§Œ ê³¨ë¼ì„œ ë¹„êµ
      // (actionStressì²˜ëŸ¼ ë§¤ë²ˆ ë³€í•˜ëŠ” ê°’ì€ ì œì™¸í•´ì•¼ ê¹œë¹¡ì„ì´ ë©ˆì¶¥ë‹ˆë‹¤)
      var syncCheckObj = {
        h: newData.house,
        b: newData.busy,
        c: newData.complete,
        cl: newData.clean,
        az: newData.activeZones,
        fc: newData.furnitureCounts // ê°€êµ¬ìˆ˜ ë° ë²¨ ë°ì´í„°
      };
      
      var currentDataStr = JSON.stringify(syncCheckObj);

      // ë°ì´í„°ê°€ ì´ì „ê³¼ ì™„ë²½íˆ ê°™ë‹¤ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ (í•µì‹¬)
      if (currentDataStr === lastDashboardDataJSON) {
        return; 
      }
      lastDashboardDataJSON = currentDataStr;

      // 2. ë°ì´í„°ê°€ ë°”ë€Œì—ˆì„ ë•Œë§Œ ì—…ë°ì´íŠ¸ ì‹¤í–‰
      leaderDashboardData = newData; 
      updateHybridLogic(); 
      updateAdminStats(); 
      
      const leaderView = document.getElementById('leaderView');
      if (leaderView && !leaderView.classList.contains('hidden')) {
        renderLeaderDashboard(newData);
        if (newData.sosAlerts) checkSOS(newData.sosAlerts);
      }
    })
    .withFailureHandler(function(e) { console.error("ê°±ì‹  ì‹¤íŒ¨:", e); })
    .getLeaderData();
}



let lastAutoSavedSync = 0; 

/**
 * [ì´ˆì™„í™” ë²„ì „] í•˜ì´ë¸Œë¦¬ë“œ ëª¨ë“œ ì—”ì§„
 * 1. ì•¡ì…˜ ê°€ì¤‘ì¹˜: 0.3 (ì—°íƒ€ë¥¼ í•´ë„ ì ìˆ˜ê°€ ë§¤ìš° ëŠë¦¬ê²Œ ìƒìŠ¹)
 * 2. ì „í™˜ ì„ê³„ì¹˜: 200ì  (ì„œë²„ê°€ í™•ì‹¤íˆ ë°”ë¹ ì§ˆ ë•Œê¹Œì§€ í•˜ì´ë¸Œë¦¬ë“œ ê°œì… ì•ˆ í•¨)
 * 3. êµ¬ê°„ ê²½ê³„ ìƒí–¥: ì¾Œì í•œ ì†ë„(0.8~1.0ë¶„) ìœ ì§€ êµ¬ê°„ì„ ëŒ€í­ í™•ëŒ€
 */
function updateHybridLogic() {
  if (!leaderDashboardData) return;
  
  const actionStress = leaderDashboardData.actionStress || 0; 
  let activeCount = 0;
  const activeMap = leaderDashboardData.activeZones || {};
  
  for (let key in activeMap) {
    const zone = activeMap[key];
    if (zone.isFinished === false) { 
      activeCount += (zone.users && Array.isArray(zone.users)) ? zone.users.length : 1;
    }
  }

  // ê°€ì¤‘ì¹˜ë¥¼ 0.3ìœ¼ë¡œ ë‚®ì¶¤ (í•œ ì‚¬ëŒì´ 10ë²ˆ í´ë¦­í•´ë„ ë¶€í•˜ ì ìˆ˜ëŠ” ë‹¨ 3ì  ìƒìŠ¹)
  const weight = 0.3; 
  const totalScore = activeCount + (actionStress * weight);
  
  // ì‹œê°í™” ì§€í‘œ ì™„í™” (ë°°ìœ¨ 1.2ë¡œ í•˜í–¥: ë¹¨ê°„ ë°”ê°€ í›¨ì”¬ ì²œì²œíˆ ì°¨ì˜¤ë¦„)
  updateUserGauge(isDeepSleeping ? 0 : Math.min(100, (activeCount / 100) * 100));
  updateActionGauge(isDeepSleeping ? 0 : Math.min(100, (actionStress * 1.2)));

  // í•˜ì´ë¸Œë¦¬ë“œ ìë™ ì „í™˜ ê¸°ì¤€ì„ 200ì ìœ¼ë¡œ ìƒí–¥ (ê°œì… ìµœì†Œí™”)
  if (currentSyncMode === 'N' && totalScore >= 200) {
    currentSyncMode = 'Y';
    setSyncMode('Y'); 
    showToast(t("ì„œë²„ ë¶€í•˜ ê°ì§€: ìµœì í™” ëª¨ë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤"), "fa-solid fa-wand-magic-sparkles text-indigo-400", 3000);
  }

  if (currentSyncMode === 'Y' && !isDeepSleeping) {
    let recSync = 0.8; 

    /**
     * [ì´ˆì™„í™” ê°€ë³€ ì‹œê°„í‘œ]
     * ë¹ ë¥¸ ì†ë„ê°€ ë” ì˜¤ë˜ ìœ ì§€ë˜ë„ë¡ ê²½ê³„ê°’ì„ ëŒ€í­ ë†’ì„
     */
    if (actionStress >= 120)      recSync = 3.0; // ì •ë§ ì‹¬ê°í•œ í­ì£¼ ì‹œì—ë§Œ 3ë¶„
    else if (actionStress >= 80)  recSync = 2.0; // ë¶€í•˜ê°€ í™•ì‹¤íˆ ëŠê»´ì§ˆ ë•Œ 2ë¶„
    else if (actionStress >= 50)  recSync = 1.0; // í™œë™ì´ ìƒë‹¹íˆ ë§ì•„ì§€ë©´ 1ë¶„
    else recSync = 0.8;                           // í‰ìƒì‹œ(ëŒ€ë¶€ë¶„ì˜ ìƒí™©) 48ì´ˆ

    const recAlive = 5.0; 

    document.getElementById('inputSyncMin').value = recSync.toFixed(1);
    document.getElementById('inputAliveMin').value = recAlive.toFixed(1);

    if (Math.abs(lastAutoSavedSync - recSync) >= 0.1) {
      lastAutoSavedSync = recSync;
      google.script.run.saveSyncSettings(recSync, recAlive, true);
    }

    CONFIG_SYNC_INTERVAL = recSync * 60 * 1000;
    CONFIG_ALIVE_INTERVAL = recAlive * 60 * 1000;
  }
}


// ì‚¬ìš©ì ë°€ë„ ê²Œì´ì§€ ìƒíƒœ ë²ˆì—­
function updateUserGauge(percent) {
  const bar = document.getElementById('userGaugeBar');
  const txt = document.getElementById('userLoadStatus');
  if (!bar || !txt) return;
  bar.style.width = percent + "%";
  
  if (isDeepSleeping) {
    txt.innerText = t("ì ˆì „ ì¤‘"); txt.className = "text-[10px] font-black text-slate-400";
    bar.style.backgroundColor = "#e2e8f0";
  } else if (percent < 30) {
    txt.innerText = t("ì¾Œì "); txt.className = "text-[10px] font-black text-emerald-500";
    bar.style.backgroundColor = "#10b981";
  } else if (percent < 75) {
    txt.innerText = t("ë³´í†µ"); txt.className = "text-[10px] font-black text-amber-500";
    bar.style.backgroundColor = "#f59e0b";
  } else {
    txt.innerText = t("ì¸ì› ë§ìŒ"); txt.className = "text-[10px] font-black text-red-500";
    bar.style.backgroundColor = "#ef4444";
  }
}

// ì•¡ì…˜ ë¶€í•˜ ê²Œì´ì§€ ìƒíƒœ ë²ˆì—­
function updateActionGauge(percent) {
  const bar = document.getElementById('actionGaugeBar');
  const txt = document.getElementById('actionLoadStatus');
  if (!bar || !txt) return;
  bar.style.width = percent + "%";
  
  if (isDeepSleeping) {
    txt.innerText = t("ëŒ€ê¸° ì¤‘"); txt.className = "text-[10px] font-black text-slate-400";
    bar.style.backgroundColor = "#e2e8f0";
  } else if (percent < 20) {
    txt.innerText = t("ì•ˆì •"); txt.className = "text-[10px] font-black text-blue-400";
    bar.style.backgroundColor = "#60a5fa";
  } else if (percent < 70) {
    txt.innerText = t("ì²˜ë¦¬ ì¤‘"); txt.className = "text-[10px] font-black text-blue-600";
    bar.style.backgroundColor = "#2563eb";
  } else {
    txt.innerText = t("ë¶€í•˜ ì§‘ì¤‘!"); txt.className = "text-[10px] font-black text-red-600 animate-pulse";
    bar.style.backgroundColor = "#dc2626";
  }
}



/**
 * 2. ëª¨ë“œ ì „í™˜ UI ì œì–´
 */
function setSyncMode(mode) {
  currentSyncMode = mode;
  const isHybrid = (mode === 'Y');
  
  const btnGeneral = document.getElementById('modeBtnGeneral');
  const btnHybrid = document.getElementById('modeBtnHybrid');
  const inputSync = document.getElementById('inputSyncMin');
  const inputAlive = document.getElementById('inputAliveMin');
  const badges = [document.getElementById('hybridBadgeSync'), document.getElementById('hybridBadgeAlive')];
  const guideText = document.getElementById('hybridGuideText');

  btnGeneral.className = isHybrid ? "px-3 py-1 text-[10px] font-black rounded-md text-slate-400" : "px-3 py-1 text-[10px] font-black rounded-md bg-white shadow-sm text-indigo-600";
  btnHybrid.className = isHybrid ? "px-3 py-1 text-[10px] font-black rounded-md bg-white shadow-sm text-indigo-600" : "px-3 py-1 text-[10px] font-black rounded-md text-slate-400";

  if (isHybrid) {
    inputSync.readOnly = true;
    inputAlive.readOnly = true;
    inputSync.classList.add('bg-indigo-50/50', 'text-indigo-600', 'border-indigo-100');
    inputAlive.classList.add('bg-indigo-50/50', 'text-indigo-600', 'border-indigo-100');
    if(guideText) guideText.classList.remove('hidden');
    badges.forEach(b => b && b.classList.remove('hidden'));
    showToast(t("í•˜ì´ë¸Œë¦¬ë“œ ì œì•ˆ ëª¨ë“œ í™œì„±í™”"), "fa-solid fa-wand-magic-sparkles text-indigo-400");
  } else {
    inputSync.readOnly = false;
    inputAlive.readOnly = false;
    inputSync.classList.remove('bg-indigo-50/50', 'text-indigo-600', 'border-indigo-100');
    inputAlive.classList.remove('bg-indigo-50/50', 'text-indigo-600', 'border-indigo-100');
    if(guideText) guideText.classList.add('hidden');
    badges.forEach(b => b && b.classList.add('hidden'));

    inputSync.value = serverSavedSyncMin;
    inputAlive.value = serverSavedAliveMin;
    showToast(t("ì¼ë°˜ ì„¤ì • ëª¨ë“œ (ìˆ˜ë™ ì…ë ¥)"), "fa-solid fa-keyboard text-slate-400");
  }
    
}


/**
 * [index.html] ê´€ë¦¬ì íŒ¨ë„ - ì„¤ì •ê°’ ì ìš© ë²„íŠ¼ í´ë¦­ ì‹œ (ë™ê¸°í™” ì„¤ì • ì „ìš©)
 */
function saveSyncSettings() {
  const syncMin = document.getElementById('inputSyncMin').value;
  const aliveMin = document.getElementById('inputAliveMin').value;
  const isHybrid = (currentSyncMode === 'Y');

  const btn = document.getElementById('btnSaveSync');
  btn.disabled = true;
  btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> ${t("ì ìš© ì¤‘...")}`;

  google.script.run
    .withSuccessHandler(function(res) {
      btn.disabled = false;
      btn.innerHTML = `<i class="fa-solid fa-cloud-arrow-up"></i> <span>${t("ì„¤ì •ê°’ ì ìš©")}</span>`;
      
      if (res.success) {
        // ë™ê¸°í™” ê´€ë ¨ ë³€ìˆ˜ë§Œ ì—…ë°ì´íŠ¸
        globalSettings.syncMin = syncMin;
        globalSettings.aliveMin = aliveMin;
        globalSettings.isHybrid = isHybrid ? "Y" : "N";
        
        showToast(t("ë™ê¸°í™” ì„¤ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤."), "fa-solid fa-check-double text-emerald-500");
      } else {
        showModal(res.message);
      }
    })
    .withFailureHandler(function(e) {
       btn.disabled = false;
       btn.innerHTML = t("ì„¤ì •ê°’ ì ìš©");
       showToast("ì„œë²„ í†µì‹  ì‹¤íŒ¨", "fa-solid fa-bomb text-red-500");
    })
    // ğŸš€ ë™ê¸°í™” ì„¤ì •(B2~B4)ì— í•„ìš”í•œ 3ê°œ ì¸ìë§Œ ì „ì†¡
    .saveSyncSettings(syncMin, aliveMin, isHybrid);
}



// [ì‹ ê·œ] ìœ íœ´ ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜
let lastInteractionTime = Date.now();
let isDeepSleeping = false;

// ì‚¬ìš©ìì˜ í™œë™(í„°ì¹˜/í´ë¦­)ì´ ìˆì„ ë•Œë§ˆë‹¤ ì‹œê°„ ì—…ë°ì´íŠ¸
function recordUserActivity() {
  lastInteractionTime = Date.now();
  if (isDeepSleeping) wakeUpFromSleep(); // ì ë“  ìƒíƒœì˜€ë‹¤ë©´ ê¹¨ì›€
}
document.addEventListener('touchstart', recordUserActivity, {passive: true});
document.addEventListener('mousedown', recordUserActivity);

// [ìˆ˜ì •] ì—”ì§„ ì •ì§€ í•¨ìˆ˜ (ë³¸ì¸ì€ ì¡°ìš©íˆ, ì„œë²„ì—ëŠ” ì¦‰ì‹œ ì•Œë¦¼)
function stopAllEngines() {
  if (isDeepSleeping) return;
  isDeepSleeping = true;

  stopKeepAlive(); 
  if (syncTimer) clearTimeout(syncTimer); 
  if (lockCheckInterval) clearInterval(lockCheckInterval); 
  
  // ğŸš€ [í•µì‹¬] ë‹¤ë¥¸ ì‚¬ëŒë“¤ì—ê²Œ ë‚´ ì ‘ì† ëŠê¹€ì„ ì¦‰ì‹œ ì•Œë¦¼
  // skipLogë¥¼ trueë¡œ ë³´ë‚´ì„œ í™œë™ ê¸°ë¡(Log)ì—ëŠ” ë‚¨ê¸°ì§€ ì•Šê³  ì‹¤ì‹œê°„ ë¨í”„ë§Œ ë•ë‹ˆë‹¤.
  if (currentNumber && currentUserName) {
    google.script.run
      .withFailureHandler(function(){})
      .notifyExit(currentNumber, currentUserName, currentLang, true); 
  }

  // ë³¸ì¸ í™”ë©´ì—ì„œëŠ” í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ì—†ì´ 'í„°ì¹˜ ì•ˆë‚´ ë ˆì´ì–´'ë§Œ í‘œì‹œ
  showSleepOverlay(); 
}


// íœ´ë©´ ëª¨ë“œ ë ˆì´ì–´ í‘œì‹œ í•¨ìˆ˜ (ì´ë²¤íŠ¸ íˆ¬ê³¼ ë°©ì§€ ì ìš©)
function showSleepOverlay() {
  let overlay = document.getElementById('sleepOverlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'sleepOverlay';
    // pointer-events-autoì™€ select-noneì„ ì¶”ê°€í•˜ì—¬ í´ë¦­ì„ í™•ì‹¤íˆ í¡ìˆ˜í•˜ê²Œ í•¨
    overlay.className = 'fixed inset-0 z-[99999] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-6 text-center cursor-pointer pointer-events-auto select-none';
    overlay.innerHTML = `
      <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-xs w-full animate-modalFadeIn">
        <div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-6">
          <i class="fa-solid fa-hand-pointer text-4xl text-indigo-500 animate-bounce"></i>
        </div>
        <h3 class="text-xl font-black text-slate-800 mb-2">${t("ì—°ê²° ìœ ì§€ ì¤‘")}</h3>
        <p class="text-slate-500 text-sm break-keep mb-0">${t("ë‹¤ì‹œ ì‹œì‘í•˜ë ¤ë©´ í™”ë©´ì„ í„°ì¹˜í•˜ì„¸ìš”.")}</p>
      </div>
    `;

    // ğŸš€ [í•µì‹¬] ìº¡ì²˜ë§(true) ë‹¨ê³„ë¥¼ ì‚¬ìš©í•˜ì—¬ í´ë¦­ì´ ì•„ë˜ ê°€êµ¬ ì¹´ë“œë¡œ ë‚´ë ¤ê°€ëŠ” ê²ƒì„ ì°¨ë‹¨
    overlay.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ë‹¨
      wakeUpFromSleep();
    }, true); 

    document.body.appendChild(overlay);
  }
  overlay.classList.remove('hidden');
}

function hideSleepOverlay() {
  const overlay = document.getElementById('sleepOverlay');
  if (overlay) overlay.classList.add('hidden');
}


// [ê¸°ì¡´ ë³€ìˆ˜ ìœ„ì¹˜ì— ì¶”ê°€]
let lastWakeUpTime = 0; // ğŸš€ ê¹¨ì–´ë‚œ ì‹œê°„ì„ ê¸°ë¡í•  ë³€ìˆ˜

// [3] ê¹¨ìš°ê¸° í•¨ìˆ˜ (íƒ€ì´ë° ìˆ˜ì •ë²„ì „)
function wakeUpFromSleep() {
  if (!isDeepSleeping) return;
  
  console.log("ğŸš€ ì ˆì „ ëª¨ë“œ í•´ì œ ì‹œì‘..."); 

  isDeepSleeping = false;
  lastWakeUpTime = Date.now(); 

  // 1. ë ˆì´ì–´ ìˆ¨ê¸°ê¸° (0.2ì´ˆ ë’¤ ì‚¬ë¼ì§)
  setTimeout(hideSleepOverlay, 200);

  // ë©”ì¸ í™”ë©´ ì¬ê°€ë™ ë¡œì§
  const mainEl = document.getElementById('mainView');
  const leaderEl = document.getElementById('leaderView');

  const isMainVisible = mainEl && !mainEl.classList.contains('hidden');
  const isLeaderVisible = leaderEl && !leaderEl.classList.contains('hidden');

  if (isMainVisible || isLeaderVisible) {
    if (isMainVisible) {
      console.log("âœ… ì¼ë°˜ ëª¨ë“œ ì¬ê°€ë™");
      startKeepAlive();
      startSync();
      if (typeof startLockPolling === 'function') startLockPolling();
      if (typeof startSOSMonitoring === 'function') startSOSMonitoring();
    } 
    else if (isLeaderVisible) {
      console.log("âœ… ì¸ë„ì ëª¨ë“œ ì¬ê°€ë™");
      if (typeof refreshLeaderDashboardInBackground === 'function') {
        refreshLeaderDashboardInBackground();
      }
      if (typeof startSOSMonitoring === 'function') startSOSMonitoring();
    }
    
    // â˜… [í•µì‹¬ ìˆ˜ì •] ì•Œë¦¼ì„ 300ms(0.3ì´ˆ) ë”œë ˆì´ë¥¼ ì£¼ì–´ í™•ì‹¤í•˜ê²Œ ë„ì›ë‹ˆë‹¤.
    // ë ˆì´ì–´ê°€ ì™„ì „íˆ ì‚¬ë¼ì§„ ë’¤ì— ëœ¨ê²Œ í•˜ì—¬ ê°€ë ¤ì§ì„ ë°©ì§€í•©ë‹ˆë‹¤.
    setTimeout(function() {
        showToast(t("ë‹¤ì‹œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤."), "fa-solid fa-bolt text-emerald-400");
    }, 300);

  } else {
      console.log("âš ï¸ ë¡œê·¸ì¸ í™”ë©´ì´ë¯€ë¡œ ì¬ì ‘ì† í”„ë¡œì„¸ìŠ¤ ìƒëµ");
  }
}


// [ìµœì¢…] ë”´ì§“ ê°ì§€ & ë‚ ì§œ ë³€ê²½ & 10ë¶„ ìœ íœ´ ê°ì§€ í†µí•© ë£¨í‹´
setInterval(function() {
  if (!currentNumber) return; // ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹ˆë©´ ì²´í¬ ì•ˆ í•¨

  const now = new Date();
  const todayString = now.toDateString();
  const idleDuration = Date.now() - lastInteractionTime;
  const isTabHidden = document.hidden;

  // ğŸš€ 1. ë‚ ì§œ ë³€ê²½ ê°ì§€ (ìì • ë¡œì§)
  if (sessionStartDate !== "" && sessionStartDate !== todayString) {
    console.log("ğŸ“… ë‚ ì§œ ë³€ê²½ ê°ì§€: ì„¸ì…˜ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.");
    
    // ì‚¬ìš©ìê°€ ì œì•ˆí•˜ì‹  ë” ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸êµ¬ë¡œ ì ìš©
    showToast(t("ë‚ ì§œê°€ ë³€ê²½ë˜ì–´ ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤."), "fa-solid fa-calendar-day text-amber-400");
    
    // 1.5ì´ˆ í›„ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ (êµ¬ì—­ ìƒíƒœ ë³€ê²½ ì—†ì´ ì•ˆì „í•˜ê²Œ ì´ˆê¸°í™”)
    setTimeout(handleLogoutConfirm, 1500); 
    return;
  }

  // 2. íƒ­ ìˆ¨ê¹€ ë˜ëŠ” 10ë¶„ ìœ íœ´ ê°ì§€ (ì—”ì§„ ì •ì§€ ë ˆì´ì–´ í‘œì‹œ)
  if (isTabHidden || idleDuration > 600000) {
    stopAllEngines();
  }
}, 10000); // 10ì´ˆë§ˆë‹¤ ì²´í¬


// [ì•ˆì „í•œ ì´ˆê¸°í™” ë¡œì§]
window.addEventListener('load', function() {
  
  // 1. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì–¸ì–´ì™€ ë²ˆì—­ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  var savedLang = localStorage.getItem('MY_SAVED_LANG') || 'ko';
  var savedDict = localStorage.getItem('APP_TRANSLATIONS');
  var translations = savedDict ? JSON.parse(savedDict) : {};

  // 2. ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ë²ˆì—­ ì‹¤í–‰
  if (translations && Object.keys(translations).length > 0) {
    applyTranslationSimple(translations, savedLang);
    updateLanguageUI(savedLang); // ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½ í•¨ìˆ˜ (ìˆë‹¤ë©´ ì‹¤í–‰)
  }

  // 3. ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë°±ê·¸ë¼ìš´ë“œ)
  google.script.run
    .withSuccessHandler(function(res) {
      // ì„œë²„ ë°ì´í„°ë¥¼ ë°›ìœ¼ë©´ ë¡œì»¬ ì €ì¥ ë° ì¬ë²ˆì—­
      if (res.translations) {
        localStorage.setItem('APP_TRANSLATIONS', JSON.stringify(res.translations));
        translations = res.translations;
      }
      if (res.currentLang) {
        savedLang = res.currentLang;
        localStorage.setItem('MY_SAVED_LANG', savedLang);
      }
      
      // ë‹¤ì‹œ í•œ ë²ˆ í™•ì‹¤í•˜ê²Œ ë²ˆì—­ ì ìš©
      applyTranslationSimple(translations, savedLang);
      
      // â˜… [í•µì‹¬] ëª¨ë“  ì‘ì—… ë! ê°€ë¦¼ë§‰ ì œê±°
      removeLoadingMask();
    })
    .withFailureHandler(function(e) {
      // ì—ëŸ¬ê°€ ë‚˜ë„ ê°€ë¦¼ë§‰ì€ ì¹˜ì›Œì•¼ í•¨
      console.error(e);
      removeLoadingMask();
    })
    .getAppInitData();

  // â˜… [ì•ˆì „ì¥ì¹˜] ë§Œì•½ ì„œë²„ ì‘ë‹µì´ 3ì´ˆ ì´ìƒ ì•ˆ ì˜¤ë©´ ê°•ì œë¡œ ê°€ë¦¼ë§‰ ì œê±° (ì•±ì´ ë©ˆì¶˜ ê²ƒì²˜ëŸ¼ ë³´ì´ì§€ ì•Šê²Œ)
  setTimeout(removeLoadingMask, 3000);
});

// [ë‹¨ìˆœí™”ëœ ë²ˆì—­ ì ìš© í•¨ìˆ˜]
function applyTranslationSimple(dict, lang) {
  if (!dict || lang === 'ko') return; // í•œêµ­ì–´ë©´ íŒ¨ìŠ¤
  
  var elements = document.querySelectorAll('[data-lang]');
  elements.forEach(function(el) {
    var key = el.getAttribute('data-lang');
    if (dict[key] && dict[key][lang]) {
      var txt = dict[key][lang];
      if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
        el.placeholder = txt;
      } else {
        el.innerHTML = txt;
      }
    }
  });
}

// [ìµœì¢… ìˆ˜ì •] ë ˆì´ë” ì™€ì´í”„ ì „í™˜ + ë¬¼ë¦¬ì  ì œê±° + ê³µì§€ì‚¬í•­ ì§€ì—° í˜¸ì¶œ í•¨ìˆ˜
function removeLoadingMask() {
  var mask = document.getElementById('app-loading-mask');
  var loginView = document.getElementById('loginView');
  
  if (!mask) return;

  // ğŸš€ [ê°•ë ¥ ë°©ì–´] ì´ë¯¸ ì ‘ì† ì¤‘ì´ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
  var isMainOpen = !document.getElementById('mainView').classList.contains('hidden');
  var isLeaderOpen = !document.getElementById('leaderView').classList.contains('hidden');
  var isLoginProcessStarted = (typeof currentNumber !== 'undefined' && currentNumber && currentNumber !== "0" && currentNumber !== "");

  if (isMainOpen || isLeaderOpen || isLoginProcessStarted) {
      mask.style.display = 'none'; 
      if (loginView) loginView.classList.add('hidden');
      console.log("âœ… ì ‘ì† ì§„í–‰ ì¤‘ ê°ì§€: ë¡œë”© í™”ë©´ ì¦‰ì‹œ ì œê±°");
      return; 
  }

  // 1. [ì¤€ë¹„] ë¡œê·¸ì¸ í¼ í™œì„±í™”
  if (loginView) {
    loginView.classList.remove('hidden');
    loginView.classList.add('reveal-effect'); 
    
    var loginBox = loginView.querySelector('div');
    if (loginBox) {
      var children = loginBox.children;
      for (var i = 0; i < children.length; i++) {
        children[i].classList.add('reveal-now');
      }
    }
  }

  // 2. [ì‹œì‘] ë ˆì´ë” ì™€ì´í”„ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ (CSSì˜ .wipe-out ì‹¤í–‰)
  mask.classList.add('wipe-out');
  mask.style.pointerEvents = 'none'; // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ ì¦‰ì‹œ í´ë¦­ì´ ê°€ë¦¼ë§‰ì„ í†µê³¼í•˜ê²Œ í•¨

  // 3. [ì •ë¦¬] ì• ë‹ˆë©”ì´ì…˜ ì¢…ë£Œ(1.2ì´ˆ) í›„ ê°€ë¦¼ë§‰ì„ ë¬¼ë¦¬ì ìœ¼ë¡œ ì œê±°
  // ğŸš€ ì´ ë¶€ë¶„ì´ í† ìŠ¤íŠ¸ ì•ŒëŒê³¼ ë²„íŠ¼ í´ë¦­ì„ ë°©í•´í•˜ì§€ ì•Šê²Œ í•˜ëŠ” í•µì‹¬ì…ë‹ˆë‹¤.
  setTimeout(function() {
    
    mask.style.display = 'none'; // ê°€ë¦¼ë§‰ì„ ì•„ì˜ˆ ì—†ì•° (ê³µê°„ ì°¨ì§€ X)
    
    // 4. [í¸ì˜] ì´ë¦„ ì…ë ¥ì°½ ìë™ í¬ì»¤ìŠ¤ (ë¡œê·¸ì¸ í™”ë©´ì¼ ë•Œë§Œ)
    if (!isLoginProcessStarted) {
        var nameInput = document.getElementById('nameInput');
        if (nameInput) {
          nameInput.focus();
          nameInput.click();
        }
    }

    // ğŸš€ ê³µì§€ì‚¬í•­ í˜¸ì¶œ (ë©”ì¸ ì§„ì… ì¤‘ì´ ì•„ë‹ ë•Œ ì§€ì—° í˜¸ì¶œ)
    if (!isLoginProcessStarted && window.pendingNotice && window.pendingNotice.trim() !== "") {
      setTimeout(function() {
        showNotice(window.pendingNotice);
        window.pendingNotice = null; 
      }, 500); 
    }
    
    console.log("âœ… ë¡œë”© ê°€ë¦¼ë§‰ ë¬¼ë¦¬ì  ì œê±° ì™„ë£Œ (ëª¨ë“  í´ë¦­/ì•ŒëŒ ì •ìƒí™”)");
  }, 1200); // .wipe-out ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„ì¸ 1.2ì´ˆì™€ ì¼ì¹˜ì‹œí‚´
}

/**
 * ğŸš€ ê´€ë¦¬ì íŒ¨ë„ ì—¬ê¸°ê¹Œì§€(ë§ˆí¬) í† ê¸€ (í´ë¦­ ì¦‰ì‹œ ì„œë²„ ì „ì†¡)
 * ì‚¬ìš©ìê°€ ì œê³µí•œ toggleBellOptionUI í•¨ìˆ˜ì™€ ë™ì¼í•œ ë¡œì§ êµ¬ì¡°ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
 */
function toggleMarkOptionUI() {
  // 1. ìƒíƒœ ì „í™˜ (ê¸°ë³¸ê°’ Y, í˜„ì¬ ìƒíƒœì— ë”°ë¼ í† ê¸€)
  var currentVal = globalSettings.isMarkEnabled || "Y";
  var newVal = (currentVal === 'Y') ? 'N' : 'Y';
  
  // 2. UI ì¦‰ì‹œ ë³€ê²½ (ë²„íŠ¼ ìƒ‰ìƒ ë° í…ìŠ¤íŠ¸)
  if (typeof updateMarkOptionButton === 'function') {
    updateMarkOptionButton(newVal);
  }
  
  // 3. ì¤‘ìš”: ì‹¤ì‹œê°„ ë Œë”ë§ì„ ìœ„í•´ globalSettings ê°ì²´ë„ ë™ê¸°í™”
  if (typeof globalSettings !== 'undefined') {
    globalSettings.isMarkEnabled = newVal;
  }
  
  // 4. ë¡œë”© í† ìŠ¤íŠ¸ í‘œì‹œ
  showToast(t("ì„¤ì • ë°˜ì˜ ì¤‘..."), "fa-solid fa-spinner fa-spin text-white", 800);

  // 5. ì„œë²„ í•¨ìˆ˜ í˜¸ì¶œ (ì‹œíŠ¸ B6 ì…€ ì €ì¥ìš©)
  google.script.run
    .withSuccessHandler(function(res) {
      if (res.success) {
        // ì„±ê³µ í† ìŠ¤íŠ¸ ì•Œë¦¼ (ë‹¤êµ­ì–´ ì§€ì›)
        showToast(t("ì—¬ê¸°ê¹Œì§€ ì„¤ì •ì´ ì¦‰ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."), "fa-solid fa-check text-emerald-500", 1500);
        
        // 6. ì„¤ì •ì´ ë°”ë€Œì—ˆìœ¼ë¯€ë¡œ ë¦¬ìŠ¤íŠ¸ë¥¼ ë‹¤ì‹œ ê·¸ë ¤ ê¹ƒë°œ ì•„ì´ì½˜ì„ ë³´ì´ê±°ë‚˜ ìˆ¨ê¹€
        if (!document.getElementById('mainView').classList.contains('hidden')) {
          renderList();
        }
      }
    })
    .withFailureHandler(function(e) {
      showToast("ì €ì¥ ì‹¤íŒ¨: " + e, "fa-solid fa-xmark text-red-500");
    })
    .saveMarkIconSettingOnly(newVal); // Code.gsì˜ ë§ˆí¬ ì „ìš© ì €ì¥ í•¨ìˆ˜ í˜¸ì¶œ
}

/**
 * ğŸš€ [ì‹ ê·œ ì¶”ê°€] ê´€ë¦¬ì íŒ¨ë„ ë²¨ ëˆ„ë¥´ê¸° ì˜µì…˜ í† ê¸€ í•¨ìˆ˜
 */
function toggleBellOptionUI() {
  // 1. í˜„ì¬ ìƒíƒœ ë°˜ì „ (Y <-> N)
  // ì „ì—­ ë³€ìˆ˜ serverSavedBellEnabled ë˜ëŠ” globalSettings.isBellEnabled ê¸°ì¤€
  var currentVal = serverSavedBellEnabled || "N";
  var newVal = (currentVal === 'Y') ? 'N' : 'Y';
  
  // 2. ì¦‰ì‹œ í™”ë©´ ë³€ìˆ˜ ë° UI ì—…ë°ì´íŠ¸
  serverSavedBellEnabled = newVal;
  if (typeof globalSettings !== 'undefined') {
    globalSettings.isBellEnabled = newVal;
  }
  updateBellOptionButton(newVal);
  
  // 3. ì•Œë¦¼ í‘œì‹œ
  showToast(t("ì„¤ì • ë°˜ì˜ ì¤‘..."), "fa-solid fa-spinner fa-spin text-white", 800);

  // 4. ì„œë²„(Google Apps Script) ì €ì¥ ìš”ì²­
  google.script.run
    .withSuccessHandler(function(res) {
      if (res.success) {
        showToast(t("ë²¨ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."), "fa-solid fa-check text-emerald-500", 1500);
        
        // 5. í˜„ì¬ êµ¬ì—­ ì¹´ë“œ í™”ë©´ì´ë¼ë©´ ë¦¬ìŠ¤íŠ¸ë¥¼ ë‹¤ì‹œ ê·¸ë ¤ ë²¨ ì•„ì´ì½˜ ë³´ì„/ìˆ¨ê¹€ ì¦‰ì‹œ ë°˜ì˜
        if (!document.getElementById('mainView').classList.contains('hidden')) {
          updateSingleCardUI(index); // ì°©í•œ ë…€ì„: ë”± ê·¸ ì¹´ë“œ í•˜ë‚˜ë§Œ ê³ ì¹¨
          recalculateLocalStats();   // ìƒë‹¨ í†µê³„ ìˆ«ìë§Œ ë‹¤ì‹œ ê³„ì‚°
        }
      }
    })
    .withFailureHandler(function(e) {
      showToast("ë²¨ ì„¤ì • ì €ì¥ ì‹¤íŒ¨: " + e, "fa-solid fa-xmark text-red-500");
    })
    .saveBellSettingOnly(newVal); // Code.gsì˜ ë²¨ ì „ìš© ì €ì¥ í•¨ìˆ˜ í˜¸ì¶œ
}


/**
 * [ìµœì¢… ìˆ˜ì •] ë²¨ ëˆ„ë¥´ê¸° í† ê¸€ (ë¬´í•œ ë¡œë”© ì œê±° + ì¦‰ì‹œ ì²´í¬ í‘œì‹œ ì ìš© ë²„ì „)
 * @param {number} index - ë°ì´í„° ë°°ì—´ì˜ ì¸ë±ìŠ¤
 * @param {number|string} visualNumber - í™”ë©´ì— í‘œì‹œë˜ëŠ” ê°€êµ¬ ë²ˆí˜¸ (ìˆœë²ˆ)
 */
function toggleBell(index, visualNumber) {
  if (Date.now() - lastWakeUpTime < 500) return; // ê¹¨ì–´ë‚˜ìë§ˆì ê°€ìƒí„°ì¹˜ ë§‰ìŒ

  // 1. ê¸°ë³¸ ì²´í¬ (ë°©ë¬¸ê¸ˆì§€, ì „ë„ì¸ ì§‘, ì´ë¯¸ ë°©ë¬¸ ì™„ë£Œëœ ê³³ì€ ë²¨ í´ë¦­ ë°©ì§€)
  var memo = currentData[index][5] || "";
  var isBanned = (globalSettings.banKeywords || [t("ë°©ë¬¸ê¸ˆì§€")])
                   .some(function(k) { return memo.trim().indexOf(k) === 0; });
                   
  var isPub = (globalSettings.pubKeywords || [t("ì „ë„ì¸ ì§‘")])
                 .some(function(k) { return memo.trim().indexOf(k) === 0; });

  if (isBanned || isPub) return;

  // 2. ê°’ í† ê¸€ ì„¤ì •
  var isCurrentlyRung = (currentData[index][7] === 'Y');
  var newValue = isCurrentlyRung ? '' : 'Y';

  // ğŸš€ [ë³´í˜¸ë§‰ í•µì‹¬] ì•¡ì…˜ ë°œìƒ ì¦‰ì‹œ ì‹œê°„ ê¸°ë¡ (30ì´ˆê°„ ì„œë²„ ì—…ë°ì´íŠ¸ë¡œë¶€í„° ë³´í˜¸)
  lastRowActionTime[index] = Date.now(); 

  // --- [STEP 1] ë‚™ê´€ì  UI ì ìš© (ìŠ¤í”¼ë„ˆ ëŒ€ì‹  ì¦‰ì‹œ ì²´í¬ í‘œì‹œ) ---
  pendingBells.delete(index); // ê¸°ì¡´ ìŠ¤í”¼ë„ˆ ë¡œì§ ì œê±°

  if (newValue === 'Y') {
    // [í•µì‹¬ ìˆ˜ì •] ì„œë²„ ì‘ë‹µ ì „ì´ë¼ë„ ì¦‰ì‹œ ì„±ê³µ ëª©ë¡(syncedBells)ì— ë„£ì–´ 'V' í‘œì‹œ ë…¸ì¶œ
    syncedBells.add(index); 
  } else {
    // ë²¨ í•´ì œ ì‹œì—ëŠ” ì²´í¬ í‘œì‹œë„ ì¦‰ì‹œ ì œê±°
    syncedBells.delete(index); 
  }

  // --- [STEP 2] UI ë° ë¡œì»¬ ë°ì´í„° ì¦‰ì‹œ ë°˜ì˜ ---
  currentData[index][7] = newValue;
  
  renderList(); 
  if (typeof recalculateLocalStats === 'function') recalculateLocalStats();
  if (typeof syncLocalCacheWithCurrentData === 'function') syncLocalCacheWithCurrentData();

  // --- [STEP 3] ì„œë²„ ì „ì†¡ (ë°°ê²½ ì²˜ë¦¬) ---
  addToQueue(() => {
    return new Promise((resolve, reject) => {
      // ê°€êµ¬ ìˆœë²ˆê³¼ ì´ë¦„ì„ í•©ì¹œ ìƒì„¸ ì •ë³´
      var detailedPlace = visualNumber + "ë²ˆ " + (currentData[index][3] || "");

      google.script.run
        .withSuccessHandler(function(res) {
          // ì„œë²„ ì‘ë‹µ ì„±ê³µ ì‹œ
          if (newValue === 'Y') {
            // ì´ë¯¸ ì²´í¬ê°€ ë–  ìˆëŠ” ìƒíƒœì´ë¯€ë¡œ, 1.5ì´ˆ ë’¤ì— ì•„ì´ì½˜ë§Œ ìì—°ìŠ¤ëŸ½ê²Œ ì œê±°
            setTimeout(function() {
              syncedBells.delete(index);
              renderList();
            }, 1500);
          } else {
            renderList();
          }
          resolve(res); 
        })
        .withFailureHandler(function(e) {
          // âŒ ì‹¤íŒ¨ ì‹œ: ì¦‰ì‹œ ì²´í¬ í‘œì‹œ ì§€ìš°ê³  ë°ì´í„° ë¡¤ë°± (ë³´í˜¸ë§‰ í•´ì œ)
          syncedBells.delete(index);
          pendingBells.delete(index);
          lastRowActionTime[index] = 0; 
          
          currentData[index][7] = isCurrentlyRung ? 'Y' : ''; 
          renderList();
          
          if (typeof recalculateLocalStats === 'function') recalculateLocalStats();
          showToast(t("ë²¨ ìƒíƒœ ì €ì¥ ì‹¤íŒ¨"), "fa-solid fa-xmark text-red-500");
          reject(e);
        })
        .updateBellStatus(
          currentNumber, 
          index, 
          newValue === 'Y', 
          currentUserName, 
          detailedPlace, 
          currentLang
        );
    });
  });
}

/**
 * ì—¬ê¸°ê¹Œì§€ í‘œì‹œ ë²„íŠ¼ì˜ ë””ìì¸ì„ ìƒíƒœ(Y/N)ì— ë”°ë¼ ë³€ê²½í•©ë‹ˆë‹¤.
 */
function updateMarkOptionButton(val) {
  const btn = document.getElementById('btnMarkOption');
  if (!btn) return;

  if (val === 'Y') {
    btn.innerText = t("ì‚¬ìš© ì¤‘");
    // ì‚¬ìš© ì¤‘ì¼ ë•Œ: ì¸ë””ê³  í…Œë§ˆ
    btn.className = "px-4 py-2 rounded-xl text-[11px] font-black transition-all shadow-sm border bg-indigo-600 text-white border-indigo-500";
  } else {
    btn.innerText = t("ë¯¸ì‚¬ìš©");
    // ë¯¸ì‚¬ìš©ì¼ ë•Œ: í°ìƒ‰ í…Œë§ˆ
    btn.className = "px-4 py-2 rounded-xl text-[11px] font-black transition-all shadow-sm border bg-white text-slate-400 border-slate-200";
  }
}

// [index.html] ìë°”ìŠ¤í¬ë¦½íŠ¸ ì˜ì—­
function toggleMarkOptionUI() {
  // 1. ê°’ í† ê¸€ (Y <-> N)
  var currentVal = globalSettings.isMarkEnabled || "Y";
  var newVal = (currentVal === 'Y') ? 'N' : 'Y';
  
  // 2. ì¦‰ì‹œ í™”ë©´ ë³€ìˆ˜ ë°˜ì˜ (ì¤‘ìš”)
  globalSettings.isMarkEnabled = newVal;
  updateMarkOptionButton(newVal);
  
  showToast(t("ì„¤ì • ë°˜ì˜ ì¤‘..."), "fa-solid fa-spinner fa-spin text-white", 800);

  // 3. ì„œë²„ ì €ì¥ ìš”ì²­
  google.script.run
    .withSuccessHandler(function(res) {
      if (res.success) {
        showToast(t("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."), "fa-solid fa-check text-emerald-500", 1500);
        renderList(); // ì•„ì´ì½˜ ì¦‰ì‹œ ë³´ì„/ìˆ¨ê¹€ ì²˜ë¦¬
      }
    })
    .saveMarkIconSettingOnly(newVal); // Code.gsì˜ B6 ì €ì¥ í•¨ìˆ˜ í˜¸ì¶œ
}


/**
 * ì„œë²„ ìš”ì²­ì„ íì— ë„£ê³  ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ (ë°ì´í„° ëˆ„ë½ ë°©ì§€ í•µì‹¬)
 */
function addToQueue(taskFn) {
  requestQueue.push(taskFn);
  processQueue();
}

function processQueue() {
  if (isProcessingQueue || requestQueue.length === 0) return;
  isProcessingQueue = true;
  const currentTask = requestQueue.shift();
  currentTask().finally(() => {
    isProcessingQueue = false;
    processQueue();
  });
}

/**
 * [ìˆ˜ì • ì™„ë£Œ] ì§‘ê³„ ë° í†µê³„ ëª¨ë“œ ì „í™˜
 * ì£¼ì†Œê°€ ë¹„ì–´ìˆëŠ”(ìƒì†ë°›ì€) ê°€êµ¬ë„ ì „ì²´ ê°œìˆ˜ì— í¬í•¨í•˜ì—¬ 100% ì˜¤ë¥˜ ìˆ˜ì •
 */
function recalculateLocalStats() {
  // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨
  if (!currentData || currentData.length === 0) return;

  let vCount = 0;     // ë°©ë¬¸ ì™„ë£Œ(Y) ìˆ˜
  let blCount = 0;    // ë²¨ ëˆ„ë¦„ ì™„ë£Œ(Y) ìˆ˜
  let totalCount = 0; // ì „ì²´ ê°€êµ¬ ìˆ˜ (ì•ˆë‚´ë¬¸ ì œì™¸)

  // 1. ë¦¬ìŠ¤íŠ¸ ì „ì²´ë¥¼ í›‘ìœ¼ë©° ê°œìˆ˜ë¥¼ ì…‰ë‹ˆë‹¤
  for (let i = 1; i < currentData.length; i++) {
    const row = currentData[i];
    const roadName = row[0] ? row[0].toString() : "";
    
    // [í•µì‹¬ ìˆ˜ì •] íŒŒë€ìƒ‰ êµ¬ì—­ì•ˆë‚´('*') ì¤„ë§Œ ì œì™¸í•˜ê³ , ë‚˜ë¨¸ì§€ëŠ” ë¬´ì¡°ê±´ ì…‰ë‹ˆë‹¤.
    // ê¸°ì¡´ì—ëŠ” ì£¼ì†Œ(Aì—´)ê°€ ë¹„ì–´ìˆìœ¼ë©´ ì œì™¸í–ˆê¸° ë•Œë¬¸ì— í†µê³„ ì˜¤ë¥˜ê°€ ë‚¬ì—ˆìŠµë‹ˆë‹¤.
    if (roadName.indexOf('*') === 0) continue; 

    // (ì„ íƒ) ë§Œì•½ ì´ë¦„(Dì—´)ë„ ì—†ê³  í˜¸ìˆ˜(Cì—´)ë„ ì—†ëŠ” ì™„ì „ ë¹ˆ ì¤„ì€ ì œì™¸í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
    // if (!row[3]) continue; 

    totalCount++; // ì „ì²´ ê°€êµ¬ ìˆ˜ +1

    // ë°©ë¬¸ ì²´í¬(Eì—´) í™•ì¸ ('Y'ë©´ ë°©ë¬¸ìˆ˜ +1)
    if (row[4] === 'Y') vCount++; 
    
    // ë²¨ ëˆ„ë¥´ê¸°(Hì—´) í™•ì¸ ('Y'ë©´ ë²¨ìˆ˜ +1)
    if (row[7] === 'Y') blCount++; 
  }

  // 2. í¼ì„¼íŠ¸ ê³„ì‚° (ì „ì²´ ê°€êµ¬ê°€ 0ê°œë©´ 0% ì²˜ë¦¬)
  const vPercent = (totalCount > 0) ? Math.round((vCount / totalCount) * 100) : 0;
  const blPercent = (totalCount > 0) ? Math.round((blCount / totalCount) * 100) : 0;
  
  // 3. ì•Œì•½ í…ìŠ¤íŠ¸ êµ¬ì„± (ì•„ì´ì½˜ + í¼ì„¼íŠ¸)
  currentProgressText = `
    <i class="fa-solid fa-circle-check text-emerald-500 text-[10px]"></i> ${vPercent}% 
    <span class="mx-1.5 opacity-30 text-slate-400">|</span> 
    <i class="fa-solid fa-bell text-amber-500 text-[10px]"></i> ${blPercent}%
  `;
  
  // 4. í•˜ë‹¨ ë²¨ ì¹´ìš´íŠ¸ ìˆ«ì ì—…ë°ì´íŠ¸
  const bellDisplay = document.getElementById('totalBellCount'); 
  if (bellDisplay) {
    bellDisplay.innerText = blCount;
  }
  
  // 5. ìƒë‹¨ ì•Œì•½ ì—…ë°ì´íŠ¸ ì‹¤í–‰
  showPillStats();

  // (ê°œë°œììš©) ì½˜ì†”ì— ê³„ì‚° ê²°ê³¼ í‘œì‹œ
  console.log(`[í†µê³„ ìˆ˜ì •ë¨] ì´:${totalCount}ê°€êµ¬ / ë°©ë¬¸:${vCount} / ë²¨:${blCount}`);
}


// [ì¶”ê°€] ë©”ëª¨ ë‚´ìš©ì— ë”°ë¼ ê°€êµ¬ í–‰ì˜ ìŠ¤íƒ€ì¼(ìƒ‰ìƒ)ì„ ê²°ì •í•˜ëŠ” í•¨ìˆ˜
function getRowStyle(memo) {
  if (!memo) return "bg-white"; 
  const trimmedMemo = memo.trim();

  // ğŸš€ [ë¡œì§ A] ë‹¤êµ­ì–´ 'ë°©ë¬¸ê¸ˆì§€' ê°ì§€
  const isBan = (globalSettings.banKeywords || ["ë°©ë¬¸ê¸ˆì§€"])
                .some(k => trimmedMemo.indexOf(k) === 0);
  if (isBan) return "bg-red-50 border-l-4 border-red-500 shadow-sm"; 

  // ğŸš€ [ë¡œì§ B] ë‹¤êµ­ì–´ 'ì „ë„ì¸ ì§‘' ê°ì§€
  const isPub = (globalSettings.pubKeywords || ["ì „ë„ì¸ ì§‘"])
                .some(k => trimmedMemo.indexOf(k) === 0);
  if (isPub) return "bg-blue-50 border-l-4 border-blue-400 opacity-80"; 

  return "bg-white"; 
}

// ì¸ë„ì ëŒ€ì‹œë³´ë“œê°€ ì¼œì§ˆ ë•Œ ì‹¤í–‰ë˜ëŠ” ë¶€ë¶„ì— ì¶”ê°€
let sosFastTimer = null;

// [ìˆ˜ì •] SOS ì „ìš© ì´ˆê³ ì† ê°ì‹œ ì—”ì§„
function startSOSMonitoring() {
  if (sosFastTimer) clearInterval(sosFastTimer); // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
  
  sosFastTimer = setInterval(function() {
    // íƒ­ì´ í™œì„±í™”ë˜ì–´ ìˆê³  ì ˆì „ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ì‘ë™
    if (document.hidden || isDeepSleeping) return;

    google.script.run
      .withSuccessHandler(function(activeSOS) {
        if (activeSOS && activeSOS.length > 0) {
          // ì´ë¯¸ ì˜ ë§Œë“¤ì–´ì§„ checkSOS í•¨ìˆ˜ë¥¼ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤.
          checkSOS(activeSOS); 
        }
      })
      .getSOSOnly(); // ì„œë²„ì˜ ì´ˆê²½ëŸ‰ í•¨ìˆ˜ í˜¸ì¶œ
  }, 5000); // 5ì´ˆ ì£¼ê¸°
}

// [ì¶”ê°€] ì—”ì§„ ì •ì§€ í•¨ìˆ˜
function stopSOSMonitoring() {
  if (sosFastTimer) {
    clearInterval(sosFastTimer);
    sosFastTimer = null;
  }
}

// [ë´‰ì‚¬ ì‹œê°„ ê³„ì‚° í•¨ìˆ˜]
function getServiceDuration() {
  const now = new Date();
  const diffMin = Math.floor((now - sessionStartTime) / 60000);
  const hours = Math.floor(diffMin / 60);
  const mins = diffMin % 60;
  
  const timeLabel = t("ë´‰ì‚¬");
  const hrLabel = t("ì‹œê°„");
  const minLabel = t("ë¶„");

  if (hours > 0) return `${timeLabel}: ${hours}${hrLabel} ${mins}${minLabel}`;
  return `${timeLabel}: ${mins}${minLabel}`;
}

/**
 * [ìˆ˜ì •] í†µê³„ í‘œì‹œ ì‹œ ì•„ì´ì½˜ ë Œë”ë§ì„ ìœ„í•´ innerHTML ì‚¬ìš©
 * + ì•Œì•½ ê°•ì œ ë…¸ì¶œ ë¡œì§ ì¶”ê°€
 */
function showPillStats() {
  const pill = document.getElementById('stickyAddressPill'); // ì•Œì•½ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
  const pillMain = document.getElementById('pillMainText');
  const pillSub = document.getElementById('pillSubText');
  const pillSubWrapper = document.getElementById('pillSubWrapper');

  if (!currentProgressText || !pillMain) return;

  // 1. í…ìŠ¤íŠ¸ ë° ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
  pillMain.innerHTML = currentProgressText;    
  pillSub.innerText = getServiceDuration();    
  
  // í†µê³„ ëª¨ë“œì—ì„œëŠ” ìœ„ì¹˜ í•€ ì•„ì´ì½˜ ìˆ¨ê¸°ê¸°
  if(pillSubWrapper) {
    const icon = pillSubWrapper.querySelector('i');
    if(icon) icon.style.display = 'none'; 
  }

  // âœ… [ì¶”ê°€] ì•Œì•½(Pill)ì„ ì¦‰ì‹œ í™”ë©´ì— ë³´ì´ê²Œ ê°•ì œí•©ë‹ˆë‹¤.
  if (pill) {
    // ìˆ¨ê¹€ í´ë˜ìŠ¤ ì œê±°
    pill.classList.remove('opacity-0', '-translate-y-4', '-translate-y-2', 'pointer-events-none');
    // ë³´ì„ í´ë˜ìŠ¤ ì¶”ê°€
    pill.classList.add('opacity-100', 'translate-y-0');
  }
}

function loadBibleSection() {
  // ğŸš€ [ì¶”ê°€] ì„¤ì •ê°’ì´ 'N'ì´ë©´ ì„±êµ¬ ë¡œë”© ì¤‘ë‹¨
  if (globalSettings && globalSettings.isShowBible === 'N') {
    document.getElementById('bibleSection').classList.add('hidden');
    return;
  }

  google.script.run
    .withSuccessHandler(function(res) {
      if (res && res.success && res.data && res.data.length > 0) {
        const area = document.getElementById('bibleSection');
        const titleEl = document.getElementById('bibleTitle');
        const contentEl = document.getElementById('bibleContent');
        
        const item = res.data[0];
        
        titleEl.innerText = item.title;
        contentEl.innerText = item.content;
        
        area.classList.remove('hidden');
      }
    })
    .withFailureHandler(function(err) {
      console.error("ì„±ì„œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
    })
    .getBibleData();
}

// ê¸°ì¡´ window.onloadì— ì¶”ê°€
window.onload = function() {
  checkRecentHistory();
  setTimeout(warmUpServer, 100);
   
};

/**
 * ğŸš€ ì„±êµ¬ í‘œì‹œ ë²„íŠ¼ UI ì—…ë°ì´íŠ¸
 */
function updateBibleOptionButton(val) {
  const btn = document.getElementById('btnBibleOption');
  if (!btn) return;

  if (val === 'Y') {
    btn.innerText = t("í‘œì‹œí•¨");
    btn.className = "px-4 py-2 rounded-xl text-[11px] font-black transition-all shadow-sm border bg-indigo-600 text-white border-indigo-500";
  } else {
    btn.innerText = t("ìˆ¨ê¹€");
    btn.className = "px-4 py-2 rounded-xl text-[11px] font-black transition-all shadow-sm border bg-white text-slate-400 border-slate-200";
  }
}

/**
 * ğŸš€ ì„±êµ¬ í‘œì‹œ í† ê¸€ (ì„œë²„ ì €ì¥)
 */
function toggleBibleOptionUI() {
  var currentVal = globalSettings.isShowBible || "Y";
  var newVal = (currentVal === 'Y') ? 'N' : 'Y';
  
  // 1. ì „ì—­ ë³€ìˆ˜ ë° UI ì¦‰ì‹œ ë°˜ì˜
  globalSettings.isShowBible = newVal;
  updateBibleOptionButton(newVal);
  
  showToast(t("ì„¤ì • ë°˜ì˜ ì¤‘..."), "fa-solid fa-spinner fa-spin text-white", 800);

  // 2. ì„œë²„ ì €ì¥
  google.script.run
    .withSuccessHandler(function(res) {
      if (res.success) {
        showToast(t("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."), "fa-solid fa-check text-emerald-500", 1500);
        // ì„¤ì • ë³€ê²½ í›„ ì¦‰ì‹œ ë¡œê·¸ì¸ í™”ë©´ì—ë„ ë°˜ì˜ (ë¡œê·¸ì•„ì›ƒ ì•ˆ í•´ë„ ì‚¬ë¼ì§€ê²Œ)
        const bibleArea = document.getElementById('bibleSection');
        if (bibleArea) {
            if (newVal === 'N') bibleArea.classList.add('hidden');
            else loadBibleSection(); // ë‹¤ì‹œ ì¼œë©´ ë¡œë“œ ì‹œë„
        }
      }
    })
    .withFailureHandler(function(e) {
      showToast("ì €ì¥ ì‹¤íŒ¨: " + e, "fa-solid fa-xmark text-red-500");
    })
    .saveBibleSettingOnly(newVal);
}


// 1. ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ ì‹œ -> ëª¨ë‹¬ ì—´ê¸°
function runClearCache() {
  // ê¸°ì¡´ì˜ ë¸Œë¼ìš°ì € confirm ëŒ€ì‹  ì»¤ìŠ¤í…€ ëª¨ë‹¬ì„ ë„ì›ë‹ˆë‹¤.
  document.getElementById('cacheClearModal').classList.remove('hidden');
}

// 2. ëª¨ë‹¬ ë‹«ê¸° (ì·¨ì†Œ)
function closeCacheClearModal() {
  document.getElementById('cacheClearModal').classList.add('hidden');
}

// 3. ì§„ì§œ ì´ˆê¸°í™” ì‹¤í–‰ (ì„œë²„ ìš”ì²­)
function confirmCacheClear() {
  closeCacheClearModal(); // ëª¨ë‹¬ ë‹«ê¸°
  
  // ë¡œë”© í† ìŠ¤íŠ¸ í‘œì‹œ
  showToast(t("ìºì‹œ ì •ë¦¬ ì¤‘..."), "fa-solid fa-spinner fa-spin text-white");

  google.script.run
    .withSuccessHandler(function(res) {
      if (res.success) {
        showToast(t("ì‹œìŠ¤í…œì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•˜ì„¸ìš”."), "fa-solid fa-check-circle text-emerald-500");
        
        // 1.5ì´ˆ ë’¤ í˜ì´ì§€ ìë™ ìƒˆë¡œê³ ì¹¨ (ê¹”ë”í•˜ê²Œ ì¬ì‹œì‘)
        setTimeout(function() { 
            location.reload(); 
        }, 1500);
      } else {
        showToast("ì‹¤íŒ¨: " + res.message, "fa-solid fa-bomb text-red-500");
      }
    })
    .withFailureHandler(function(e) {
      showToast("í†µì‹  ì˜¤ë¥˜", "fa-solid fa-bomb text-red-500");
    })
    .clearSystemCache();
}






    </script>
  </body>
</html>
